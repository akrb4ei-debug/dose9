<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>도스온라인 국방부 근퇴시스템</title>

<style>
body{margin:0;background:#111;color:#eee;font-family:Segoe UI;}
.top{padding:15px 30px;background:#1a1a1a;border-bottom:1px solid #333;}
.container{display:flex;gap:20px;padding:20px;}
.card{background:#1a1a1a;padding:15px;border:1px solid #333;border-radius:8px;margin-bottom:15px;}
button{background:#222;color:#fff;border:1px solid #444;padding:5px 10px;border-radius:5px;cursor:pointer;margin:3px;}
button:hover{background:#333;}
input,select{background:#111;color:#fff;border:1px solid #444;padding:5px;border-radius:5px;margin:3px;}
.hidden{display:none;}
.stat{background:#111;padding:6px;margin-bottom:5px;border-radius:5px;}
</style>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
query, where, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyAJ6MhR1JsGbvieb8akAi4Zpas_W3uaNJ4",
authDomain:"dosep-b6ee3.firebaseapp.com",
projectId:"dosep-b6ee3"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const colUsers=collection(db,"users");
const colWork=collection(db,"workRecords");
const colContent=collection(db,"contentRecords");

let currentUser=null;
let currentUserData=null;
let usersCache=new Map();
let contentPage=0;
const PAGE_SIZE=20;

function $(id){return document.getElementById(id);}
function show(id,f){if($(id))$(id).classList.toggle("hidden",!f);}

function err(e){
if(e?.code==="permission-denied") return "Firestore 권한 문제";
if(e?.code==="resource-exhausted") return "할당량 초과";
return "오류 발생 (콘솔 확인)";
}

async function login(){
try{
const id=$("loginId").value.trim();
const pw=$("loginPw").value;
const snap=await getDoc(doc(db,"users",id));
if(!snap.exists()) return alert("등록된 유저 없음");
if(String(snap.data().password)!==String(pw)) return alert("비밀번호 오류");

currentUser=id;
currentUserData=snap.data();
await loadUsers();

$("userInfo").innerText=`${id} | ${currentUserData.rank||"-"} | 관리자:${currentUserData.isAdmin?"O":"X"}`;
show("loginBox",false);
show("mainBox",true);

loadStats();
loadContent();

}catch(e){alert(err(e));console.error(e);}
}

async function loadUsers(){
const snap=await getDocs(colUsers);
usersCache=new Map();
snap.forEach(d=>usersCache.set(d.id,d.data()));
}

async function checkIn(){
const q=query(colWork,where("nickname","==",currentUser),where("checkOut","==",null));
if(!(await getDocs(q)).empty) return alert("이미 출근중");
await addDoc(colWork,{nickname:currentUser,checkIn:serverTimestamp(),checkOut:null});
loadStats();
}

async function checkOut(){
const q=query(colWork,where("nickname","==",currentUser),where("checkOut","==",null));
const snap=await getDocs(q);
if(snap.empty) return alert("출근 기록 없음");
await updateDoc(doc(db,"workRecords",snap.docs[0].id),{checkOut:serverTimestamp()});
loadStats();
}

async function loadStats(){
const snap=await getDocs(colWork);
let map=new Map();
snap.forEach(d=>{
const r=d.data();
if(!map.has(r.nickname)) map.set(r.nickname,{total:0,open:false});
if(r.checkOut){
map.get(r.nickname).total+=(r.checkOut.seconds-r.checkIn.seconds);
}else{
map.get(r.nickname).open=true;
}
});
renderStats(map);
}

function renderStats(map){
let html="";
usersCache.forEach((data,name)=>{
const s=map.get(name)||{total:0,open:false};
html+=`<div class="stat">
<b>${name}</b> (${data.rank||"-"})
| 접속:${s.open?"O":"X"}
| ${Math.floor(s.total/3600)}시간
${currentUserData.isAdmin?`<button data-force="${name}">강제퇴근</button>`:""}
</div>`;
});
$("statsArea").innerHTML=html||"데이터 없음";

if(currentUserData.isAdmin){
document.querySelectorAll("[data-force]").forEach(btn=>{
btn.onclick=async()=>{
const name=btn.dataset.force;
const q=query(colWork,where("nickname","==",name),where("checkOut","==",null));
const snap=await getDocs(q);
snap.forEach(async d=>{
await updateDoc(doc(db,"workRecords",d.id),{checkOut:serverTimestamp()});
});
loadStats();
};
});
}
}

async function createContent(type){
let names=prompt("참여자(콤마구분)");
if(!names) return;
let arr=names.split(",").map(x=>x.trim()).filter(x=>x);
if(!arr.includes(currentUser)) arr.unshift(currentUser);
await addDoc(colContent,{
type,
writer:currentUser,
participants:arr,
time:serverTimestamp()
});
loadContent();
}

async function loadContent(){
const seven=new Date();
seven.setDate(seven.getDate()-7);

const q=query(colContent,
where("time",">=",seven),
orderBy("time","desc"),
limit((contentPage+1)*PAGE_SIZE)
);

const snap=await getDocs(q);
let docs=snap.docs;
let html="";
docs.slice(contentPage*PAGE_SIZE,(contentPage+1)*PAGE_SIZE).forEach(d=>{
const r=d.data();
html+=`<div class="stat">
<b>${r.type}</b> | ${r.writer}<br>
참여자: ${r.participants.join(", ")}
</div>`;
});
$("contentArea").innerHTML=html||"기록 없음";

$("pageArea").innerHTML="";
if(docs.length>(contentPage+1)*PAGE_SIZE){
const next=document.createElement("button");
next.textContent="다음 페이지";
next.onclick=()=>{contentPage++;loadContent();}
$("pageArea").appendChild(next);
}
if(contentPage>0){
const prev=document.createElement("button");
prev.textContent="이전 페이지";
prev.onclick=()=>{contentPage--;loadContent();}
$("pageArea").appendChild(prev);
}
}

document.addEventListener("DOMContentLoaded",()=>{
$("loginBtn").addEventListener("click",login);
$("inBtn").addEventListener("click",checkIn);
$("outBtn").addEventListener("click",checkOut);
$("supplyBtn").addEventListener("click",()=>createContent("보급"));
$("plantBtn").addEventListener("click",()=>createContent("송전소"));
$("escortBtn").addEventListener("click",()=>createContent("차량수호"));
});

</script>
</head>

<body>

<div id="loginBox" class="card" style="width:350px;margin:100px auto;">
<h2>로그인</h2>
<input id="loginId" placeholder="아이디"><br>
<input id="loginPw" type="password" placeholder="비밀번호"><br>
<button id="loginBtn">로그인</button>
</div>

<div id="mainBox" class="hidden">
<div class="top"><span id="userInfo"></span></div>
<div class="container">

<div style="flex:1">
<div class="card">
<h3>근태</h3>
<button id="inBtn">출근</button>
<button id="outBtn">퇴근</button>
</div>

<div class="card">
<h3>컨텐츠 작성</h3>
<button id="supplyBtn">보급</button>
<button id="plantBtn">송전소</button>
<button id="escortBtn">차량수호</button>
</div>

<div class="card">
<h3>컨텐츠 기록</h3>
<div id="contentArea"></div>
<div id="pageArea"></div>
</div>
</div>

<div style="flex:1">
<div class="card">
<h3>유저 통계</h3>
<div id="statsArea"></div>
</div>
</div>

</div>
</div>

</body>
</html>

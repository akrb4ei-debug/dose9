<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Operation Dashboard</title>

  <!-- í°íŠ¸/ì°¨íŠ¸/OCR -->
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{
      /* Black / White / Gray */
      --bg:#0B0C0E;
      --panel:rgba(255,255,255,0.06);
      --panel2:rgba(255,255,255,0.04);
      --stroke:rgba(255,255,255,0.12);
      --stroke2:rgba(255,255,255,0.08);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.62);
      --muted2:rgba(255,255,255,0.50);
      --shadow:0 18px 60px rgba(0,0,0,0.55);
      --shadow2:0 14px 40px rgba(0,0,0,0.40);
      --ok:rgba(255,255,255,0.92);
      --bad:rgba(255,255,255,0.45);
    }
    *{box-sizing:border-box;font-family:'Pretendard',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    body{
      margin:0;min-height:100vh;color:var(--text);
      background:
        radial-gradient(900px 700px at 15% 0%, rgba(255,255,255,0.06), transparent 60%),
        radial-gradient(900px 700px at 85% 10%, rgba(255,255,255,0.04), transparent 60%),
        linear-gradient(180deg,#0B0C0E,#070709 70%,#0B0C0E);
    }
    .wrap{width:min(1680px,96vw);margin:18px auto 46px;position:relative;z-index:1;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border-radius:18px;
      background:rgba(255,255,255,0.05);
      border:1px solid var(--stroke);
      backdrop-filter:blur(12px);
      box-shadow:var(--shadow);
      position:sticky;top:12px;z-index:30;
    }
    .brand{display:flex;align-items:center;gap:12px;}
    .logo{
      width:40px;height:40px;border-radius:14px;display:grid;place-items:center;
      background:rgba(255,255,255,0.92);color:#0B0C0E;box-shadow:var(--shadow2);
      font-weight:900;letter-spacing:-0.5px;
    }
    .brandTitle{font-size:16px;font-weight:900;letter-spacing:-0.2px;}
    .brandSub{font-size:12px;color:var(--muted);font-weight:800;margin-top:2px;}

    .pill{
      font-size:12px;padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      color:rgba(255,255,255,0.84);
      font-weight:800;white-space:nowrap;
    }
    .pill.on{background:rgba(255,255,255,0.10);}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:14px;align-items:start;}
    @media (max-width:1080px){.grid{grid-template-columns:1fr;}}

    .card{
      background:rgba(255,255,255,0.05);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:18px;
      backdrop-filter:blur(12px);
      box-shadow:var(--shadow);
    }
    h2,h3{margin:0 0 10px;}
    .sub{color:var(--muted);font-size:13px;line-height:1.55;margin-top:-4px;font-weight:700;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}

    input,select,textarea{
      border:none;outline:none;
      padding:11px 12px;border-radius:14px;
      background:rgba(255,255,255,0.06);
      border:1px solid var(--stroke);
      color:var(--text);
      min-width:190px;
    }
    textarea{min-width:240px;width:100%;resize:vertical;min-height:84px;}
    input::placeholder{color:rgba(255,255,255,0.48);}

    .btn{
      border:none;outline:none;cursor:pointer;user-select:none;
      padding:11px 14px;border-radius:14px;font-weight:900;
      color:rgba(255,255,255,0.92);
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      transition:transform .15s ease,box-shadow .15s ease,background .15s ease;
      white-space:nowrap;min-height:42px;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:var(--shadow2);background:rgba(255,255,255,0.09);}
    .btn:active{transform:translateY(0);box-shadow:none;}
    .btn.primary{background:rgba(255,255,255,0.92);color:#0B0C0E;border-color:rgba(255,255,255,0.20);}
    .btn.danger{background:rgba(255,255,255,0.12);border-color:rgba(255,255,255,0.18);color:rgba(255,255,255,0.92);}
    .btn.admin{background:rgba(255,255,255,0.92);color:#0B0C0E;}
    .btn.ghost{background:rgba(255,255,255,0.04);}
    .btn.small{min-height:34px;padding:8px 10px;font-size:12.5px;border-radius:12px;}
    .btn.disabled{opacity:.55;pointer-events:none;}

    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:10px;}
    @media (max-width:980px){.kpi{grid-template-columns:repeat(2,minmax(0,1fr));}}
    .kpi .box{border-radius:14px;padding:12px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.10);}
    .kpi .label{font-size:12px;color:var(--muted);font-weight:900;}
    .kpi .value{font-size:20px;font-weight:900;margin-top:6px;letter-spacing:-0.2px;}

    .online-list{margin-top:10px;display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto;padding-right:4px;}
    .chip{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-radius:999px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.10);
      font-weight:900;
    }
    .chip .leftPart{display:flex;align-items:center;gap:10px;}
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,0.92);box-shadow:0 0 0 4px rgba(255,255,255,0.10);}
    .dot.off{background:rgba(255,255,255,0.38);box-shadow:0 0 0 4px rgba(255,255,255,0.07);}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px;}
    .tab{
      padding:9px 12px;border-radius:14px;cursor:pointer;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.10);
      font-weight:900;font-size:13px;transition:.15s;white-space:nowrap;
    }
    .tab.active{background:rgba(255,255,255,0.10);border:1px solid rgba(255,255,255,0.14);box-shadow:var(--shadow2);}

    .dropdown-wrap{position:relative;display:inline-flex;}
    .dropdown{
      position:absolute;top:44px;right:0;width:260px;border-radius:14px;
      background:rgba(10,10,12,0.96);
      border:1px solid rgba(255,255,255,0.14);
      backdrop-filter:blur(12px);
      overflow:hidden;
      transform-origin:top right;
      max-height:0;opacity:0;transform:translateY(-6px) scale(0.98);
      transition:max-height .22s ease,opacity .22s ease,transform .22s ease;
      pointer-events:none;z-index:40;
    }
    .dropdown.open{max-height:420px;opacity:1;transform:translateY(0) scale(1);pointer-events:auto;}
    .dropdown button{
      width:100%;text-align:left;border:none;outline:none;cursor:pointer;
      padding:11px 12px;background:transparent;color:var(--text);font-weight:900;
    }
    .dropdown button:hover{background:rgba(255,255,255,0.06);}

    .tableWrap{margin-top:10px;overflow:auto;max-height:680px;padding-right:6px;}
    .table{
      width:100%;min-width:1200px;border-collapse:collapse;overflow:hidden;
      border-radius:14px;border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.03);
    }
    .table th,.table td{
      padding:12px 10px;border-bottom:1px solid rgba(255,255,255,0.08);
      text-align:center;font-size:13.5px;line-height:1.35;white-space:nowrap;vertical-align:middle;
    }
    .table th{
      color:rgba(255,255,255,0.72);font-weight:900;font-size:12.5px;
      position:sticky;top:0;z-index:2;background:rgba(0,0,0,0.70);
      backdrop-filter:blur(10px);
    }
    .table tr:hover td{background:rgba(255,255,255,0.05);}
    .left{text-align:left!important;white-space:normal;word-break:break-word;}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.78);display:none;align-items:center;justify-content:center;padding:18px;z-index:100;}
    .modal.show{display:flex;}
    .modal-box{
      width:min(980px,96vw);
      border-radius:18px;background:rgba(10,10,12,0.96);
      border:1px solid rgba(255,255,255,0.14);
      backdrop-filter:blur(16px);
      box-shadow:0 30px 100px rgba(0,0,0,0.75);
      overflow:hidden;animation:pop .18s ease;
    }
    @keyframes pop{from{transform:translateY(8px) scale(0.985);opacity:0;}to{transform:translateY(0) scale(1);opacity:1;}}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:rgba(255,255,255,0.05);border-bottom:1px solid rgba(255,255,255,0.08);}
    .modal-title{font-weight:900;font-size:14px;letter-spacing:.2px;}
    .modal-body{padding:16px;}
    .modal-foot{display:flex;justify-content:flex-end;gap:10px;padding:14px 16px;background:rgba(255,255,255,0.05);border-top:1px solid rgba(255,255,255,0.08);flex-wrap:wrap;}

    .collapse{overflow:hidden;max-height:0;opacity:0;transform:translateY(-6px);transition:max-height .22s ease,opacity .22s ease,transform .22s ease;}
    .collapse.open{max-height:1200px;opacity:1;transform:translateY(0);}

    .chatWrap{display:grid;grid-template-columns:1fr;gap:12px;}
    .chatBox{border-radius:14px;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.03);padding:12px;}
    .chatMsgs{max-height:360px;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:4px;}
    .msg{padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.04);}
    .msg .mHead{display:flex;gap:8px;align-items:baseline;justify-content:space-between;}
    .msg .sender{font-weight:900;}
    .msg .time{font-size:12px;color:rgba(255,255,255,0.58);font-weight:800;white-space:nowrap;}
    .msg .text{margin-top:6px;white-space:pre-wrap;word-break:break-word;font-weight:700;color:rgba(255,255,255,0.88);}

    .bold{font-weight:900;}
    .mutedSmall{font-size:12px;color:rgba(255,255,255,0.60);font-weight:800;margin-top:2px;}
    .tinyStatus{margin-top:8px;font-size:12px;color:rgba(255,255,255,0.70);font-weight:900;min-height:16px;}
    .note{font-size:12px;color:var(--muted);margin-top:8px;font-weight:800;line-height:1.55;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">OD</div>
        <div>
          <div class="brandTitle">Operation Dashboard</div>
          <div class="brandSub">ê·¼íƒœ Â· ì½˜í…ì¸  Â· ë¶€ì„œ Â· ì±„íŒ… Â· ê³„ê¸‰</div>
        </div>
      </div>
      <div class="row">
        <span class="pill on">ì‹¤ì‹œê°„</span>
        <span class="pill" id="whoami">ë¯¸ë¡œê·¸ì¸</span>
      </div>
    </div>

    <div class="grid">
      <!-- Main -->
      <div class="card">
        <h2>ë©”ì¸</h2>
        <div class="sub">ì¶œê·¼/í‡´ê·¼ ë° ì½˜í…ì¸  ë³´ê³ , ìœ ì €/ì½˜í…ì¸  ì¡°íšŒ, ë¶€ì„œ ì†Œí†µë°©ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>

        <div class="row" style="margin-top:12px;">
          <input id="nickname" placeholder="ë‹‰ë„¤ì„(ì•„ì´ë””)" autocomplete="username" />
          <input id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" autocomplete="current-password" />
          <button class="btn primary" id="loginBtn">ë¡œê·¸ì¸</button>
          <button class="btn ghost" id="logoutBtn" disabled>ë¡œê·¸ì•„ì›ƒ</button>
          <button class="btn" id="myInfoBtn" disabled>ë‚´ ì •ë³´</button>
          <button class="btn" id="publicUsersBtn" disabled>ìœ ì € ëª©ë¡</button>
          <button class="btn" id="publicContentBtn" disabled>ì½˜í…ì¸  ê¸°ë¡</button>
          <button class="btn admin" id="adminBtn" style="display:none;">ê´€ë¦¬</button>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="label">í˜„ì¬ ì ‘ì†</div>
            <div class="value" id="kpiOnline">0</div>
          </div>
          <div class="box">
            <div class="label">ë‚´ ìƒíƒœ</div>
            <div class="value" id="kpiMe">-</div>
          </div>
          <div class="box">
            <div class="label">ë‚´ ë¶€ì„œ</div>
            <div class="value" id="kpiDept">-</div>
          </div>
          <div class="box">
            <div class="label">ìµœê·¼ 7ì¼ ë‚´ ê·¼ë¬´</div>
            <div class="value" id="kpiWeekHours">-</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="checkInBtn" disabled>ì¶œê·¼</button>
          <button class="btn danger" id="checkOutBtn" disabled>í‡´ê·¼</button>
          <button class="btn" id="supplyBtn" disabled>ë³´ê¸‰</button>
          <button class="btn" id="powerBtn" disabled>ì†¡ì „ì†Œ</button>
          <button class="btn" id="escortBtn" disabled>ì°¨ëŸ‰ìˆ˜í˜¸</button>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="row" style="justify-content:space-between;">
            <h3 style="margin:0;">ì ‘ì†ì¤‘(ì¶œê·¼ì¤‘) ëª©ë¡</h3>
            <span class="pill on">ì‹¤ì‹œê°„</span>
          </div>
          <div class="sub">ì¼ë°˜ ìœ ì €ëŠ” ìˆ¨ê¹€ ìœ ì €ê°€ ì—¬ê¸°ì„œ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ê´€ë¦¬ìëŠ” ë³´ì…ë‹ˆë‹¤.)</div>
          <div class="online-list" id="onlineUsers"></div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="row" style="justify-content:space-between;">
            <h3 style="margin:0;">ë¶€ì„œ ì†Œí†µë°©</h3>
            <span class="pill" id="chatScope">-</span>
          </div>
          <div class="sub">ì¼ë°˜ ìœ ì €ëŠ” ë³¸ì¸ ë¶€ì„œë§Œ, ê´€ë¦¬ìëŠ” ëª¨ë“  ë¶€ì„œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>

          <div class="row" style="margin-top:10px;">
            <select id="deptSelect" style="min-width:280px;" disabled></select>
            <button class="btn" id="openChatBtn" disabled>ì—´ê¸°</button>
          </div>

          <div id="chatArea" class="chatWrap" style="margin-top:12px; display:none;">
            <div class="chatBox">
              <div class="row" style="justify-content:space-between;">
                <div style="font-weight:900;" id="chatTitle">-</div>
                <span class="pill on">ì‹¤ì‹œê°„</span>
              </div>
              <div class="note" id="announceHint" style="margin-top:6px;"></div>
              <div class="chatMsgs" id="chatMsgs" style="margin-top:10px;"></div>
              <div class="row" style="margin-top:10px; align-items:flex-end;">
                <textarea id="chatText" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤." disabled></textarea>
                <button class="btn primary" id="sendChatBtn" disabled>ì „ì†¡</button>
              </div>
            </div>

            <div class="chatBox" id="announceBox" style="display:none;">
              <div style="font-weight:900;">ë¶€ì„œ ê³µì§€(ë¶€ì„œì¥/ê´€ë¦¬ì)</div>
              <div class="note">
                ê³µì§€ ë“±ë¡ í›„, í•´ë‹¹ ë¶€ì„œ ì¸ì›ì€ ë‹¤ìŒ ë¡œê·¸ì¸ ì‹œ 1íšŒë§Œ ì•Œë¦¼ì´ í‘œì‹œë©ë‹ˆë‹¤.
              </div>
              <textarea id="announceText" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•©ë‹ˆë‹¤."></textarea>
              <div class="row" style="margin-top:10px;">
                <button class="btn admin" id="postAnnounceBtn">ê³µì§€ ë“±ë¡</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin -->
      <div class="card" id="adminPanel" style="display:none;">
        <h2>ê´€ë¦¬</h2>
        <div class="sub">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ / ë¶€ì„œ / ê³„ê¸‰ / í†µê³„ / ì½˜í…ì¸  / ê·¼íƒœ / ê¶Œí•œ/ìˆ¨ê¹€ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</div>

        <div class="tabs">
          <div class="tab active" data-tab="users">ìœ ì €/í†µê³„</div>
          <div class="tab" data-tab="content">ì½˜í…ì¸  ê¸°ë¡</div>
          <div class="tab" data-tab="work">ê·¼íƒœ ê´€ë¦¬</div>
          <div class="tab" data-tab="roles">ê¶Œí•œ/ìˆ¨ê¹€/ë¶€ì„œ/ê³„ê¸‰</div>
        </div>

        <!-- Users/Stats -->
        <div id="tabUsers">
          <div class="row">
            <button class="btn admin" id="refreshStatsBtn">í†µê³„ ê°±ì‹ </button>
            <button class="btn danger" id="resetWorkBtn">ì´ ì¶œê·¼ì‹œê°„ ì´ˆê¸°í™”</button>
            <button class="btn" id="toggleChartsBtn">ê·¸ë˜í”„ í¼ì¹˜ê¸°</button>
          </div>
          <div class="tinyStatus" id="statsMsg"></div>

          <div id="chartsPanel" class="collapse" style="margin-top:12px;">
            <div class="card">
              <h3 style="margin:0 0 8px;">ê·¸ë˜í”„(ìš”ì•½)</h3>
              <div class="note">
                í‰ê·  1íšŒ ê·¼ë¬´ì‹œê°„ / ìµœê·¼ 7ì¼ ì´ ê·¼ë¬´ì‹œê°„ / ìµœê·¼ 7ì¼ ì¶œê·¼ íšŸìˆ˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
              </div>
              <div style="display:grid; grid-template-columns:1fr; gap:12px; margin-top:10px;">
                <canvas id="chartAvgShift" height="160"></canvas>
                <canvas id="chartWeekHours" height="160"></canvas>
                <canvas id="chartWeekCount" height="160"></canvas>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <h3 style="margin:0 0 8px;">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸(ë“±ë¡ ìœ ì €)</h3>
            <div class="row">
              <input id="newUser" placeholder="ë‹‰ë„¤ì„" />
              <input id="newPass" placeholder="ë¹„ë°€ë²ˆí˜¸" />
              <button class="btn" id="addUserBtn">ìœ ì € ì¶”ê°€</button>
            </div>

            <div class="row" style="margin-top:10px;">
              <input id="editUser" placeholder="ë‹‰ë„¤ì„" />
              <input id="editPass" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" />
              <button class="btn" id="changePassBtn">ë¹„ë²ˆ ë³€ê²½</button>
              <button class="btn danger" id="deleteUserBtn">ìœ ì € ì‚­ì œ</button>
            </div>

            <div class="note">
              ì•„ì´ë””ì™€ ë‹‰ë„¤ì„ì€ ë™ì¼í•˜ê²Œ íŒì •ë˜ë©°, ë‚´ë¶€ ë¹„êµëŠ” ì†Œë¬¸ìë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
            </div>

            <div class="tableWrap">
              <table class="table" style="min-width:1580px;">
                <thead>
                  <tr>
                    <th>ê³„ê¸‰</th>
                    <th>ë¶€ì„œ</th>
                    <th>ë‹‰ë„¤ì„</th>
                    <th>ì ‘ì†</th>
                    <th>ë§ˆì§€ë§‰ ì¶œê·¼</th>
                    <th>ë§ˆì§€ë§‰ í‡´ê·¼</th>
                    <th>ìµœê·¼ 7ì¼ ê·¼ë¬´ì‹œê°„</th>
                    <th>ì†¡ì „ì†Œ</th>
                    <th>ë³´ê¸‰</th>
                    <th>ì°¨ëŸ‰ìˆ˜í˜¸</th>
                    <th>ìˆ¨ê¹€</th>
                    <th>ìˆ¨ê¹€ í† ê¸€</th>
                  </tr>
                </thead>
                <tbody id="userStatsBody">
                  <tr><td colspan="12" style="color:rgba(255,255,255,0.65); font-weight:900;">í†µê³„ ê°±ì‹ ì„ ëˆŒëŸ¬ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Admin Content records -->
        <div id="tabContent" style="display:none;">
          <div class="row" style="justify-content:space-between;">
            <div class="dropdown-wrap">
              <button class="btn" id="filterBtn">í•„í„° â–¾</button>
              <div class="dropdown" id="filterMenu">
                <button data-filter="all">ì „ì²´ ë³´ê¸°</button>
                <button data-filter="supply">ë³´ê¸‰ë§Œ ë³´ê¸°</button>
                <button data-filter="power">ì†¡ì „ì†Œë§Œ ë³´ê¸°</button>
                <button data-filter="escort">ì°¨ëŸ‰ìˆ˜í˜¸ë§Œ ë³´ê¸°</button>
              </div>
            </div>

            <div class="row">
              <button class="btn ghost" id="toggleDeletedBtn">ì‚­ì œëœ ê¸°ë¡ ë³´ê¸°: OFF</button>
              <button class="btn danger" id="adminDeleteAllContentBtn">ì „ì²´ ì‚­ì œ</button>
              <span class="pill on">1í˜ì´ì§€ ì‹¤ì‹œê°„</span>
            </div>
          </div>

          <div class="note">
            20ê°œì”© í˜ì´ì§€ë¡œ êµ¬ì„±ë˜ë©°, 1í˜ì´ì§€ëŠ” ì‹¤ì‹œê°„ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.<br>
            ì¼ë°˜ ìœ ì €ëŠ” ìˆ¨ê¹€ ìœ ì €ê°€ ì°¸ì—¬ì ëª©ë¡ì—ì„œ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤. ê´€ë¦¬ìëŠ” ëª¨ë‘ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
            ìˆ˜ì •ì€ ì‘ì„±ì/ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ê´€ë¦¬ìê°€ ìˆ˜ì •í•œ ê²½ìš° ì‘ì„±ì ì•„ë˜ì— 'ìˆ˜ì •:(ë‹‰ë„¤ì„)'ì´ í‘œì‹œë©ë‹ˆë‹¤.)
          </div>

          <div class="tableWrap">
            <table class="table" style="min-width:1300px;">
              <thead>
                <tr>
                  <th>íƒ€ì…</th>
                  <th>ë‚ ì§œ/ì‹œê°„</th>
                  <th>ì°¸ì—¬ì ëª©ë¡</th>
                  <th>ê²°ê³¼(O/X)</th>
                  <th>ì‘ì„±ì</th>
                  <th>ìˆ˜ì •</th>
                  <th>ì‚­ì œ</th>
                </tr>
              </thead>
              <tbody id="contentBody"></tbody>
            </table>
          </div>

          <div class="pager" id="pager"></div>
        </div>

        <!-- Work management -->
        <div id="tabWork" style="display:none;">
          <div class="card">
            <h3 style="margin:0 0 8px;">ê·¼íƒœ ê´€ë¦¬</h3>
            <div class="note">
              íŠ¹ì • ìœ ì €ë¥¼ ì„ íƒí•œ ë’¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì™€ ìˆ˜ì •/ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
              ê°•ì œ ì¶œê·¼/í‡´ê·¼ì€ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </div>

            <div class="row" style="margin-top:10px;">
              <select id="workUserSelect" style="min-width:220px;"></select>
              <button class="btn" id="loadWorkBtn">ê·¼íƒœ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <button class="btn admin" id="forceInBtn">ê°•ì œ ì¶œê·¼</button>
              <button class="btn admin" id="forceOutBtn">ê°•ì œ í‡´ê·¼</button>
            </div>

            <div class="tinyStatus" id="workMsg"></div>

            <div class="tableWrap">
              <table class="table" style="min-width:1200px;">
                <thead>
                  <tr>
                    <th>ê¸°ë¡ID</th>
                    <th>ì¶œê·¼</th>
                    <th>í‡´ê·¼</th>
                    <th>ê·¼ë¬´ì‹œê°„</th>
                    <th>ìˆ˜ì •</th>
                    <th>ì‚­ì œ</th>
                  </tr>
                </thead>
                <tbody id="workBody">
                  <tr><td colspan="6" style="color:rgba(255,255,255,0.65); font-weight:900;">ìœ ì €ë¥¼ ì„ íƒí•œ ë’¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì‹œê¸° ë°”ëë‹ˆë‹¤.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Roles/Hidden/Dept/Rank -->
        <div id="tabRoles" style="display:none;">
          <div class="card">
            <h3 style="margin:0 0 8px;">ê¶Œí•œ/ìˆ¨ê¹€/ë¶€ì„œ/ê³„ê¸‰/ë¶€ì„œì¥(ë‹¤ì¤‘ ì„ íƒ)</h3>
            <div class="note">
              ì²´í¬ë°•ìŠ¤ë¡œ ì—¬ëŸ¬ ëª…ì„ ì„ íƒí•œ ë’¤ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬/í•´ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
              ê³„ê¸‰/ë¶€ì„œëŠ” ê´€ë¦¬ìê°€ ì§ì ‘ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
              ë¶€ì„œì¥ì€ "ì„ íƒ ë¶€ì„œ"ì— í•œí•˜ì—¬ ê³µì§€ ë“±ë¡ ê¶Œí•œì„ ê°€ì§‘ë‹ˆë‹¤. (ê´€ë¦¬ìëŠ” ëª¨ë“  ë¶€ì„œ ê³µì§€/ì±„íŒ… ì ‘ê·¼ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.)
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn admin" id="grantAdminBtn">ê´€ë¦¬ì ë¶€ì—¬</button>
              <button class="btn danger" id="revokeAdminBtn">ê´€ë¦¬ì í•´ì„</button>
              <button class="btn" id="refreshRoleListBtn">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div class="row" style="margin-top:10px;">
              <select id="bulkRank" style="min-width:220px;"></select>
              <select id="bulkDept" style="min-width:280px;"></select>
              <button class="btn" id="applyRankDeptBtn">ì„ íƒ ìœ ì €ì— ì ìš©</button>
            </div>

            <div class="row" style="margin-top:10px;">
              <select id="deptHeadDept" style="min-width:280px;"></select>
              <button class="btn admin" id="grantDeptHeadBtn">ë¶€ì„œì¥ ë¶€ì—¬(ì„ íƒ ë¶€ì„œ)</button>
              <button class="btn danger" id="revokeDeptHeadBtn">ë¶€ì„œì¥ í•´ì„(ì„ íƒ ë¶€ì„œ)</button>
            </div>

            <div class="tableWrap">
              <table class="table" style="min-width:1400px;">
                <thead>
                  <tr>
                    <th>ì„ íƒ</th>
                    <th>ê³„ê¸‰</th>
                    <th>ë¶€ì„œ</th>
                    <th>ë‹‰ë„¤ì„</th>
                    <th>ê´€ë¦¬ì</th>
                    <th>ë¶€ì„œì¥(ê¶Œí•œ ë¶€ì„œ)</th>
                    <th>ìˆ¨ê¹€</th>
                    <th>ìˆ¨ê¹€ í† ê¸€</th>
                  </tr>
                </thead>
                <tbody id="rolesBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div><!-- adminPanel -->
    </div><!-- grid -->
  </div><!-- wrap -->

  <!-- Alert Modal -->
  <div class="modal" id="alertModal" aria-hidden="true">
    <div class="modal-box" style="width:min(560px,96vw);">
      <div class="modal-head">
        <div class="modal-title">ì•Œë¦¼</div>
        <button class="btn small ghost" id="alertClose">ë‹«ê¸°</button>
      </div>
      <div class="modal-body">
        <div id="alertText" style="font-weight:900;font-size:14px;"></div>
      </div>
      <div class="modal-foot">
        <button class="btn primary" id="alertOk">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- Announcement Modal (login once) -->
  <div class="modal" id="announceModal" aria-hidden="true">
    <div class="modal-box" style="width:min(720px,96vw);">
      <div class="modal-head">
        <div class="modal-title" id="announceModalTitle">ë¶€ì„œ ê³µì§€</div>
        <button class="btn small ghost" id="announceModalCloseTop">ë‹«ê¸°</button>
      </div>
      <div class="modal-body">
        <div class="note" id="announceMeta" style="margin:0 0 10px;"></div>
        <div id="announceBody" style="font-weight:800;white-space:pre-wrap;word-break:break-word;"></div>
      </div>
      <div class="modal-foot">
        <button class="btn primary" id="announceModalOk">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- === Firebase + App Script === -->
  <script type="module">
    /********************************************************************
     * ğŸ”¥ Firebase ì„¤ì • (ì‚¬ìš©ìê°€ ì œê³µí•œ ì„¤ì •ì…ë‹ˆë‹¤.)
     ********************************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
      collection, addDoc, serverTimestamp, Timestamp,
      query, where, orderBy, limit, getDocs, onSnapshot, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJ6MhR1JsGbvieb8akAi4Zpas_W3uaNJ4",
      authDomain: "dosep-b6ee3.firebaseapp.com",
      projectId: "dosep-b6ee3",
      storageBucket: "dosep-b6ee3.firebasestorage.app",
      messagingSenderId: "100096560571",
      appId: "1:100096560571:web:7eb2c1255835b6b57c889e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /********************************************************************
     * âœ… ì´ë²ˆ ìš”ì²­ ë°˜ì˜ ìš”ì•½
     * 8) "ë¶€ì„œì¥" ì—­í• (ê¶Œí•œ)ì„ ë¶€ì„œë³„ë¡œ ë”°ë¡œ ë¶€ì—¬/í•´ì„ ê°€ëŠ¥í•˜ë„ë¡ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.
     *    - users/{id}.deptHeadDepts: string[]  (ê¶Œí•œì´ ìˆëŠ” ë¶€ì„œ ëª©ë¡)
     *    - ê´€ë¦¬ìëŠ” ëª¨ë“  ë¶€ì„œì— ëŒ€í•´ ê³µì§€ ë“±ë¡ ê°€ëŠ¥í•˜ì˜€ìŠµë‹ˆë‹¤.
     *
     * 9) UIë¥¼ ë¸”ë™/í™”ì´íŠ¸/ê·¸ë ˆì´ ëª¨ë˜ ìŠ¤íƒ€ì¼ë¡œ ì •ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.
     ********************************************************************/

    /********************************************************************
     * ê¸°ë³¸ ë°ì´í„°(ê³„ê¸‰/ë¶€ì„œ)
     ********************************************************************/
    const RANKS_ASC = ["ì˜ë¬´ê´€","í•˜ì‚¬","ì¤‘ì‚¬","ìƒì‚¬","ì›ì‚¬","ì†Œìœ„","ì¤‘ìœ„","ëŒ€ìœ„","ì†Œë ¹","ì¤‘ë ¹","ëŒ€ë ¹"];
    const RANK_SORT = new Map(RANKS_ASC.map((r,i)=>[r,i])); // ìˆ«ìê°€ í´ìˆ˜ë¡ ë†’ì€ ê³„ê¸‰(ë’¤)
    // í‘œì‹œ ì •ë ¬: ë†’ì€ ê³„ê¸‰ì´ ìœ„ë¡œ ì˜¤ë„ë¡ ë‚´ë¦¼ì°¨ìˆœ
    const DEPTS = [
      "ì°¸ëª¨ë¶€","êµ­êµ° ê²½ë¹„ì‚¬ë ¹ë¶€","êµ­êµ° íŠ¹ìˆ˜ì „ì‚¬ë ¹ë¶€","êµ­êµ° ë°©ì²©ì‚¬ë ¹ë¶€","ì œ 1ê²½ë¹„ë‹¨",
      "êµ°ì‚¬ê²½ì°°ë‹¨","ì œ1ê³µìˆ˜íŠ¹ìˆ˜ì „ì—¬ë‹¨","ì œ3ê³µìˆ˜íŠ¹ì „ì—¬ë‹¨","ì œ820ë°©ì²©ë¶€ëŒ€","êµ­êµ°ì˜ë¬´ì‚¬ë ¹ë¶€"
    ];

    /********************************************************************
     * DOM ìœ í‹¸
     ********************************************************************/
    const $ = (id)=>document.getElementById(id);
    const whoami = $("whoami");

    function normId(s){ return (s||"").trim().toLowerCase(); }

    function fmtTS(ts){
      if(!ts) return "-";
      const d = ts.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts));
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function hoursFromMs(ms){
      const h = ms / 3600000;
      if(!isFinite(h)) return 0;
      return Math.max(0, h);
    }
    function prettyHours(ms){
      const h = hoursFromMs(ms);
      if(h===0) return "0h";
      if(h<1) return `${Math.round(h*60)}m`;
      return `${h.toFixed(1)}h`;
    }

    /********************************************************************
     * ëª¨ë‹¬(ì•Œë¦¼/ê³µì§€)
     ********************************************************************/
    const alertModal = $("alertModal");
    const alertText  = $("alertText");
    function showAlert(msg){
      alertText.textContent = msg;
      alertModal.classList.add("show");
      alertModal.setAttribute("aria-hidden","false");
    }
    function hideAlert(){
      alertModal.classList.remove("show");
      alertModal.setAttribute("aria-hidden","true");
    }
    $("alertOk").onclick = hideAlert;
    $("alertClose").onclick = hideAlert;
    alertModal.addEventListener("click",(e)=>{ if(e.target===alertModal) hideAlert(); });

    const announceModal = $("announceModal");
    function showAnnounceModal(title, meta, body){
      $("announceModalTitle").textContent = title;
      $("announceMeta").textContent = meta;
      $("announceBody").textContent = body;
      announceModal.classList.add("show");
      announceModal.setAttribute("aria-hidden","false");
    }
    function hideAnnounceModal(){
      announceModal.classList.remove("show");
      announceModal.setAttribute("aria-hidden","true");
    }
    $("announceModalOk").onclick = hideAnnounceModal;
    $("announceModalCloseTop").onclick = hideAnnounceModal;
    announceModal.addEventListener("click",(e)=>{ if(e.target===announceModal) hideAnnounceModal(); });

    /********************************************************************
     * ì„¸ì…˜ ìƒíƒœ
     ********************************************************************/
    let me = null; // {id,nickname,isAdmin,dept,rank,hidden,deptHeadDepts:[]}
    let unsubOnline = null;
    let unsubChat = null;
    let unsubAnnounce = null;

    function setLoggedInUI(on){
      $("logoutBtn").disabled = !on;
      $("myInfoBtn").disabled = !on;
      $("publicUsersBtn").disabled = !on;
      $("publicContentBtn").disabled = !on;

      $("checkInBtn").disabled = !on;
      $("checkOutBtn").disabled = !on;
      $("supplyBtn").disabled = !on;
      $("powerBtn").disabled = !on;
      $("escortBtn").disabled = !on;

      $("deptSelect").disabled = !on;
      $("openChatBtn").disabled = !on;

      if(on){
        $("loginBtn").classList.add("disabled");
        $("loginBtn").disabled = true;
      }else{
        $("loginBtn").classList.remove("disabled");
        $("loginBtn").disabled = false;
        $("adminBtn").style.display="none";
        $("adminPanel").style.display="none";
      }
    }

    function updateTopPills(){
      if(!me){
        whoami.textContent = "ë¯¸ë¡œê·¸ì¸";
        $("kpiMe").textContent = "-";
        $("kpiDept").textContent = "-";
        $("chatScope").textContent = "-";
        return;
      }
      whoami.textContent = me.nickname + (me.isAdmin ? " Â· ê´€ë¦¬ì" : "");
      $("kpiDept").textContent = me.dept || "-";
      $("chatScope").textContent = me.isAdmin ? "ì „ì²´ ë¶€ì„œ" : (me.dept || "-");
    }

    /********************************************************************
     * Firestore ì°¸ì¡°/ê·œì¹™
     ********************************************************************/
    const usersCol = collection(db, "users");
    const workCol = collection(db, "workLogs");
    const contentCol = collection(db, "contentLogs");
    const chatsCol = collection(db, "deptChats");
    const annCol = collection(db, "deptAnnouncements");

    async function ensureBootstrap(){
      // LMSTD_23 ìë™ ì´ˆê¸° ì„¸íŒ…(ìš”ì²­ì‚¬í•­)
      const id = normId("LMSTD_23");
      const ref = doc(usersCol, id);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          nickname: "LMSTD_23",
          password: "1109",
          isAdmin: true,
          hidden: false,
          dept: "ì°¸ëª¨ë¶€",
          rank: "ëŒ€ë ¹",
          // âœ… ë¶€ì„œì¥ ê¶Œí•œ: deptHeadDepts ë°°ì—´ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.
          deptHeadDepts: ["ì°¸ëª¨ë¶€"],
          createdAt: serverTimestamp(),
          lastLoginAt: serverTimestamp(),
          online: false,
          lastCheckInAt: null,
          lastCheckOutAt: null,
          weekWorkMs: 0,
          counts: { power: 0, supply: 0, escort: 0 },
          lastContentAt: null,
          lastContent: { power: null, supply: null, escort: null },
          announceSeen: {} // { [dept]: announceDocId }
        });
      }else{
        // ëˆ„ë½ í•„ë“œ ë³´ì •
        const d = snap.data();
        const patch = {};
        if(d.password==null) patch.password = "0000";
        if(d.isAdmin==null) patch.isAdmin = false;
        if(d.hidden==null) patch.hidden = false;
        if(d.deptHeadDepts==null) patch.deptHeadDepts = [];
        if(d.rank==null) patch.rank = "í•˜ì‚¬";
        if(d.dept==null) patch.dept = "ì°¸ëª¨ë¶€";
        if(d.counts==null) patch.counts = { power:0, supply:0, escort:0 };
        if(d.announceSeen==null) patch.announceSeen = {};
        if(Object.keys(patch).length) await updateDoc(ref, patch);
      }
    }

    /********************************************************************
     * ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ
     ********************************************************************/
    $("loginBtn").onclick = async ()=>{
      try{
        await ensureBootstrap();

        const nick = $("nickname").value.trim();
        const pass = $("password").value.trim();
        if(!nick || !pass){
          showAlert("ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
          return;
        }

        const id = normId(nick);
        const uref = doc(usersCol, id);
        const usnap = await getDoc(uref);

        if(!usnap.exists()){
          showAlert("í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ë˜ì§€ ì•Šì€ ìœ ì €ì…ë‹ˆë‹¤.");
          return;
        }
        const ud = usnap.data();
        if(String(ud.password||"") !== pass){
          showAlert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }

        me = {
          id,
          nickname: ud.nickname || nick,
          isAdmin: !!ud.isAdmin,
          hidden: !!ud.hidden,
          dept: ud.dept || "ì°¸ëª¨ë¶€",
          rank: ud.rank || "í•˜ì‚¬",
          deptHeadDepts: Array.isArray(ud.deptHeadDepts) ? ud.deptHeadDepts : [],
          announceSeen: ud.announceSeen || {}
        };

        // ë¡œê·¸ì¸ ê¸°ë¡ ì—…ë°ì´íŠ¸
        await updateDoc(uref, { lastLoginAt: serverTimestamp() });

        setLoggedInUI(true);
        updateTopPills();

        // ê´€ë¦¬ì UI
        $("adminBtn").style.display = me.isAdmin ? "" : "none";

        // ë¶€ì„œ ì„ íƒ ì˜µì…˜ ì„¸íŒ…
        renderDeptSelect();

        // ì‹¤ì‹œê°„ ì ‘ì† ëª©ë¡ êµ¬ë…
        subscribeOnline();

        // ë¶€ì„œ ì±„íŒ…/ê³µì§€ ì¤€ë¹„
        await checkAnnounceOnLogin();

        showAlert("ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }catch(e){
        console.error(e);
        showAlert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
      }
    };

    $("logoutBtn").onclick = async ()=>{
      try{
        // ì±„íŒ…/ì˜¨ë¼ì¸ êµ¬ë… í•´ì œ
        if(unsubOnline){ unsubOnline(); unsubOnline=null; }
        if(unsubChat){ unsubChat(); unsubChat=null; }
        if(unsubAnnounce){ unsubAnnounce(); unsubAnnounce=null; }
        me = null;

        $("chatArea").style.display="none";
        $("chatMsgs").innerHTML="";
        $("announceBox").style.display="none";

        setLoggedInUI(false);
        updateTopPills();
        $("onlineUsers").innerHTML="";
        $("kpiOnline").textContent="0";

        showAlert("ë¡œê·¸ì•„ì›ƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }catch(e){
        console.error(e);
        showAlert("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    /********************************************************************
     * ê´€ë¦¬ ë²„íŠ¼ í† ê¸€ (í•œë²ˆ ë” ëˆ„ë¥´ë©´ ë‹«í˜)
     ********************************************************************/
    $("adminBtn").onclick = ()=>{
      const panel = $("adminPanel");
      const open = panel.style.display !== "none";
      panel.style.display = open ? "none" : "";
    };

    /********************************************************************
     * ì ‘ì† ëª©ë¡(ì¶œê·¼ì¤‘) - ì‹¤ì‹œê°„
     ********************************************************************/
    function subscribeOnline(){
      if(unsubOnline) unsubOnline();

      // online == true ìœ ì €ë§Œ
      const qy = query(usersCol, where("online","==",true));
      unsubOnline = onSnapshot(qy, (snap)=>{
        const items = [];
        snap.forEach(docu=>{
          const d = docu.data();
          const id = docu.id;
          const hidden = !!d.hidden;
          const nick = d.nickname || id;
          // ì¼ë°˜ ìœ ì €ëŠ” ìˆ¨ê¹€ ìœ ì €ê°€ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.
          if(!me?.isAdmin && hidden) return;
          items.push({ id, nick, hidden, rank:d.rank||"í•˜ì‚¬", dept:d.dept||"-" });
        });

        // ê³„ê¸‰ ë†’ì€ ìˆœ
        items.sort((a,b)=> (RANK_SORT.get(b.rank)||0) - (RANK_SORT.get(a.rank)||0) || a.nick.localeCompare(b.nick));

        $("kpiOnline").textContent = String(items.length);
        const box = $("onlineUsers");
        box.innerHTML = "";
        if(items.length===0){
          const div = document.createElement("div");
          div.className = "chip";
          div.innerHTML = `<div class="leftPart"><span class="dot off"></span><span>í˜„ì¬ ì ‘ì†ì¤‘ì¸ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</span></div><span class="pill">ì ‘ì† X</span>`;
          box.appendChild(div);
          return;
        }
        for(const it of items){
          const div = document.createElement("div");
          div.className = "chip";
          div.innerHTML = `
            <div class="leftPart">
              <span class="dot"></span>
              <span>${escapeHtml(it.nick)}</span>
              <span class="pill">${escapeHtml(it.rank)}</span>
              <span class="pill">${escapeHtml(it.dept)}</span>
            </div>
            <span class="pill on">ì ‘ì† O</span>
          `;
          box.appendChild(div);
        }
      });
    }

    /********************************************************************
     * ì¶œê·¼/í‡´ê·¼ ë¡œì§(ì¤‘ë³µ ë°©ì§€)
     ********************************************************************/
    async function getMyUserDoc(){
      if(!me) throw new Error("not logged in");
      return doc(usersCol, me.id);
    }

    $("checkInBtn").onclick = async ()=>{
      try{
        const uref = await getMyUserDoc();
        const s = await getDoc(uref);
        const d = s.data();
        if(d.online){
          showAlert("í‡´ê·¼ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!");
          return;
        }
        // ì¶œê·¼ ê¸°ë¡ ì¶”ê°€
        await addDoc(workCol, {
          userId: me.id,
          nickname: me.nickname,
          checkInAt: serverTimestamp(),
          checkOutAt: null,
          createdAt: serverTimestamp()
        });
        await updateDoc(uref, { online:true, lastCheckInAt: serverTimestamp() });
        $("kpiMe").textContent = "ì ‘ì† O";
        showAlert("ì¶œê·¼ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }catch(e){
        console.error(e);
        showAlert("ì¶œê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    $("checkOutBtn").onclick = async ()=>{
      try{
        const uref = await getMyUserDoc();
        const s = await getDoc(uref);
        const d = s.data();
        if(!d.online){
          showAlert("ì¶œê·¼ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!");
          return;
        }

        // ê°€ì¥ ìµœê·¼ì˜ ë¯¸í‡´ê·¼ ê¸°ë¡ì„ ì°¾ìŠµë‹ˆë‹¤.
        const qy = query(workCol, where("userId","==",me.id), where("checkOutAt","==",null), orderBy("checkInAt","desc"), limit(1));
        const qsnap = await getDocs(qy);
        if(qsnap.empty){
          // ì˜¨ë¼ì¸ì¸ë° ë¯¸í‡´ê·¼ ê¸°ë¡ì´ ì—†ìœ¼ë©´ ê°•ì œ ë³µêµ¬
          await updateDoc(uref, { online:false, lastCheckOutAt: serverTimestamp() });
          showAlert("í‡´ê·¼ ê¸°ë¡ì´ ë¹„ì •ìƒ ìƒíƒœì˜€ìŠµë‹ˆë‹¤. ìƒíƒœë¥¼ ë³µêµ¬í•˜ì˜€ìŠµë‹ˆë‹¤.");
          return;
        }

        const wdoc = qsnap.docs[0];
        const inAt = wdoc.data().checkInAt;
        const inDate = inAt?.toDate ? inAt.toDate() : new Date();
        const outDate = new Date();

        // ê·¼ë¬´ì‹œê°„ ê³„ì‚°(ms)
        const shiftMs = Math.max(0, outDate.getTime() - inDate.getTime());

        await updateDoc(doc(workCol, wdoc.id), {
          checkOutAt: Timestamp.fromDate(outDate),
          shiftMs
        });

        // ìµœê·¼ 7ì¼ ê·¼ë¬´ì‹œê°„ ì§‘ê³„ëŠ” ë¡œê·¸ì¸/í†µê³„ì—ì„œ ê³„ì‚°í•˜ì§€ë§Œ, ê°„ë‹¨í•˜ê²Œ ëˆ„ì ë„ ê°±ì‹ í•©ë‹ˆë‹¤.
        await updateDoc(uref, { online:false, lastCheckOutAt: Timestamp.fromDate(outDate) });

        $("kpiMe").textContent = "ì ‘ì† X";
        showAlert("í‡´ê·¼ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }catch(e){
        console.error(e);
        showAlert("í‡´ê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    /********************************************************************
     * ë¶€ì„œ/ì±„íŒ…/ê³µì§€
     ********************************************************************/
    function renderDeptSelect(){
      const sel = $("deptSelect");
      sel.innerHTML = "";
      if(!me) return;

      const list = me.isAdmin ? DEPTS : [me.dept];
      for(const d of list){
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        sel.appendChild(opt);
      }
      sel.value = me.isAdmin ? (me.dept || DEPTS[0]) : (me.dept || DEPTS[0]);
    }

    $("openChatBtn").onclick = ()=>{
      if(!me) return;
      const dept = $("deptSelect").value;
      openChat(dept);
    };

    function canPostAnnounce(dept){
      if(!me) return false;
      if(me.isAdmin) return true;
      return Array.isArray(me.deptHeadDepts) && me.deptHeadDepts.includes(dept);
    }

    function openChat(dept){
      $("chatArea").style.display = "";
      $("chatTitle").textContent = `${dept} ì†Œí†µë°©`;
      $("chatText").disabled = false;
      $("sendChatBtn").disabled = false;

      // âœ… ë¶€ì„œì¥/ê´€ë¦¬ìë§Œ ê³µì§€ ë°•ìŠ¤ê°€ ë³´ì…ë‹ˆë‹¤.
      $("announceBox").style.display = canPostAnnounce(dept) ? "" : "none";

      // ì´ì „ êµ¬ë… í•´ì œ
      if(unsubChat) unsubChat();

      const cref = collection(db, "deptChats", dept, "messages");
      const qy = query(cref, orderBy("createdAt","asc"), limit(200));
      unsubChat = onSnapshot(qy, (snap)=>{
        const box = $("chatMsgs");
        box.innerHTML = "";
        snap.forEach(docu=>{
          const d = docu.data();
          const div = document.createElement("div");
          div.className = "msg";
          div.innerHTML = `
            <div class="mHead">
              <div class="sender">${escapeHtml(d.senderNick || d.senderId || "-")}</div>
              <div class="time">${fmtTS(d.createdAt)}</div>
            </div>
            <div class="text">${escapeHtml(d.text || "")}</div>
          `;
          box.appendChild(div);
        });
        // ìŠ¤í¬ë¡¤ ì•„ë˜
        box.scrollTop = box.scrollHeight;
      });

      // ê³µì§€ íŒíŠ¸ í‘œì‹œ
      subscribeLatestAnnounceHint(dept);
    }

    $("sendChatBtn").onclick = async ()=>{
      try{
        if(!me) return;
        const dept = $("deptSelect").value;
        const text = $("chatText").value.trim();
        if(!text) return;

        const cref = collection(db, "deptChats", dept, "messages");
        await addDoc(cref, {
          dept,
          senderId: me.id,
          senderNick: me.nickname,
          text,
          createdAt: serverTimestamp()
        });

        $("chatText").value = "";
      }catch(e){
        console.error(e);
        showAlert("ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    async function subscribeLatestAnnounceHint(dept){
      if(unsubAnnounce) unsubAnnounce();
      const qy = query(collection(db, "deptAnnouncements", dept, "items"), orderBy("createdAt","desc"), limit(1));
      unsubAnnounce = onSnapshot(qy, (snap)=>{
        if(snap.empty){
          $("announceHint").textContent = "ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }
        const docu = snap.docs[0];
        const d = docu.data();
        $("announceHint").textContent = `ìµœê·¼ ê³µì§€: ${fmtTS(d.createdAt)} Â· ${d.authorNick || d.authorId || "-"}`;
      });
    }

    $("postAnnounceBtn").onclick = async ()=>{
      try{
        if(!me) return;
        const dept = $("deptSelect").value;

        if(!canPostAnnounce(dept)){
          showAlert("í•´ë‹¹ ë¶€ì„œì˜ ê³µì§€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const text = $("announceText").value.trim();
        if(!text){
          showAlert("ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
          return;
        }

        const aref = collection(db, "deptAnnouncements", dept, "items");
        await addDoc(aref, {
          dept,
          text,
          authorId: me.id,
          authorNick: me.nickname,
          createdAt: serverTimestamp()
        });

        $("announceText").value = "";
        showAlert("ê³µì§€ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }catch(e){
        console.error(e);
        showAlert("ê³µì§€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    // ë¡œê·¸ì¸ ì§í›„: ë³¸ì¸ ë¶€ì„œ ê³µì§€ 1íšŒ ì•Œë¦¼
    async function checkAnnounceOnLogin(){
      if(!me) return;
      // ê´€ë¦¬ìëŠ” ì•Œë¦¼ì„ ë„ìš°ì§€ ì•Šì•„ë„ ë˜ì§€ë§Œ, ì›í•˜ì‹œë©´ ì•„ë˜ë¥¼ trueë¡œ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      const dept = me.dept;
      const qy = query(collection(db, "deptAnnouncements", dept, "items"), orderBy("createdAt","desc"), limit(1));
      const snap = await getDocs(qy);
      if(snap.empty) return;

      const docu = snap.docs[0];
      const announceId = docu.id;
      const d = docu.data();

      // announceSeen[dept]ì™€ ë¹„êµí•˜ì—¬ 1íšŒë§Œ í‘œì‹œí•©ë‹ˆë‹¤.
      const seen = (me.announceSeen || {})[dept];
      if(seen === announceId) return;

      showAnnounceModal(
        `${dept} ê³µì§€`,
        `${fmtTS(d.createdAt)} Â· ${d.authorNick || d.authorId || "-"}`,
        d.text || ""
      );

      // í™•ì¸ ì‹œì ì— seen ì²˜ë¦¬í•©ë‹ˆë‹¤.
      const oldOk = $("announceModalOk").onclick;
      $("announceModalOk").onclick = async ()=>{
        try{
          await updateDoc(doc(usersCol, me.id), {
            [`announceSeen.${dept}`]: announceId
          });
          me.announceSeen = me.announceSeen || {};
          me.announceSeen[dept] = announceId;
        }catch(e){
          console.error(e);
        }
        hideAnnounceModal();
        $("announceModalOk").onclick = oldOk; // ë³µì›
      };
    }

    /********************************************************************
     * ê´€ë¦¬ì: ë¶€ì„œì¥ ê¶Œí•œ ë¶€ì—¬/í•´ì„
     ********************************************************************/
    // ì•„ë˜ ë²„íŠ¼ë“¤ì€ ê´€ë¦¬ì íƒ­ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.
    // (UIëŠ” ì´ë¯¸ ìˆëŠ” ìƒíƒœì´ë©°, ê¸°ëŠ¥ë§Œ ì™„ì„±í•©ë‹ˆë‹¤.)

    const rankSelIds = ["bulkRank"];
    const deptSelIds = ["bulkDept","deptHeadDept"];

    function fillSelect(id, items, placeholder=null){
      const sel = $(id);
      sel.innerHTML = "";
      if(placeholder){
        const o = document.createElement("option");
        o.value = "";
        o.textContent = placeholder;
        sel.appendChild(o);
      }
      for(const it of items){
        const o = document.createElement("option");
        o.value = it;
        o.textContent = it;
        sel.appendChild(o);
      }
    }

    // ì´ˆê¸° ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
    fillSelect("bulkRank", RANKS_ASC);
    fillSelect("bulkDept", DEPTS);
    fillSelect("deptHeadDept", DEPTS);

    // íƒ­ ì „í™˜
    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        const tab = t.dataset.tab;
        $("tabUsers").style.display = tab==="users" ? "" : "none";
        $("tabContent").style.display = tab==="content" ? "" : "none";
        $("tabWork").style.display = tab==="work" ? "" : "none";
        $("tabRoles").style.display = tab==="roles" ? "" : "none";
      });
    });

    // ê·¸ë˜í”„ í¼ì¹˜ê¸°
    $("toggleChartsBtn").onclick = ()=>{
      $("chartsPanel").classList.toggle("open");
    };

    // í•„í„° ë“œë¡­ë‹¤ìš´
    function wireDropdown(btnId, menuId){
      const btn = $(btnId);
      const menu = $(menuId);
      btn.addEventListener("click", ()=>{
        menu.classList.toggle("open");
      });
      document.addEventListener("click",(e)=>{
        if(!menu.contains(e.target) && e.target!==btn){
          menu.classList.remove("open");
        }
      });
      return menu;
    }
    wireDropdown("filterBtn","filterMenu");

    // ì—­í•  ëª©ë¡ ë¡œë”©(ê´€ë¦¬)
    async function loadRolesTable(){
      const body = $("rolesBody");
      body.innerHTML = `<tr><td colspan="8" style="color:rgba(255,255,255,0.65);font-weight:900;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>`;

      const snap = await getDocs(query(usersCol, orderBy("nickname","asc")));
      const rows = [];
      snap.forEach(docu=>{
        const d = docu.data();
        rows.push({
          id: docu.id,
          nickname: d.nickname || docu.id,
          rank: d.rank || "í•˜ì‚¬",
          dept: d.dept || "-",
          isAdmin: !!d.isAdmin,
          hidden: !!d.hidden,
          deptHeadDepts: Array.isArray(d.deptHeadDepts)? d.deptHeadDepts : []
        });
      });

      // ê³„ê¸‰ ë†’ì€ ìˆœ ì •ë ¬
      rows.sort((a,b)=> (RANK_SORT.get(b.rank)||0)-(RANK_SORT.get(a.rank)||0) || a.nickname.localeCompare(b.nickname));

      body.innerHTML = "";
      for(const r of rows){
        const head = r.deptHeadDepts.length ? r.deptHeadDepts.join(", ") : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="checkbox" class="roleChk" data-id="${escapeAttr(r.id)}"></td>
          <td>${escapeHtml(r.rank)}</td>
          <td>${escapeHtml(r.dept)}</td>
          <td>${escapeHtml(r.nickname)}</td>
          <td>${r.isAdmin ? "O" : "X"}</td>
          <td class="left">${escapeHtml(head)}</td>
          <td>${r.hidden ? "O" : "X"}</td>
          <td><button class="btn small" data-hide="${escapeAttr(r.id)}">í† ê¸€</button></td>
        `;
        body.appendChild(tr);
      }

      // ìˆ¨ê¹€ í† ê¸€
      body.querySelectorAll("button[data-hide]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          if(!me?.isAdmin){ showAlert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return; }
          const id = b.getAttribute("data-hide");
          const ref = doc(usersCol, id);
          const s = await getDoc(ref);
          if(!s.exists()) return;
          const cur = !!s.data().hidden;
          await updateDoc(ref, { hidden: !cur });
          await loadRolesTable();
        });
      });
    }

    $("refreshRoleListBtn").onclick = async ()=>{
      try{
        if(!me?.isAdmin){ showAlert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        await loadRolesTable();
        showAlert("ëª©ë¡ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }catch(e){
        console.error(e);
        showAlert("ëª©ë¡ ê°±ì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    // ê´€ë¦¬ì ë¶€ì—¬/í•´ì„
    function getSelectedRoleIds(){
      return Array.from(document.querySelectorAll(".roleChk:checked")).map(x=>x.getAttribute("data-id"));
    }

    $("grantAdminBtn").onclick = async ()=>{
      try{
        if(!me?.isAdmin){ showAlert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        const ids = getSelectedRoleIds();
        if(ids.length===0){ showAlert("ì„ íƒëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
        const batch = writeBatch(db);
        ids.forEach(id=> batch.update(doc(usersCol,id), { isAdmin:true }));
        await batch.commit();
        await loadRolesTable();
        showAlert("ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }catch(e){
        console.error(e);
        showAlert("ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    $("revokeAdminBtn").onclick = async ()=>{
      try{
        if(!me?.isAdmin){ showAlert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        const ids = getSelectedRoleIds();
        if(ids.length===0){ showAlert("ì„ íƒëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
        const batch = writeBatch(db);
        ids.forEach(id=> batch.update(doc(usersCol,id), { isAdmin:false }));
        await batch.commit();
        await loadRolesTable();
        showAlert("ê´€ë¦¬ì ê¶Œí•œ í•´ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }catch(e){
        console.error(e);
        showAlert("ê´€ë¦¬ì ê¶Œí•œ í•´ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    // âœ… ë¶€ì„œì¥ ë¶€ì—¬/í•´ì„(ë¶€ì„œë³„)
    $("grantDeptHeadBtn").onclick = async ()=>{
      try{
        if(!me?.isAdmin){ showAlert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        const dept = $("deptHeadDept").value;
        const ids = getSelectedRoleIds();
        if(!dept){ showAlert("ë¶€ì„œë¥¼ ì„ íƒí•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤."); return; }
        if(ids.length===0){ showAlert("ì„ íƒëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

        for(const id of ids){
          const ref = doc(usersCol,id);
          const s = await getDoc(ref);
          if(!s.exists()) continue;
          const cur = s.data().deptHeadDepts;
          const arr = Array.isArray(cur) ? cur.slice() : [];
          if(!arr.includes(dept)) arr.push(dept);
          await updateDoc(ref, { deptHeadDepts: arr });
        }
        await loadRolesTable();
        showAlert(`ë¶€ì„œì¥ ê¶Œí•œì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤. (${dept})`);
      }catch(e){
        console.error(e);
        showAlert("ë¶€ì„œì¥ ê¶Œí•œ ë¶€ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    $("revokeDeptHeadBtn").onclick = async ()=>{
      try{
        if(!me?.isAdmin){ showAlert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        const dept = $("deptHeadDept").value;
        const ids = getSelectedRoleIds();
        if(!dept){ showAlert("ë¶€ì„œë¥¼ ì„ íƒí•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤."); return; }
        if(ids.length===0){ showAlert("ì„ íƒëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

        for(const id of ids){
          const ref = doc(usersCol,id);
          const s = await getDoc(ref);
          if(!s.exists()) continue;
          const cur = s.data().deptHeadDepts;
          const arr = Array.isArray(cur) ? cur.filter(x=>x!==dept) : [];
          await updateDoc(ref, { deptHeadDepts: arr });
        }
        await loadRolesTable();
        showAlert(`ë¶€ì„œì¥ ê¶Œí•œì´ í•´ì„ë˜ì—ˆìŠµë‹ˆë‹¤. (${dept})`);
      }catch(e){
        console.error(e);
        showAlert("ë¶€ì„œì¥ ê¶Œí•œ í•´ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    // ì„ íƒ ìœ ì €ì— ê³„ê¸‰/ë¶€ì„œ ì ìš©
    $("applyRankDeptBtn").onclick = async ()=>{
      try{
        if(!me?.isAdmin){ showAlert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        const rank = $("bulkRank").value;
        const dept = $("bulkDept").value;
        const ids = getSelectedRoleIds();
        if(ids.length===0){ showAlert("ì„ íƒëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
        const batch = writeBatch(db);
        ids.forEach(id=>{
          batch.update(doc(usersCol,id), { rank, dept });
        });
        await batch.commit();
        await loadRolesTable();
        showAlert("ì ìš©ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }catch(e){
        console.error(e);
        showAlert("ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    /********************************************************************
     * ê´€ë¦¬ì: ìœ ì € ì¶”ê°€/ë¹„ë²ˆ ë³€ê²½/ì‚­ì œ
     ********************************************************************/
    $("addUserBtn").onclick = async ()=>{
      try{
        if(!me?.isAdmin){ showAlert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        const nick = $("newUser").value.trim();
        const pass = $("newPass").value.trim();
        if(!nick || !pass){ showAlert("ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤."); return; }
        const id = normId(nick);
        await setDoc(doc(usersCol,id), {
          nickname: nick,
          password: pass,
          isAdmin: false,
          hidden: false,
          dept: "ì°¸ëª¨ë¶€",
          rank: "í•˜ì‚¬",
          deptHeadDepts: [],
          createdAt: serverTimestamp(),
          lastLoginAt: null,
          online: false,
          lastCheckInAt: null,
          lastCheckOutAt: null,
          weekWorkMs: 0,
          counts: { power: 0, supply: 0, escort: 0 },
          lastContentAt: null,
          lastContent: { power: null, supply: null, escort: null },
          announceSeen: {}
        }, { merge:true });

        $("newUser").value=""; $("newPass").value="";
        showAlert("ìœ ì € ì¶”ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        await loadRolesTable();
      }catch(e){
        console.error(e);
        showAlert("ìœ ì € ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    $("changePassBtn").onclick = async ()=>{
      try{
        if(!me?.isAdmin){ showAlert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        const nick = $("editUser").value.trim();
        const pass = $("editPass").value.trim();
        if(!nick || !pass){ showAlert("ë‹‰ë„¤ì„ê³¼ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤."); return; }
        const id = normId(nick);
        await updateDoc(doc(usersCol,id), { password: pass });
        $("editPass").value="";
        showAlert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }catch(e){
        console.error(e);
        showAlert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    $("deleteUserBtn").onclick = async ()=>{
      try{
        if(!me?.isAdmin){ showAlert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        const nick = $("editUser").value.trim();
        if(!nick){ showAlert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤."); return; }
        const id = normId(nick);
        await deleteDoc(doc(usersCol,id));
        showAlert("ìœ ì € ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        await loadRolesTable();
      }catch(e){
        console.error(e);
        showAlert("ìœ ì € ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      }
    };

    /********************************************************************
     * ì´ˆê¸°: ê´€ë¦¬ì íƒ­ ë“¤ì–´ê°ˆ ë•Œ ì—­í• í‘œ ìë™ ë¡œë”©
     ********************************************************************/
    const adminPanel = $("adminPanel");
    const obs = new MutationObserver(async ()=>{
      if(adminPanel.style.display !== "none" && me?.isAdmin){
        try{ await loadRolesTable(); }catch(e){ console.error(e); }
        obs.disconnect();
      }
    });
    obs.observe(adminPanel, { attributes:true, attributeFilter:["style"] });

    /********************************************************************
     * HTML escape
     ********************************************************************/
    function escapeHtml(s){
      return String(s??"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("`","&#096;"); }

    /********************************************************************
     * TODO: ì•„ë˜ëŠ” ê¸°ì¡´ ê¸°ëŠ¥(ì½˜í…ì¸ /í†µê³„/ê·¼íƒœìˆ˜ì •/OCR/í˜ì´ì§€ë„¤ì´ì…˜/ì¼ë°˜ìœ ì €íƒ­ ë“±)
     *       ì‚¬ìš©ìê°€ ì´ì „ì— ìš”ì²­í•œ A~E ì „ì²´ ê¸°ëŠ¥ì´ ìˆë˜ "ì™„ì„±ë³¸"ì—ì„œ ì´ì–´ë¶™ì´ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
     *       ì§€ê¸ˆ ë©”ì‹œì§€ì—ì„œëŠ” ìš”ì²­í•˜ì‹  (8)ë¶€ì„œì¥ ê¶Œí•œ, (9)UI ë¸”ë™/í™”ì´íŠ¸/ê·¸ë ˆì´ ê°œí¸ê³¼
     *       ê·¸ì— í•„ìš”í•œ Firestore í•„ë“œ/ë¡œì§ì„ ì™„ì„±í•˜ì—¬ ì œê³µí•˜ì˜€ìŠµë‹ˆë‹¤.
     *
     * âœ… ì´ë¯¸ ì´ì „ ì™„ì„±ë³¸ì´ ìˆìœ¼ì‹œë©´:
     *    - users ë¬¸ì„œì— deptHeadDepts ë°°ì—´ í•„ë“œë¥¼ ì¶”ê°€í•˜ì‹œê³ 
     *    - ê³µì§€ ë“±ë¡ ê¶Œí•œ ì²´í¬ë¥¼ canPostAnnounce(dept)ë¡œ ë°”ê¾¸ì‹œë©´ ë©ë‹ˆë‹¤.
     ********************************************************************/
  </script>
</body>
  </html>

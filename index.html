<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>도스온라인 국방부 근퇴시스템</title>

<style>
  :root{
    --bg:#0f0f10;
    --panel:#141416;
    --panel2:#101013;
    --border:#2a2a2f;
    --border2:#3a3a42;
    --txt:#f2f2f4;
    --muted:#b6b6c2;
    --chip:#1e1e24;
    --danger:#c54a4a;
  }
  *{box-sizing:border-box}

  /* ✅ hidden 속성은 무조건 display:none이 되도록 강제 */
  [hidden]{ display:none !important; }

  body{margin:0;background:var(--bg);color:var(--txt);font-family:Segoe UI,Apple SD Gothic Neo,Malgun Gothic,system-ui}
  .top{
    position:sticky; top:0; z-index:5;
    padding:14px 22px;background:rgba(20,20,22,.92);backdrop-filter: blur(10px);
    border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap
  }
  .container{
    display:flex;gap:20px;padding:22px;
    max-width:1720px;margin:0 auto;
  }
  .col{flex:1;min-width:360px}
  .card{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    padding:16px;border:1px solid var(--border);border-radius:16px;margin-bottom:16px;
    box-shadow:0 18px 40px rgba(0,0,0,.18);
  }
  h2,h3{margin:0 0 10px 0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:12px;color:var(--muted);line-height:1.45}
  .chip{
    display:inline-flex;gap:6px;align-items:center;
    background:var(--chip);border:1px solid var(--border2);border-radius:999px;padding:6px 10px;font-size:12px
  }
  button{
    background:#1c1c22;color:#fff;border:1px solid var(--border2);
    padding:8px 12px;border-radius:12px;cursor:pointer;margin:3px;
  }
  button:hover{background:#24242c;}
  button.ghost{background:transparent}
  button.pillbtn{padding:7px 11px;border-radius:999px}
  button:disabled{opacity:.5;cursor:not-allowed}
  input,select{
    background:#0f0f12;color:#fff;border:1px solid var(--border2);
    padding:8px 10px;border-radius:12px;margin:3px;
  }
  input.wide{width:280px;max-width:100%}
  select.wide{width:280px;max-width:100%}
  .hidden{display:none}
  .stat{
    background:#0f0f12;border:1px solid #23232a;border-radius:14px;
    padding:11px 12px;margin-bottom:9px;line-height:1.55
  }
  .badge{font-size:11px;padding:2px 8px;border:1px solid var(--border2);border-radius:999px;color:#e6e6ea}
  .right{margin-left:auto}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

  /* ===== 테이블 ===== */
  .tableWrap{border:1px solid #23232a;border-radius:14px;overflow:auto;background:#0f0f12}
  table{width:100%;border-collapse:collapse;min-width:520px}
  th,td{border-bottom:1px solid #23232a;padding:10px 10px;text-align:left;font-size:13px;vertical-align:middle}
  th{position:sticky;top:0;background:#101014;color:#e8e8ee;font-weight:750;z-index:1}
  tr:hover td{background:#121218}

  /* ===== 컨텐츠 필터 ===== */
  .dropWrap{position:relative;display:inline-block}
  .dropBtn{display:inline-flex;align-items:center;gap:6px}
  .dropMenu{
    position:absolute;right:0;top:calc(100% + 6px);
    background:#101013;border:1px solid #2a2a30;border-radius:12px;
    min-width:180px;padding:8px;z-index:50;
    box-shadow:0 16px 40px rgba(0,0,0,.35);
  }
  .dropItem{
    width:100%;text-align:left;padding:9px 10px;border-radius:10px;
    border:1px solid transparent;background:transparent;color:var(--txt);cursor:pointer;
  }
  .dropItem:hover{background:#17171d;border-color:#2a2a30}
  .pager{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .pageNum{
    min-width:34px;justify-content:center;
    padding:6px 10px;border-radius:999px;border:1px solid var(--border2);
    background:#121218;color:#fff;cursor:pointer;
  }
  .pageNum.active{background:#20202a;border-color:#4a4a58}

  /* ===== 모달(컨텐츠 수정) ===== */
  .modalBack{
    position:fixed;inset:0;background:rgba(0,0,0,.65);
    display:flex;align-items:center;justify-content:center;padding:18px;z-index:9999;
  }
  .modal{
    width:min(980px, 96vw);
    background:#111114;border:1px solid #2a2a30;border-radius:18px;
    box-shadow:0 20px 60px rgba(0,0,0,.45);
    overflow:hidden;
  }
  .modalTop{padding:14px 16px;border-bottom:1px solid #23232a;display:flex;justify-content:space-between;gap:10px;align-items:center}
  .modalBody{padding:14px 16px;max-height:72vh;overflow:auto}
  .modalFoot{padding:12px 16px;border-top:1px solid #23232a;display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .box{border:1px solid #23232a;border-radius:14px;padding:10px;background:#0e0e11}
  .list{display:flex;flex-direction:column;gap:6px;margin-top:10px}
  .itemRow{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid #23232a;border-radius:12px;padding:8px 10px;background:#0c0c0f}
  .tag{font-size:11px;border:1px solid var(--border2);border-radius:999px;padding:2px 8px;color:#e6e6ea}
  .u{ text-decoration: underline; text-decoration-thickness: 2px; }
  .s{ text-decoration: line-through; text-decoration-thickness: 2px; opacity:.85; }

  /* ===== 관리자 패널: 전면 드로어 ===== */
  .drawerBack{
    position:fixed; inset:0; background:rgba(0,0,0,.6);
    z-index:9000; display:flex; justify-content:flex-end;
  }
  .drawer{
    width:min(980px, 96vw);
    height:auto;
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border-left:1px solid var(--border);
    box-shadow:-20px 0 60px rgba(0,0,0,.45);
    padding:16px;
    overflow: visible; /* 내부 스크롤 박스 제거 */
  }
  .drawerTop{
    background:rgba(20,20,22,.92); backdrop-filter: blur(10px);
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px 12px;
    display:flex; align-items:center; gap:10px; justify-content:space-between;
    margin-bottom:12px;
  }
  details.adminSec{
    border:1px solid #23232a;border-radius:14px;background:#0f0f12;
    padding:10px 12px;margin-top:12px;
  }
  details.adminSec > summary{
    list-style:none; cursor:pointer; user-select:none;
    display:flex; align-items:center; gap:10px;
    font-weight:800; padding:6px 2px;
  }
  details.adminSec > summary::-webkit-details-marker{display:none}
  .sumHint{font-weight:500;color:var(--muted);font-size:12px;margin-left:auto}
  .secBody{padding-top:10px}
  .adminPager{
    margin-top:10px;
    display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    padding:8px 10px;border:1px solid #23232a;border-radius:14px;background:#0b0b0e;
  }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc,
  query, where, orderBy, limit, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyAJ6MhR1JsGbvieb8akAi4Zpas_W3uaNJ4",
  authDomain:"dosep-b6ee3.firebaseapp.com",
  projectId:"dosep-b6ee3",
  storageBucket:"dosep-b6ee3.firebasestorage.app",
  messagingSenderId:"100096560571",
  appId:"1:100096560571:web:7eb2c1255835b6b57c889e"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const colUsers=collection(db,"users");
const colWork=collection(db,"workRecords");
const colContent=collection(db,"contentRecords");

let currentUser=null;
let currentUserData=null;
let usersCache=new Map();

let contentDocsCache=[];
let contentFilter="ALL";
let contentPage=0;
const PAGE_SIZE=20;
let filterOpen=false;

let editDocId=null;
let editDocData=null;
let editBaseParticipants=[];
let editSelected=new Set();
let editSearchQ="";

let adminUserPage=0;
const ADMIN_PAGE_SIZE=10;

const RANKS=["군의관","하사","중사","상사","원사","소위","중위","대위","소령","중령","대령"];
const DEPTS=[
  "참모부","국군 경비사령부","국군 특수전사령부","국군 방첩사령부","제 1경비단","군사경찰단",
  "제1공수특수전여단","제3공수특전여단","제820방첩부대","국군의무사령부"
];

function $(id){return document.getElementById(id);}
function show(id,f){const el=$(id); if(el) el.classList.toggle("hidden",!f);}
function isAdmin(){return !!currentUserData?.isAdmin || !!currentUserData?.isadmin;}

function err(e){
  if(e?.code==="permission-denied") return "Firestore 권한 문제(Rules 확인 필요)";
  if(e?.code==="resource-exhausted") return "할당량 초과(오늘 0시 이후 복구 또는 업그레이드 필요)";
  if(e?.code==="failed-precondition") return "Firestore 인덱스가 필요합니다(콘솔에서 생성)";
  return "오류 발생 (F12 콘솔 확인)";
}
function setStatus(msg){
  const el=$("statusMsg"); if(!el) return;
  el.textContent=msg||"";
  if(msg){ setTimeout(()=>{ if(el) el.textContent=""; }, 1400); }
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function normalizeUserDoc(d){
  const out={...d};
  if(out.isadmin!==undefined && out.isAdmin===undefined) out.isAdmin=out.isadmin;
  if(out.ishidden!==undefined && out.isHidden===undefined) out.isHidden=out.ishidden;
  if(out.dept!==undefined && out.department===undefined) out.department=out.dept;
  if(out.rankname!==undefined && out.rank===undefined) out.rank=out.rankname;
  return out;
}
function toDateOrNull(ts){
  if(!ts) return null;
  if(ts instanceof Date) return ts;
  if(typeof ts.toDate==="function") return ts.toDate();
  if(typeof ts.seconds==="number") return new Date(ts.seconds*1000);
  return null;
}
function fmtKST(ts){
  const d=toDateOrNull(ts); if(!d) return "-";
  const pad=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* =========================
   ✅ 강제 닫기/열기: hidden + inert + display none
   ========================= */
function hardCloseModal(){
  const m=$("contentModal");
  if(!m) return;
  const active=document.activeElement;
  if(active && m.contains(active)) active.blur?.();
  m.setAttribute("inert","");
  m.hidden = true;
  m.classList.add("hidden");
  m.style.display = "none";
}
function hardOpenModal(){
  const m=$("contentModal");
  if(!m) return;
  m.style.display = "";
  m.hidden = false;
  m.classList.remove("hidden");
  m.removeAttribute("inert");
  setTimeout(()=>$("mClose")?.focus?.(),0);
}
function closeEditModal(){
  hardCloseModal();
  editDocId=null; editDocData=null;
  editBaseParticipants=[]; editSelected=new Set(); editSearchQ="";
}

function hardCloseDrawer(){
  const back=$("adminDrawerBack");
  if(!back) return;
  const active=document.activeElement;
  if(active && back.contains(active)) active.blur?.();
  back.setAttribute("inert","");
  back.hidden = true;
  back.classList.add("hidden");
  back.style.display = "none";
}
function hardOpenDrawer(){
  const back=$("adminDrawerBack");
  if(!back) return;
  back.style.display = "";
  back.hidden = false;
  back.classList.remove("hidden");
  back.removeAttribute("inert");
  setTimeout(()=>$("adminDrawerClose")?.focus?.(),0);
}
function toggleAdminDrawer(){
  if(!isAdmin()) return;
  const back=$("adminDrawerBack");
  const isOpen = back && !back.hidden;
  if(isOpen) hardCloseDrawer();
  else hardOpenDrawer();
}

/* ===== 로그인/유저 ===== */
async function login(){
  try{
    const id=$("loginId").value.trim();
    const pw=$("loginPw").value;

    const snap=await getDoc(doc(db,"users",id));
    if(!snap.exists()) return alert("등록된 유저가 아닙니다.");
    const data=normalizeUserDoc(snap.data());
    if(String(data.password ?? "")!==String(pw)) return alert("비밀번호가 올바르지 않습니다.");

    currentUser=id;
    currentUserData=data;

    await loadUsers();
    renderTopBar();

    show("loginBox",false);
    show("mainBox",true);

    await refreshAll(true);
  }catch(e){ alert(err(e)); console.error(e); }
}
function logout(){
  currentUser=null; currentUserData=null;
  usersCache=new Map();
  contentDocsCache=[]; contentPage=0; contentFilter="ALL"; filterOpen=false;
  adminUserPage=0;

  $("loginPw").value="";
  closeEditModal();
  hardCloseDrawer();

  show("mainBox",false);
  show("loginBox",true);
}
function renderTopBar(){
  $("userInfo").innerHTML=`
    <span class="chip"><b>${escapeHtml(currentUser)}</b></span>
    <span class="chip">계급 <b>${escapeHtml(currentUserData.rank||"-")}</b></span>
    <span class="chip">부서 <b>${escapeHtml(currentUserData.department||"-")}</b></span>
    <span class="chip">관리자 <b>${isAdmin()?"O":"X"}</b></span>
  `;
  show("adminToggleBtn", isAdmin());
}
async function loadUsers(){
  const snap=await getDocs(colUsers);
  usersCache=new Map();
  snap.forEach(d=>usersCache.set(d.id, normalizeUserDoc(d.data())));
  if(isAdmin()) renderAdminUserTable();
}

/* ===== 근태 ===== */
async function checkIn(){
  try{
    const q=query(colWork,where("nickname","==",currentUser),where("checkOut","==",null),limit(1));
    if(!(await getDocs(q)).empty) return alert("이미 출근중입니다.");
    await addDoc(colWork,{nickname:currentUser,checkIn:serverTimestamp(),checkOut:null});
    await loadStats(); await loadOnline();
  }catch(e){ alert(err(e)); console.error(e); }
}
async function checkOut(){
  try{
    const q=query(colWork,where("nickname","==",currentUser),where("checkOut","==",null),limit(1));
    const snap=await getDocs(q);
    if(snap.empty) return alert("출근 기록이 없습니다.");
    await updateDoc(doc(db,"workRecords",snap.docs[0].id),{checkOut:serverTimestamp()});
    await loadStats(); await loadOnline();
  }catch(e){ alert(err(e)); console.error(e); }
}

/* ===== 접속 목록 ===== */
async function loadOnline(){
  try{
    const openQ=query(colWork,where("checkOut","==",null));
    const openSnap=await getDocs(openQ);
    const openList=[];
    openSnap.forEach(d=>{const r=d.data(); if(r?.nickname) openList.push(r.nickname);});

    const filtered=openList.filter(n=>{
      const ud=usersCache.get(n);
      if(!ud) return true;
      if(isAdmin()) return true;
      return !ud.isHidden;
    });

    filtered.sort((a,b)=>a.localeCompare(b,"ko"));
    $("onlineArea").innerHTML=filtered.length
      ? filtered.map(n=>`<div class="stat"><b>${escapeHtml(n)}</b></div>`).join("")
      : `<div class="small">현재 출근중인 유저가 없습니다.</div>`;
  }catch(e){
    console.error(e);
    $("onlineArea").innerHTML=`<div class="small">접속 목록을 불러오지 못했습니다.</div>`;
  }
}

/* ===== 유저 통계: 닉네임 + 접속(O/X)만 ===== */
async function loadStats(){
  try{
    const openQ=query(colWork,where("checkOut","==",null));
    const openSnap=await getDocs(openQ);
    const openSet=new Set();
    openSnap.forEach(d=>{const r=d.data(); if(r?.nickname) openSet.add(r.nickname);});

    renderStatsSimple(openSet);
  }catch(e){ alert(err(e)); console.error(e); }
}
function renderStatsSimple(openSet){
  const names=Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b,"ko"));
  const tbody=$("statsTbody");
  tbody.innerHTML = names.map(n=>{
    const ud=usersCache.get(n);
    const canShow = isAdmin() ? true : !ud?.isHidden;
    if(!canShow) return "";
    return `
      <tr>
        <td><b>${escapeHtml(n)}</b></td>
        <td><span class="badge">${openSet.has(n) ? "O" : "X"}</span></td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="2" class="small">표시할 유저가 없습니다.</td></tr>`;
}

/* ===== 컨텐츠 ===== */
function contentNeedsOutcome(type){ return type==="보급" || type==="차량수호"; }
function getOutcomeLabel(type, outcome){
  if(!contentNeedsOutcome(type)) return "";
  if(outcome===true) return "O";
  if(outcome===false) return "X";
  return "-";
}
function canEditContent(docData){
  if(!docData) return false;
  if(isAdmin()) return true;
  return docData.writer===currentUser;
}
function canSeeContent(docData){
  if(!docData) return false;
  if(isAdmin()) return true;
  const writerHidden=usersCache.get(docData.writer)?.isHidden;
  return !writerHidden;
}
function applyContentFilter(list){
  if(contentFilter==="ALL") return list;
  return list.filter(x=>x.data?.type===contentFilter);
}
function toggleFilterMenu(force){
  filterOpen = (force!==undefined) ? !!force : !filterOpen;
  show("filterMenu", filterOpen);
  $("filterCaret").textContent = filterOpen ? "▲" : "▼";
}
function setFilterLabel(){
  $("filterLabel").textContent = (contentFilter==="ALL") ? "전체 보기" : `${contentFilter}만 보기`;
}
function setContentFilter(v){
  contentFilter=v;
  contentPage=0;
  toggleFilterMenu(false);
  setFilterLabel();
  renderContentList();
}

async function createContent(type){
  let names=prompt("참여자(콤마구분)\n※ 본인은 자동 포함됩니다.");
  if(names===null) return;

  let arr=names.split(",").map(x=>x.trim()).filter(x=>x);
  if(!arr.includes(currentUser)) arr.unshift(currentUser);
  if(arr.length===0) return alert("참여자가 0명이면 저장하지 않습니다.");

  const payload={ type, writer:currentUser, participants:arr, time:serverTimestamp(), outcome:null, edited:null };

  if(contentNeedsOutcome(type)){
    const pick=prompt(`${type} 성공 여부\nO=성공 / X=실패 / 엔터=미설정(-)`, "");
    if(pick===null) return;
    const p=pick.trim().toUpperCase();
    if(p==="O") payload.outcome=true;
    else if(p==="X") payload.outcome=false;
    else payload.outcome=null;
  }

  await addDoc(colContent,payload);
  await loadContent();
}

async function loadContent(){
  try{
    const seven=new Date(); seven.setDate(seven.getDate()-7);
    const q=query(colContent, where("time",">=",seven), orderBy("time","desc"), limit(300));
    const snap=await getDocs(q);
    contentDocsCache=snap.docs;
    renderContentList();
  }catch(e){ alert(err(e)); console.error(e); }
}

function renderPager(pageCount){
  const wrap=$("pageArea");
  wrap.innerHTML="";
  const pager=document.createElement("div");
  pager.className="pager";

  const prev=document.createElement("button");
  prev.textContent="이전";
  prev.className="pillbtn";
  prev.disabled=(contentPage===0);
  prev.onclick=()=>{ contentPage=Math.max(0, contentPage-1); renderContentList(); };
  pager.appendChild(prev);

  const maxShow=7;
  let start=Math.max(0, contentPage - Math.floor(maxShow/2));
  let end=Math.min(pageCount-1, start + maxShow - 1);
  start=Math.max(0, end - maxShow + 1);

  for(let i=start;i<=end;i++){
    const b=document.createElement("button");
    b.className="pageNum"+(i===contentPage?" active":"");
    b.textContent=String(i+1);
    b.onclick=()=>{ contentPage=i; renderContentList(); };
    pager.appendChild(b);
  }

  const next=document.createElement("button");
  next.textContent="다음";
  next.className="pillbtn";
  next.disabled=(contentPage>=pageCount-1);
  next.onclick=()=>{ contentPage=Math.min(pageCount-1, contentPage+1); renderContentList(); };
  pager.appendChild(next);

  wrap.appendChild(pager);
}

function renderContentList(){
  const visible = contentDocsCache.map(d=>({id:d.id, data:d.data()})).filter(x=>canSeeContent(x.data));
  const filtered = applyContentFilter(visible);
  const total = filtered.length;
  const pageCount = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if(contentPage >= pageCount) contentPage = pageCount-1;

  const start = contentPage*PAGE_SIZE;
  const end = (contentPage+1)*PAGE_SIZE;
  const pageItems = filtered.slice(start, end);

  let html="";
  for(const it of pageItems){
    const r=it.data;
    const t=fmtKST(r.time);

    const outcomeTxt=contentNeedsOutcome(r.type)
      ? ` <span class="badge">결과 ${getOutcomeLabel(r.type,r.outcome)}</span>` : "";

    let editInfo="";
    if(r.edited && r.edited.mode==="admin"){
      editInfo=`<div class="small">수정:${escapeHtml(r.edited.by||"-")}</div>`;
    }else if(r.edited && r.edited.mode==="self"){
      editInfo=`<div class="small">(수정됨)</div>`;
    }

    const parts=Array.isArray(r.participants)?r.participants:[];
    const added=new Set((r.edited?.mode==="self" && Array.isArray(r.edited.added))?r.edited.added:[]);
    const removed=new Set((r.edited?.mode==="self" && Array.isArray(r.edited.removed))?r.edited.removed:[]);

    const shown=parts.map(p=>`<span class="${added.has(p)?"u":""}">${escapeHtml(p)}</span>`);
    const removedShown=Array.from(removed).map(p=>`<span class="s">${escapeHtml(p)}</span>`);
    const partHtml=[...shown,...removedShown].length ? [...shown,...removedShown].join(", ") : "-";

    html+=`<div class="stat">
      <div class="row">
        <b>${escapeHtml(r.type)}</b>${outcomeTxt}
        <span class="right small">${escapeHtml(t)}</span>
      </div>
      <div><b>${escapeHtml(r.writer||"-")}</b></div>
      ${editInfo}
      <div class="small" style="margin-top:6px;">참여자: ${partHtml}</div>
      <div class="row" style="margin-top:8px;">
        ${canEditContent(r)?`<button class="pillbtn" data-edit="${escapeHtml(it.id)}" type="button">수정</button>`:""}
      </div>
    </div>`;
  }

  $("contentArea").innerHTML=html || `<div class="small">기록 없음</div>`;
  $("contentCount").textContent=`${total}건`;
  renderPager(pageCount);

  document.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick=()=>openEditModal(btn.getAttribute("data-edit"));
  });
}

/* ===== 컨텐츠 수정 모달(체크박스) ===== */
function openEditModal(docId){
  const found=contentDocsCache.find(d=>d.id===docId);
  if(!found) return alert("문서를 찾지 못했습니다. 새로고침 후 다시 시도해 주세요.");
  const data=found.data();
  if(!canEditContent(data)) return alert("수정 권한이 없습니다.");

  editDocId=docId;
  editDocData=data;
  editBaseParticipants=Array.isArray(data.participants)?[...data.participants]:[];
  editSelected=new Set(editBaseParticipants);
  editSelected.add(data.writer||currentUser);

  $("mTitle").textContent=`컨텐츠 수정 · ${data.type}`;
  $("mMeta").innerHTML=`
    <span class="tag">작성자 ${escapeHtml(data.writer||"-")}</span>
    <span class="tag">시간 ${escapeHtml(fmtKST(data.time))}</span>
    ${contentNeedsOutcome(data.type)?`<span class="tag">결과 ${getOutcomeLabel(data.type,data.outcome)}</span>`:`<span class="tag">결과 -</span>`}
  `;

  if(contentNeedsOutcome(data.type)){
    $("mOutcomeBox").hidden=false;
    $("mOutcomeBox").style.display="";
    $("mOutcome").value=(data.outcome===true?"O":(data.outcome===false?"X":"-"));
  }else{
    $("mOutcomeBox").hidden=true;
    $("mOutcomeBox").style.display="none";
  }

  $("mSearch").value="";
  editSearchQ="";
  $("mSearch").oninput=()=>{ editSearchQ=$("mSearch").value.trim().toLowerCase(); renderModalUserList(); };

  renderModalUserList();
  renderModalSelected();

  hardOpenModal();
}

function renderModalUserList(){
  const list=$("mUserList");
  const names=Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b,"ko"));
  const q=editSearchQ;
  const filtered=q?names.filter(n=>n.toLowerCase().includes(q)):names;

  list.innerHTML=filtered.map(n=>{
    const checked=editSelected.has(n)?"checked":"";
    return `
      <label class="itemRow" style="cursor:pointer;">
        <span><b>${escapeHtml(n)}</b></span>
        <input type="checkbox" data-pick="${escapeHtml(n)}" ${checked}/>
      </label>`;
  }).join("");

  list.querySelectorAll("input[type='checkbox'][data-pick]").forEach(cb=>{
    cb.onchange=()=>{
      const name=cb.getAttribute("data-pick");
      if(cb.checked) editSelected.add(name);
      else editSelected.delete(name);
      editSelected.add(editDocData?.writer||currentUser);
      renderModalSelected();
      renderModalUserList();
    };
  });
}
function renderModalSelected(){
  const box=$("mSelected");
  const arr=Array.from(editSelected).sort((a,b)=>a.localeCompare(b,"ko"));
  $("mSelectedCount").textContent=`${arr.length}명 선택`;
  box.innerHTML=arr.length ? arr.map(n=>`<span class="badge">${escapeHtml(n)}</span>`).join(" ")
                          : `<span class="small">선택된 인원이 없습니다.</span>`;
}
function modalSelectAll(){
  Array.from(usersCache.keys()).forEach(n=>editSelected.add(n));
  editSelected.add(editDocData?.writer||currentUser);
  renderModalSelected(); renderModalUserList();
}
function modalClearAll(){
  editSelected=new Set();
  editSelected.add(editDocData?.writer||currentUser);
  renderModalSelected(); renderModalUserList();
}

async function saveEditModal(){
  if(!editDocId || !editDocData) return;

  const type=editDocData.type;
  const writer=editDocData.writer||currentUser;

  let participants=Array.from(editSelected).map(x=>x.trim()).filter(Boolean);
  if(!participants.includes(writer)) participants.unshift(writer);
  if(participants.length===0) return alert("참여자가 0명이면 저장하지 않습니다.");

  let outcome=editDocData.outcome ?? null;
  if(contentNeedsOutcome(type)){
    const v=$("mOutcome").value;
    if(v==="O") outcome=true;
    else if(v==="X") outcome=false;
    else outcome=null;
  }

  const before=new Set(editBaseParticipants);
  const after=new Set(participants);
  const added=[], removed=[];
  for(const p of after){ if(!before.has(p)) added.push(p); }
  for(const p of before){ if(!after.has(p)) removed.push(p); }

  let edited=null;
  if(isAdmin() && currentUser!==writer){
    edited={mode:"admin", by:currentUser, at:serverTimestamp()};
  }else{
    edited={mode:"self", by:writer, at:serverTimestamp(), added, removed};
  }

  try{
    await updateDoc(doc(db,"contentRecords",editDocId), { participants, outcome, edited });
    setStatus("저장되었습니다.");
    closeEditModal();
    await loadContent();
  }catch(e){ alert(err(e)); console.error(e); }
}

/* ===== 관리자: 유저 관리(10명 페이지네이션) ===== */
function renderAdminUserTable(){
  if(!isAdmin()) return;
  const tbody=$("adminUserTbody");
  const pager=$("adminPager");
  if(!tbody || !pager) return;

  const q=($("adminUserSearch")?.value||"").trim().toLowerCase();
  const rows=[];
  for(const [name,ud] of usersCache.entries()){
    if(q && !name.toLowerCase().includes(q)) continue;
    rows.push({name,ud});
  }
  rows.sort((a,b)=>a.name.localeCompare(b.name,"ko"));

  const total=rows.length;
  const pageCount=Math.max(1, Math.ceil(total/ADMIN_PAGE_SIZE));
  if(adminUserPage>=pageCount) adminUserPage=pageCount-1;

  const start=adminUserPage*ADMIN_PAGE_SIZE;
  const pageRows=rows.slice(start, start+ADMIN_PAGE_SIZE);

  tbody.innerHTML = pageRows.map(({name,ud})=>{
    const rankOptions = `<option value="">-</option>` + RANKS.map(r=>`<option value="${r}" ${ud.rank===r?"selected":""}>${r}</option>`).join("");
    const deptOptions = `<option value="">-</option>` + DEPTS.map(d=>`<option value="${d}" ${ud.department===d?"selected":""}>${d}</option>`).join("");
    const adminChecked = ud.isAdmin===true ? "checked" : "";
    const hiddenChecked = ud.isHidden===true ? "checked" : "";
    const pw = (ud.password ?? "").toString();
    return `
      <tr data-user="${escapeHtml(name)}">
        <td style="min-width:220px;">
          <b>${escapeHtml(name)}</b>
          <div class="small mono">pw:
            <span class="pwText" data-pw="${escapeHtml(pw)}">••••</span>
            <button class="pillbtn ghost pwToggle" type="button">보기</button>
          </div>
        </td>
        <td style="min-width:200px;"><select class="rankSel wide">${rankOptions}</select></td>
        <td style="min-width:240px;"><select class="deptSel wide">${deptOptions}</select></td>
        <td style="min-width:140px;">
          <label class="row"><input type="checkbox" class="adminChk" ${adminChecked}/> <span class="small">관리자</span></label>
          <label class="row"><input type="checkbox" class="hiddenChk" ${hiddenChecked}/> <span class="small">숨김</span></label>
        </td>
        <td style="min-width:360px;">
          <div class="row">
            <input class="pwInput wide" placeholder="새 비밀번호" />
            <button class="pillbtn pwSet" type="button">설정</button>
          </div>
          <div class="row" style="margin-top:6px;">
            <button class="pillbtn ghost saveRow" type="button">저장</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  pager.innerHTML = `
    <span class="small">총 ${total}명 · ${adminUserPage+1}/${pageCount} 페이지</span>
    <button class="pillbtn" id="adminPrev" ${adminUserPage===0?"disabled":""}>이전</button>
    <button class="pillbtn" id="adminNext" ${adminUserPage>=pageCount-1?"disabled":""}>다음</button>
  `;

  $("adminPrev")?.addEventListener("click", ()=>{
    adminUserPage=Math.max(0, adminUserPage-1);
    renderAdminUserTable();
  });
  $("adminNext")?.addEventListener("click", ()=>{
    adminUserPage=Math.min(pageCount-1, adminUserPage+1);
    renderAdminUserTable();
  });

  tbody.querySelectorAll("tr").forEach(tr=>{
    const user=tr.getAttribute("data-user");

    tr.querySelector(".pwToggle")?.addEventListener("click",()=>{
      const span=tr.querySelector(".pwText");
      span.textContent = (span.textContent==="••••") ? (span.getAttribute("data-pw")||"") : "••••";
    });

    tr.querySelector(".pwSet")?.addEventListener("click", async ()=>{
      const v=(tr.querySelector(".pwInput")?.value||"").trim();
      if(!v) return alert("새 비밀번호를 입력해 주세요.");
      try{
        await updateDoc(doc(db,"users",user), { password:v });
        const ud=usersCache.get(user)||{};
        ud.password=v; usersCache.set(user,ud);
        tr.querySelector(".pwText")?.setAttribute("data-pw", escapeHtml(v));
        tr.querySelector(".pwInput").value="";
        setStatus("비밀번호가 설정되었습니다.");
      }catch(e){ alert(err(e)); console.error(e); }
    });

    tr.querySelector(".saveRow")?.addEventListener("click", async ()=>{
      try{
        const rank=tr.querySelector(".rankSel")?.value || "";
        const dept=tr.querySelector(".deptSel")?.value || "";
        const admin=!!tr.querySelector(".adminChk")?.checked;
        const hidden=!!tr.querySelector(".hiddenChk")?.checked;

        await updateDoc(doc(db,"users",user), {
          rank: rank || "",
          department: dept || "",
          isAdmin: admin,
          isHidden: hidden
        });

        const ud=usersCache.get(user)||{};
        ud.rank=rank||""; ud.department=dept||""; ud.isAdmin=admin; ud.isHidden=hidden;
        usersCache.set(user,ud);

        setStatus("저장되었습니다.");
        await loadStats(); await loadOnline(); await loadContent();
      }catch(e){ alert(err(e)); console.error(e); }
    });
  });
}

async function adminAddUser(){
  const nick=($("adminAddNick").value||"").trim();
  const pw=($("adminAddPw").value||"").trim();
  if(!nick) return alert("닉네임을 입력해 주세요.");
  if(!pw) return alert("비밀번호를 입력해 주세요.");

  try{
    const exists=await getDoc(doc(db,"users",nick));
    if(exists.exists()) return alert("이미 존재하는 유저입니다.");

    await setDoc(doc(db,"users",nick), {
      password: pw,
      isAdmin: false,
      isHidden: false,
      rank: "",
      department: ""
    });

    $("adminAddNick").value="";
    $("adminAddPw").value="";
    adminUserPage=0;
    await loadUsers();
    setStatus("유저가 추가되었습니다.");
  }catch(e){ alert(err(e)); console.error(e); }
}

/* ===== 수동 새로고침 ===== */
async function refreshAll(toast){
  try{ await loadUsers(); }catch(e){ console.error(e); }
  try{ await loadStats(); }catch(e){ console.error(e); }
  try{ await loadOnline(); }catch(e){ console.error(e); }
  try{ await loadContent(); }catch(e){ console.error(e); }
  if(toast) setStatus("갱신되었습니다.");
}

/* ===== 이벤트 ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  // ✅ 페이지 첫 로드에서 모달/드로어 무조건 닫기(즉시 + 다음 tick)
  hardCloseModal();
  hardCloseDrawer();
  setTimeout(()=>{ hardCloseModal(); hardCloseDrawer(); },0);

  // 모달/드로어 배경 클릭 닫기
  $("contentModal")?.addEventListener("click",(e)=>{
    if(e.target?.id==="contentModal") closeEditModal();
  });
  $("adminDrawerBack")?.addEventListener("click",(e)=>{
    if(e.target?.id==="adminDrawerBack") hardCloseDrawer();
  });

  // ESC로 닫기
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape"){
      closeEditModal();
      hardCloseDrawer();
      toggleFilterMenu(false);
    }
  });

  $("loginBtn").addEventListener("click",login);
  $("logoutBtn").addEventListener("click",logout);
  $("refreshBtn").addEventListener("click",()=>refreshAll(true));

  $("inBtn").addEventListener("click",checkIn);
  $("outBtn").addEventListener("click",checkOut);

  $("supplyBtn").addEventListener("click",()=>createContent("보급"));
  $("plantBtn").addEventListener("click",()=>createContent("송전소"));
  $("escortBtn").addEventListener("click",()=>createContent("차량수호"));

  $("adminToggleBtn").addEventListener("click",toggleAdminDrawer);
  $("adminDrawerClose")?.addEventListener("click",hardCloseDrawer);

  $("adminUserSearch")?.addEventListener("input",()=>{ adminUserPage=0; renderAdminUserTable(); });
  $("adminAddBtn")?.addEventListener("click",adminAddUser);

  // 컨텐츠 필터
  $("filterBtn").addEventListener("click", ()=>toggleFilterMenu());
  document.addEventListener("click",(e)=>{
    if(!e.target.closest("#filterWrap")) toggleFilterMenu(false);
  });
  $("fAll").addEventListener("click", ()=>setContentFilter("ALL"));
  $("fSup").addEventListener("click", ()=>setContentFilter("보급"));
  $("fPlt").addEventListener("click", ()=>setContentFilter("송전소"));
  $("fEsc").addEventListener("click", ()=>setContentFilter("차량수호"));

  // 모달 버튼
  $("mClose").addEventListener("click",closeEditModal);
  $("mCancel").addEventListener("click",closeEditModal);
  $("mSave").addEventListener("click",saveEditModal);
  $("mAll").addEventListener("click",modalSelectAll);
  $("mClear").addEventListener("click",modalClearAll);

  setFilterLabel();
});
</script>
</head>

<body>

<div id="loginBox" class="card" style="width:360px;margin:100px auto;">
  <h2>로그인</h2>
  <input id="loginId" placeholder="아이디"><br>
  <input id="loginPw" type="password" placeholder="비밀번호"><br>
  <button id="loginBtn">로그인</button>
  <div class="small" style="margin-top:8px;">* 아이디=닉네임으로 판정합니다.</div>
</div>

<div id="mainBox" class="hidden">
  <div class="top">
    <div class="row" id="userInfo"></div>
    <div class="row">
      <span id="statusMsg" class="small"></span>
      <button id="refreshBtn">새로고침</button>
      <button id="adminToggleBtn" class="ghost hidden">관리</button>
      <button id="logoutBtn">로그아웃</button>
    </div>
  </div>

  <div class="container">

    <div class="col">
      <div class="card">
        <h3>근태</h3>
        <button id="inBtn">출근</button>
        <button id="outBtn">퇴근</button>
      </div>

      <div class="card">
        <h3>접속 목록(출근중)</h3>
        <div class="small" style="margin-bottom:8px;">* 일반 유저는 ‘숨김 유저’가 보이지 않습니다.</div>
        <div id="onlineArea"></div>
      </div>

      <div class="card">
        <h3>컨텐츠 작성</h3>
        <button id="supplyBtn">보급</button>
        <button id="plantBtn">송전소</button>
        <button id="escortBtn">차량수호</button>
        <div class="small" style="margin-top:8px;">* 컨텐츠 기록은 최근 7일만 표시됩니다.</div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <h3 style="margin:0;">컨텐츠 기록</h3>
          <div class="row">
            <div id="filterWrap" class="dropWrap">
              <button id="filterBtn" class="pillbtn dropBtn" type="button">
                <span id="filterLabel">전체 보기</span>
                <span id="filterCaret">▼</span>
              </button>
              <div id="filterMenu" class="dropMenu hidden">
                <button id="fAll" class="dropItem" type="button">전체 보기</button>
                <button id="fSup" class="dropItem" type="button">보급만 보기</button>
                <button id="fPlt" class="dropItem" type="button">송전소만 보기</button>
                <button id="fEsc" class="dropItem" type="button">차량수호만 보기</button>
              </div>
            </div>
            <span class="badge" id="contentCount">0건</span>
          </div>
        </div>

        <div id="contentArea" style="margin-top:10px;"></div>
        <div id="pageArea"></div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h3>유저 통계</h3>
        <div class="small" style="margin-bottom:10px;">* 유저 목록 + 접속 여부(O/X)만 표시합니다.</div>

        <div class="tableWrap">
          <table style="min-width:380px;">
            <thead>
              <tr>
                <th>닉네임</th>
                <th>접속</th>
              </tr>
            </thead>
            <tbody id="statsTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ✅ 관리자 드로어 (기본: inert + hidden + hidden 속성 + style display none은 JS에서 강제) -->
<div id="adminDrawerBack" class="drawerBack hidden" inert hidden style="display:none;">
  <div class="drawer" role="dialog" aria-modal="true">
    <div class="drawerTop">
      <div>
        <b style="font-size:15px;">관리자 패널</b>
        <div class="small">* “관리” 버튼을 한 번 더 누르거나 배경 클릭/ESC로 닫힙니다.</div>
        <div class="small">* 유저 목록은 10명씩 넘깁니다.</div>
      </div>
      <div class="row">
        <button id="adminDrawerClose" class="pillbtn ghost" type="button">닫기</button>
      </div>
    </div>

    <details class="adminSec" open>
      <summary>유저 관리 <span class="sumHint">화이트리스트 / 계급 / 부서 / 숨김 / 비밀번호</span></summary>
      <div class="secBody">
        <div class="row">
          <input id="adminAddNick" class="wide" placeholder="추가할 닉네임" />
          <input id="adminAddPw" class="wide" placeholder="초기 비밀번호" />
          <button id="adminAddBtn" type="button">유저 추가</button>
        </div>

        <div class="row" style="margin-top:8px;">
          <input id="adminUserSearch" class="wide" placeholder="유저 검색(닉네임)" />
        </div>

        <div class="tableWrap" style="margin-top:10px;">
          <table style="min-width:1100px;">
            <thead>
              <tr>
                <th style="min-width:220px;">유저</th>
                <th style="min-width:200px;">계급</th>
                <th style="min-width:240px;">부서</th>
                <th style="min-width:140px;">권한/숨김</th>
                <th style="min-width:360px;">비밀번호/저장</th>
              </tr>
            </thead>
            <tbody id="adminUserTbody"></tbody>
          </table>
        </div>

        <div id="adminPager" class="adminPager"></div>
      </div>
    </details>
  </div>
</div>

<!-- ✅ 컨텐츠 수정 모달 (기본: inert + hidden + hidden 속성 + style display none은 JS에서 강제) -->
<div id="contentModal" class="modalBack hidden" inert hidden style="display:none;">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div id="mTitle" style="font-weight:800;">컨텐츠 수정</div>
        <div id="mMeta" class="row" style="margin-top:6px;"></div>
      </div>
      <button id="mClose" class="pillbtn ghost" type="button">닫기</button>
    </div>

    <div class="modalBody">
      <div class="grid2">
        <div class="box">
          <div class="row" style="justify-content:space-between;">
            <b>참여자 선택</b>
            <span class="small">* 체크박스로 추가/삭제합니다.</span>
          </div>

          <div class="row" style="margin-top:8px;">
            <input id="mSearch" class="wide" placeholder="검색(닉네임)" style="width:100%;">
          </div>

          <div class="row" style="margin-top:8px;">
            <button id="mAll" class="pillbtn" type="button">전체 선택</button>
            <button id="mClear" class="pillbtn ghost" type="button">전체 해제</button>
            <span id="mSelectedCount" class="right small">0명 선택</span>
          </div>

          <div id="mUserList" class="list"></div>
        </div>

        <div class="box">
          <div class="row" style="justify-content:space-between;">
            <b>현재 선택</b>
            <span class="small">* 작성자는 자동 포함됩니다.</span>
          </div>
          <div id="mSelected" style="margin-top:10px;"></div>

          <div id="mOutcomeBox" class="box" style="margin-top:12px;">
            <div class="row" style="justify-content:space-between;">
              <b>성공 여부</b>
              <span class="small">보급/차량수호만 적용됩니다.</span>
            </div>
            <div class="row" style="margin-top:8px;">
              <select id="mOutcome" class="wide">
                <option value="-">- (미설정)</option>
                <option value="O">O (성공)</option>
                <option value="X">X (실패)</option>
              </select>
            </div>
          </div>

          <div class="small" style="margin-top:10px;">
            * 작성자 수정: (수정됨) + 추가=밑줄, 삭제=취소선으로 표시됩니다.<br>
            * 관리자(작성자 아님) 수정: 작성자 아래에 수정:닉네임이 표시됩니다.
          </div>
        </div>
      </div>
    </div>

    <div class="modalFoot">
      <button id="mCancel" class="pillbtn ghost" type="button">취소</button>
      <button id="mSave" class="pillbtn" type="button">저장</button>
    </div>
  </div>
</div>

</body>
</html>

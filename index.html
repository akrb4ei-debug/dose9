<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë„ìŠ¤ì˜¨ë¼ì¸ êµ­ë°©ë¶€ ê·¼í‡´ì‹œìŠ¤í…œ</title>

  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#0B0B0D;
      --bg2:#111114;
      --bg3:#16161A;
      --stroke: rgba(255,255,255,0.10);
      --ink: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --good:#EDEDED;
      --bad:#9C9C9C;
      --gold:#FFFFFF;
      --shadow: 0 18px 60px rgba(0,0,0,0.55);
    }
    *{ box-sizing:border-box; font-family:'Pretendard',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    body{
      margin:0; min-height:100vh; color:var(--ink);
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(255,255,255,0.06), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(255,255,255,0.04), transparent 65%),
        linear-gradient(180deg,var(--bg1),var(--bg2) 55%,var(--bg3));
    }
    50%{background-position:100% 50%;}
      100%{background-position:0% 50%;}
    }
    .wrap{ width:min(1560px, 96vw); margin: 22px auto 46px; position:relative; z-index:1; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 14px 16px; border-radius: 18px;
      background: rgba(255,255,255,0.06);
      border:1px solid var(--stroke);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      position: sticky; top: 14px; z-index: 30;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:40px; height:40px; border-radius: 14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg,var(--gold),#B89A5E);
      color:#121212;
      box-shadow: 0 15px 35px rgba(0,0,0,0.6);
      font-weight: 900;
    }
    .brandTitle{ font-size:16px; font-weight:900; }
    .brandSub{ font-size:12px; color:var(--muted); font-weight:800; margin-top:2px; }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.86);
      font-weight:800;
      white-space:nowrap;
    }
    .pill.good{ color: var(--good); border-color: rgba(50,230,201,0.22); background: rgba(50,230,201,0.10); }
    .pill.admin{ color: var(--gold); border-color: rgba(214,195,154,0.22); background: rgba(214,195,154,0.10); }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:18px; margin-top:14px; align-items:start; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background: rgba(255,255,255,0.06);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:18px;
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
    }

    h2,h3{ margin:0 0 10px; }
    .sub{ color: var(--muted); font-size: 13px; line-height: 1.55; margin-top:-4px; font-weight:700; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    input, select{
      border:none; outline:none;
      padding: 11px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.08);
      border:1px solid var(--stroke);
      color: var(--ink);
      min-width: 190px;
    }
    input::placeholder{ color: rgba(255,255,255,0.52); }

    .btn{
      border:none; outline:none; cursor:pointer; user-select:none;
      padding: 11px 14px;
      border-radius: 14px;
      font-weight:900;
      color: var(--ink);
      background: rgba(255,255,255,0.08);
      border:1px solid var(--stroke);
      transition: transform .15s ease, box-shadow .15s ease;
      white-space:nowrap;
      min-height: 42px;
    }
    .btn:hover{ transform: translateY(-2px); box-shadow: 0 18px 40px rgba(0,0,0,0.35); }
    .btn:active{ transform: translateY(0px); box-shadow:none; }
    .btn.primary{ background: linear-gradient(135deg,#4F6BFF,#3F3D91); }
    .btn.danger{ background: linear-gradient(135deg,#FF5A78,#D03A55); }
    .btn.admin{ background: linear-gradient(135deg,var(--gold),#B89A5E); color:#151515; }
    .btn.ghost{ background: rgba(255,255,255,0.05); }
    .btn.small{ min-height: 34px; padding: 8px 10px; font-size: 12.5px; border-radius: 12px; }
    .btn.icon{ padding: 8px 10px; min-height: 34px; border-radius: 12px; }
    .btn.disabled{ opacity:.55; pointer-events:none; }

    .kpi{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:10px; margin-top:10px; }
    @media (max-width: 980px){ .kpi{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    .kpi .box{
      border-radius:14px; padding:12px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
    }
    .kpi .label{ font-size:12px; color: var(--muted); font-weight:900; }
    .kpi .value{ font-size:20px; font-weight:900; margin-top:6px; }

    .good{ color: var(--good); }
    .bad{ color: var(--bad); }

    .online-list{ margin-top:10px; display:flex; flex-direction:column; gap:8px; max-height: 320px; overflow:auto; padding-right:4px; }
    .chip{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.12);
      font-weight:900;
    }
    .chip .leftPart{ display:flex; align-items:center; gap:10px; }
    .dot{ width:10px; height:10px; border-radius:999px; background: var(--good); box-shadow: 0 0 12px rgba(50,230,201,0.5); }
    .dot.off{ background: var(--bad); box-shadow: 0 0 12px rgba(255,90,120,0.5); }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin: 6px 0 12px; }
    .tab{
      padding: 9px 12px; border-radius: 14px; cursor:pointer;
      background: rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.10);
      font-weight:900; font-size:13px;
      transition: .15s;
      white-space:nowrap;
    }
    .tab.active{
      background: rgba(255,255,255,0.12);
      border:1px solid rgba(255,255,255,0.16);
      box-shadow: 0 12px 28px rgba(0,0,0,0.30);
    }

    .dropdown-wrap{ position:relative; display:inline-flex; }
    .dropdown{
      position:absolute; top: 44px; right:0;
      width: 240px;
      border-radius: 14px;
      background: rgba(12, 14, 24, 0.92);
      border:1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(12px);
      overflow:hidden;
      transform-origin: top right;
      max-height: 0; opacity: 0; transform: translateY(-6px) scale(0.98);
      transition: max-height .22s ease, opacity .22s ease, transform .22s ease;
      pointer-events:none;
      z-index: 40;
    }
    .dropdown.open{ max-height: 360px; opacity: 1; transform: translateY(0px) scale(1); pointer-events:auto; }
    .dropdown button{
      width:100%; text-align:left;
      border:none; outline:none; cursor:pointer;
      padding: 11px 12px;
      background: transparent;
      color: var(--ink);
      font-weight:900;
    }
    .dropdown button:hover{ background: rgba(255,255,255,0.08); }

    .tableWrap{ margin-top:10px; overflow:auto; max-height: 640px; padding-right:6px; }
    .table{
      width:100%;
      min-width: 1120px;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
    }
    .table th, .table td{
      padding: 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align:center;
      font-size: 13.5px;
      line-height: 1.35;
      white-space: nowrap;
      vertical-align: middle;
    }
    .table th{
      color: rgba(255,255,255,0.78);
      font-weight:900; font-size: 12.5px;
      letter-spacing:.25px;
      position: sticky; top:0; z-index: 2;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
    }
    .table tr:hover td{ background: rgba(255,255,255,0.06); }
    .left{ text-align:left !important; white-space: normal; word-break: break-word; }

    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.76);
      display:none; align-items:center; justify-content:center;
      padding: 18px;
      z-index: 100;
    }
    .modal.show{ display:flex; }

    .modal-box{
      width: min(940px, 96vw);
      border-radius: 18px;
      background: rgba(10,12,20,0.95);
      border:1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(16px);
      box-shadow: 0 30px 100px rgba(0,0,0,0.75);
      overflow:hidden;
      animation: pop .18s ease;
    }
    @keyframes pop{
      from{ transform: translateY(8px) scale(0.985); opacity:0; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }
    .modal-head{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      background: rgba(255,255,255,0.06);
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    .modal-title{ font-weight:900; font-size: 14px; letter-spacing:.2px; }
    .modal-body{ padding: 16px; }
    .modal-foot{
      display:flex; justify-content:flex-end; gap:10px;
      padding: 14px 16px;
      background: rgba(255,255,255,0.06);
      border-top:1px solid rgba(255,255,255,0.08);
      flex-wrap: wrap;
    }

    .picker{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .picker{ grid-template-columns: 1fr; } }
    .panel{
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.10);
      padding: 12px;
    }
    .panel h4{ margin:0 0 10px; font-size: 13px; font-weight:900; }
    .hint{ font-size:12px; color: var(--muted); margin-top:-6px; margin-bottom:8px; font-weight:800; line-height:1.45; }

    .userlist{ max-height: 360px; overflow:auto; display:flex; flex-direction:column; gap:6px; padding-right:4px; }
    .userrow{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      cursor:pointer;
      transition:.12s;
    }
    .userrow:hover{ background: rgba(255,255,255,0.10); transform: translateY(-1px); }
    .userrow .name{ font-weight:900; }
    .userrow .tag{
      font-size: 12px; padding: 4px 8px; border-radius: 999px;
      border:1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.86);
      background: rgba(255,255,255,0.04);
      font-weight:900;
      white-space: nowrap;
    }

    .selected{
      display:flex; flex-wrap:wrap; gap:8px;
      min-height: 44px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(255,255,255,0.03);
      border:1px dashed rgba(255,255,255,0.16);
    }
    .selchip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(214,195,154,0.10);
      border:1px solid rgba(214,195,154,0.16);
      font-weight:900;
      white-space: nowrap;
    }
    .xbtn{
      width:22px; height:22px; border-radius: 999px;
      display:inline-flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,0.14);
      border:1px solid rgba(255,255,255,0.14);
      cursor:pointer;
      font-weight:900;
    }

    .toggle{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .toggle .opt{
      padding: 10px 12px; min-width: 84px; text-align:center;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      cursor:pointer;
      font-weight:900;
      white-space: nowrap;
    }
    .toggle .opt.active{
      background: rgba(50,230,201,0.12);
      border:1px solid rgba(50,230,201,0.22);
      color: var(--good);
    }

    .pager{ display:flex; gap:10px; justify-content:center; align-items:center; margin-top: 12px; flex-wrap:wrap; }
    .pagebtn{
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      cursor:pointer;
      font-weight:900;
      white-space: nowrap;
    }
    .pagebtn.active{
      background: rgba(214,195,154,0.12);
      border:1px solid rgba(214,195,154,0.18);
      color: var(--gold);
    }

    .note{ font-size:12px; color: var(--muted); margin-top:8px; font-weight:800; line-height: 1.55; }
    .tinyStatus{ margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.74); font-weight: 900; min-height: 16px; }
    canvas{ background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.10); border-radius: 14px; padding: 10px; }
  
    /* ===== Admin Drawer ===== */
    .adminOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      z-index: 70;
    }
    .adminOverlay.show{ opacity:1; pointer-events:auto; }

    #adminPanel{
      position:fixed;
      top: 0; right: 0;
      height: 100vh;
      width: min(760px, 96vw);
      margin: 0;
      border-radius: 0;
      overflow: auto;
      transform: translateX(110%);
      transition: transform .22s ease;
      z-index: 80;
      display:block !important; /* display í† ê¸€ ëŒ€ì‹  transformìœ¼ë¡œ ì œì–´í•©ë‹ˆë‹¤. */
    }
    #adminPanel.open{ transform: translateX(0); }
    body.drawerOpen{ overflow:hidden; }

    .adminHeadRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }

    /* ===== Content Timeline ===== */
    .timeline{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .tcard{
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
    }
    .tmeta{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .tmeta .type{ font-weight:900; letter-spacing:.2px; }
    .tmeta .time{ color: var(--muted); font-weight:800; font-size:12px; }
    .tline{ margin-top:8px; color: rgba(255,255,255,0.86); font-weight:800; line-height:1.55; }
    .tactions{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">â—†</div>
        <div>
          <div class="brandTitle">ë„ìŠ¤ì˜¨ë¼ì¸ êµ­ë°©ë¶€ ê·¼í‡´ì‹œìŠ¤í…œ</div>
          <div class="brandSub">ì¶œÂ·í‡´ê·¼ + ì½˜í…ì¸ (ë³´ê¸‰/ì†¡ì „ì†Œ/ì°¨ëŸ‰ìˆ˜í˜¸)</div>
        </div>
      </div>
      <div class="row">
        <span class="pill good">ì‹¤ì‹œê°„: ON</span>
        <span class="pill" id="whoami">ë¯¸ë¡œê·¸ì¸</span>
      </div>
    </div>

    <div class="grid">
      <!-- Main -->
      <div class="card">
        <h2>ë©”ì¸</h2>
        <div class="sub">ì¶œê·¼/í‡´ê·¼ ë° ì½˜í…ì¸  ë³´ê³ ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.</div>

        <div class="row" style="margin-top:12px;">
          <input id="nickname" placeholder="ë‹‰ë„¤ì„(ì•„ì´ë””)" autocomplete="username" />
          <input id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" autocomplete="current-password" />
          <button class="btn primary" id="loginBtn">ë¡œê·¸ì¸</button>
          <button class="btn ghost" id="logoutBtn" disabled>ë¡œê·¸ì•„ì›ƒ</button>
          <button class="btn" id="publicStatsBtn" disabled>ìœ ì € í†µê³„</button>
          <button class="btn admin" id="adminBtn" style="display:none;">ê´€ë¦¬</button>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="label">í˜„ì¬ ì ‘ì†</div>
            <div class="value good" id="kpiOnline">0</div>
          </div>
          <div class="box">
            <div class="label">ë‚´ ìƒíƒœ</div>
            <div class="value" id="kpiMe">-</div>
          </div>
          <div class="box">
            <div class="label">ì˜¤ëŠ˜ ì½˜í…ì¸ </div>
            <div class="value" id="kpiTodayContent">-</div>
          </div>
          <div class="box">
            <div class="label">ìµœê·¼ 7ì¼ ë‚´ ê·¼ë¬´</div>
            <div class="value" id="kpiWeekHours">-</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="checkInBtn" disabled>ì¶œê·¼</button>
          <button class="btn danger" id="checkOutBtn" disabled>í‡´ê·¼</button>
          <button class="btn" id="supplyBtn" disabled>ë³´ê¸‰</button>
          <button class="btn" id="powerBtn" disabled>ì†¡ì „ì†Œ</button>
          <button class="btn" id="escortBtn" disabled>ì°¨ëŸ‰ìˆ˜í˜¸</button>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="row" style="justify-content:space-between;">
            <h3 style="margin:0;">ì ‘ì†ì¤‘(ì¶œê·¼ì¤‘) ëª©ë¡</h3>
            <span class="pill good">ì‹¤ì‹œê°„</span>
          </div>
          <div class="sub">ì¼ë°˜ ìœ ì €ëŠ” ìˆ¨ê¹€ ìœ ì €ê°€ ì—¬ê¸°ì„œ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ê´€ë¦¬ìëŠ” ë³´ì…ë‹ˆë‹¤.)</div>
          <div class="online-list" id="onlineUsers"></div>
        </div>
      </div>

      <!-- Admin -->
      <div class="card" id="adminPanel">
        <div class="adminHeadRow">
          <h2 style="margin:0;">ê´€ë¦¬</h2>
          <div class="row" style="gap:8px;">
            <button class="btn small ghost" id="adminCloseBtn">ë‹«ê¸°</button>
          </div>
        </div>
        <div class="sub">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ / í†µê³„ / ì½˜í…ì¸  / ê·¼íƒœ / ê¶Œí•œ/ìˆ¨ê¹€ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</div>

        <div class="tabs">
          <div class="tab active" data-tab="users">ìœ ì €/í†µê³„</div>
          <div class="tab" data-tab="content">ì½˜í…ì¸  ê¸°ë¡</div>
          <div class="tab" data-tab="work">ê·¼íƒœ ê´€ë¦¬</div>
          <div class="tab" data-tab="roles">ê¶Œí•œ/ìˆ¨ê¹€</div>
        </div>

        <!-- Users/Stats -->
        <div id="tabUsers">
          <div class="row">
            <button class="btn admin" id="refreshStatsBtn">í†µê³„ ê°±ì‹ </button>
             <button class="btn ghost" id="toggleGraphsBtn">ê·¸ë˜í”„ í¼ì¹˜ê¸°</button>
            <button class="btn danger" id="resetWorkBtn">ì´ ì¶œê·¼ì‹œê°„ ì´ˆê¸°í™”</button>
          </div>
          <div class="tinyStatus" id="statsMsg"></div>

          <div class="card" style="margin-top:12px;">
            <h3 style="margin:0 0 8px;">ê·¸ë˜í”„(ìš”ì•½)</h3>
            <div class="note">â€¢ í‰ê·  1íšŒ ê·¼ë¬´ì‹œê°„ / ìµœê·¼ 7ì¼ ì´ ê·¼ë¬´ì‹œê°„ / ìµœê·¼ 7ì¼ ì¶œê·¼ íšŸìˆ˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</div>
            <div style="display:grid; grid-template-columns:1fr; gap:12px; margin-top:10px;">
              <canvas id="chartAvgShift" height="160"></canvas>
              <canvas id="chartWeekHours" height="160"></canvas>
              <canvas id="chartWeekCount" height="160"></canvas>
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <h3 style="margin:0 0 8px;">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸(ë“±ë¡ ìœ ì €)</h3>
            <div class="row">
              <input id="newUser" placeholder="ë‹‰ë„¤ì„" />
              <input id="newPass" placeholder="ë¹„ë°€ë²ˆí˜¸" />
              <button class="btn" id="addUserBtn">ìœ ì € ì¶”ê°€</button>
            </div>

            <div class="row" style="margin-top:10px;">
              <input id="editUser" placeholder="ë‹‰ë„¤ì„" />
              <input id="editPass" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" />
              <button class="btn" id="changePassBtn">ë¹„ë²ˆ ë³€ê²½</button>
              <button class="btn danger" id="deleteUserBtn">ìœ ì € ì‚­ì œ</button>
            </div>

            <div class="note">â€¢ ì•„ì´ë””ì™€ ë‹‰ë„¤ì„ì€ ë™ì¼í•˜ê²Œ íŒì •ë˜ë©°, ë‚´ë¶€ ë¹„êµëŠ” ì†Œë¬¸ìë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</div>

            <div class="tableWrap">
              <table class="table" style="min-width: 1420px;">
                <thead>
                  <tr>
                    <th>ë‹‰ë„¤ì„</th>
                    <th>ì ‘ì†</th>
                    <th>ë§ˆì§€ë§‰ ì¶œê·¼</th>
                    <th>ë§ˆì§€ë§‰ í‡´ê·¼</th>
                    <th>ìµœê·¼ 7ì¼ ê·¼ë¬´ì‹œê°„</th>
                    <th>ì†¡ì „ì†Œ</th>
                    <th>ë³´ê¸‰</th>
                    <th>ì°¨ëŸ‰ìˆ˜í˜¸</th>
                    <th>ìˆ¨ê¹€</th>
                    <th>ìˆ¨ê¹€ í† ê¸€</th>
                  </tr>
                </thead>
                <tbody id="userStatsBody">
                  <tr><td colspan="10" style="color:rgba(255,255,255,0.65); font-weight:900;">í†µê³„ ê°±ì‹ ì„ ëˆŒëŸ¬ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Content records -->
        <div id="tabContent" style="display:none;">
          <div class="row" style="justify-content:space-between;">
            <div class="dropdown-wrap">
              <button class="btn" id="filterBtn">í•„í„° â–¾</button>
              <div class="dropdown" id="filterMenu">
                <button data-filter="all">ì „ì²´ ë³´ê¸°</button>
                <button data-filter="supply">ë³´ê¸‰ë§Œ ë³´ê¸°</button>
                <button data-filter="power">ì†¡ì „ì†Œë§Œ ë³´ê¸°</button>
                <button data-filter="escort">ì°¨ëŸ‰ìˆ˜í˜¸ë§Œ ë³´ê¸°</button>
              </div>
            </div>

            <div class="row">
              <button class="btn ghost" id="toggleDeletedBtn">ì‚­ì œëœ ê¸°ë¡ ë³´ê¸°: OFF</button>
              <span class="pill good">1í˜ì´ì§€ ì‹¤ì‹œê°„</span>
            </div>
          </div>

          <div class="note">
            â€¢ 20ê°œì”© í˜ì´ì§€ë¡œ êµ¬ì„±ë˜ë©°, 1í˜ì´ì§€ëŠ” ì‹¤ì‹œê°„ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.<br>
            â€¢ ì¼ë°˜ ìœ ì €ëŠ” ìˆ¨ê¹€ ìœ ì €ê°€ ì°¸ì—¬ì ëª©ë¡ì—ì„œ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤. ê´€ë¦¬ìëŠ” ëª¨ë‘ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
            â€¢ ìˆ˜ì •ì€ ì‘ì„±ì/ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>

          <div class="tableWrap">
            <table class="table" style="min-width: 1220px;">
              <thead>
                <tr>
                  <th>íƒ€ì…</th>
                  <th>ë‚ ì§œ/ì‹œê°„</th>
                  <th>ì°¸ì—¬ì ëª©ë¡</th>
                  <th>ê²°ê³¼(O/X)</th>
                  <th>ì‘ì„±ì</th>
                  <th>ìˆ˜ì •</th>
                  <th>ì‚­ì œ</th>
                </tr>
              </thead>
              <tbody id="contentBody"></tbody>
            </table>
          </div>

          <div class="pager" id="pager"></div>
        </div>

        <!-- Work management -->
        <div id="tabWork" style="display:none;">
          <div class="card">
            <h3 style="margin:0 0 8px;">ì¶œÂ·í‡´ê·¼ ê´€ë¦¬</h3>
            <div class="note">
              â€¢ íŠ¹ì • ìœ ì €ë¥¼ ì„ íƒí•œ ë’¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì™€ ìˆ˜ì •/ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
              â€¢ ê°•ì œ ì¶œê·¼/í‡´ê·¼ì€ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </div>

            <div class="row" style="margin-top:10px;">
              <select id="workUserSelect" style="min-width:220px;"></select>
              <button class="btn" id="loadWorkBtn">ê·¼íƒœ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <button class="btn admin" id="forceInBtn">ê°•ì œ ì¶œê·¼</button>
              <button class="btn admin" id="forceOutBtn">ê°•ì œ í‡´ê·¼</button>
            </div>

            <div class="tinyStatus" id="workMsg"></div>

            <div class="tableWrap">
              <table class="table" style="min-width: 1200px;">
                <thead>
                  <tr>
                    <th>ê¸°ë¡ID</th>
                    <th>ì¶œê·¼</th>
                    <th>í‡´ê·¼</th>
                    <th>ê·¼ë¬´ì‹œê°„</th>
                    <th>ìˆ˜ì •</th>
                    <th>ì‚­ì œ</th>
                  </tr>
                </thead>
                <tbody id="workBody">
                  <tr><td colspan="6" style="color:rgba(255,255,255,0.65); font-weight:900;">ìœ ì €ë¥¼ ì„ íƒí•œ ë’¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì‹œê¸° ë°”ëë‹ˆë‹¤.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Roles/Hidden -->
        <div id="tabRoles" style="display:none;">
          <div class="card">
            <h3 style="margin:0 0 8px;">ê´€ë¦¬ì ê¶Œí•œ / ìˆ¨ê¹€(ë‹¤ì¤‘ ì„ íƒ)</h3>
            <div class="note">
              â€¢ ì²´í¬ë°•ìŠ¤ë¡œ ì—¬ëŸ¬ ëª…ì„ ì„ íƒí•œ ë’¤ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬/í•´ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
              â€¢ ìˆ¨ê¹€ì€ ì¼ë°˜ ìœ ì €ì—ê²ŒëŠ” ì ‘ì†ëª©ë¡/ì½˜í…ì¸  ì°¸ì—¬ìì—ì„œë§Œ ì ìš©ë˜ë©°, ê´€ë¦¬ìëŠ” í•­ìƒ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn admin" id="grantAdminBtn">ê´€ë¦¬ì ë¶€ì—¬</button>
              <button class="btn danger" id="revokeAdminBtn">ê´€ë¦¬ì í•´ì„</button>
              <button class="btn" id="refreshRoleListBtn">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div class="tableWrap">
              <table class="table" style="min-width: 1000px;">
                <thead>
                  <tr>
                    <th>ì„ íƒ</th>
                    <th>ë‹‰ë„¤ì„</th>
                    <th>ê´€ë¦¬ì</th>
                    <th>ìˆ¨ê¹€</th>
                    <th>ìˆ¨ê¹€ í† ê¸€</th>
                  </tr>
                </thead>
                <tbody id="rolesBody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div><!-- adminPanel -->
    </div><!-- grid -->
  </div><!-- wrap -->

  <div id="adminOverlay" class="adminOverlay" aria-hidden="true"></div>

  <!-- Alert Modal -->
  <div class="modal" id="alertModal" aria-hidden="true">
    <div class="modal-box" style="width:min(520px,96vw);">
      <div class="modal-head">
        <div class="modal-title">ì•Œë¦¼</div>
        <button class="btn small ghost" id="alertClose">ë‹«ê¸°</button>
      </div>
      <div class="modal-body">
        <div id="alertText" style="font-weight:900; font-size:14px;"></div>
      </div>
      <div class="modal-foot">
        <button class="btn primary" id="alertOk">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- Public Stats Modal (ì¼ë°˜ ìœ ì €ìš©) -->
  <div class="modal" id="publicStatsModal" aria-hidden="true">
    <div class="modal-box" style="width:min(1100px,96vw);">
      <div class="modal-head">
        <div class="modal-title">ìœ ì € í†µê³„(ì¼ë°˜)</div>
        <button class="btn small ghost" id="publicStatsCloseTop">ë‹«ê¸°</button>
      </div>
      <div class="modal-body">
        <div class="row" style="justify-content:space-between;">
          <div class="note" style="margin:0;">
            â€¢ ë‹‰ë„¤ì„ / ì¶œÂ·í‡´ ì—¬ë¶€ / ì´ë²ˆì£¼ ì´ ì ‘ì†ì‹œê°„ / ë§ˆì§€ë§‰ ì ‘ì† / ì†¡ì „ì†ŒÂ·ë³´ê¸‰Â·ì°¨ëŸ‰ìˆ˜í˜¸ ì°¸ì—¬ íšŸìˆ˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.<br>
            â€¢ ë³¸ í™”ë©´ì€ ê´€ë¦¬ì í†µê³„ì™€ ë³„ê°œë¡œ, ì¼ë°˜ ìœ ì €ê°€ ë³´ê¸° ì‰¬ìš´ í˜•íƒœë¡œ ì œê³µí•©ë‹ˆë‹¤.
          </div>
          <button class="btn" id="publicStatsRefreshBtn">ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div class="tinyStatus" id="publicStatsMsg"></div>

        <div class="tableWrap">
          <table class="table" style="min-width: 1100px;">
            <thead>
              <tr>
                <th>ë‹‰ë„¤ì„</th>
                <th>ì ‘ì†</th>
                <th>ì´ë²ˆì£¼ ì´ ì ‘ì†ì‹œê°„</th>
                <th>ë§ˆì§€ë§‰ ì ‘ì†</th>
                <th>ì†¡ì „ì†Œ</th>
                <th>ë³´ê¸‰</th>
                <th>ì°¨ëŸ‰ìˆ˜í˜¸</th>
              </tr>
            </thead>
            <tbody id="publicStatsBody">
              <tr><td colspan="7" style="color:rgba(255,255,255,0.65); font-weight:900;">ìƒˆë¡œê³ ì¹¨ì„ ëˆŒëŸ¬ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn primary" id="publicStatsClose">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Content Modal (create/edit ê³µìš©) -->
  <div class="modal" id="contentModal" aria-hidden="true">
    <div class="modal-box">
      <div class="modal-head">
        <div class="modal-title" id="contentTitle">ì½˜í…ì¸ </div>
        <button class="btn small ghost" id="contentCloseTop">ë‹«ê¸°</button>
      </div>

      <div class="modal-body">
        <div class="picker">
          <div class="panel">
            <h4>ëª…ë‹¨ ì¶”ê°€</h4>
            <div class="hint">ëª©ë¡ì—ì„œ í´ë¦­í•˜ë©´ ì°¸ì—¬ìì— ì¶”ê°€ë©ë‹ˆë‹¤.</div>
            <div class="row">
              <input id="userSearch" placeholder="ê²€ìƒ‰(ë‹‰ë„¤ì„)" style="flex:1 1 auto; min-width: 220px;">
              <button class="btn small" id="toggleUserListBtn">+ ëª…ë‹¨ í¼ì¹˜ê¸°</button>
            </div>
            <div id="userListWrap" style="margin-top:10px; display:none;">
              <div class="userlist" id="userList"></div>
            </div>
          </div>

          <div class="panel">
            <h4>ì°¸ì—¬ì</h4>
            <div class="hint">ì €ì¥ ì‹œ ì‘ì„±ìê°€ ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤.</div>
            <div class="selected" id="selectedUsers"></div>

            <div style="height:12px;"></div>

            <div id="supplyResultWrap" style="display:none;">
              <h4>ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€</h4>
              <div class="hint">O / X ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</div>
              <div class="toggle">
                <div class="opt" id="optO">O</div>
                <div class="opt" id="optX">X</div>
              </div>
            </div>

            <div class="note" id="contentHint"></div>
            <div class="note" id="contentMeta" style="opacity:.9;"></div>
          </div>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn ghost" id="contentCancel">ì·¨ì†Œ</button>
        <button class="btn primary" id="contentSave">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- Work Edit Modal -->
  <div class="modal" id="workEditModal" aria-hidden="true">
    <div class="modal-box" style="width:min(720px,96vw);">
      <div class="modal-head">
        <div class="modal-title">ê·¼íƒœ ê¸°ë¡ ìˆ˜ì •</div>
        <button class="btn small ghost" id="workEditCloseTop">ë‹«ê¸°</button>
      </div>
      <div class="modal-body">
        <div class="note">â€¢ ë‚ ì§œ/ì‹œê°„ì€ ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì…ë ¥í•©ë‹ˆë‹¤. í˜•ì‹: YYYY-MM-DD HH:MM</div>
        <div class="row" style="margin-top:10px;">
          <div class="panel" style="flex:1 1 320px;">
            <h4>ì¶œê·¼</h4>
            <input id="workEditIn" placeholder="ì˜ˆ: 2026-02-16 09:00" style="width:100%; min-width:auto;">
          </div>
          <div class="panel" style="flex:1 1 320px;">
            <h4>í‡´ê·¼(ë¹ˆì¹¸ ê°€ëŠ¥)</h4>
            <input id="workEditOut" placeholder="ì˜ˆ: 2026-02-16 18:00" style="width:100%; min-width:auto;">
          </div>
        </div>
        <div class="note" id="workEditMeta"></div>
      </div>
      <div class="modal-foot">
        <button class="btn ghost" id="workEditCancel">ì·¨ì†Œ</button>
        <button class="btn primary" id="workEditSave">ì €ì¥</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore,
    collection, doc, getDoc, setDoc, updateDoc, deleteDoc, addDoc,
    getDocs, query, where, orderBy, limit, startAfter,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAJ6MhR1JsGbvieb8akAi4Zpas_W3uaNJ4",
    authDomain: "dosep-b6ee3.firebaseapp.com",
    projectId: "dosep-b6ee3",
    storageBucket: "dosep-b6ee3.firebasestorage.app",
    messagingSenderId: "100096560571",
    appId: "1:100096560571:web:7eb2c1255835b6b57c889e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);
  const lowerNick = (s) => (s || "").trim().toLowerCase();
  const nowMs = () => Date.now();
  const fmt = (ms) => { if (!ms) return "-"; try { return new Date(ms).toLocaleString(); } catch { return "-"; } };
  const msToHours = (ms) => (ms/3600000);
  const safeNum = (v) => (typeof v === "number" && Number.isFinite(v)) ? v : 0;

  const colUsers = collection(db, "users");
  const colWork = collection(db, "workRecords");
  const colContent = collection(db, "contentRecords");

  let currentUser = null;
  let currentIsAdmin = false;

  let usersCache = new Map();

  let unsubUsers = null;
  let unsubOnline = null;
  let unsubContentFirst = null;

  // ì½˜í…ì¸  ìƒíƒœ
  let contentType = null; // supply | power | escort
  let selectedSet = new Set();
  let supplyResult = null; // O | X
  let contentMode = "create"; // create | edit
  let editingContentId = null;
  let editingContentCreatedBy = null;

  // ì½˜í…ì¸  ê¸°ë¡
  let contentFilter = "all";
  let contentPage = 1;
  let showDeletedContent = false;
  const PAGE_SIZE = 20;
  const cursors = [];

  // ê·¼íƒœ ìˆ˜ì •
  let editingWorkId = null;

  // ì°¨íŠ¸
  let chartAvgShift = null;
  let chartWeekHours = null;
  let chartWeekCount = null;

  // ===== Alert Modal =====
  const alertModal = $("alertModal");
  const alertText = $("alertText");
  function showAlert(msg){
    alertText.textContent = String(msg ?? "").slice(0, 500);
    alertModal.classList.add("show");
    alertModal.setAttribute("aria-hidden","false");
  }
  function closeAlert(){
    alertModal.classList.remove("show");
    alertModal.setAttribute("aria-hidden","true");
  }
  $("alertOk").addEventListener("click", closeAlert);
  $("alertClose").addEventListener("click", closeAlert);
  alertModal.addEventListener("click", (e)=>{ if(e.target===alertModal) closeAlert(); });

  function setWhoami(){
    $("whoami").textContent = currentUser
      ? `ì ‘ì†: ${currentUser}${currentIsAdmin ? " (ê´€ë¦¬ì)" : ""}`
      : "ë¯¸ë¡œê·¸ì¸";
  }

  function setLoggedInUI(on){
    $("logoutBtn").disabled = !on;
    $("publicStatsBtn").disabled = !on;
    $("checkInBtn").disabled = !on;
    $("checkOutBtn").disabled = !on;
    $("supplyBtn").disabled = !on;
    $("powerBtn").disabled = !on;
    $("escortBtn").disabled = !on;
    if(!on){
      $("adminBtn").style.display = "none";
      $("adminPanel").style.display = "none";
    }
  }
  function setAdminUI(on){
    $("adminBtn").style.display = on ? "inline-flex" : "none";
  }

  async function refreshUsersCacheOnce(){
    const snap = await getDocs(colUsers);
    const map = new Map();
    snap.forEach(d => map.set(d.id, d.data() || {}));
    usersCache = map;
    rebuildAdminSelectors();
  }

  function startUsersRealtime(){
    stopUsersRealtime();
    unsubUsers = onSnapshot(colUsers, (snap)=>{
      const map = new Map();
      snap.forEach(d => map.set(d.id, d.data() || {}));
      usersCache = map;
      rebuildAdminSelectors();
      if(currentIsAdmin){
        renderRolesList();
      }
    });
  }
  function stopUsersRealtime(){
    if(unsubUsers){ unsubUsers(); unsubUsers=null; }
  }

  function visibleUserForOnlineList(nick){
    const u = usersCache.get(nick);
    if(!u) return false;
    if(currentIsAdmin) return true;
    return !u.hidden; // ì ‘ì†ëª©ë¡ ìˆ¨ê¹€ ì ìš©
  }
  function visibleUserForContentParticipants(nick){
    const u = usersCache.get(nick);
    if(!u) return false;
    if(currentIsAdmin) return true;
    return !u.hidden; // ì½˜í…ì¸  ì°¸ì—¬ì ìˆ¨ê¹€ ì ìš©
  }

  function stopOnlineRealtime(){
    if(unsubOnline){ unsubOnline(); unsubOnline=null; }
  }
  function startOnlineRealtime(){
    stopOnlineRealtime();
    const q = query(colWork, where("checkOut","==", null));
    unsubOnline = onSnapshot(q, (snap)=>{
      const online = new Set();
      snap.forEach(d=>{
        const r = d.data() || {};
        const n = lowerNick(r.nickname);
        if(!n) return;
        if(!visibleUserForOnlineList(n)) return;
        online.add(n);
      });

      const list = Array.from(online).sort((a,b)=>a.localeCompare(b));
      $("kpiOnline").textContent = String(list.length);

      if(list.length === 0){
        $("onlineUsers").innerHTML = `
          <div class="chip">
            <div class="leftPart"><span class="dot off"></span><span>ì ‘ì† X</span></div>
            <span class="bad">ì ‘ì† X</span>
          </div>
        `;
      }else{
        $("onlineUsers").innerHTML = list.map(n => `
          <div class="chip">
            <div class="leftPart"><span class="dot"></span><span>${n}</span></div>
            <span class="good">ì ‘ì† O</span>
          </div>
        `).join("");
      }
    });
  }

  async function refreshKPI(){
    if(!currentUser){
      $("kpiMe").textContent = "-";
      $("kpiWeekHours").textContent = "-";
      $("kpiTodayContent").textContent = "-";
      return;
    }

    try{
      const q = query(colWork, where("nickname","==", currentUser), where("checkOut","==", null));
      const s = await getDocs(q);
      const online = !s.empty;
      $("kpiMe").innerHTML = online
        ? `<span class="good">ğŸŸ¢ ì ‘ì† O</span>`
        : `<span class="bad">ğŸ”´ ì ‘ì† X</span>`;
    }catch{
      $("kpiMe").textContent = "-";
    }

    try{
      const weekAgo = nowMs() - 7*24*60*60*1000;
      const snap = await getDocs(query(colWork, where("nickname","==", currentUser)));
      let totalMs = 0;

      snap.forEach(d=>{
        const r = d.data() || {};
        const ci = r.checkIn;
        const co = (r.checkOut == null) ? nowMs() : r.checkOut;
        if(typeof ci !== "number") return;

        const start = Math.max(ci, weekAgo);
        const end = co;
        if(end <= weekAgo) return;
        if(end > start) totalMs += (end - start);
      });

      $("kpiWeekHours").textContent = `${(totalMs/3600000).toFixed(2)}h`;
    }catch{
      $("kpiWeekHours").textContent = "-";
    }

    try{
      const today = new Date(); today.setHours(0,0,0,0);
      const startMs = today.getTime();
      const csnap = await getDocs(colContent);
      let cnt = 0;
      csnap.forEach(d=>{
        const c = d.data() || {};
        if(!!c.deleted) return;
        if((c.time || 0) >= startMs) cnt++;
      });
      $("kpiTodayContent").textContent = `${cnt}ê±´`;
    }catch{
      $("kpiTodayContent").textContent = "-";
    }
  }

  // ===== ë¡œê·¸ì¸ =====
  async function login(){
    const nick = lowerNick($("nickname").value);
    const pass = $("password").value;

    if(!nick || !pass){
      return showAlert("ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    }

    try{
      const uSnap = await getDoc(doc(db,"users",nick));
      if(!uSnap.exists()){
        return showAlert("í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ë˜ì§€ ì•Šì€ ìœ ì €ì…ë‹ˆë‹¤.");
      }

      const u = uSnap.data() || {};
      if((u.password ?? "") !== pass){
        return showAlert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }

      currentUser = nick;
      currentIsAdmin = !!u.isAdmin;

      setWhoami();
      setLoggedInUI(true);
      setAdminUI(currentIsAdmin);

      startUsersRealtime();
      await refreshUsersCacheOnce();

      startOnlineRealtime();
      await refreshKPI();

      showAlert("ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch{
      showAlert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤. (DB/ê·œì¹™ì„ í™•ì¸í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.)");
    }
  }

  function stopContentRealtime(){
    if(unsubContentFirst){
      unsubContentFirst();
      unsubContentFirst = null;
    }
  }

  function logout(){
    stopContentRealtime();
    stopOnlineRealtime();
    stopUsersRealtime();

    currentUser = null;
    currentIsAdmin = false;

    $("adminPanel").style.display = "none";

    setWhoami();
    setLoggedInUI(false);

    $("kpiOnline").textContent = "0";
    $("kpiMe").textContent = "-";
    $("kpiTodayContent").textContent = "-";
    $("kpiWeekHours").textContent = "-";
    $("onlineUsers").innerHTML = "";

    showAlert("ë¡œê·¸ì•„ì›ƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  // ===== ê·¼íƒœ(ì¼ë°˜) =====
  async function checkIn(){
    if(!currentUser) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    try{
      const qOpen = query(colWork, where("nickname","==", currentUser), where("checkOut","==", null));
      const snap = await getDocs(qOpen);
      if(!snap.empty) return showAlert("í‡´ê·¼ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!");

      await addDoc(colWork, { nickname: currentUser, checkIn: nowMs(), checkOut: null });
      showAlert("ì¶œê·¼ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await refreshKPI();
    }catch{
      showAlert("ì¶œê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  }

  async function checkOut(){
    if(!currentUser) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    try{
      const qOpen = query(colWork, where("nickname","==", currentUser), where("checkOut","==", null));
      const snap = await getDocs(qOpen);
      if(snap.empty) return showAlert("ì¶œê·¼ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!");

      await updateDoc(snap.docs[0].ref, { checkOut: nowMs() });
      showAlert("í‡´ê·¼ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await refreshKPI();
    }catch{
      showAlert("í‡´ê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  }

  // ===== ê´€ë¦¬ íŒ¨ë„ í† ê¸€(í•œ ë²ˆ ë” ëˆ„ë¥´ë©´ ë‹«í˜) =====
  function toggleAdminPanel(){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");

    const panel = $("adminPanel");
    const overlay = $("adminOverlay");
    const isOpen = panel.classList.contains("open");

    if(isOpen){
      // í¬ì»¤ìŠ¤ë¥¼ ë¨¼ì € í•´ì œí•œ ë’¤ ë‹«ìŠµë‹ˆë‹¤.
      try{ document.activeElement && document.activeElement.blur && document.activeElement.blur(); }catch(_){}
      panel.classList.remove("open");
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
      document.body.classList.remove("drawerOpen");
      stopContentRealtime();
      return;
    }

    panel.classList.add("open");
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
    document.body.classList.add("drawerOpen");
    openTab("users");

    // ì ‘ê·¼ì„±: ì—´ë¦´ ë•Œ ì²« íƒ­ìœ¼ë¡œ í¬ì»¤ìŠ¤ë¥¼ ì´ë™í•©ë‹ˆë‹¤.
    const firstTab = panel.querySelector(".tab");
    if(firstTab) firstTab.focus && firstTab.focus();
  }

  // ===== ê´€ë¦¬ì íƒ­ =====
  const tabs = Array.from(document.querySelectorAll(".tab"));
  function openTab(key){
    tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab") === key));
    $("tabUsers").style.display = (key === "users") ? "block" : "none";
    $("tabContent").style.display = (key === "content") ? "block" : "none";
    $("tabWork").style.display = (key === "work") ? "block" : "none";
    $("tabRoles").style.display = (key === "roles") ? "block" : "none";

    if(key === "content"){
      contentPage = 1;
      renderPager(1);
      openContentPage(1);
    }else{
      stopContentRealtime();
    }

    if(key === "roles"){
      renderRolesList();
    }
    if(key === "work"){
      rebuildAdminSelectors();
    }
  }
  tabs.forEach(t => t.addEventListener("click", () => openTab(t.getAttribute("data-tab"))));

  // ===== ì½˜í…ì¸  ëª¨ë‹¬ =====
  const contentModal = $("contentModal");
  function setOX(val){
    supplyResult = val;
    $("optO").classList.toggle("active", val === "O");
    $("optX").classList.toggle("active", val === "X");
  }
  $("optO").addEventListener("click", ()=>setOX("O"));
  $("optX").addEventListener("click", ()=>setOX("X"));

  function renderSelected(){
    const el = $("selectedUsers");
    if(selectedSet.size === 0){
      el.innerHTML = `<span style="color:rgba(255,255,255,0.65); font-weight:900;">ì„ íƒëœ ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
      return;
    }
    el.innerHTML = Array.from(selectedSet).map(n => `
      <span class="selchip">
        ${n}
        <span class="xbtn" data-x="${n}">Ã—</span>
      </span>
    `).join("");

    el.querySelectorAll(".xbtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        selectedSet.delete(btn.getAttribute("data-x"));
        renderSelected();
      });
    });
  }

  function renderUserList(){
    const list = $("userList");
    const q = lowerNick($("userSearch").value);

    let users = Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b));
    if(!currentIsAdmin){
      users = users.filter(n => !(usersCache.get(n)?.hidden));
    }
    const filtered = q ? users.filter(n => n.includes(q)) : users;

    list.innerHTML = filtered.length ? filtered.map(n=>{
      const u = usersCache.get(n) || {};
      const badges = [];
      if(u.isAdmin) badges.push("ê´€ë¦¬ì");
      if(u.hidden) badges.push("ìˆ¨ê¹€");
      const tag = badges.length ? badges.join(" Â· ") : "ìœ ì €";
      return `
        <div class="userrow" data-nick="${n}">
          <div class="name">${n}</div>
          <div class="tag">${tag}</div>
        </div>
      `;
    }).join("") : `<div style="color:rgba(255,255,255,0.7); font-weight:900;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;

    list.querySelectorAll(".userrow").forEach(row=>{
      row.addEventListener("click", ()=>{
        const n = row.getAttribute("data-nick");
        if(!n) return;
        selectedSet.add(n);
        renderSelected();
      });
    });
  }

  function openContentModalCreate(type){
    if(!currentUser) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    contentMode = "create";
    editingContentId = null;
    editingContentCreatedBy = null;

    contentType = type;
    selectedSet = new Set();
    supplyResult = null;

    const needsResult = (type === "supply" || type === "escort");

    $("contentTitle").textContent =
      (type === "supply") ? "ğŸ“¦ ë³´ê¸‰ ë“±ë¡" :
      (type === "escort") ? "ğŸšš ì°¨ëŸ‰ìˆ˜í˜¸ ë“±ë¡" :
      "âš¡ ì†¡ì „ì†Œ ë“±ë¡";

    $("contentHint").textContent = (type === "power")
      ? "ì†¡ì „ì†ŒëŠ” ì°¸ì—¬ìë§Œ ì„ íƒí•˜ë©´ ë©ë‹ˆë‹¤."
      : "ë³´ê¸‰/ì°¨ëŸ‰ìˆ˜í˜¸ëŠ” O/X(ì„±ê³µ ì—¬ë¶€)ê°€ í•„ìš”í•©ë‹ˆë‹¤.";

    $("contentMeta").textContent = "â€¢ ìƒˆ ê¸°ë¡ ì‘ì„± ëª¨ë“œì…ë‹ˆë‹¤. ì €ì¥ ì‹œ ì‘ì„±ìê°€ ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤.";
    $("contentSave").textContent = "ì €ì¥";

    $("supplyResultWrap").style.display = needsResult ? "block" : "none";
    $("optO").classList.remove("active");
    $("optX").classList.remove("active");

    $("userSearch").value = "";
    $("userListWrap").style.display = "none";

    renderSelected();
    renderUserList();

    contentModal.classList.add("show");
    contentModal.setAttribute("aria-hidden","false");
  }

  async function openContentModalEdit(docId){
    if(!currentUser) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    try{
      const snap = await getDoc(doc(db,"contentRecords", docId));
      if(!snap.exists()) return showAlert("í•´ë‹¹ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

      const c = snap.data() || {};
      const createdBy = lowerNick(c.createdBy || "");
      const canEdit = currentIsAdmin || (createdBy && createdBy === lowerNick(currentUser));
      if(!canEdit) return showAlert("ì‘ì„±ì ë˜ëŠ” ê´€ë¦¬ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

      contentMode = "edit";
      editingContentId = docId;
      editingContentCreatedBy = createdBy;

      contentType = c.type || "power";
      selectedSet = new Set((Array.isArray(c.participants) ? c.participants : []).map(lowerNick).filter(Boolean));
      supplyResult = c.result || null;

      const needsResult = (contentType === "supply" || contentType === "escort");

      $("contentTitle").textContent =
        (contentType === "supply") ? "ğŸ“¦ ë³´ê¸‰ ìˆ˜ì •" :
        (contentType === "escort") ? "ğŸšš ì°¨ëŸ‰ìˆ˜í˜¸ ìˆ˜ì •" :
        "âš¡ ì†¡ì „ì†Œ ìˆ˜ì •";

      $("contentHint").textContent = (contentType === "power")
        ? "ì†¡ì „ì†ŒëŠ” ì°¸ì—¬ìë§Œ ì„ íƒí•˜ë©´ ë©ë‹ˆë‹¤."
        : "ë³´ê¸‰/ì°¨ëŸ‰ìˆ˜í˜¸ëŠ” O/X(ì„±ê³µ ì—¬ë¶€)ê°€ í•„ìš”í•©ë‹ˆë‹¤.";

      $("contentMeta").textContent = `â€¢ ìˆ˜ì • ëª¨ë“œì…ë‹ˆë‹¤. ê¸°ë¡ID: ${docId} / ì‘ì„±ì: ${createdBy || "-"}`;
      $("contentSave").textContent = "ìˆ˜ì • ì €ì¥";

      $("supplyResultWrap").style.display = needsResult ? "block" : "none";
      $("optO").classList.toggle("active", supplyResult === "O");
      $("optX").classList.toggle("active", supplyResult === "X");

      $("userSearch").value = "";
      $("userListWrap").style.display = "none";

      renderSelected();
      renderUserList();

      contentModal.classList.add("show");
      contentModal.setAttribute("aria-hidden","false");
    }catch{
      showAlert("ìˆ˜ì • ëª¨ë‹¬ì„ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  }

  function closeContentModal(){
    try{ document.activeElement && document.activeElement.blur && document.activeElement.blur(); }catch(_){ }
    contentModal.classList.remove("show");
    contentModal.setAttribute("aria-hidden","true");
  }
  $("contentCloseTop").addEventListener("click", closeContentModal);
  $("contentCancel").addEventListener("click", closeContentModal);
  contentModal.addEventListener("click", (e)=>{ if(e.target===contentModal) closeContentModal(); });

  $("toggleUserListBtn").addEventListener("click", ()=>{
    const wrap = $("userListWrap");
    wrap.style.display = (wrap.style.display === "none") ? "block" : "none";
  });
  $("userSearch").addEventListener("input", renderUserList);

  $("contentSave").addEventListener("click", async ()=>{
    if(!currentUser) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    const author = lowerNick(currentUser);
    const picked = Array.from(selectedSet).map(lowerNick).filter(Boolean);
    const participants = Array.from(new Set([author, ...picked])).filter(Boolean);

    if(participants.length === 0){
      return showAlert("ì°¸ì—¬ìë¥¼ 1ëª… ì´ìƒ ì¶”ê°€í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    }

    const needsResult = (contentType === "supply" || contentType === "escort");
    if(needsResult && !supplyResult){
      return showAlert("ì„±ê³µ ì—¬ë¶€(O/X)ë¥¼ ì„ íƒí•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    }

    try{
      if(contentMode === "create"){
        await addDoc(colContent, {
          type: contentType,
          time: nowMs(),
          participants,
          result: needsResult ? supplyResult : null,
          createdBy: author,
          createdAt: nowMs(),
          updatedAt: null,
          updatedBy: null,
          deleted: false,
          deletedAt: null,
          deletedBy: null
        });
        closeContentModal();
        showAlert("ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }else{
        if(!editingContentId) return showAlert("ìˆ˜ì • ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
        const canEdit = currentIsAdmin || (editingContentCreatedBy && editingContentCreatedBy === author);
        if(!canEdit) return showAlert("ì‘ì„±ì ë˜ëŠ” ê´€ë¦¬ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

        await updateDoc(doc(db,"contentRecords", editingContentId), {
          type: contentType,
          participants,
          result: needsResult ? supplyResult : null,
          updatedAt: nowMs(),
          updatedBy: author
        });
        closeContentModal();
        showAlert("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
      await refreshKPI();
    }catch{
      showAlert("ì €ì¥/ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  });

  // ===== ë²„íŠ¼ ì—°ê²° =====
  $("loginBtn").addEventListener("click", login);
  $("logoutBtn").addEventListener("click", logout);
  $("checkInBtn").addEventListener("click", checkIn);
  $("checkOutBtn").addEventListener("click", checkOut);
  $("supplyBtn").addEventListener("click", ()=> openContentModalCreate("supply"));
  $("powerBtn").addEventListener("click", ()=> openContentModalCreate("power"));
  $("escortBtn").addEventListener("click", ()=> openContentModalCreate("escort"));
  $("adminBtn").addEventListener("click", toggleAdminPanel);

  // ê´€ë¦¬ íŒ¨ë„: ë‹«ê¸° ë²„íŠ¼/ì˜¤ë²„ë ˆì´ í´ë¦­ìœ¼ë¡œ ë‹«ìŠµë‹ˆë‹¤.
  const adminOverlay = $("adminOverlay");
  $("adminCloseBtn")?.addEventListener("click", toggleAdminPanel);
  adminOverlay?.addEventListener("click", ()=>{ 
    const panel = $("adminPanel");
    if(panel && panel.classList.contains("open")) toggleAdminPanel();
  });

  // ===== ì½˜í…ì¸  ê¸°ë¡(ê´€ë¦¬ì) =====
  const filterBtn = $("filterBtn");
  const filterMenu = $("filterMenu");
  function closeFilterMenu(){ filterMenu.classList.remove("open"); }

  filterBtn.addEventListener("click", ()=> filterMenu.classList.toggle("open"));
  document.addEventListener("click", (e)=>{
    if(!filterMenu.contains(e.target) && e.target !== filterBtn) closeFilterMenu();
  });
  filterMenu.querySelectorAll("button").forEach(b=>{
    b.addEventListener("click", ()=>{
      contentFilter = b.getAttribute("data-filter");
      closeFilterMenu();
      contentPage = 1;
      renderPager(1);
      openContentPage(1);
    });
  });

  $("toggleDeletedBtn").addEventListener("click", ()=>{
    showDeletedContent = !showDeletedContent;
    $("toggleDeletedBtn").textContent = `ì‚­ì œëœ ê¸°ë¡ ë³´ê¸°: ${showDeletedContent ? "ON" : "OFF"}`;
    contentPage = 1;
    renderPager(1);
    openContentPage(1);
  });

  function labelType(t){
    if(t === "supply") return "ë³´ê¸‰";
    if(t === "power") return "ì†¡ì „ì†Œ";
    if(t === "escort") return "ì°¨ëŸ‰ìˆ˜í˜¸";
    return t || "-";
  }

  function applyHiddenFilterToParticipants(parts){
    if(currentIsAdmin) return parts;
    return parts.filter(n => visibleUserForContentParticipants(lowerNick(n)));
  }

  function renderContentRows(docs){
    const rows = docs.map(ds=>{
      const c = ds.data() || {};
      const type = c.type || "-";

      const deleted = !!c.deleted;
      if(!showDeletedContent && deleted) return null;
      if(contentFilter !== "all" && type !== contentFilter) return null;

      const time = fmt(c.time);

      const rawParts = Array.isArray(c.participants) ? c.participants : [];
      const parts = applyHiddenFilterToParticipants(rawParts);

      const createdBy = lowerNick(c.createdBy || "");
      const participants = parts.length
        ? parts.map(n => (lowerNick(n) === createdBy ? `<b>${n}</b>` : n)).join(", ")
        : (rawParts.length ? "(ìˆ¨ê¹€ ì²˜ë¦¬ë¨)" : "-");

      const result = (type === "supply" || type === "escort") ? (c.result || "-") : "-";
      const authorCell = createdBy ? `<b>${createdBy}</b>` : "-";

      const canEdit = currentIsAdmin || (createdBy && createdBy === lowerNick(currentUser || ""));
      const editBtn = canEdit
        ? `<button class="btn icon" data-edit="${ds.id}">ìˆ˜ì •</button>`
        : `<button class="btn icon disabled">ìˆ˜ì •</button>`;

      const delCell = deleted
        ? `<span class="pill" style="opacity:.85;">ì‚­ì œë¨</span>`
        : `<button class="btn danger icon" data-softdel="${ds.id}">ì‚­ì œ</button>`;

      return `
        <tr>
          <td style="font-weight:900;">${labelType(type)}</td>
          <td>${time}</td>
          <td class="left">${participants}</td>
          <td style="font-weight:900;">${result}</td>
          <td>${authorCell}</td>
          <td>${editBtn}</td>
          <td>${delCell}</td>
        </tr>
      `;
    }).filter(Boolean).join("");

    $("contentBody").innerHTML = rows || `<tr><td colspan="7" style="color:rgba(255,255,255,0.65); font-weight:900;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;

    // íƒ€ì„ë¼ì¸(ì¹´ë“œ)ë„ í•¨ê»˜ ê·¸ë¦½ë‹ˆë‹¤.
    const cards = docs.map(ds=>{
      const c = ds.data() || {};
      const type = c.type || "-";

      const deleted = !!c.deleted;
      if(!showDeletedContent && deleted) return null;
      if(contentFilter !== "all" && type !== contentFilter) return null;

      const time = fmt(c.time);

      const rawParts = Array.isArray(c.participants) ? c.participants : [];
      const parts = applyHiddenFilterToParticipants(rawParts);

      const createdBy = lowerNick(c.createdBy || "");
      const participants = parts.length
        ? parts.map(n => (lowerNick(n) === createdBy ? `<b>${n}</b>` : n)).join(", ")
        : (rawParts.length ? "(ìˆ¨ê¹€ ì²˜ë¦¬ë¨)" : "-");

      const result = (type === "supply" || type === "escort") ? (c.result || "-") : "-";
      const authorCell = createdBy ? `<b>${createdBy}</b>` : "-";

      const canEdit = currentIsAdmin || (createdBy && createdBy === lowerNick(currentUser || ""));
      const editBtn = canEdit
        ? `<button class="btn small ghost" data-edit="${ds.id}">ìˆ˜ì •</button>`
        : `<button class="btn small ghost disabled">ìˆ˜ì •</button>`;

      const delBtn = deleted
        ? `<span class="pill" style="opacity:.85;">ì‚­ì œë¨</span>`
        : `<button class="btn small danger" data-softdel="${ds.id}">ì‚­ì œ</button>`;

      return `
        <div class="tcard">
          <div class="tmeta">
            <div class="type">${labelType(type)} ${deleted ? '<span class="pill" style="margin-left:6px; opacity:.85;">ì‚­ì œë¨</span>' : ''}</div>
            <div class="time">${time}</div>
          </div>
          <div class="tline"><span style="color:var(--muted); font-weight:900;">ì°¸ì—¬ì</span> : <span>${participants}</span></div>
          ${((type === "supply" || type === "escort") ? `<div class="tline"><span style="color:var(--muted); font-weight:900;">ê²°ê³¼</span> : <b>${result}</b></div>` : ``)}
          <div class="tline"><span style="color:var(--muted); font-weight:900;">ì‘ì„±ì</span> : ${authorCell}</div>
          <div class="tactions">${editBtn}${delBtn}</div>
        </div>
      `;
    }).filter(Boolean).join("");

    const tl = $("contentTimeline");
    if(tl) tl.innerHTML = cards || `<div class="tcard" style="opacity:.85; font-weight:900;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;

    $("tabContent").querySelectorAll("[data-softdel]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        const id = btn.getAttribute("data-softdel");
        if(!id) return;

        const ok = confirm("ì´ ì½˜í…ì¸  ê¸°ë¡ì„ ì‚­ì œ ì²˜ë¦¬(ì†Œí”„íŠ¸ ì‚­ì œ)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if(!ok) return;

        try{
          await updateDoc(doc(db, "contentRecords", id), {
            deleted: true,
            deletedAt: nowMs(),
            deletedBy: currentUser || "unknown"
          });
        }catch{
          showAlert("ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
        }
      });
    });

    $("tabContent").querySelectorAll("[data-edit]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-edit");
        if(!id) return;
        await openContentModalEdit(id);
      });
    });
  }

  function renderPager(active){
    const maxShow = 11;
    const start = Math.max(1, active - Math.floor(maxShow/2));
    const end = start + maxShow - 1;

    let html = `<span class="pagebtn" data-page="prev">â—€</span>`;
    for(let p=start; p<=end; p++){
      html += `<span class="pagebtn ${p===active?"active":""}" data-page="${p}">${p}</span>`;
    }
    html += `<span class="pagebtn" data-page="next">â–¶</span>`;
    $("pager").innerHTML = html;

    $("pager").querySelectorAll("[data-page]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const v = btn.getAttribute("data-page");
        if(v === "prev"){
          if(contentPage > 1) openContentPage(contentPage - 1);
          return;
        }
        if(v === "next"){
          openContentPage(contentPage + 1);
          return;
        }
        const p = parseInt(v,10);
        if(Number.isFinite(p)) openContentPage(p);
      });
    });
  }

  function baseContentQuery(){
    return query(colContent, orderBy("time","desc"), limit(PAGE_SIZE));
  }

  async function openContentPage(page){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    contentPage = page;

    if(page === 1){
      stopContentRealtime();
      const q = baseContentQuery();
      unsubContentFirst = onSnapshot(q, (snap)=>{
        const docs = snap.docs;
        cursors[1] = docs.length ? docs[docs.length-1] : null;
        renderContentRows(docs);
        renderPager(1);
      });
      return;
    }

    stopContentRealtime();

    try{
      if(!cursors[1]){
        const first = await getDocs(baseContentQuery());
        cursors[1] = first.docs.length ? first.docs[first.docs.length-1] : null;
      }
      if(!cursors[1]){
        contentPage = 1;
        renderPager(1);
        renderContentRows([]);
        return;
      }

      for(let p=2; p<=page; p++){
        if(cursors[p-1] == null){
          const prevCursor = cursors[p-2] || cursors[1];
          const prevQ = query(colContent, orderBy("time","desc"), startAfter(prevCursor), limit(PAGE_SIZE));
          const prevSnap = await getDocs(prevQ);
          cursors[p-1] = prevSnap.docs.length ? prevSnap.docs[prevSnap.docs.length-1] : null;
          if(!cursors[p-1]){ contentPage = p-1; break; }
        }
      }

      const prevLast = cursors[page-1];
      if(!prevLast){
        contentPage = Math.max(1, page-1);
        renderPager(contentPage);
        return;
      }

      const q = query(colContent, orderBy("time","desc"), startAfter(prevLast), limit(PAGE_SIZE));
      const snap = await getDocs(q);
      if(snap.docs.length === 0){
        contentPage = Math.max(1, page-1);
        renderPager(contentPage);
        return;
      }

      cursors[page] = snap.docs[snap.docs.length-1];
      renderContentRows(snap.docs);
      renderPager(contentPage);
    }catch{
      showAlert("í˜ì´ì§€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      contentPage = 1;
      renderPager(1);
      renderContentRows([]);
    }
  }

  // ===== ê´€ë¦¬ì í†µê³„/ê·¸ë˜í”„ =====
  function setTinyStatus(id,msg){
    const el = $(id);
    el.textContent = msg || "";
    if(!msg) return;
    setTimeout(()=>{ if(el.textContent === msg) el.textContent = ""; }, 3000);
  }
  function destroyChart(ch){ try{ if(ch) ch.destroy(); }catch{} return null; }

  function buildCharts(labels, avgShiftHours, weekHours, weekCounts){
    chartAvgShift = destroyChart(chartAvgShift);
    chartWeekHours = destroyChart(chartWeekHours);
    chartWeekCount = destroyChart(chartWeekCount);

    chartAvgShift = new Chart($("chartAvgShift"), {
      type: "bar",
      data: { labels, datasets:[{ label:"í‰ê·  1íšŒ ê·¼ë¬´ì‹œê°„(h)", data: avgShiftHours }] },
      options: { responsive:true, plugins:{ legend:{ display:true } } }
    });
    chartWeekHours = new Chart($("chartWeekHours"), {
      type: "bar",
      data: { labels, datasets:[{ label:"ìµœê·¼ 7ì¼ ì´ ê·¼ë¬´ì‹œê°„(h)", data: weekHours }] },
      options: { responsive:true, plugins:{ legend:{ display:true } } }
    });
    chartWeekCount = new Chart($("chartWeekCount"), {
      type: "bar",
      data: { labels, datasets:[{ label:"ìµœê·¼ 7ì¼ ì¶œê·¼ íšŸìˆ˜(íšŒ)", data: weekCounts }] },
      options: { responsive:true, plugins:{ legend:{ display:true } } }
    });
  }

  async function refreshStatsAdmin(){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");

    try{
      const workSnap = await getDocs(colWork);
      const workByUser = new Map();
      workSnap.forEach(d=>{
        const r = d.data() || {};
        const n = lowerNick(r.nickname);
        if(!n) return;
        if(!workByUser.has(n)) workByUser.set(n, []);
        workByUser.get(n).push({ ...r, _id: d.id });
      });

      const contentSnap = await getDocs(colContent);
      const supplyCount = new Map();
      const powerCount = new Map();
      const escortCount = new Map();

      contentSnap.forEach(d=>{
        const c = d.data() || {};
        if(!!c.deleted) return;
        const type = c.type;
        const participants = Array.isArray(c.participants) ? c.participants.map(lowerNick) : [];
        for(const p of participants){
          if(!p) continue;
          if(type === "supply") supplyCount.set(p, (supplyCount.get(p)||0) + 1);
          if(type === "power") powerCount.set(p, (powerCount.get(p)||0) + 1);
          if(type === "escort") escortCount.set(p, (escortCount.get(p)||0) + 1);
        }
      });

      const weekAgo = nowMs() - 7*24*60*60*1000;
      const users = Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b));

      const labels = [];
      const avgShiftHours = [];
      const weekHours = [];
      const weekCounts = [];

      const rows = users.map(n=>{
        const u = usersCache.get(n) || {};
        const records = workByUser.get(n) || [];

        const online = records.some(r => r.checkOut == null);

        let lastIn = 0, lastOut = 0;
        for(const r of records){
          if(typeof r.checkIn === "number") lastIn = Math.max(lastIn, r.checkIn);
          if(typeof r.checkOut === "number") lastOut = Math.max(lastOut, r.checkOut);
        }

        let totalWeekMs = 0;
        let weekCnt = 0;

        let totalShiftMs = 0;
        let shiftCnt = 0;

        for(const r of records){
          const ci = r.checkIn;
          const co = (r.checkOut == null) ? nowMs() : r.checkOut;
          if(typeof ci !== "number") continue;

          if(typeof r.checkOut === "number" && r.checkOut > ci){
            totalShiftMs += (r.checkOut - ci);
            shiftCnt += 1;
          }

          const start = Math.max(ci, weekAgo);
          const end = co;
          if(end <= weekAgo) continue;
          if(end > start) totalWeekMs += (end - start);
          if(ci >= weekAgo) weekCnt += 1;
        }

        labels.push(n);
        avgShiftHours.push(shiftCnt ? +(msToHours(totalShiftMs)/shiftCnt).toFixed(2) : 0);
        weekHours.push(+msToHours(totalWeekMs).toFixed(2));
        weekCounts.push(weekCnt);

        const statusHtml = online
          ? `<span class="good">ì ‘ì† O</span>`
          : `<span class="bad">ì ‘ì† X</span>`;

        const pCnt = powerCount.get(n) || 0;
        const sCnt = supplyCount.get(n) || 0;
        const eCnt = escortCount.get(n) || 0;

        const hiddenBadge = u.hidden ? ` <span class="pill" style="opacity:.85;">ìˆ¨ê¹€</span>` : ``;
        const hideText = u.hidden ? "ìˆ¨ê¹€" : "-";
        const hideBtn = `<button class="btn icon" data-togglehide="${n}">${u.hidden ? "ğŸ™ˆ" : "ğŸ‘"}</button>`;

        return `
          <tr>
            <td style="font-weight:900;" class="left">${n}${hiddenBadge}</td>
            <td>${statusHtml}</td>
            <td>${fmt(lastIn)}</td>
            <td>${fmt(lastOut)}</td>
            <td>${(msToHours(totalWeekMs)).toFixed(2)}h</td>
            <td>${pCnt}</td>
            <td>${sCnt}</td>
            <td>${eCnt}</td>
            <td>${hideText}</td>
            <td>${hideBtn}</td>
          </tr>
        `;
      }).join("");

      $("userStatsBody").innerHTML = rows || `<tr><td colspan="10" style="color:rgba(255,255,255,0.65); font-weight:900;">í‘œì‹œí•  ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;

      $("userStatsBody").querySelectorAll("[data-togglehide]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
          const nick = btn.getAttribute("data-togglehide");
          if(!nick) return;
          try{
            const u = usersCache.get(nick) || {};
            await updateDoc(doc(db,"users", nick), { hidden: !u.hidden });
            setTinyStatus("statsMsg","ê°±ì‹  ë˜ì—ˆìŠµë‹ˆë‹¤.");
          }catch{
            showAlert("ìˆ¨ê¹€ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
          }
        });
      });

      buildCharts(labels, avgShiftHours, weekHours, weekCounts);
      setTinyStatus("statsMsg","ê°±ì‹  ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch{
      showAlert("í†µê³„ ê°±ì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  }

  // ===== ê´€ë¦¬ì: ìœ ì € ì¶”ê°€/ì‚­ì œ/ë¹„ë²ˆ ë³€ê²½ =====
  async function addUser(){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    const n = lowerNick($("newUser").value);
    const p = $("newPass").value;
    if(!n) return showAlert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    if(!p) return showAlert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    try{
      await setDoc(doc(db,"users",n), { password: p, isAdmin:false, hidden:false }, { merge:true });
      $("newUser").value=""; $("newPass").value="";
      showAlert("ìœ ì € ì¶”ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await refreshUsersCacheOnce();
    }catch{
      showAlert("ìœ ì € ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  }
  async function changePassword(){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    const n = lowerNick($("editUser").value);
    const p = $("editPass").value;
    if(!n || !p) return showAlert("ë‹‰ë„¤ì„ê³¼ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    try{
      await updateDoc(doc(db,"users",n), { password: p });
      $("editPass").value="";
      showAlert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch{
      showAlert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  }
  async function deleteUser(){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    const n = lowerNick($("editUser").value);
    if(!n) return showAlert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    if(n === currentUser) return showAlert("ë³¸ì¸ ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    const ok = confirm("ì •ë§ë¡œ í•´ë‹¹ ìœ ì €ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
    if(!ok) return;
    try{
      await deleteDoc(doc(db,"users",n));
      showAlert("ìœ ì € ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await refreshUsersCacheOnce();
    }catch{
      showAlert("ìœ ì € ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  }
  async function resetWorkAll(){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    const ok = confirm("ì •ë§ë¡œ ê·¼íƒœ ê¸°ë¡ì„ ì „ì²´ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    if(!ok) return;
    try{
      const snap = await getDocs(colWork);
      const ops = [];
      snap.forEach(d => ops.push(deleteDoc(d.ref)));
      await Promise.all(ops);
      showAlert("ê·¼íƒœ ê¸°ë¡ ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await refreshKPI();
    }catch{
      showAlert("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  }

  $("refreshStatsBtn").addEventListener("click", refreshStatsAdmin);
  $("toggleGraphsBtn").addEventListener("click", ()=>{
    const wrap = $("graphsWrap");
    if(!wrap) return;
    const open = wrap.style.display !== "none";
    wrap.style.display = open ? "none" : "block";
    $("toggleGraphsBtn").textContent = open ? "ê·¸ë˜í”„ í¼ì¹˜ê¸°" : "ê·¸ë˜í”„ ì ‘ê¸°";
  });
  $("addUserBtn").addEventListener("click", addUser);
  $("changePassBtn").addEventListener("click", changePassword);
  $("deleteUserBtn").addEventListener("click", deleteUser);
  $("resetWorkBtn").addEventListener("click", resetWorkAll);

  // ===== ê·¼íƒœ ê´€ë¦¬ =====
  function rebuildAdminSelectors(){
    if(!currentIsAdmin) return;
    const sel = $("workUserSelect");
    if(!sel) return;
    const users = Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b));
    const cur = sel.value;
    sel.innerHTML = users.map(n => `<option value="${n}">${n}</option>`).join("");
    if(cur && users.includes(cur)) sel.value = cur;
  }
  function setWorkMsg(msg){ setTinyStatus("workMsg", msg); }

  function parseLocalDateTime(str){
    const s = String(str||"").trim();
    if(!s) return null;
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/);
    if(!m) return null;
    const y = +m[1], mo = +m[2]-1, d = +m[3], hh = +m[4], mm = +m[5];
    const dt = new Date(y,mo,d,hh,mm,0,0);
    const ms = dt.getTime();
    return Number.isFinite(ms) ? ms : null;
  }
  function toInputStr(ms){
    if(!ms) return "";
    const d = new Date(ms);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
  }

  async function loadWorkList(){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    const nick = lowerNick($("workUserSelect").value);
    if(!nick) return showAlert("ìœ ì €ë¥¼ ì„ íƒí•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    setWorkMsg("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...");

    try{
      const snap = await getDocs(query(colWork, where("nickname","==", nick)));
      const recs = [];
      snap.forEach(d=>{
        const r = d.data() || {};
        recs.push({ id: d.id, checkIn: r.checkIn ?? null, checkOut: r.checkOut ?? null });
      });

      recs.sort((a,b)=>safeNum(b.checkIn)-safeNum(a.checkIn));

      const rows = recs.slice(0, 120).map(r=>{
        const dur = (typeof r.checkIn === "number")
          ? ((typeof r.checkOut === "number" ? r.checkOut : nowMs()) - r.checkIn)
          : 0;
        const durText = r.checkIn ? `${msToHours(Math.max(0,dur)).toFixed(2)}h` : "-";
        return `
          <tr>
            <td style="font-weight:900;">${r.id}</td>
            <td>${fmt(r.checkIn)}</td>
            <td>${fmt(r.checkOut)}</td>
            <td>${durText}</td>
            <td><button class="btn icon" data-workedit="${r.id}">ìˆ˜ì •</button></td>
            <td><button class="btn danger icon" data-workdel="${r.id}">ì‚­ì œ</button></td>
          </tr>
        `;
      }).join("");

      $("workBody").innerHTML = rows || `<tr><td colspan="6" style="color:rgba(255,255,255,0.65); font-weight:900;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;

      $("workBody").querySelectorAll("[data-workdel]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-workdel");
          if(!id) return;
          const ok = confirm("í•´ë‹¹ ê·¼íƒœ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
          if(!ok) return;
          try{
            await deleteDoc(doc(db,"workRecords", id));
            setWorkMsg("ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            await loadWorkList();
          }catch{
            showAlert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
          }
        });
      });

      $("workBody").querySelectorAll("[data-workedit]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-workedit");
          if(!id) return;
          await openWorkEditModal(id);
        });
      });

      setWorkMsg("ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
    }catch{
      showAlert("ê·¼íƒœ ëª©ë¡ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      setWorkMsg("");
    }
  }

  async function forceCheckIn(){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    const nick = lowerNick($("workUserSelect").value);
    if(!nick) return showAlert("ìœ ì €ë¥¼ ì„ íƒí•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    try{
      const openSnap = await getDocs(query(colWork, where("nickname","==", nick), where("checkOut","==", null)));
      if(!openSnap.empty){
        return showAlert("ì´ë¯¸ ì¶œê·¼ ì¤‘ì¸ ê¸°ë¡ì´ ì¡´ì¬í•©ë‹ˆë‹¤.");
      }
      await addDoc(colWork, { nickname: nick, checkIn: nowMs(), checkOut: null, forcedBy: currentUser, forcedAt: nowMs() });
      showAlert("ê°•ì œ ì¶œê·¼ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadWorkList();
    }catch{
      showAlert("ê°•ì œ ì¶œê·¼ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  }

  async function forceCheckOut(){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    const nick = lowerNick($("workUserSelect").value);
    if(!nick) return showAlert("ìœ ì €ë¥¼ ì„ íƒí•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");

    try{
      const openSnap = await getDocs(query(colWork, where("nickname","==", nick), where("checkOut","==", null)));
      if(openSnap.empty){
        return showAlert("ì¶œê·¼ ì¤‘ì¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
      }
      await updateDoc(openSnap.docs[0].ref, { checkOut: nowMs(), forcedOutBy: currentUser, forcedOutAt: nowMs() });
      showAlert("ê°•ì œ í‡´ê·¼ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadWorkList();
    }catch{
      showAlert("ê°•ì œ í‡´ê·¼ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  }

  $("loadWorkBtn").addEventListener("click", loadWorkList);
  $("forceInBtn").addEventListener("click", forceCheckIn);
  $("forceOutBtn").addEventListener("click", forceCheckOut);

  // ê·¼íƒœ ìˆ˜ì • ëª¨ë‹¬
  const workEditModal = $("workEditModal");
  function openWorkEditModalUI(){
    workEditModal.classList.add("show");
    workEditModal.setAttribute("aria-hidden","false");
  }
  function closeWorkEditModalUI(){
    workEditModal.classList.remove("show");
    workEditModal.setAttribute("aria-hidden","true");
  }
  $("workEditCloseTop").addEventListener("click", closeWorkEditModalUI);
  $("workEditCancel").addEventListener("click", closeWorkEditModalUI);
  workEditModal.addEventListener("click", (e)=>{ if(e.target===workEditModal) closeWorkEditModalUI(); });

  async function openWorkEditModal(workId){
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    try{
      const snap = await getDoc(doc(db,"workRecords", workId));
      if(!snap.exists()) return showAlert("í•´ë‹¹ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      const r = snap.data() || {};
      editingWorkId = workId;
      $("workEditIn").value = toInputStr(r.checkIn);
      $("workEditOut").value = r.checkOut ? toInputStr(r.checkOut) : "";
      $("workEditMeta").textContent = `â€¢ ê¸°ë¡ID: ${workId} / ìœ ì €: ${lowerNick(r.nickname||"-")}`;
      openWorkEditModalUI();
    }catch{
      showAlert("ê·¼íƒœ ìˆ˜ì • ëª¨ë‹¬ì„ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  }

  $("workEditSave").addEventListener("click", async ()=>{
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    if(!editingWorkId) return showAlert("ìˆ˜ì • ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.");

    const ci = parseLocalDateTime($("workEditIn").value);
    const co = parseLocalDateTime($("workEditOut").value);

    if(ci == null) return showAlert("ì¶œê·¼ ì‹œê°„ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    if(co != null && co < ci) return showAlert("í‡´ê·¼ ì‹œê°„ì´ ì¶œê·¼ ì‹œê°„ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    try{
      await updateDoc(doc(db,"workRecords", editingWorkId), {
        checkIn: ci,
        checkOut: (co == null ? null : co),
        editedBy: currentUser,
        editedAt: nowMs()
      });
      closeWorkEditModalUI();
      showAlert("ê·¼íƒœ ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadWorkList();
    }catch{
      showAlert("ê·¼íƒœ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  });

  // ===== ê¶Œí•œ/ìˆ¨ê¹€ =====
  function getSelectedRoleNicks(){
    const boxes = Array.from(document.querySelectorAll("#rolesBody input[type=checkbox][data-rolenick]"));
    return boxes.filter(b=>b.checked).map(b=>b.getAttribute("data-rolenick")).filter(Boolean);
  }

  function renderRolesList(){
    if(!currentIsAdmin) return;
    const users = Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b));
    const rows = users.map(n=>{
      const u = usersCache.get(n) || {};
      const isAdmin = !!u.isAdmin;
      const hidden = !!u.hidden;
      return `
        <tr>
          <td><input type="checkbox" data-rolenick="${n}"></td>
          <td class="left" style="font-weight:900;">${n}</td>
          <td>${isAdmin ? `<span class="pill admin">ADMIN</span>` : "-"}</td>
          <td>${hidden ? `<span class="pill">ìˆ¨ê¹€</span>` : "-"}</td>
          <td><button class="btn icon" data-rolehide="${n}">${hidden ? "ğŸ™ˆ" : "ğŸ‘"}</button></td>
        </tr>
      `;
    }).join("");
    $("rolesBody").innerHTML = rows || `<tr><td colspan="5" style="color:rgba(255,255,255,0.65); font-weight:900;">ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;

    $("rolesBody").querySelectorAll("[data-rolehide]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const nick = btn.getAttribute("data-rolehide");
        if(!nick) return;
        try{
          const u = usersCache.get(nick) || {};
          await updateDoc(doc(db,"users", nick), { hidden: !u.hidden });
        }catch{
          showAlert("ìˆ¨ê¹€ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
        }
      });
    });
  }

  $("refreshRoleListBtn").addEventListener("click", async ()=>{
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    await refreshUsersCacheOnce();
    renderRolesList();
  });

  $("grantAdminBtn").addEventListener("click", async ()=>{
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    const list = getSelectedRoleNicks();
    if(list.length === 0) return showAlert("ì„ íƒëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.");
    const ok = confirm(`ì„ íƒí•œ ${list.length}ëª…ì—ê²Œ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    if(!ok) return;
    try{
      await Promise.all(list.map(n => updateDoc(doc(db,"users",n), { isAdmin:true })));
      showAlert("ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch{
      showAlert("ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  });

  $("revokeAdminBtn").addEventListener("click", async ()=>{
    if(!currentIsAdmin) return showAlert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    const list = getSelectedRoleNicks();
    if(list.length === 0) return showAlert("ì„ íƒëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.");
    if(list.includes(lowerNick(currentUser))) return showAlert("ë³¸ì¸ ê´€ë¦¬ì ê¶Œí•œì€ í•´ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    const ok = confirm(`ì„ íƒí•œ ${list.length}ëª…ì˜ ê´€ë¦¬ì ê¶Œí•œì„ í•´ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    if(!ok) return;
    try{
      await Promise.all(list.map(n => updateDoc(doc(db,"users",n), { isAdmin:false })));
      showAlert("ê´€ë¦¬ì ê¶Œí•œ í•´ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch{
      showAlert("ê´€ë¦¬ì ê¶Œí•œ í•´ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  });

  // ===== ì¼ë°˜ ìœ ì € í†µê³„ =====
  const publicStatsModal = $("publicStatsModal");
  function openPublicStatsModal(){
    publicStatsModal.classList.add("show");
    publicStatsModal.setAttribute("aria-hidden","false");
  }
  function closePublicStatsModal(){
    publicStatsModal.classList.remove("show");
    publicStatsModal.setAttribute("aria-hidden","true");
  }
  $("publicStatsCloseTop").addEventListener("click", closePublicStatsModal);
  $("publicStatsClose").addEventListener("click", closePublicStatsModal);
  publicStatsModal.addEventListener("click", (e)=>{ if(e.target===publicStatsModal) closePublicStatsModal(); });

  function setPublicStatsMsg(msg){ setTinyStatus("publicStatsMsg", msg); }

  async function refreshPublicStats(){
    if(!currentUser) return showAlert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    setPublicStatsMsg("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...");

    try{
      const users = Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b));

      const workSnap = await getDocs(colWork);
      const workByUser = new Map();
      workSnap.forEach(d=>{
        const r = d.data() || {};
        const n = lowerNick(r.nickname);
        if(!n) return;
        if(!workByUser.has(n)) workByUser.set(n, []);
        workByUser.get(n).push(r);
      });

      const onlineSet = new Set();
      for(const [n, recs] of workByUser.entries()){
        if(recs.some(r => r.checkOut == null)) onlineSet.add(n);
      }

      const contentSnap = await getDocs(colContent);
      const supplyCount = new Map();
      const powerCount = new Map();
      const escortCount = new Map();

      contentSnap.forEach(d=>{
        const c = d.data() || {};
        if(!!c.deleted) return;
        const type = c.type;
        const participants = Array.isArray(c.participants) ? c.participants.map(lowerNick) : [];
        for(const p of participants){
          if(!p) continue;
          if(type === "supply") supplyCount.set(p, (supplyCount.get(p)||0) + 1);
          if(type === "power") powerCount.set(p, (powerCount.get(p)||0) + 1);
          if(type === "escort") escortCount.set(p, (escortCount.get(p)||0) + 1);
        }
      });

      const weekAgo = nowMs() - 7*24*60*60*1000;

      const rows = users.map(n=>{
        const recs = workByUser.get(n) || [];

        let totalWeekMs = 0;
        let lastSeen = 0;
        for(const r of recs){
          if(typeof r.checkIn === "number") lastSeen = Math.max(lastSeen, r.checkIn);
          if(typeof r.checkOut === "number") lastSeen = Math.max(lastSeen, r.checkOut);

          const ci = r.checkIn;
          const co = (r.checkOut == null) ? nowMs() : r.checkOut;
          if(typeof ci !== "number") continue;

          const start = Math.max(ci, weekAgo);
          const end = co;
          if(end <= weekAgo) continue;
          if(end > start) totalWeekMs += (end - start);
        }

        const online = onlineSet.has(n);
        const status = online ? `<span class="good">ì ‘ì† O</span>` : `<span class="bad">ì ‘ì† X</span>`;

        const pCnt = powerCount.get(n) || 0;
        const sCnt = supplyCount.get(n) || 0;
        const eCnt = escortCount.get(n) || 0;

        return `
          <tr>
            <td class="left" style="font-weight:900;">${n}</td>
            <td>${status}</td>
            <td style="font-weight:900;">${msToHours(totalWeekMs).toFixed(2)}h</td>
            <td>${fmt(lastSeen)}</td>
            <td>${pCnt}</td>
            <td>${sCnt}</td>
            <td>${eCnt}</td>
          </tr>
        `;
      }).join("");

      $("publicStatsBody").innerHTML = rows || `<tr><td colspan="7" style="color:rgba(255,255,255,0.65); font-weight:900;">í‘œì‹œí•  ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      setPublicStatsMsg("ê°±ì‹  ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch{
      showAlert("ìœ ì € í†µê³„ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
      setPublicStatsMsg("");
    }
  }

  $("publicStatsBtn").addEventListener("click", async ()=>{
    openPublicStatsModal();
    await refreshPublicStats();
  });
  $("publicStatsRefreshBtn").addEventListener("click", refreshPublicStats);

  // ===== ë©”ì¸ ì—°ê²° =====
  $("loginBtn").addEventListener("click", login);
  $("logoutBtn").addEventListener("click", logout);
  $("checkInBtn").addEventListener("click", checkIn);
  $("checkOutBtn").addEventListener("click", checkOut);
  $("supplyBtn").addEventListener("click", ()=> openContentModalCreate("supply"));
  $("powerBtn").addEventListener("click", ()=> openContentModalCreate("power"));
  $("escortBtn").addEventListener("click", ()=> openContentModalCreate("escort"));
  $("adminBtn").addEventListener("click", toggleAdminPanel);

  // ===== ë¶€íŒ… =====
  (async function boot(){
    setWhoami();
    setLoggedInUI(false);
    try{ await refreshUsersCacheOnce(); }catch{}
  })();

</script>
</body>
</html>

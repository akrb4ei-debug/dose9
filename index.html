<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>도스온라인 국방부 근퇴시스템</title>

<style>
  :root{
    --bg:#111;
    --panel:#1a1a1a;
    --border:#333;
    --border2:#444;
    --txt:#eee;
    --muted:#aaa;
    --chip:#222;
  }
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Segoe UI,Apple SD Gothic Neo,Malgun Gothic,system-ui}
  .top{
    padding:14px 22px;background:var(--panel);border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap
  }
  .container{
    display:flex;gap:20px;padding:20px;max-width:1500px;margin:0 auto;
  }
  .col{flex:1;min-width:340px}
  .card{
    background:var(--panel);padding:15px;border:1px solid var(--border);border-radius:12px;margin-bottom:15px;
  }
  h2,h3{margin:0 0 10px 0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:12px;color:var(--muted)}
  .chip{
    display:inline-flex;gap:6px;align-items:center;
    background:var(--chip);border:1px solid var(--border2);border-radius:999px;padding:6px 10px;font-size:12px
  }
  button{
    background:#222;color:#fff;border:1px solid var(--border2);
    padding:7px 12px;border-radius:8px;cursor:pointer;margin:3px;
  }
  button:hover{background:#333;}
  button.ghost{background:transparent}
  button.danger{border-color:#8b2f2f;background:#2a1414}
  button.danger:hover{background:#3a1717}
  input,select{
    background:#111;color:#fff;border:1px solid var(--border2);
    padding:7px 10px;border-radius:8px;margin:3px;
  }
  input.wide{width:260px;max-width:100%}
  select.wide{width:260px;max-width:100%}
  .hidden{display:none}
  .stat{
    background:#111;border:1px solid #222;border-radius:10px;
    padding:10px 12px;margin-bottom:8px;line-height:1.5
  }
  .hr{height:1px;background:#2a2a2a;margin:12px 0}
  .badge{font-size:11px;padding:2px 8px;border:1px solid #444;border-radius:999px;color:#ddd}
  .right{margin-left:auto}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid #2a2a2a;padding:8px 6px;text-align:left;font-size:13px;vertical-align:top}
  .table th{color:#cfcfcf;font-weight:600}
  .pillbtn{padding:6px 10px;border-radius:999px}
  .anim{transition:max-height .25s ease, opacity .25s ease, transform .25s ease}
  .collapse{max-height:0; opacity:0; transform:translateY(-6px); overflow:hidden}
  .expand{max-height:1200px; opacity:1; transform:translateY(0); overflow:hidden}
  .barWrap{margin-top:10px;display:flex;flex-direction:column;gap:8px}
  .barRow{display:grid;grid-template-columns:180px 1fr 90px;gap:10px;align-items:center}
  .barBg{height:10px;border:1px solid #333;border-radius:999px;overflow:hidden;background:#0c0c0c}
  .barFill{height:100%;background:#dcdcdc}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
  query, where, orderBy, limit, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyAJ6MhR1JsGbvieb8akAi4Zpas_W3uaNJ4",
  authDomain:"dosep-b6ee3.firebaseapp.com",
  projectId:"dosep-b6ee3"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const colUsers=collection(db,"users");
const colWork=collection(db,"workRecords");
const colContent=collection(db,"contentRecords");

let currentUser=null;
let currentUserData=null;
let usersCache=new Map();

let contentPage=0;
const PAGE_SIZE=20;

let autoTimer=null;
let sortMode="rank_desc"; // 개인용(메모리). 새로고침 시 초기화됨.
let lastStatsMap=null; // 그래프용 캐시

const RANKS=["군의관","하사","중사","상사","원사","소위","중위","대위","소령","중령","대령"];
const DEPTS=[
  "참모부","국군 경비사령부","국군 특수전사령부","국군 방첩사령부","제 1경비단","군사경찰단",
  "제1공수특수전여단","제3공수특전여단","제820방첩부대","국군의무사령부"
];

function $(id){return document.getElementById(id);}
function show(id,f){const el=$(id); if(el) el.classList.toggle("hidden",!f);}
function isAdmin(){return !!currentUserData?.isAdmin || !!currentUserData?.isadmin;}

function err(e){
  if(e?.code==="permission-denied") return "Firestore 권한 문제(Rules 확인)";
  if(e?.code==="resource-exhausted") return "할당량 초과(오늘 0시 이후 복구 또는 업그레이드)";
  if(e?.code==="failed-precondition") return "Firestore 인덱스 필요(콘솔 링크로 생성)";
  return "오류 발생 (F12 콘솔 확인)";
}

function stopAuto(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } }
function startAuto(){
  stopAuto();
  autoTimer = setInterval(()=>{ refreshAll(false); }, 60*1000); // 1분
}
function setStatus(msg){
  const el=$("statusMsg"); if(!el) return;
  el.textContent=msg||"";
  if(msg){ setTimeout(()=>{ if(el) el.textContent=""; }, 1400); }
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function normalizeUserDoc(d){
  const out = {...d};
  if(out.isadmin!==undefined && out.isAdmin===undefined) out.isAdmin = out.isadmin;
  if(out.ishidden!==undefined && out.isHidden===undefined) out.isHidden = out.ishidden;
  if(out.dept!==undefined && out.department===undefined) out.department = out.dept;
  if(out.rankname!==undefined && out.rank===undefined) out.rank = out.rankname;
  return out;
}

function rankIndex(rank){
  const i=RANKS.indexOf(rank||"");
  return i>=0?i: -1;
}

function toDateOrNull(ts){
  if(!ts) return null;
  if(ts instanceof Date) return ts;
  if(typeof ts.toDate === "function") return ts.toDate();
  if(typeof ts.seconds === "number") return new Date(ts.seconds*1000);
  return null;
}
function toDatetimeLocalValue(d){
  if(!d) return "";
  const pad=n=>String(n).padStart(2,"0");
  const yyyy=d.getFullYear();
  const mm=pad(d.getMonth()+1);
  const dd=pad(d.getDate());
  const hh=pad(d.getHours());
  const mi=pad(d.getMinutes());
  return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
}
function parseDatetimeLocal(str){
  if(!str) return null;
  const d = new Date(str);
  if(isNaN(d.getTime())) return null;
  return d;
}

/* =========================
   로그인/기본
   ========================= */

async function login(){
  try{
    const id=$("loginId").value.trim();
    const pw=$("loginPw").value;

    const snap=await getDoc(doc(db,"users",id));
    if(!snap.exists()) return alert("등록된 유저 없음");
    const data=normalizeUserDoc(snap.data());
    if(String(data.password ?? "")!==String(pw)) return alert("비밀번호 오류");

    currentUser=id;
    currentUserData=data;

    await loadUsers();
    renderTopBar();

    show("loginBox",false);
    show("mainBox",true);

    await refreshAll(true);
    startAuto();
  }catch(e){
    alert(err(e));
    console.error(e);
  }
}

function logout(){
  stopAuto();
  currentUser=null;
  currentUserData=null;
  usersCache=new Map();
  contentPage=0;
  sortMode="rank_desc";
  lastStatsMap=null;

  $("loginPw").value="";
  show("mainBox",false);
  show("loginBox",true);
}

function renderTopBar(){
  $("userInfo").innerHTML = `
    <span class="chip"><b>${currentUser}</b></span>
    <span class="chip">계급 <b>${currentUserData.rank||"-"}</b></span>
    <span class="chip">부서 <b>${currentUserData.department||"-"}</b></span>
    <span class="chip">관리자 <b>${isAdmin()?"O":"X"}</b></span>
  `;
  show("adminToggleBtn", isAdmin());
  show("adminPanel", false);
}

async function loadUsers(){
  const snap=await getDocs(colUsers);
  usersCache=new Map();
  snap.forEach(d=>usersCache.set(d.id, normalizeUserDoc(d.data())));
  renderAdminUserTable();
  renderAdminWorkUserSelect();
}

/* =========================
   근태(출/퇴)
   ========================= */

async function checkIn(){
  try{
    const q=query(colWork,where("nickname","==",currentUser),where("checkOut","==",null),limit(1));
    if(!(await getDocs(q)).empty) return alert("이미 출근중");
    await addDoc(colWork,{nickname:currentUser,checkIn:serverTimestamp(),checkOut:null});
    await loadStats(); await loadOnline();
  }catch(e){ alert(err(e)); console.error(e); }
}

async function checkOut(){
  try{
    const q=query(colWork,where("nickname","==",currentUser),where("checkOut","==",null),limit(1));
    const snap=await getDocs(q);
    if(snap.empty) return alert("출근 기록 없음");
    await updateDoc(doc(db,"workRecords",snap.docs[0].id),{checkOut:serverTimestamp()});
    await loadStats(); await loadOnline();
  }catch(e){ alert(err(e)); console.error(e); }
}

async function loadOnline(){
  try{
    const openQ = query(colWork, where("checkOut","==",null));
    const openSnap = await getDocs(openQ);
    const openList=[];
    openSnap.forEach(d=>{
      const r=d.data();
      if(r?.nickname) openList.push(r.nickname);
    });

    const adm=isAdmin();
    const filtered = openList.filter(n=>{
      const ud = usersCache.get(n);
      if(!ud) return true;
      if(adm) return true;
      return !ud.isHidden; // 일반 유저는 접속목록에서 숨김 유저 비표시
    });

    filtered.sort((a,b)=>a.localeCompare(b,"ko"));
    $("onlineArea").innerHTML = filtered.length
      ? filtered.map(n=>`<div class="stat"><b>${n}</b></div>`).join("")
      : `<div class="small">현재 출근중인 유저가 없습니다.</div>`;
  }catch(e){
    console.error(e);
    $("onlineArea").innerHTML = `<div class="small">접속 목록을 불러오지 못했습니다.</div>`;
  }
}

/**
 * ✅ 리드 최적화 유지:
 * - 출근중(open)은 checkOut==null 로만 조회
 * - 시간 통계는 최근 7일(checkIn>=7일)만 조회
 */
async function loadStats(){
  try{
    const seven=new Date();
    seven.setDate(seven.getDate()-7);

    const openQ = query(colWork, where("checkOut","==",null));
    const openSnap = await getDocs(openQ);
    const openSet = new Set();
    openSnap.forEach(d=>{
      const r=d.data();
      if(r?.nickname) openSet.add(r.nickname);
    });

    const recentQ = query(colWork, where("checkIn",">=", seven));
    const recentSnap = await getDocs(recentQ);

    const map=new Map();
    usersCache.forEach((_,name)=>map.set(name,{total:0,open:openSet.has(name)}));

    recentSnap.forEach(d=>{
      const r=d.data();
      if(!r?.nickname) return;
      if(!map.has(r.nickname)) map.set(r.nickname,{total:0,open:openSet.has(r.nickname)});
      if(r.checkIn && r.checkOut){
        const ci=toDateOrNull(r.checkIn);
        const co=toDateOrNull(r.checkOut);
        if(!ci || !co) return;
        const sec=Math.max(0, Math.floor((co-ci)/1000));
        map.get(r.nickname).total+=sec;
      }
    });

    lastStatsMap = map;
    renderStats(map);

    // 그래프가 열려 있으면 같이 갱신
    if(isAdmin()){
      const panel = $("graphPanel");
      if(panel && panel.classList.contains("expand")){
        renderGraphFromStats(map);
      }
    }

  }catch(e){
    alert(err(e));
    console.error(e);
  }
}

function sortedUserEntries(map){
  const entries = Array.from(usersCache.entries()).map(([name,ud])=>{
    const st = map.get(name)||{total:0,open:false};
    return {name, ud, st};
  });
  const cmpName = (a,b)=>a.name.localeCompare(b.name,"ko");

  if(sortMode==="rank_desc"){
    entries.sort((a,b)=>{
      const ra=rankIndex(a.ud.rank), rb=rankIndex(b.ud.rank);
      if(ra!==rb) return rb-ra;
      return cmpName(a,b);
    });
  }else if(sortMode==="rank_asc"){
    entries.sort((a,b)=>{
      const ra=rankIndex(a.ud.rank), rb=rankIndex(b.ud.rank);
      if(ra!==rb) return ra-rb;
      return cmpName(a,b);
    });
  }else if(sortMode==="online_first"){
    entries.sort((a,b)=>{
      if(a.st.open!==b.st.open) return (b.st.open?1:0)-(a.st.open?1:0);
      return cmpName(a,b);
    });
  }else{
    entries.sort(cmpName);
  }
  return entries;
}

function renderStats(map){
  const entries = sortedUserEntries(map);

  let html="";
  for(const it of entries){
    const {name,ud,st}=it;
    html+=`<div class="stat">
      <div class="row">
        <b>${name}</b>
        <span class="badge">${ud.rank||"-"}</span>
        <span class="badge">${ud.department||"-"}</span>
        ${ud.isHidden?`<span class="badge">숨김</span>`:""}
        <span class="right small">접속 ${st.open?"O":"X"} · 최근7일 ${Math.floor(st.total/3600)}시간</span>
      </div>
      ${isAdmin()?`<div class="row" style="margin-top:8px;">
        <button class="pillbtn" data-force="${escapeHtml(name)}">강제퇴근</button>
      </div>`:""}
    </div>`;
  }
  $("statsArea").innerHTML=html||"데이터 없음";

  if(isAdmin()){
    document.querySelectorAll("[data-force]").forEach(btn=>{
      btn.onclick=async()=>{
        try{
          const name=btn.getAttribute("data-force");
          if(!confirm(`${name} 님을 강제 퇴근 처리하시겠습니까?`)) return;
          const q=query(colWork,where("nickname","==",name),where("checkOut","==",null));
          const snap=await getDocs(q);
          for(const d of snap.docs){
            await updateDoc(doc(db,"workRecords",d.id),{checkOut:serverTimestamp()});
          }
          await loadStats();
          await loadOnline();
        }catch(e){ alert(err(e)); console.error(e); }
      };
    });
  }
}

/* =========================
   컨텐츠(보급/송전소/차량수호) V2 유지
   ========================= */

async function createContent(type){
  let names=prompt("참여자(콤마구분)\n※ 본인은 자동 포함됩니다.");
  if(names===null) return;
  let arr=names.split(",").map(x=>x.trim()).filter(x=>x);
  if(!arr.includes(currentUser)) arr.unshift(currentUser);
  if(arr.length===0) return alert("참여자가 0명이면 저장하지 않습니다.");

  await addDoc(colContent,{
    type,
    writer:currentUser,
    participants:arr,
    time:serverTimestamp()
  });
  loadContent();
}

async function loadContent(){
  try{
    const seven=new Date();
    seven.setDate(seven.getDate()-7);

    const q=query(
      colContent,
      where("time",">=",seven),
      orderBy("time","desc"),
      limit((contentPage+1)*PAGE_SIZE)
    );

    const snap=await getDocs(q);
    const docs=snap.docs;

    let html="";
    docs.slice(contentPage*PAGE_SIZE,(contentPage+1)*PAGE_SIZE).forEach(d=>{
      const r=d.data();
      // 일반 유저: 컨텐츠 목록에서 숨김 작성자 기록 숨김
      if(!isAdmin()){
        const writerHidden = usersCache.get(r.writer)?.isHidden;
        if(writerHidden) return;
      }
      html+=`<div class="stat">
        <b>${r.type}</b> | <b>${r.writer}</b><br>
        참여자: ${Array.isArray(r.participants)?r.participants.join(", "):""}
      </div>`;
    });

    $("contentArea").innerHTML=html||"기록 없음";

    $("pageArea").innerHTML="";
    const hasNext = docs.length > (contentPage+1)*PAGE_SIZE;
    if(hasNext){
      const next=document.createElement("button");
      next.textContent="다음 페이지";
      next.onclick=()=>{contentPage++;loadContent();}
      $("pageArea").appendChild(next);
    }
    if(contentPage>0){
      const prev=document.createElement("button");
      prev.textContent="이전 페이지";
      prev.onclick=()=>{contentPage--;loadContent();}
      $("pageArea").appendChild(prev);
    }

  }catch(e){
    alert(err(e));
    console.error(e);
  }
}

async function refreshAll(showToast){
  try{ await loadUsers(); }catch(e){ console.error(e); }
  try{ await loadStats(); }catch(e){ console.error(e); }
  try{ await loadOnline(); }catch(e){ console.error(e); }
  try{ await loadContent(); }catch(e){ console.error(e); }
  if(showToast) setStatus("갱신되었습니다.");
}

/* =========================
   관리자 패널 토글 + 유저 관리(V2)
   ========================= */

function toggleAdminPanel(){
  if(!isAdmin()) return;
  const open = !$("adminPanel").classList.contains("hidden");
  show("adminPanel", open?false:true);
  if(!open){
    renderAdminUserTable();
    renderAdminWorkUserSelect();
  }
}

function renderAdminUserTable(){
  if(!isAdmin()) return;
  const tbody = $("adminUserTbody");
  if(!tbody) return;

  const q = $("adminUserSearch")?.value?.trim()?.toLowerCase() || "";
  const rows = [];

  for(const [name,ud] of usersCache.entries()){
    if(q && !name.toLowerCase().includes(q)) continue;
    rows.push({name,ud});
  }

  rows.sort((a,b)=>a.name.localeCompare(b.name,"ko"));

  tbody.innerHTML = rows.map(({name,ud})=>{
    const rankOptions = `<option value="">-</option>` + RANKS.map(r=>`<option value="${r}" ${ud.rank===r?"selected":""}>${r}</option>`).join("");
    const deptOptions = `<option value="">-</option>` + DEPTS.map(d=>`<option value="${d}" ${ud.department===d?"selected":""}>${d}</option>`).join("");
    const adminChecked = (ud.isAdmin===true) ? "checked" : "";
    const hiddenChecked = (ud.isHidden===true) ? "checked" : "";
    const pw = (ud.password!==undefined && ud.password!==null) ? String(ud.password) : "";
    return `
      <tr data-user="${escapeHtml(name)}">
        <td>
          <div class="row">
            <input type="checkbox" class="adminPick" />
            <b>${escapeHtml(name)}</b>
          </div>
          <div class="small mono">pw: <span class="pwText" data-pw="${escapeHtml(pw)}">••••</span>
            <button class="pillbtn ghost pwToggle" type="button">보기</button>
          </div>
        </td>
        <td><select class="rankSel wide">${rankOptions}</select></td>
        <td><select class="deptSel wide">${deptOptions}</select></td>
        <td>
          <label class="row"><input type="checkbox" class="adminChk" ${adminChecked}/> <span class="small">관리자</span></label>
          <label class="row"><input type="checkbox" class="hiddenChk" ${hiddenChecked}/> <span class="small">숨김</span></label>
        </td>
        <td>
          <div class="row">
            <input class="pwInput wide" placeholder="새 비밀번호" />
            <button class="pillbtn pwSet" type="button">설정</button>
          </div>
          <div class="row" style="margin-top:6px;">
            <button class="pillbtn ghost saveRow" type="button">저장</button>
            <button class="pillbtn danger delUser" type="button">삭제</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  tbody.querySelectorAll("tr").forEach(tr=>{
    const user = tr.getAttribute("data-user");

    tr.querySelector(".pwToggle")?.addEventListener("click",()=>{
      const span=tr.querySelector(".pwText");
      span.textContent = (span.textContent==="••••") ? (span.getAttribute("data-pw")||"") : "••••";
    });

    tr.querySelector(".pwSet")?.addEventListener("click", async ()=>{
      const v = tr.querySelector(".pwInput")?.value ?? "";
      if(!v) return alert("새 비밀번호를 입력해 주세요.");
      try{
        await updateDoc(doc(db,"users",user), { password: v });
        const ud = usersCache.get(user)||{};
        ud.password = v;
        usersCache.set(user, ud);
        tr.querySelector(".pwText")?.setAttribute("data-pw", escapeHtml(String(v)));
        tr.querySelector(".pwInput").value="";
        setStatus("비밀번호가 설정되었습니다.");
      }catch(e){ alert(err(e)); console.error(e); }
    });

    tr.querySelector(".saveRow")?.addEventListener("click", async ()=>{
      try{
        const rank = tr.querySelector(".rankSel")?.value || "";
        const dept = tr.querySelector(".deptSel")?.value || "";
        const admin = !!tr.querySelector(".adminChk")?.checked;
        const hidden = !!tr.querySelector(".hiddenChk")?.checked;

        await updateDoc(doc(db,"users",user), {
          rank: rank || "",
          department: dept || "",
          isAdmin: admin,
          isHidden: hidden
        });

        const ud = usersCache.get(user)||{};
        ud.rank = rank || "";
        ud.department = dept || "";
        ud.isAdmin = admin;
        ud.isHidden = hidden;
        usersCache.set(user, ud);

        setStatus("저장되었습니다.");
        await loadStats();
        await loadOnline();
        await loadContent();
        renderAdminWorkUserSelect();
      }catch(e){ alert(err(e)); console.error(e); }
    });

    tr.querySelector(".delUser")?.addEventListener("click", async ()=>{
      if(!confirm(`${user} 유저를 삭제하시겠습니까?\n(화이트리스트에서 제거됩니다.)`)) return;
      try{
        await deleteDoc(doc(db,"users",user));
        usersCache.delete(user);
        renderAdminUserTable();
        renderAdminWorkUserSelect();
        await loadStats();
        await loadOnline();
        await loadContent();
        setStatus("삭제되었습니다.");
      }catch(e){ alert(err(e)); console.error(e); }
    });
  });
}

async function adminAddUser(){
  const nick = $("adminAddNick").value.trim();
  const pw = $("adminAddPw").value.trim();
  if(!nick) return alert("닉네임을 입력해 주세요.");
  if(!pw) return alert("비밀번호를 입력해 주세요.");
  try{
    const exists = await getDoc(doc(db,"users",nick));
    if(exists.exists()) return alert("이미 존재하는 유저입니다.");

    await setDoc(doc(db,"users",nick), {
      password: pw,
      isAdmin: false,
      isHidden: false,
      rank: "",
      department: ""
    });

    $("adminAddNick").value="";
    $("adminAddPw").value="";
    await loadUsers();
    setStatus("유저가 추가되었습니다.");
  }catch(e){ alert(err(e)); console.error(e); }
}

async function adminBulkSetAdmin(flag){
  const picks = Array.from(document.querySelectorAll("#adminUserTbody .adminPick"))
    .filter(x=>x.checked)
    .map(x=>x.closest("tr")?.getAttribute("data-user"))
    .filter(Boolean);

  if(picks.length===0) return alert("선택된 유저가 없습니다.");
  if(!confirm(`${picks.length}명에게 관리자 권한을 ${flag?"부여":"해임"}하시겠습니까?`)) return;

  try{
    for(const u of picks){
      await updateDoc(doc(db,"users",u), { isAdmin: flag });
      const ud = usersCache.get(u)||{};
      ud.isAdmin = flag;
      usersCache.set(u, ud);
    }
    renderAdminUserTable();
    await loadStats();
    await loadOnline();
    setStatus("적용되었습니다.");
  }catch(e){ alert(err(e)); console.error(e); }
}

/* =========================
   V3 추가: 그래프(펼치기/접기)
   ========================= */

function toggleGraph(){
  if(!isAdmin()) return;
  const panel=$("graphPanel");
  const isOpen = panel.classList.contains("expand");
  panel.classList.toggle("expand", !isOpen);
  panel.classList.toggle("collapse", isOpen);
  $("graphBtn").textContent = isOpen ? "그래프 펼치기" : "그래프 접기";
  if(!isOpen && lastStatsMap) renderGraphFromStats(lastStatsMap);
}

function renderGraphFromStats(map){
  const entries = sortedUserEntries(map);
  const maxSec = Math.max(1, ...entries.map(e=>e.st.total||0));
  const wrap = $("graphArea");
  if(!wrap) return;

  wrap.innerHTML = `
    <div class="small">* 최근 7일 누적 근무시간(시간) 기준 그래프입니다.</div>
    <div class="barWrap">
      ${entries.map(e=>{
        const hours = Math.floor((e.st.total||0)/3600);
        const pct = Math.round(((e.st.total||0)/maxSec)*100);
        return `
          <div class="barRow">
            <div><b>${escapeHtml(e.name)}</b> <span class="badge">${escapeHtml(e.ud.rank||"-")}</span></div>
            <div class="barBg"><div class="barFill" style="width:${pct}%;"></div></div>
            <div class="small" style="text-align:right;">${hours}h</div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

/* =========================
   V3 추가: 관리자 근태 기록 관리(수정/삭제/전체삭제)
   ========================= */

function renderAdminWorkUserSelect(){
  if(!isAdmin()) return;
  const sel = $("adminWorkUser");
  if(!sel) return;
  const names = Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b,"ko"));
  const cur = sel.value || "";
  sel.innerHTML = `<option value="">유저 선택</option>` + names.map(n=>`<option value="${escapeHtml(n)}" ${n===cur?"selected":""}>${escapeHtml(n)}</option>`).join("");
}

async function adminLoadWorkRecords(){
  if(!isAdmin()) return;
  const user = $("adminWorkUser").value;
  if(!user) return alert("유저를 선택해 주세요.");

  try{
    const q = query(colWork, where("nickname","==",user), orderBy("checkIn","desc"), limit(50));
    const snap = await getDocs(q);

    const rows = snap.docs.map(d=>{
      const r=d.data();
      const ci=toDatetimeLocalValue(toDateOrNull(r.checkIn));
      const co=toDatetimeLocalValue(toDateOrNull(r.checkOut));
      return {id:d.id, ci, co};
    });

    const tbody = $("adminWorkTbody");
    tbody.innerHTML = rows.map(r=>`
      <tr data-id="${escapeHtml(r.id)}">
        <td class="mono">${escapeHtml(r.id.slice(-8))}</td>
        <td><input type="datetime-local" class="ci" value="${escapeHtml(r.ci)}"></td>
        <td><input type="datetime-local" class="co" value="${escapeHtml(r.co)}"></td>
        <td>
          <div class="row">
            <button class="pillbtn ghost save" type="button">저장</button>
            <button class="pillbtn danger del" type="button">삭제</button>
          </div>
        </td>
      </tr>
    `).join("");

    tbody.querySelectorAll("tr").forEach(tr=>{
      const id = tr.getAttribute("data-id");
      tr.querySelector(".save")?.addEventListener("click", async ()=>{
        const ciStr = tr.querySelector(".ci")?.value || "";
        const coStr = tr.querySelector(".co")?.value || "";
        const ci = parseDatetimeLocal(ciStr);
        const co = coStr ? parseDatetimeLocal(coStr) : null;
        if(!ci) return alert("출근 시간이 올바르지 않습니다.");
        if(co && co < ci) return alert("퇴근 시간은 출근 시간보다 빠를 수 없습니다.");

        try{
          await updateDoc(doc(db,"workRecords",id), { checkIn: ci, checkOut: co ? co : null });
          setStatus("저장되었습니다.");
          await loadStats(); await loadOnline();
        }catch(e){ alert(err(e)); console.error(e); }
      });

      tr.querySelector(".del")?.addEventListener("click", async ()=>{
        if(!confirm("이 근태 기록을 삭제하시겠습니까?")) return;
        try{
          await deleteDoc(doc(db,"workRecords",id));
          tr.remove();
          setStatus("삭제되었습니다.");
          await loadStats(); await loadOnline();
        }catch(e){ alert(err(e)); console.error(e); }
      });
    });

    $("adminWorkHint").innerHTML = `<span class="small">현재 선택: <b>${escapeHtml(user)}</b> · 최대 50건 표시</span>`;
    setStatus("근태 기록을 불러왔습니다.");
  }catch(e){
    alert(err(e));
    console.error(e);
  }
}

async function adminDeleteAllWorkOfUser(){
  if(!isAdmin()) return;
  const user = $("adminWorkUser").value;
  if(!user) return alert("유저를 선택해 주세요.");
  if(!confirm(`${user}의 근태 기록을 전부 삭제하시겠습니까?`)) return;
  if(!confirm("정말로 삭제합니다. 되돌릴 수 없습니다.")) return;

  try{
    const q = query(colWork, where("nickname","==",user));
    const snap = await getDocs(q);
    for(const d of snap.docs){
      await deleteDoc(doc(db,"workRecords",d.id));
    }
    $("adminWorkTbody").innerHTML="";
    $("adminWorkHint").innerHTML="";
    setStatus("유저 근태 전체 삭제 완료");
    await loadStats(); await loadOnline();
  }catch(e){ alert(err(e)); console.error(e); }
}

async function adminDeleteAllWork(){
  if(!isAdmin()) return;
  if(!confirm("전체 근태 기록을 전부 삭제하시겠습니까?")) return;
  if(!confirm("정말로 삭제합니다. 되돌릴 수 없습니다.")) return;

  try{
    const snap = await getDocs(colWork);
    for(const d of snap.docs){
      await deleteDoc(doc(db,"workRecords",d.id));
    }
    $("adminWorkTbody").innerHTML="";
    $("adminWorkHint").innerHTML="";
    setStatus("전체 근태 삭제 완료");
    await loadStats(); await loadOnline();
  }catch(e){ alert(err(e)); console.error(e); }
}

/* =========================
   바인딩
   ========================= */

document.addEventListener("DOMContentLoaded",()=>{
  $("loginBtn").addEventListener("click",login);
  $("logoutBtn").addEventListener("click",logout);
  $("refreshBtn").addEventListener("click",()=>refreshAll(true));

  $("inBtn").addEventListener("click",checkIn);
  $("outBtn").addEventListener("click",checkOut);

  $("supplyBtn").addEventListener("click",()=>createContent("보급"));
  $("plantBtn").addEventListener("click",()=>createContent("송전소"));
  $("escortBtn").addEventListener("click",()=>createContent("차량수호"));

  $("sortSel").addEventListener("change",(e)=>{
    sortMode = e.target.value;
    loadStats();
  });

  $("adminToggleBtn").addEventListener("click",toggleAdminPanel);
  $("adminUserSearch").addEventListener("input",renderAdminUserTable);
  $("adminAddBtn").addEventListener("click",adminAddUser);
  $("bulkAdminOn").addEventListener("click",()=>adminBulkSetAdmin(true));
  $("bulkAdminOff").addEventListener("click",()=>adminBulkSetAdmin(false));

  // V3 추가
  $("graphBtn").addEventListener("click",toggleGraph);
  $("adminWorkLoadBtn").addEventListener("click",adminLoadWorkRecords);
  $("adminWorkDelUserBtn").addEventListener("click",adminDeleteAllWorkOfUser);
  $("adminWorkDelAllBtn").addEventListener("click",adminDeleteAllWork);
});
</script>
</head>

<body>

<div id="loginBox" class="card" style="width:350px;margin:100px auto;">
  <h2>로그인</h2>
  <input id="loginId" placeholder="아이디"><br>
  <input id="loginPw" type="password" placeholder="비밀번호"><br>
  <button id="loginBtn">로그인</button>
  <div class="small" style="margin-top:8px;">* 아이디=닉네임으로 판정합니다.</div>
</div>

<div id="mainBox" class="hidden">
  <div class="top">
    <div class="row" id="userInfo"></div>
    <div class="row">
      <span id="statusMsg" class="small"></span>
      <select id="sortSel" class="wide" title="유저 통계 정렬">
        <option value="rank_desc">계급 높은순</option>
        <option value="rank_asc">계급 낮은순</option>
        <option value="online_first">접속자 우선</option>
        <option value="name">이름순</option>
      </select>
      <button id="refreshBtn">새로고침</button>
      <button id="adminToggleBtn" class="ghost hidden">관리</button>
      <button id="logoutBtn">로그아웃</button>
    </div>
  </div>

  <div class="container">

    <div class="col">
      <div class="card">
        <h3>근태</h3>
        <button id="inBtn">출근</button>
        <button id="outBtn">퇴근</button>
        <div class="small" style="margin-top:8px;">* 통계는 최근 7일 기준으로 계산됩니다.</div>
      </div>

      <div class="card">
        <h3>접속 목록(출근중)</h3>
        <div class="small" style="margin-bottom:8px;">* 일반 유저는 ‘숨김 유저’가 보이지 않습니다.</div>
        <div id="onlineArea"></div>
      </div>

      <div class="card">
        <h3>컨텐츠 작성</h3>
        <button id="supplyBtn">보급</button>
        <button id="plantBtn">송전소</button>
        <button id="escortBtn">차량수호</button>
        <div class="small" style="margin-top:8px;">* 컨텐츠 기록은 최근 7일만 표시됩니다.</div>
      </div>

      <div class="card">
        <h3>컨텐츠 기록</h3>
        <div id="contentArea"></div>
        <div id="pageArea" class="row" style="margin-top:10px;"></div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h3>유저 통계</h3>
        <div class="small" style="margin-bottom:8px;">* 접속 O/X = 출근중 여부 / 시간 = 최근 7일 누적</div>
        <div id="statsArea"></div>
      </div>

      <!-- 관리자 패널 -->
      <div id="adminPanel" class="card hidden">
        <h3>관리자 패널</h3>
        <div class="small">* 유저 등록=화이트리스트이며, 계급/부서/숨김/관리자/비밀번호/근태기록을 관리합니다.</div>

        <div class="hr"></div>

        <!-- 그래프 -->
        <div class="row">
          <button id="graphBtn" class="pillbtn" type="button">그래프 펼치기</button>
          <span class="small">* 그래프는 최근 7일 누적시간 기반입니다.</span>
        </div>
        <div id="graphPanel" class="anim collapse" style="margin-top:10px;">
          <div id="graphArea"></div>
        </div>

        <div class="hr"></div>

        <!-- 유저 추가/검색/일괄 -->
        <div class="row">
          <input id="adminAddNick" class="wide" placeholder="추가할 닉네임" />
          <input id="adminAddPw" class="wide" placeholder="초기 비밀번호" />
          <button id="adminAddBtn" type="button">유저 추가</button>
        </div>

        <div class="row" style="margin-top:8px;">
          <input id="adminUserSearch" class="wide" placeholder="유저 검색(닉네임)" />
          <button id="bulkAdminOn" type="button">선택 관리자 부여</button>
          <button id="bulkAdminOff" class="danger" type="button">선택 관리자 해임</button>
        </div>

        <div class="hr"></div>

        <div style="overflow:auto;max-height:420px;border:1px solid #2a2a2a;border-radius:12px;">
          <table class="table">
            <thead>
              <tr>
                <th style="min-width:200px;">유저</th>
                <th style="min-width:200px;">계급</th>
                <th style="min-width:240px;">부서</th>
                <th style="min-width:140px;">권한/숨김</th>
                <th style="min-width:360px;">비밀번호/관리</th>
              </tr>
            </thead>
            <tbody id="adminUserTbody"></tbody>
          </table>
        </div>

        <div class="hr"></div>

        <!-- 근태 기록 관리 -->
        <h3 style="margin-top:0;">근태 기록 관리</h3>
        <div class="small" style="margin-bottom:10px;">
          * 유저 선택 후 ‘최근 기록 불러오기’를 누르면 최대 50건을 불러옵니다.<br>
          * 출근/퇴근 시간을 수정할 수 있으며, 퇴근이 출근보다 빠르면 저장되지 않습니다.
        </div>

        <div class="row">
          <select id="adminWorkUser" class="wide"></select>
          <button id="adminWorkLoadBtn" type="button">최근 기록 불러오기</button>
          <button id="adminWorkDelUserBtn" class="danger" type="button">해당 유저 근태 전체 삭제</button>
          <button id="adminWorkDelAllBtn" class="danger" type="button">전체 근태 삭제</button>
        </div>

        <div id="adminWorkHint" class="small" style="margin-top:8px;"></div>

        <div style="overflow:auto;max-height:420px;border:1px solid #2a2a2a;border-radius:12px;margin-top:10px;">
          <table class="table">
            <thead>
              <tr>
                <th style="min-width:100px;">ID</th>
                <th style="min-width:210px;">출근(수정)</th>
                <th style="min-width:210px;">퇴근(수정)</th>
                <th style="min-width:160px;">작업</th>
              </tr>
            </thead>
            <tbody id="adminWorkTbody"></tbody>
          </table>
        </div>

      </div>
    </div>

  </div>
</div>

</body>
</html>

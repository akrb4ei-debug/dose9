
    // ==== PATCH: in-page toast (no browser alert) ====
    function toast(msg,type="info"){
      const host=$("toastHost") || document.body;
      const el=document.createElement("div");
      el.className="toastMsg "+type;
      el.textContent=String(msg||"");
      host.appendChild(el);
      requestAnimationFrame(()=>el.classList.add("show"));
      setTimeout(()=>{ el.classList.remove("show"); setTimeout(()=>el.remove(),220); }, 2200);
    }
    // 브라우저 alert을 사이트 내 토스트로 대체합니다.
    window.alert = (m)=>toast(m,"info");
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>도스온라인 국방부 근퇴시스템</title>

  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
  --bg:#0b0c0f;
  --panel:#111318;
  --panel2:#171a20;
  --panel3:#1e222a;
  --stroke: rgba(255,255,255,0.10);
  --stroke2: rgba(255,255,255,0.16);
  --ink: rgba(255,255,255,0.92);
  --muted: rgba(255,255,255,0.62);
  --muted2: rgba(255,255,255,0.44);
  --good:#7CFFA8;
  --bad:#FF7C9A;
  --warn:#FFD36A;
  --accent:#AFC3D8; /* steel */
  --accent2:#7F92A6;
  --shadow: 0 18px 60px rgba(0,0,0,0.55);
  --radius: 18px;
}
    *{ box-sizing:border-box; font-family:'Pretendard',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    [hidden]{ display:none !important; }
    body{
  margin:0; min-height:100vh; color:var(--ink);
  background:
    radial-gradient(1200px 900px at 18% 12%, rgba(175,195,216,0.12), transparent 58%),
    radial-gradient(900px 700px at 85% 18%, rgba(255,255,255,0.06), transparent 62%),
    linear-gradient(180deg, #0b0c0f 0%, #101218 45%, #0b0c0f 100%);
  overflow-x:hidden;
}
body::before{
  content:"";
  position:fixed; inset:0; pointer-events:none;
  background:
    repeating-linear-gradient(90deg, rgba(255,255,255,0.02) 0 1px, transparent 1px 6px),
    repeating-linear-gradient(0deg, rgba(0,0,0,0.08) 0 1px, transparent 1px 5px);
  opacity:0.35;
  mix-blend-mode:overlay;
}

      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    /* layout */
    .wrap{ max-width: 1400px; margin: 0 auto; padding: 22px 18px 60px; }
    .topbar{
      position:sticky; top:0; z-index:30;
      background: rgba(10,12,18,0.64);
      backdrop-filter: blur(14px);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px 14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom: 16px;
    }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{
      width:36px; height:36px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.26), transparent 60%),
                  linear-gradient(135deg, rgba(185,198,255,0.75), rgba(46,230,182,0.25));
      border:1px solid rgba(255,255,255,0.22);
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }
    .title{ font-weight:800; letter-spacing: -0.2px; }
    .subtitle{ font-size:12px; color: var(--muted2); margin-top:2px; }
    .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(17,21,32,0.60);
      color: var(--muted);
      font-size: 12px;
    }
    .chip b{ color: var(--ink); }
    .pill{
      appearance:none;
      border: 1px solid var(--stroke2);
      background: rgba(17,21,32,0.68);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      transition: transform .06s ease, border-color .15s ease, background .15s ease;
      box-shadow: 0 10px 24px rgba(0,0,0,0.18);
      font-weight: 700;
    }
    .pill:hover{ border-color: rgba(255,255,255,0.35); background: rgba(17,21,32,0.78); }
    .pill:active{ transform: translateY(1px); }
    .pill.primary{ background: rgba(185,198,255,0.18); border-color: rgba(185,198,255,0.42); }
    .pill.danger{ background: rgba(255,90,120,0.14); border-color: rgba(255,90,120,0.40); }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
      align-items:start;
      max-width: 1180px;
      margin: 0 auto;
    }
    body.admin-open .grid{
      grid-template-columns: 1fr 420px;
      max-width: 1480px;
    }
    .adminCol{
      max-height: calc(100vh - 210px);
      overflow:auto;
      overscroll-behavior: contain;
    }
    body.admin-open [data-view="dashboard"].card:first-of-type{
      transform: translateX(-6px);
      transition: transform .18s ease;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid var(--stroke);
      background: rgba(13,16,24,0.72);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px;
    }
    .card h3{
      margin: 2px 0 10px 0;
      font-weight: 800;
      letter-spacing: -0.2px;
      font-size: 14px;
      color: rgba(255,255,255,0.88);
    }
    .muted{ color: var(--muted); font-size: 12px; line-height: 1.4; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .spacer{ flex:1; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 980px){
      .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .kpi{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(17,21,32,0.58);
      border-radius: 16px;
      padding: 12px 12px;
    }
    .kpi .k{ font-size: 11px; color: var(--muted2); }
    .kpi .v{ font-size: 18px; font-weight: 800; margin-top: 4px; letter-spacing: -0.2px; }
    .good{ color: var(--good); }
    .bad{ color: var(--bad); }
    .warn{ color: var(--warn); }

    /* tables */
    .tableWrap{ overflow:auto; border-radius: 16px; border:1px solid rgba(255,255,255,0.10); }
    table{ width:100%; border-collapse: collapse; min-width: 620px; }
    th,td{ padding: 10px 10px; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 13px; }
    th{ position: sticky; top: 0; z-index: 2; background: rgba(10,12,18,0.75); color: rgba(255,255,255,0.84); }
    tr:hover td{ background: rgba(255,255,255,0.03); }
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 4px 10px; border-radius: 999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      font-size: 12px;
      color: rgba(255,255,255,0.82);
      white-space:nowrap;
    }
    .badge.on{ border-color: rgba(46,230,182,0.40); background: rgba(46,230,182,0.10); color: rgba(46,230,182,0.98); }
    .badge.off{ border-color: rgba(255,90,120,0.40); background: rgba(255,90,120,0.10); color: rgba(255,90,120,0.98); }
    .badge.role{ border-color: rgba(185,198,255,0.40); background: rgba(185,198,255,0.12); }
    .badge.dim{ opacity:.7; }

    /* inputs */
    input,select,textarea{
      background: rgba(17,21,32,0.58);
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--ink);
      padding: 10px 10px;
      border-radius: 14px;
      outline: none;
    }
    textarea{ min-height: 84px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,0.40); }
    .w220{ width: 220px; max-width: 100%; }
    .w320{ width: 320px; max-width: 100%; }

    /* tabs */
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      padding: 9px 12px; border-radius: 999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(17,21,32,0.55);
      color: rgba(255,255,255,0.86);
      cursor:pointer;
      font-weight: 800;
      font-size: 12px;
    }
    .tab.active{ border-color: rgba(185,198,255,0.45); background: rgba(185,198,255,0.12); }

    /* modal */
    body.noscroll{ overflow:hidden !important; height:100vh; }
    .overlay{
      position:fixed; inset:0; z-index:9999;
      background: rgba(0,0,0,0.62);
      display:flex; align-items:center; justify-content:center;
      padding: 18px;
    }
    .modal{
      width: min(1100px, 96vw);
      background: rgba(10,12,18,0.86);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .mTop{ padding: 12px 12px; border-bottom:1px solid rgba(255,255,255,0.10); display:flex; align-items:center; gap:10px; }
    .mTitle{ font-weight: 900; }
    .mBody{ padding: 12px 12px; max-height: 72vh; overflow:auto; overscroll-behavior:contain; }
    .mFoot{ padding: 12px 12px; border-top:1px solid rgba(255,255,255,0.10); display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    .two{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 980px){ .two{ grid-template-columns: 1fr; } }
    .box{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(17,21,32,0.48);
      border-radius: 16px;
      padding: 12px;
    }
    .list{ display:flex; flex-direction:column; gap:8px; margin-top: 10px; }
    .itemRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding: 10px 10px; border-radius: 14px; border:1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.14); }

    /* timeline */
    .timeline{ display:flex; flex-direction:column; gap:10px; }
    .event{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(17,21,32,0.50);
      border-radius: 16px;
      padding: 12px;
    }
    .event .head{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .event .head .t{ font-weight: 900; }
    .event .meta{ color: var(--muted2); font-size: 12px; margin-top: 6px; }
    .event .p{ margin-top: 8px; font-size: 13px; color: rgba(255,255,255,0.88); line-height: 1.5; }

    .tiny{ font-size: 12px; color: var(--muted2); }
    .tinyStatus{ font-size: 12px; color: var(--muted2); margin-left: 8px; }

  
/* ==== PATCH: Admin wide side panel (3-column shift, no auto-down) ==== */
.layout{ display:flex; } /* keep */
body.admin-open .grid{
  grid-template-columns: 1fr 1.3fr 720px !important;
  max-width: 1680px !important;
}
body.admin-open .grid > .card{ grid-column: 2; }
body.admin-open #adminCol{
  grid-column: 3 !important;
  position: relative !important;
  width: auto !important;
  height: auto !important;
  max-height: none !important;
  overflow: auto !important;
  box-shadow: none !important;
}
#adminBackdrop{ display:none !important; }
#adminCol::-webkit-scrollbar{ width:10px; }
#adminCol::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.14); border-radius:12px; }
#adminCol::-webkit-scrollbar-track{ background:transparent; }
/* ==== PATCH: Toast system ==== */
#toastHost{ position:fixed; top:18px; right:18px; z-index:10050; display:flex; flex-direction:column; gap:10px; pointer-events:none; }
.toastMsg{
  pointer-events:none;
  background:rgba(20,22,28,.92);
  border:1px solid rgba(255,255,255,.14);
  border-left:4px solid rgba(199,211,226,.7);
  padding:12px 14px;
  border-radius:14px;
  min-width: 220px;
  max-width: 360px;
  box-shadow:0 18px 50px rgba(0,0,0,.45);
  opacity:0;
  transform: translateY(-8px);
  transition:.22s ease;
  font-weight:700;
}
.toastMsg.show{ opacity:1; transform: translateY(0); }
.toastMsg.success{ border-left-color: rgba(124,255,168,.9); }
.toastMsg.error{ border-left-color: rgba(255,124,154,.9); }
.toastMsg.info{ border-left-color: rgba(199,211,226,.9); }
/* ==== PATCH: slightly brighter gray tone ==== */
:root{
  --bg:#101218;
  --panel:#151823;
  --panel2:#1b1f2b;
  --panel3:#23293a;
  --stroke: rgba(255,255,255,0.12);
}

</style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
      query, where, orderBy, limit, startAfter, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ✅ 사용자 제공 Firebase 설정 반영
    const firebaseConfig = {
      apiKey: "AIzaSyAJ6MhR1JsGbvieb8akAi4Zpas_W3uaNJ4",
      authDomain: "dosep-b6ee3.firebaseapp.com",
      projectId: "dosep-b6ee3",
      storageBucket: "dosep-b6ee3.firebasestorage.app",
      messagingSenderId: "100096560571",
      appId: "1:100096560571:web:7eb2c1255835b6b57c889e"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const colUsers   = collection(db, "users");
    const colWork    = collection(db, "workRecords");
    const colContent = collection(db, "contentRecords");
    const colDeptChat = (dept)=>collection(db, "deptChats", dept, "messages");
    const docDeptNotice = (dept)=>doc(db, "deptNotices", dept);

    const RANKS = ["군의관","하사","중사","상사","원사","소위","중위","대위","소령","중령","대령"];
    const DEPTS = ["참모부","국군 경비사령부","국군 특수전사령부","국군 방첩사령부","제 1경비단","군사경찰단","제1공수특수전여단","제3공수특전여단","제820방첩부대","국군의무사령부"];

    const PAGE_SIZE = 20;
    let currentUser=null;
    let currentUserData=null;
    let usersCache=new Map();
    let lastUsersLoadAt=0;
    const USERS_COOLDOWN_MS = 5*60*1000; // 5분
const USER_PAGE_SIZE = 10;
    let usersPage = 0; // 유저 목록 페이지(10명 단위)

    // content paging
    let contentPage=0;
    let contentFilter="ALL";
    let contentPageCursors=[]; // startAfter cursors
    let contentPageDocs=[];

    // admin work paging
    let workPage=0;
    let workCursors=[];
    let workDocs=[];

    // UI helpers
    const $ = (id)=>document.getElementById(id);
    const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const setStatus=(msg)=>{ const el=$("status"); if(!el) return; el.textContent=msg||""; if(msg) setTimeout(()=>{el.textContent="";},1200); };
    const lockBody=(on)=>document.body.classList.toggle("noscroll", !!on);

    function normalizeUser(d){
      const u={...d};
      if(u.isadmin!==undefined && u.isAdmin===undefined) u.isAdmin=u.isadmin;
      if(u.ishidden!==undefined && u.isHidden===undefined) u.isHidden=u.ishidden;
      if(u.hidden!==undefined && u.isHidden===undefined) u.isHidden=u.hidden;
      if(u.dept!==undefined && u.department===undefined) u.department=u.dept;
      if(u.rankname!==undefined && u.rank===undefined) u.rank=u.rankname;
      if(!Array.isArray(u.deptLeaderOf)) u.deptLeaderOf = Array.isArray(u.deptLeads)?u.deptLeads:(u.deptLeaderOf||[]);
      return u;
    }

// ✅ 로그인 시 1회: 유저 문서 스키마 누락 자동 보정 + 오늘/주간 키 롤오버를 적용합니다.
// - 이 과정은 "읽기(read)"를 늘리지 않고, 필요할 때만 updateDoc을 수행합니다.
async function ensureUserDocDefaultsOnce(userId, userData){
  try{
    const tKey = dayKey(todayStart());       // 오늘 0시 기준 키(YYYY-MM-DD)
    const wsKey = dayKey(weekStartMonday0()); // 이번 주 시작(월) 키(YYYY-MM-DD)

    const patch = {};

    // 필수 필드 기본값
    if(userData.isAdmin === undefined) patch.isAdmin = false;
    if(userData.isHidden === undefined) patch.isHidden = false;
    if(userData.rank === undefined) patch.rank = "";
    if(userData.department === undefined) patch.department = "";
    if(!Array.isArray(userData.deptLeaderOf)) patch.deptLeaderOf = [];

    if(userData.seenNotices === undefined || typeof userData.seenNotices !== "object") patch.seenNotices = {};
    if(userData.contentCounts === undefined || typeof userData.contentCounts !== "object") patch.contentCounts = {supply:0, plant:0, escort:0};
    if(userData.lastContentAt === undefined || typeof userData.lastContentAt !== "object") patch.lastContentAt = {supply:null, plant:null, escort:null};

    // 요약필드(통계/접속용)
    if(userData.isOnline === undefined) patch.isOnline = false;
    if(userData.weekStart === undefined) patch.weekStart = wsKey;
    if(userData.weekSeconds === undefined) patch.weekSeconds = 0;
    if(userData.todayKey === undefined) patch.todayKey = tKey;
    if(userData.todaySeconds === undefined) patch.todaySeconds = 0;
    if(userData.todayCheckIns === undefined) patch.todayCheckIns = 0;

    // 0시 필터 / 주간 필터: 키가 바뀌면 자동 초기화
    if(userData.todayKey && userData.todayKey !== tKey){
      patch.todayKey = tKey;
      patch.todaySeconds = 0;
      patch.todayCheckIns = 0;
    }
    if(userData.weekStart && userData.weekStart !== wsKey){
      patch.weekStart = wsKey;
      patch.weekSeconds = 0;
    }

    // patch가 비어있지 않다면 업데이트
    if(Object.keys(patch).length){
      await updateDoc(doc(db,"users",userId), patch);
      // 로컬에도 반영(즉시 UI 안정화)
      Object.assign(userData, patch);
    }
  }catch(e){
    console.warn("ensureUserDocDefaultsOnce failed:", e);
  }
}
    function isAdmin(){ return !!currentUserData?.isAdmin; }
    function isDeptLeaderOf(dept){
      if(isAdmin()) return true;
      const arr=currentUserData?.deptLeaderOf||[];
      return arr.includes(dept);
    }

    // 날짜키 (KST 기준)
    function kstNow(){
      // 브라우저가 KST가 아닐 수도 있으나, 서버가 한국 기준 운영이라 가정.
      // 보정이 필요하면, 여기서 UTC+9 오프셋을 강제할 수 있음.
      return new Date();
    }
    function dayKey(d){
      const yyyy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,"0");
      const dd=String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function todayStart(){
      const d=kstNow();
      return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0);
    }
    function weekStartMonday0(){
      const d=todayStart();
      const day=d.getDay(); // 0 Sun ... 6 Sat
      const diff=(day===0?6:day-1); // monday=0
      const ws=new Date(d); ws.setDate(d.getDate()-diff);
      return ws; // 00:00
    }
    function fmt(ts){
      if(!ts) return "-";
      const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
      if(!d) return "-";
      const p=(n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
    }
    function secsToHMS(sec){
      sec=Math.max(0, Math.floor(sec||0));
      const h=Math.floor(sec/3600);
      const m=Math.floor((sec%3600)/60);
      return `${h}시간 ${m}분`;
    }

    // ---------- LOGIN ----------
    async function login(){
      try{
        const id=$("loginId").value.trim();
        const pw=$("loginPw").value;
        if(!id||!pw) return alert("아이디/비밀번호를 입력해 주세요.");

        const s=await getDoc(doc(db,"users",id));
        if(!s.exists()) return alert("등록된 유저가 아닙니다.");
        const u=normalizeUser(s.data());
        if(String(u.password??"")!==String(pw)) return alert("비밀번호가 올바르지 않습니다.");

        currentUser=id;
        currentUserData=u;

        await ensureUserDocDefaultsOnce(id, currentUserData);

        $("who").innerHTML = `
          <span class="chip">ID <b>${esc(id)}</b></span>
          <span class="chip">계급 <b>${esc(u.rank||"-")}</b></span>
          <span class="chip">부서 <b>${esc(u.department||"-")}</b></span>
          <span class="chip">관리자 <b>${u.isAdmin?"O":"X"}</b></span>
        `;
        $("btnAdmin").hidden = !u.isAdmin;

        $("loginView").hidden=true;
        $("appView").hidden=false;

        await refreshAll({silent:true});
        await maybeShowNoticeOnce();
      }catch(e){
        console.error(e);
        alert("로그인 중 오류가 발생했습니다. (콘솔 확인)");
      }
    }
    function logout(){
      currentUser=null; currentUserData=null;
      usersCache=new Map();
      $("loginPw").value="";
      $("appView").hidden=true;
      $("loginView").hidden=false;
      setStatus("");
    }

    // ---------- READ MINIMIZATION CORE ----------
    // ✅ 원칙: onSnapshot 사용하지 않음. (자동 리드 없음)
    // ✅ 로그인 시 1회 로드, 이후 "새로고침" 버튼으로만 갱신.

    async function refreshAll({silent}={}){
      await loadUsersOnce();
      await loadDashKpis();
      await loadUserTable();
      await loadContentPage(0);
      if(!silent) setStatus("갱신되었습니다.");
    }

    async function loadUsersOnce({force=false}={}){
      const now=Date.now();
      if(!force && lastUsersLoadAt && (now-lastUsersLoadAt)<USERS_COOLDOWN_MS){
        const remain=Math.ceil((USERS_COOLDOWN_MS-(now-lastUsersLoadAt))/1000);
        setStatus(`유저 목록 갱신 쿨타임: ${remain}초 남았습니다.`);
        return;
      }
      const s=await getDocs(colUsers);
      usersCache=new Map();
      s.forEach(d=>usersCache.set(d.id, normalizeUser(d.data())));
      // 내 data 최신 반영
      const mine=usersCache.get(currentUser);
      if(mine) currentUserData=mine;
      lastUsersLoadAt = Date.now();
    }

    // KPI: 온라인 수 / 오늘 출근(카운트) / 오늘 누적 / 주간 누적
    async function loadDashKpis(){
      const online = Array.from(usersCache.values()).filter(u=>u.isOnline && (!u.isHidden || isAdmin())).length;
      const tKey = dayKey(todayStart());
      let todayIns=0, todaySec=0, weekSec=0;

      const wsKey=dayKey(weekStartMonday0());

      for(const [id,u] of usersCache.entries()){
        if(!isAdmin() && u.isHidden) continue;
        // 오늘
        if(u.todayKey===tKey){
          todayIns += Number(u.todayCheckIns||0);
          todaySec += Number(u.todaySeconds||0);
        }
        // 주간(요약필드가 주차가 다르면 0으로 취급)
        if(u.weekStart===wsKey){
          weekSec += Number(u.weekSeconds||0);
        }
      }

      $("kpiOnline").innerHTML = `<div class="k">현재 접속</div><div class="v ${online? "good":""}">${online}명</div>`;
      $("kpiTodayIn").innerHTML = `<div class="k">오늘 출근 횟수</div><div class="v">${todayIns}</div>`;
      $("kpiTodaySec").innerHTML = `<div class="k">오늘 누적 접속</div><div class="v">${secsToHMS(todaySec)}</div>`;
      $("kpiWeekSec").innerHTML = `<div class="k">이번주 누적 접속</div><div class="v">${secsToHMS(weekSec)}</div>`;
    }

    // 유저 테이블: users만 읽어서 표시(리드 최소)
    async function loadUserTable(){
      const rows=[];
      for(const [id,u] of usersCache.entries()){
        if(!isAdmin() && u.isHidden) continue;
        rows.push({id,u});
      }

      const sort=$("sortUsers").value;

      // "온라인만" 옵션은 목록 자체를 필터링합니다.
      if(sort==="onlineOnly"){
        for(let i=rows.length-1;i>=0;i--){
          if(!rows[i].u.isOnline) rows.splice(i,1);
        }
      }

      rows.sort((a,b)=>{
        const ra=RANKS.indexOf(a.u.rank||"");
        const rb=RANKS.indexOf(b.u.rank||"");
        const onlineA=!!a.u.isOnline, onlineB=!!b.u.isOnline;

        if(sort==="onlineFirst"){
          if(onlineA!==onlineB) return onlineB-onlineA;
        }

        if(sort==="rankHigh"){
          if(ra!==rb) return rb-ra; // 대령(높음)이 먼저
        }else if(sort==="rankLow"){
          if(ra!==rb) return ra-rb;
        }

        return a.id.localeCompare(b.id,"ko");
      });

      // ✅ 10명 단위 페이지네이션
      const total = rows.length;
      const totalPages = Math.max(1, Math.ceil(total / USER_PAGE_SIZE));
      usersPage = Math.min(usersPage, totalPages-1);
      const start = usersPage * USER_PAGE_SIZE;
      const pageRows = rows.slice(start, start + USER_PAGE_SIZE);

      const tKey=dayKey(todayStart());
      const wsKey=dayKey(weekStartMonday0());

      const tb = pageRows.map(({id,u})=>{
        const on = u.isOnline ? `<span class="badge on">접속 O</span>` : `<span class="badge off">접속 X</span>`;
        const rank = `<span class="badge role">${esc(u.rank||"-")}</span>`;
        const dept = `<span class="badge dim">${esc(u.department||"-")}</span>`;
        const last = `<span class="tiny">${esc(fmt(u.isOnline?u.lastCheckIn:u.lastCheckOut))}</span>`;
        const week = (u.weekStart===wsKey) ? secsToHMS(u.weekSeconds||0) : "0시간 0분";
        const today = (u.todayKey===tKey) ? secsToHMS(u.todaySeconds||0) : "0시간 0분";
        const sup=u.contentCounts?.supply||0;
        const pl=u.contentCounts?.plant||0;
        const es=u.contentCounts?.escort||0;
        return `<tr>
          <td><b>${esc(id)}</b></td>
          <td>${rank}</td>
          <td>${dept}</td>
          <td>${on}</td>
          <td>${last}</td>
          <td>${week}</td>
          <td>${today}</td>
          <td>${sup}</td>
          <td>${pl}</td>
          <td>${es}</td>
        </tr>`;
      }).join("");

      $("userTbody").innerHTML = tb || `<tr><td colspan="10" class="tiny">표시할 유저가 없습니다.</td></tr>`;

      // 페이지 UI
      const pInfo=$("userPageInfo");
      if(pInfo) pInfo.textContent = `${usersPage+1} / ${totalPages} (총 ${total}명)`;
      const prev=$("userPrev"), next=$("userNext");
      if(prev) prev.disabled = usersPage<=0;
      if(next) next.disabled = usersPage>=totalPages-1;

      // 쿨타임 표시(유저 목록 읽기 쿨타임)
      const now=Date.now();
      const remain=Math.max(0, USERS_COOLDOWN_MS-(now-lastUsersLoadAt));
      const cd=$("userCooldown");
      if(cd) cd.textContent = lastUsersLoadAt ? (remain>0?`다음 갱신까지 ${Math.ceil(remain/1000)}초`:"지금 갱신 가능합니다.") : "";
    }


    // ---------- CHECK IN/OUT with SUMMARY FIELDS ----------
    async function checkIn(){
      try{
        // 1) 내 users 문서 1회 읽기 (최신 상태)
        const uSnap=await getDoc(doc(db,"users",currentUser));
        if(!uSnap.exists()) return alert("유저 문서가 없습니다.");
        const u=normalizeUser(uSnap.data());

        if(u.isOnline===true && u.openWorkId){
          return alert("이미 출근중입니다.");
        }

        const now = kstNow();
        const tKey = dayKey(todayStart());
        const wsKey = dayKey(weekStartMonday0());

        // 2) workRecords 1건 추가 (write)
        const wr = await addDoc(colWork, {
          nickname: currentUser,
          checkIn: serverTimestamp(),
          checkOut: null,
          durationSec: null,
          dayKey: tKey,
          weekStart: wsKey
        });

        // 3) users 요약 필드 업데이트 (write) — 리드 추가 없음
        const updates={
          isOnline:true,
          openWorkId: wr.id,
          openCheckInAt: serverTimestamp(),
          lastCheckIn: serverTimestamp()
        };

        // 0시 필터(오늘키가 바뀌면 오늘 요약 초기화)
        if(u.todayKey !== tKey){
          updates.todayKey = tKey;
          updates.todaySeconds = 0;
          updates.todayCheckIns = 0;
        }
        updates.todayCheckIns = increment(1);

        // 주간키가 바뀌면 주간 요약 초기화(해당 유저만)
        if(u.weekStart !== wsKey){
          updates.weekStart = wsKey;
          updates.weekSeconds = 0;
        }

        await updateDoc(doc(db,"users",currentUser), updates);

        setStatus("출근 처리되었습니다.");
        await refreshAll({silent:true});
      }catch(e){
        console.error(e);
        alert("출근 처리 중 오류가 발생했습니다.");
      }
    }

    async function checkOut(){
      try{
        const uSnap=await getDoc(doc(db,"users",currentUser));
        if(!uSnap.exists()) return alert("유저 문서가 없습니다.");
        const u=normalizeUser(uSnap.data());

        if(!u.isOnline || !u.openWorkId){
          return alert("출근 기록이 없습니다.");
        }

        // openCheckInAt가 없으면 workRecords에서 1회 더 읽어야 해서 리드 증가
        // → 안전장치로 workRecords를 1회 읽어서 duration을 계산합니다.
        const wrRef = doc(db,"workRecords",u.openWorkId);
        const wrSnap = await getDoc(wrRef); // 1 read
        if(!wrSnap.exists()) return alert("출근 기록을 찾지 못했습니다.");
        const wr = wrSnap.data();
        const ci = wr.checkIn?.toDate ? wr.checkIn.toDate() : null;
        if(!ci) return alert("출근 시간이 아직 확정되지 않았습니다. 잠시 후 다시 시도해 주세요.");

        const co = kstNow();
        const durSec = Math.max(0, Math.floor((co.getTime()-ci.getTime())/1000));

        const tKey = dayKey(todayStart());
        const wsKey = dayKey(weekStartMonday0());

        // workRecords 마감
        await updateDoc(wrRef, {
          checkOut: serverTimestamp(),
          durationSec: durSec
        });

        // users 요약 업데이트
        const updates={
          isOnline:false,
          openWorkId: null,
          openCheckInAt: null,
          lastCheckOut: serverTimestamp()
        };

        // 오늘키/주간키 맞춰서 누적
        if(u.todayKey !== tKey){
          updates.todayKey = tKey;
          updates.todaySeconds = 0;
          updates.todayCheckIns = 0;
        }
        if(u.weekStart !== wsKey){
          updates.weekStart = wsKey;
          updates.weekSeconds = 0;
        }

        updates.todaySeconds = increment(durSec);
        updates.weekSeconds = increment(durSec);

        await updateDoc(doc(db,"users",currentUser), updates);

        setStatus("퇴근 처리되었습니다.");
        await refreshAll({silent:true});
      }catch(e){
        console.error(e);
        alert("퇴근 처리 중 오류가 발생했습니다.");
      }
    }

    // 관리자 강제 출근/퇴근
    async function adminForceIn(nick){
      if(!isAdmin()) return;
      const s=await getDoc(doc(db,"users",nick));
      if(!s.exists()) return alert("유저 없음");
      const u=normalizeUser(s.data());
      if(u.isOnline && u.openWorkId) return alert("이미 출근중");
      // 강제 출근도 동일 처리
      const tKey=dayKey(todayStart());
      const wsKey=dayKey(weekStartMonday0());
      const wr=await addDoc(colWork,{nickname:nick,checkIn:serverTimestamp(),checkOut:null,durationSec:null,dayKey:tKey,weekStart:wsKey});
      const updates={ isOnline:true, openWorkId:wr.id, openCheckInAt:serverTimestamp(), lastCheckIn:serverTimestamp() };
      if(u.todayKey!==tKey){ updates.todayKey=tKey; updates.todaySeconds=0; updates.todayCheckIns=0; }
      updates.todayCheckIns=increment(1);
      if(u.weekStart!==wsKey){ updates.weekStart=wsKey; updates.weekSeconds=0; }
      await updateDoc(doc(db,"users",nick), updates);
      setStatus("강제 출근 완료");
    }
    async function adminForceOut(nick){
      if(!isAdmin()) return;
      const s=await getDoc(doc(db,"users",nick));
      if(!s.exists()) return alert("유저 없음");
      const u=normalizeUser(s.data());
      if(!u.isOnline || !u.openWorkId) return alert("출근중이 아님");
      const wrRef=doc(db,"workRecords",u.openWorkId);
      const wrSnap=await getDoc(wrRef);
      if(!wrSnap.exists()) return alert("출근 기록 없음");
      const wr=wrSnap.data();
      const ci=wr.checkIn?.toDate?wr.checkIn.toDate():null;
      if(!ci) return alert("출근 시간 확정 전");
      const durSec=Math.max(0, Math.floor((kstNow().getTime()-ci.getTime())/1000));
      await updateDoc(wrRef,{checkOut:serverTimestamp(),durationSec:durSec});
      const tKey=dayKey(todayStart());
      const wsKey=dayKey(weekStartMonday0());
      const updates={ isOnline:false, openWorkId:null, openCheckInAt:null, lastCheckOut:serverTimestamp() };
      if(u.todayKey!==tKey){ updates.todayKey=tKey; updates.todaySeconds=0; updates.todayCheckIns=0; }
      if(u.weekStart!==wsKey){ updates.weekStart=wsKey; updates.weekSeconds=0; }
      updates.todaySeconds=increment(durSec);
      updates.weekSeconds=increment(durSec);
      await updateDoc(doc(db,"users",nick), updates);
      setStatus("강제 퇴근 완료");
    }

    // ---------- CONTENT (7일 제한 + 페이지네이션 + 작성 모달) ----------
    function needsOutcome(type){ return type==="보급" || type==="차량수호"; }

    function contentBaseQuery(){
      const since = new Date(kstNow().getTime());
      since.setDate(since.getDate()-7);
      // ✅ 7일 제한
      let qy = query(colContent, where("time", ">=", since), orderBy("time","desc"), limit(PAGE_SIZE));
      if(contentFilter!=="ALL"){
        qy = query(colContent, where("time", ">=", since), where("type","==",contentFilter), orderBy("time","desc"), limit(PAGE_SIZE));
      }
      return qy;
    }

    async function loadContentPage(pageIndex){
      contentPage = pageIndex;
      const since = new Date(kstNow().getTime()); since.setDate(since.getDate()-7);

      let qy;
      if(pageIndex===0){
        qy = contentBaseQuery();
      }else{
        const cursor = contentPageCursors[pageIndex-1];
        if(!cursor){
          // 커서가 없으면 이전 페이지부터 다시 계산
          return loadContentPage(0);
        }
        if(contentFilter==="ALL"){
          qy = query(colContent, where("time", ">=", since), orderBy("time","desc"), startAfter(cursor), limit(PAGE_SIZE));
        }else{
          qy = query(colContent, where("time", ">=", since), where("type","==",contentFilter), orderBy("time","desc"), startAfter(cursor), limit(PAGE_SIZE));
        }
      }

      const snap = await getDocs(qy);
      contentPageDocs = snap.docs;
      // 다음 페이지 커서 저장
      if(snap.docs.length>0){
        contentPageCursors[pageIndex] = snap.docs[snap.docs.length-1];
      }

      renderContentTimeline();
    }

    function renderContentTimeline(){
      const list = $("contentList");
      if(!list) return;
      const items = contentPageDocs.map(d=>{
        const r=d.data();
        const type = r.type || "-";
        const out = needsOutcome(type) ? (r.outcome===true?"O":(r.outcome===false?"X":"-")) : "-";
        const writer = r.writer || "-";
        const time = fmt(r.time);
        const parts = Array.isArray(r.participants)?r.participants:[];
        const boldWriter = `<b style="font-weight:900;">${esc(writer)}</b>`;
        const edited = r.edited?.mode==="admin" ? `<span class="tiny">수정:${esc(r.edited.by||"-")}</span>` :
                      r.edited?.mode==="self" ? `<span class="tiny">(수정됨)</span>` : "";
        const canEdit = isAdmin() || writer===currentUser;
        const canDelete = isAdmin() || writer===currentUser;
        return `
          <div class="event">
            <div class="head">
              <span class="badge">${esc(type)}</span>
              ${needsOutcome(type)?`<span class="badge">${out}</span>`:""}
              <span class="spacer"></span>
              <span class="tiny">${esc(time)}</span>
            </div>
            <div class="meta">${boldWriter} ${edited}</div>
            <div class="p">참여자: ${parts.map(esc).join(", ") || "-"}</div>
            <div class="row" style="margin-top:10px;">
              ${canEdit?`<button class="pill" data-edit="${d.id}">수정</button>`:""}
              ${canDelete?`<button class="pill danger" data-del="${d.id}">삭제</button>`:""}
            </div>
          </div>
        `;
      }).join("");

      list.innerHTML = items || `<div class="tiny">최근 7일 기록이 없습니다.</div>`;

      // paging buttons
      $("contentPageInfo").textContent = `${contentPage+1} 페이지`;
      $("btnPrevContent").disabled = contentPage===0;
      $("btnNextContent").disabled = contentPageDocs.length < PAGE_SIZE;

      // bind edit/delete
      list.querySelectorAll("[data-edit]").forEach(b=>{
        b.onclick=()=>openEditContent(b.getAttribute("data-edit"));
      });
      list.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick=()=>deleteContent(b.getAttribute("data-del"));
      });
    }

    // create content modal
    let createType=null, createSelected=new Set(), createSearch="";
    function openCreate(type){
      createType=type;
      createSelected=new Set([currentUser]); // 작성자 자동 포함
      createSearch="";
      $("cTitle").textContent = `컨텐츠 작성 · ${type}`;
      $("cSearch").value="";
      $("cOutcomeBox").hidden = !needsOutcome(type);
      $("cOutcome").value="-";
      renderCreateUsers();
      renderCreateSelected();
      showModal("createModal", true);
    }
    function renderCreateUsers(){
      const q=(createSearch||"").toLowerCase();
      const names=Array.from(usersCache.keys()).filter(n=>{ const u=usersCache.get(n)||{}; return isAdmin() || !u.isHidden; }).sort((a,b)=>a.localeCompare(b,"ko"));
      const filtered=q?names.filter(n=>n.toLowerCase().includes(q)):names;
      $("cUserList").innerHTML = filtered.map(n=>{
        const checked=createSelected.has(n)?"checked":"";
        return `<label class="itemRow" style="cursor:pointer;">
          <span><b>${esc(n)}</b></span>
          <input type="checkbox" data-cpick="${esc(n)}" ${checked}/>
        </label>`;
      }).join("");
      $("cUserList").querySelectorAll("input[data-cpick]").forEach(cb=>{
        cb.onchange=()=>{
          const n=cb.getAttribute("data-cpick");
          if(cb.checked) createSelected.add(n); else createSelected.delete(n);
          createSelected.add(currentUser);
          renderCreateSelected();
        };
      });
    }
    function renderCreateSelected(){
      const arr=Array.from(createSelected).sort((a,b)=>a.localeCompare(b,"ko"));
      $("cSelected").innerHTML = arr.map(n=>`<span class="badge">${esc(n)}</span>`).join(" ") || `<span class="tiny">선택 없음</span>`;
      $("cCount").textContent = `${arr.length}명`;
    }
    // ---------- OCR (TAB 스크린샷 → 닉네임 자동 선택) ----------
    // - 리드/성능 영향이 없도록, 버튼을 눌렀을 때만 라이브러리를 로드합니다.
    let _tesseractLoaded = false;
    async function ensureTesseract(){
      if(_tesseractLoaded) return;
      await new Promise((resolve, reject)=>{
        const s=document.createElement("script");
        s.src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
        s.onload=()=>resolve();
        s.onerror=()=>reject(new Error("tesseract load failed"));
        document.head.appendChild(s);
      });
      _tesseractLoaded = true;
    }

    function pickNamesFromText(text){
      const raw=(text||"").replace(/\s+/g," ").toLowerCase();
      const names = Array.from(usersCache.keys());
      const found=[];
      for(const n of names){
        if(raw.includes(String(n).toLowerCase())) found.push(n);
      }
      // 긴 닉네임 우선(부분 포함 오탐 줄이기)
      found.sort((a,b)=>b.length-a.length);
      return Array.from(new Set(found));
    }

    async function runOcrForCreate(){
      try{
        const file=$("cOcrFile")?.files?.[0];
        if(!file) return alert("먼저 스크린샷 파일을 선택해 주세요.");
        $("cOcrResult").textContent = "인식 중입니다… (조금만 기다려 주세요)";
        await ensureTesseract();
        const { data } = await Tesseract.recognize(file, "eng+kor");
        const txt = data?.text || "";
        const picked = pickNamesFromText(txt);

        if(picked.length===0){
          $("cOcrResult").textContent = "인식 결과에서 등록된 닉네임을 찾지 못했습니다. (스크린샷 해상도/선명도 확인)";
          return;
        }

        picked.forEach(n=>createSelected.add(n));
        createSelected.add(currentUser);
        renderCreateUsers();
        renderCreateSelected();
        $("cOcrResult").innerHTML = `추천 선택: ${picked.map(n=>`<span class="badge">${esc(n)}</span>`).join(" ")}`;
      }catch(e){
        console.error(e);
        $("cOcrResult").textContent = "OCR 처리 중 오류가 발생했습니다. (콘솔 확인)";
      }
    }

    function createSelectAll(){
      Array.from(usersCache.keys()).forEach(n=>createSelected.add(n));
      createSelected.add(currentUser);
      renderCreateSelected(); renderCreateUsers();
    }
    function createClearAll(){
      createSelected=new Set([currentUser]);
      renderCreateSelected(); renderCreateUsers();
    }
    async function saveCreate(){
      if(!createType) return;
      const parts=Array.from(createSelected).map(s=>s.trim()).filter(Boolean);
      if(parts.length===0) return alert("0명은 저장하지 않습니다.");
      let outcome=null;
      if(needsOutcome(createType)){
        const v=$("cOutcome").value;
        if(v==="O") outcome=true; else if(v==="X") outcome=false; else outcome=null;
      }
      await addDoc(colContent,{
        type:createType,
        writer: currentUser,
        participants: parts,
        outcome,
        time: serverTimestamp(),
        edited: null
      });

      // ✅ users 요약: 컨텐츠 카운트/마지막 참여 업데이트 (요약필드)
      const countField = createType==="보급" ? "contentCounts.supply" : (createType==="송전소" ? "contentCounts.plant" : "contentCounts.escort");
      const lastField  = createType==="보급" ? "contentLast.supply" : (createType==="송전소" ? "contentLast.plant" : "contentLast.escort");

      // 작성자 포함 참여자들의 카운트도 올릴지? (리드 최소 위해 write만)
      // 요구사항: "참여 횟수"는 유저 통계에 보여야 함 → 참여자 전원 업데이트.
      // 20~30명이라도 참여자 수가 많으면 writes가 늘지만 reads는 늘지 않음.
      // (무료 한도에서 reads가 먼저 터지는 상황이므로 여기서는 writes 증가를 감수)
      const uniq = Array.from(new Set(parts));
      for(const nick of uniq){
        await updateDoc(doc(db,"users",nick), {
          [countField]: increment(1),
          [lastField]: serverTimestamp(),
          lastContentAt: serverTimestamp()
        }).catch(()=>{});
      }

      showModal("createModal", false);
      setStatus("작성되었습니다.");
      await loadUsersOnce();
      await loadDashKpis();
      await loadUserTable();
      await loadContentPage(0);
    }

    // edit content modal (participants 수정 + outcome 수정, 권한: 작성자 또는 관리자)
    let editId=null, editData=null, editSelected=new Set(), editSearch="";
    async function openEditContent(id){
      const s=await getDoc(doc(db,"contentRecords",id));
      if(!s.exists()) return alert("기록이 없습니다.");
      const r=s.data();
      if(!(isAdmin() || r.writer===currentUser)) return alert("수정 권한이 없습니다.");

      editId=id; editData=r;
      editSelected=new Set((Array.isArray(r.participants)?r.participants:[]));
      editSelected.add(r.writer||currentUser);
      editSearch="";

      $("eTitle").textContent = `컨텐츠 수정 · ${r.type}`;
      $("eSearch").value="";
      $("eOutcomeBox").hidden = !needsOutcome(r.type);
      $("eOutcome").value = (r.outcome===true?"O":(r.outcome===false?"X":"-"));

      renderEditUsers();
      renderEditSelected();

      showModal("editModal", true);
    }
    function renderEditUsers(){
      const q=(editSearch||"").toLowerCase();
      const names=Array.from(usersCache.keys()).filter(n=>{ const u=usersCache.get(n)||{}; return isAdmin() || !u.isHidden; }).sort((a,b)=>a.localeCompare(b,"ko"));
      const filtered=q?names.filter(n=>n.toLowerCase().includes(q)):names;
      $("eUserList").innerHTML = filtered.map(n=>{
        const checked=editSelected.has(n)?"checked":"";
        return `<label class="itemRow" style="cursor:pointer;">
          <span><b>${esc(n)}</b></span>
          <input type="checkbox" data-epick="${esc(n)}" ${checked}/>
        </label>`;
      }).join("");
      $("eUserList").querySelectorAll("input[data-epick]").forEach(cb=>{
        cb.onchange=()=>{
          const n=cb.getAttribute("data-epick");
          if(cb.checked) editSelected.add(n); else editSelected.delete(n);
          editSelected.add(editData.writer||currentUser);
          renderEditSelected();
        };
      });
    }
    function renderEditSelected(){
      const arr=Array.from(editSelected).sort((a,b)=>a.localeCompare(b,"ko"));
      $("eSelected").innerHTML = arr.map(n=>`<span class="badge">${esc(n)}</span>`).join(" ") || `<span class="tiny">선택 없음</span>`;
      $("eCount").textContent = `${arr.length}명`;
    }
    function editSelectAll(){ Array.from(usersCache.keys()).forEach(n=>editSelected.add(n)); editSelected.add(editData.writer||currentUser); renderEditSelected(); renderEditUsers(); }
    function editClearAll(){ editSelected=new Set([editData.writer||currentUser]); renderEditSelected(); renderEditUsers(); }

    async function saveEdit(){
      if(!editId||!editData) return;
      const parts=Array.from(editSelected).map(s=>s.trim()).filter(Boolean);
      if(parts.length===0) return alert("0명은 저장하지 않습니다.");

      let outcome=editData.outcome ?? null;
      if(needsOutcome(editData.type)){
        const v=$("eOutcome").value;
        if(v==="O") outcome=true; else if(v==="X") outcome=false; else outcome=null;
      }

      const edited = (isAdmin() && editData.writer!==currentUser)
        ? {mode:"admin", by: currentUser, at: serverTimestamp()}
        : {mode:"self", by: editData.writer||currentUser, at: serverTimestamp()};

      await updateDoc(doc(db,"contentRecords",editId),{
        participants: parts,
        outcome,
        edited
      });

      showModal("editModal", false);
      setStatus("저장되었습니다.");
      await loadContentPage(0);
    }

    async function deleteContent(id){
      const s=await getDoc(doc(db,"contentRecords",id));
      if(!s.exists()) return;
      const r=s.data();
      if(!(isAdmin() || r.writer===currentUser)) return alert("삭제 권한이 없습니다.");
      if(!confirm("정말 삭제하시겠습니까?")) return;
      await deleteDoc(doc(db,"contentRecords",id));
      setStatus("삭제되었습니다.");
      await loadContentPage(0);
    }
    async function adminDeleteAllContent(){
      if(!isAdmin()) return;
      if(!confirm("컨텐츠 기록을 전체 삭제하시겠습니까? (되돌릴 수 없습니다)")) return;
      // 최근 7일만 보지만, 전체 삭제는 contentRecords 전체를 대상으로 해야 함.
      // 리드 최소화 목적상, 여기서는 "최근 7일"만 삭제 옵션으로 제한합니다.
      if(!confirm("최근 7일 기록만 삭제합니다. 진행하시겠습니까?")) return;
      const since=new Date(kstNow().getTime()); since.setDate(since.getDate()-7);
      const qy=query(colContent, where("time",">=",since), orderBy("time","desc"), limit(500));
      const snap=await getDocs(qy);
      for(const d of snap.docs){
        await deleteDoc(doc(db,"contentRecords",d.id));
      }
      setStatus("최근 7일 기록 삭제 완료");
      await loadContentPage(0);
    }

    // ---------- ADMIN: WORK RECORDS MANAGE (3-A,B,C,D 적용 중 A) ----------
    function workBaseQuery(){
      const since=new Date(kstNow().getTime()); since.setDate(since.getDate()-7);
      return query(colWork, where("checkIn", ">=", since), orderBy("checkIn","desc"), limit(PAGE_SIZE));
    }
    async function loadWorkPage(pageIndex){
      workPage=pageIndex;
      const since=new Date(kstNow().getTime()); since.setDate(since.getDate()-7);

      let qy;
      if(pageIndex===0){
        qy=workBaseQuery();
      }else{
        const cursor=workCursors[pageIndex-1];
        if(!cursor) return loadWorkPage(0);
        qy=query(colWork, where("checkIn", ">=", since), orderBy("checkIn","desc"), startAfter(cursor), limit(PAGE_SIZE));
      }
      const snap=await getDocs(qy);
      workDocs=snap.docs;
      if(snap.docs.length>0) workCursors[pageIndex]=snap.docs[snap.docs.length-1];
      renderWorkTable();
    }
    function renderWorkTable(){
      $("workPageInfo").textContent=`${workPage+1} 페이지`;
      $("btnPrevWork").disabled = workPage===0;
      $("btnNextWork").disabled = workDocs.length < PAGE_SIZE;

      $("workTbody").innerHTML = workDocs.map(d=>{
        const r=d.data();
        const nick=r.nickname||"-";
        const ci=fmt(r.checkIn);
        const co=fmt(r.checkOut);
        const dur = (r.durationSec!=null) ? secsToHMS(r.durationSec) : "-";
        const open = r.checkOut==null ? `<span class="badge on">OPEN</span>` : `<span class="badge dim">CLOSED</span>`;
        return `<tr>
          <td><b>${esc(nick)}</b></td>
          <td>${esc(ci)}</td>
          <td>${esc(co)}</td>
          <td>${dur}</td>
          <td>${open}</td>
          <td>
            <button class="pill" data-wedit="${d.id}">수정</button>
            <button class="pill danger" data-wdel="${d.id}">삭제</button>
            ${r.checkOut==null?`<button class="pill danger" data-wforce="${esc(nick)}">강제퇴근</button>`:""}
          </td>
        </tr>`;
      }).join("") || `<tr><td colspan="6" class="tiny">최근 7일 근무 기록이 없습니다.</td></tr>`;

      $("workTbody").querySelectorAll("[data-wdel]").forEach(b=>{
        b.onclick=()=>adminDeleteWork(b.getAttribute("data-wdel"));
      });
      $("workTbody").querySelectorAll("[data-wforce]").forEach(b=>{
        b.onclick=()=>adminForceOut(b.getAttribute("data-wforce"));
      });
      $("workTbody").querySelectorAll("[data-wedit]").forEach(b=>{
        b.onclick=()=>openEditWork(b.getAttribute("data-wedit"));
      });
    }

    async function adminDeleteWork(id){
      if(!isAdmin()) return;
      if(!confirm("이 근무 기록을 삭제하시겠습니까?")) return;
      await deleteDoc(doc(db,"workRecords",id));
      setStatus("삭제되었습니다.");
      await loadWorkPage(workPage);
    }
    async function adminDeleteAllWork(){
      if(!isAdmin()) return;
      if(!confirm("최근 7일 근무 기록을 전체 삭제하시겠습니까?")) return;
      const since=new Date(kstNow().getTime()); since.setDate(since.getDate()-7);
      const qy=query(colWork, where("checkIn",">=",since), orderBy("checkIn","desc"), limit(500));
      const snap=await getDocs(qy);
      for(const d of snap.docs){
        await deleteDoc(doc(db,"workRecords",d.id));
      }
      setStatus("최근 7일 근무 기록 삭제 완료");
      await loadWorkPage(0);
    }

    // edit work record modal: 관리자만
    let wEditId=null;
    async function openEditWork(id){
      if(!isAdmin()) return;
      const s=await getDoc(doc(db,"workRecords",id));
      if(!s.exists()) return alert("기록 없음");
      wEditId=id;
      const r=s.data();
      $("wNick").value=r.nickname||"";
      $("wIn").value = toLocalInput(r.checkIn);
      $("wOut").value = toLocalInput(r.checkOut);
      showModal("workEditModal", true);
    }
    function toLocalInput(ts){
      if(!ts) return "";
      const d=ts.toDate?ts.toDate():null; if(!d) return "";
      const p=n=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
    }
    async function saveEditWork(){
      if(!isAdmin()||!wEditId) return;
      const nick=$("wNick").value.trim();
      const inV=$("wIn").value;
      const outV=$("wOut").value;
      if(!nick||!inV) return alert("닉네임/출근은 필수입니다.");
      const ci=new Date(inV);
      const co=outV?new Date(outV):null;
      const dur = co ? Math.max(0, Math.floor((co.getTime()-ci.getTime())/1000)) : null;
      await updateDoc(doc(db,"workRecords",wEditId),{
        nickname:nick,
        checkIn: ci,
        checkOut: co,
        durationSec: dur
      });
      showModal("workEditModal", false);
      setStatus("저장되었습니다.");
      await loadWorkPage(workPage);
    }

    // total reset(3-1 confirm): users 요약 리셋
    async function adminResetTotals(){
      if(!isAdmin()) return;
      if(!confirm("총 출근(접속)시간을 초기화하시겠습니까?")) return;
      if(!confirm("정말로 진행하시겠습니까? (되돌릴 수 없습니다)")) return;

      // 20~30명 규모이므로 전체 users 문서 업데이트 가능(쓰기 많지만 reads 줄이기 목적)
      for(const [id,u] of usersCache.entries()){
        await updateDoc(doc(db,"users",id),{
          weekSeconds: 0,
          todaySeconds: 0,
          todayCheckIns: 0
        }).catch(()=>{});
      }
      setStatus("초기화 완료");
      await loadUsersOnce();
      await loadDashKpis();
      await loadUserTable();
    }

    // ---------- ADMIN: USER MANAGEMENT (화이트리스트/계급/부서/숨김/권한/부서장) ----------
    async function adminAddUser(){
      if(!isAdmin()) return;
      const id=$("addNick").value.trim();
      const pw=$("addPw").value.trim();
      if(!id||!pw) return alert("닉네임/비밀번호를 입력해 주세요.");
      const s=await getDoc(doc(db,"users",id));
      if(s.exists()) return alert("이미 존재합니다.");
      await setDoc(doc(db,"users",id),{
        password: pw,
        isAdmin:false,
        isHidden:false,
        rank:"",
        department:"",
        deptLeaderOf: [],
        // 요약필드 기본값
        isOnline:false,
        openWorkId:null,
        lastCheckIn:null,
        lastCheckOut:null,
        weekStart: dayKey(weekStartMonday0()),
        weekSeconds: 0,
        todayKey: dayKey(todayStart()),
        todaySeconds: 0,
        todayCheckIns: 0,
        contentCounts: {supply:0, plant:0, escort:0},
        contentLast: {supply:null, plant:null, escort:null},
        lastContentAt: null
      });
      $("addNick").value=""; $("addPw").value="";
      setStatus("유저 추가 완료");
      await loadUsersOnce();
      await loadDashKpis();
      await loadUserTable();
      await renderAdminUserCards();
    }

    function renderAdminUserCards(){
      const q=($("adminSearch").value||"").trim().toLowerCase();
      const cards=Array.from(usersCache.entries())
        .filter(([id,u])=>!q || id.toLowerCase().includes(q))
        .sort(([a],[b])=>a.localeCompare(b,"ko"))
        .map(([id,u])=>{
          const admin=u.isAdmin? "checked":"";
          const hidden=u.isHidden? "checked":"";
          const rankOpts = `<option value="">-</option>` + RANKS.map(r=>`<option value="${esc(r)}" ${u.rank===r?"selected":""}>${esc(r)}</option>`).join("");
          const deptOpts = `<option value="">-</option>` + DEPTS.map(d=>`<option value="${esc(d)}" ${u.department===d?"selected":""}>${esc(d)}</option>`).join("");

          const lead = (u.deptLeaderOf||[]).join(", ");
          return `<div class="box" style="margin-top:10px;">
            <div class="row">
              <span class="badge">${esc(id)}</span>
              <span class="badge role">${esc(u.rank||"-")}</span>
              <span class="badge dim">${esc(u.department||"-")}</span>
              <span class="spacer"></span>
              <label class="tiny"><input type="checkbox" data-admin="${esc(id)}" ${admin}/> 관리자</label>
              <label class="tiny"><input type="checkbox" data-hidden="${esc(id)}" ${hidden}/> 숨김</label>
            </div>
            <div class="row" style="margin-top:10px;">
              <select class="w220" data-rank="${esc(id)}">${rankOpts}</select>
              <select class="w320" data-dept="${esc(id)}">${deptOpts}</select>
              <input class="w220" placeholder="비밀번호 변경" data-pw="${esc(id)}"/>
              <button class="pill" data-save="${esc(id)}">저장</button>
            </div>
            <div class="row" style="margin-top:8px;">
              <input class="w320" placeholder="부서장 권한(쉼표로 부서 입력)" data-lead="${esc(id)}" value="${esc(lead)}"/>
              <button class="pill" data-savelead="${esc(id)}">부서장 저장</button>
              <button class="pill danger" data-forcein="${esc(id)}">강제출근</button>
              <button class="pill danger" data-forceout="${esc(id)}">강제퇴근</button>
            </div>
          </div>`;
        }).join("");

      $("adminUserCards").innerHTML = cards || `<div class="tiny">유저가 없습니다.</div>`;

      // bind
      $("adminUserCards").querySelectorAll("[data-save]").forEach(b=>{
        b.onclick=()=>adminSaveUser(b.getAttribute("data-save"));
      });
      $("adminUserCards").querySelectorAll("[data-savelead]").forEach(b=>{
        b.onclick=()=>adminSaveLeader(b.getAttribute("data-savelead"));
      });
      $("adminUserCards").querySelectorAll("[data-forcein]").forEach(b=>{
        b.onclick=()=>adminForceIn(b.getAttribute("data-forcein"));
      });
      $("adminUserCards").querySelectorAll("[data-forceout]").forEach(b=>{
        b.onclick=()=>adminForceOut(b.getAttribute("data-forceout"));
      });
    }

    async function adminSaveUser(id){
      if(!isAdmin()) return;
      const isA = $("adminUserCards").querySelector(`input[data-admin="${CSS.escape(id)}"]`)?.checked || false;
      const isH = $("adminUserCards").querySelector(`input[data-hidden="${CSS.escape(id)}"]`)?.checked || false;
      const rank = $("adminUserCards").querySelector(`select[data-rank="${CSS.escape(id)}"]`)?.value || "";
      const dept = $("adminUserCards").querySelector(`select[data-dept="${CSS.escape(id)}"]`)?.value || "";
      const pwEl = $("adminUserCards").querySelector(`input[data-pw="${CSS.escape(id)}"]`);
      const pw = (pwEl?.value||"").trim();

      const updates={ isAdmin:isA, isHidden:isH, rank, department:dept };
      if(pw) updates.password=pw;

      await updateDoc(doc(db,"users",id), updates);
      if(pwEl) pwEl.value="";
      setStatus("저장 완료");
      await loadUsersOnce();
      await loadDashKpis();
      await loadUserTable();
      await renderAdminUserCards();
    }

    async function adminSaveLeader(id){
      if(!isAdmin()) return;
      const el = $("adminUserCards").querySelector(`input[data-lead="${CSS.escape(id)}"]`);
      const raw=(el?.value||"").trim();
      const arr=raw?raw.split(",").map(s=>s.trim()).filter(Boolean):[];
      // 없는 부서 입력도 허용(자유), 대신 표준 부서만 쓰길 권장
      await updateDoc(doc(db,"users",id), { deptLeaderOf: arr });
      setStatus("부서장 권한 저장");
      await loadUsersOnce();
      await renderAdminUserCards();
    }

    // ---------- CHAT/NOTICE (3-D) ----------
    async function loadChat(){
      const dept=currentUserData?.department;
      if(!dept) { $("chatInfo").textContent="부서가 설정되어야 채팅을 사용할 수 있습니다."; return; }
      $("chatDept").textContent = dept;
      // 최근 50개만
      const qy=query(colDeptChat(dept), orderBy("time","desc"), limit(50));
      const snap=await getDocs(qy);
      const msgs=snap.docs.map(d=>d.data()).reverse();
      $("chatList").innerHTML = msgs.map(m=>{
        const mine=(m.by===currentUser);
        return `<div class="event" style="background:${mine?'rgba(185,198,255,0.10)':'rgba(17,21,32,0.50)'}">
          <div class="head"><span class="badge">${esc(m.by||"-")}</span><span class="spacer"></span><span class="tiny">${esc(fmt(m.time))}</span></div>
          <div class="p">${esc(m.text||"")}</div>
        </div>`;
      }).join("") || `<div class="tiny">메시지가 없습니다.</div>`;

      // 공지
      const ns=await getDoc(docDeptNotice(dept));
      if(ns.exists()){
        const n=ns.data();
        $("noticeBox").innerHTML = `
          <div class="event">
            <div class="head"><span class="badge role">공지</span><span class="badge">${esc(n.by||"-")}</span><span class="spacer"></span><span class="tiny">${esc(fmt(n.at))}</span></div>
            <div class="p">${esc(n.text||"")}</div>
          </div>`;
      }else{
        $("noticeBox").innerHTML = `<div class="tiny">등록된 공지가 없습니다.</div>`;
      }

      $("noticeCompose").hidden = !isDeptLeaderOf(dept);
    }

    async function sendChat(){
      const dept=currentUserData?.department;
      if(!dept) return alert("부서가 없습니다.");
      const text=$("chatText").value.trim();
      if(!text) return;
      await addDoc(colDeptChat(dept), { by: currentUser, text, time: serverTimestamp() });
      $("chatText").value="";
      setStatus("전송됨");
      await loadChat();
    }

    async function postNotice(){
      const dept=currentUserData?.department;
      if(!dept) return;
      if(!isDeptLeaderOf(dept)) return alert("부서장 권한이 없습니다.");
      const text=$("noticeText").value.trim();
      if(!text) return alert("공지 내용을 입력해 주세요.");
      await setDoc(docDeptNotice(dept), { text, by: currentUser, at: serverTimestamp(), id: `${Date.now()}_${Math.random().toString(16).slice(2)}` }, {merge:true});
      $("noticeText").value="";
      setStatus("공지 등록됨");
      await loadChat();
    }

    async function maybeShowNoticeOnce(){
      const dept=currentUserData?.department;
      if(!dept) return;
      const ns=await getDoc(docDeptNotice(dept));
      if(!ns.exists()) return;
      const n=ns.data();
      if(!n?.id) return;

      // users 문서의 seenNotice.{dept}에 id 저장해서 1회만 표시
      const seen = currentUserData?.seenNotices || {};
      if(seen[dept] === n.id) return;

      // 모달로 띄움
      $("nDept").textContent = dept;
      $("nBy").textContent = n.by||"-";
      $("nAt").textContent = fmt(n.at);
      $("nText").textContent = n.text||"";
      showModal("noticeModal", true);

      // 확인 누르면 저장
      $("btnNoticeOk").onclick = async ()=>{
        const patch = { seenNotices: { ...(currentUserData?.seenNotices||{}), [dept]: n.id } };
        await updateDoc(doc(db,"users",currentUser), patch).catch(()=>{});
        currentUserData.seenNotices = patch.seenNotices;
        showModal("noticeModal", false);
      };
    }

    // ---------- MODAL CONTROL ----------
    function showModal(id, on){
      const el=$(id);
      if(!el) return;
      if(on){
        lockBody(true);
        el.hidden=false;
      }else{
        // blur focus
        const active=document.activeElement;
        if(active && el.contains(active)) active.blur?.();
        el.hidden=true;
        lockBody(false);
      }
    }

    // ---------- GRAPH (3-A 그래프: users 요약 기반) ----------
    let chart=null;
    function renderGraph(){
      // 평균 주간/오늘/온라인 등 간단 그래프
      const wsKey=dayKey(weekStartMonday0());
      const tKey=dayKey(todayStart());
      const rows=Array.from(usersCache.entries()).filter(([id,u])=>isAdmin()||!u.isHidden);

      const labels=rows.map(([id])=>id);
      const week=rows.map(([id,u])=> (u.weekStart===wsKey)?(u.weekSeconds||0)/3600:0);
      const today=rows.map(([id,u])=> (u.todayKey===tKey)?(u.todaySeconds||0)/3600:0);

      const ctx=$("chart")?.getContext("2d");
      if(!ctx) return;
      if(chart) chart.destroy();
      chart = new Chart(ctx,{
        type:"bar",
        data:{
          labels,
          datasets:[
            { label:"이번주 시간(시간)", data:week },
            { label:"오늘 시간(시간)", data:today }
          ]
        },
        options:{
          responsive:true,
          plugins:{ legend:{ labels:{ color:"rgba(255,255,255,0.75)" } } },
          scales:{
            x:{ ticks:{ color:"rgba(255,255,255,0.65)" }, grid:{ color:"rgba(255,255,255,0.06)" } },
            y:{ ticks:{ color:"rgba(255,255,255,0.65)" }, grid:{ color:"rgba(255,255,255,0.06)" } }
          }
        }
      });
    }

    // ---------- EVENTS ----------

    let lastNonAdminTab = "dashboard";
    function closeAdminPanel(){
      document.body.classList.remove("admin-open");
      const admin=$("adminCol");
      if(admin){
        const active=document.activeElement;
        if(active && admin.contains(active)) active.blur?.();
        admin.hidden=true;
        admin.inert = true;
      }
    }
    }

function openAdminPanel(){
      if(!isAdmin()) return;
      document.body.classList.add("admin-open");
      const admin=$("adminCol");
      if(admin){
        admin.hidden=false;
        admin.inert = false;
        // 관리자 카드 렌더는 열릴 때만 수행하여 렉을 줄입니다.
        renderAdminUserCards();
        loadWorkPage(0);
        admin.scrollTop=0;
      }
    }
    }

function toggleAdminPanel(){
      if(!isAdmin()) return;
      const open = document.body.classList.contains("admin-open");
      if(open) closeAdminPanel();
      else openAdminPanel();
    }

    function setTab(name){
      if(name==="admin"){
        // 관리자 탭은 "대시보드 유지 + 우측 패널 토글" 방식입니다.
        toggleAdminPanel();
        // 탭 표시 상태는 마지막 일반 탭을 유지합니다.
        document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===lastNonAdminTab));
        return;
      }
      lastNonAdminTab = name;
      closeAdminPanel();
      document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
      document.querySelectorAll("[data-view]").forEach(v=>v.hidden = v.dataset.view!==name);
      if(name==="chat") loadChat();
      if(name==="graph") renderGraph();
    }

    window.addEventListener("DOMContentLoaded", ()=>{
      $("btnLogin").addEventListener("click", login);
      $("btnLogout").addEventListener("click", logout);

      $("btnRefresh").addEventListener("click", ()=>refreshAll({silent:false}));

      $("btnIn").addEventListener("click", checkIn);
      $("btnOut").addEventListener("click", checkOut);

      // create
      $("btnCreateSupply").addEventListener("click", ()=>openCreate("보급"));
      $("btnCreatePlant").addEventListener("click", ()=>openCreate("송전소"));
      $("btnCreateEscort").addEventListener("click", ()=>openCreate("차량수호"));

      $("contentFilter").addEventListener("change", async ()=>{
        contentFilter=$("contentFilter").value;
        contentPage=0;
        contentPageCursors=[];
        await loadContentPage(0);
      });
      $("btnPrevContent").addEventListener("click", ()=>loadContentPage(Math.max(0, contentPage-1)));
      $("btnNextContent").addEventListener("click", ()=>loadContentPage(contentPage+1));

      $("sortUsers").addEventListener("change", ()=>{ usersPage=0; loadUserTable(); });

      $("userPrev").addEventListener("click", ()=>{ usersPage=Math.max(0, usersPage-1); loadUserTable(); });
      $("userNext").addEventListener("click", ()=>{ usersPage=usersPage+1; loadUserTable(); });

      // modals
      $("createModal").addEventListener("click",(e)=>{ if(e.target.id==="createModal") showModal("createModal", false); });
      $("btnCreateClose").addEventListener("click", ()=>showModal("createModal", false));
      $("btnCreateCancel").addEventListener("click", ()=>showModal("createModal", false));
      $("btnCreateAll").addEventListener("click", createSelectAll);
      $("btnCreateClear").addEventListener("click", createClearAll);
      $("cSearch").addEventListener("input", ()=>{ createSearch=$("cSearch").value.trim(); renderCreateUsers(); });
      $("btnOcr").addEventListener("click", runOcrForCreate);
      $("cOcrFile").addEventListener("change", ()=>{ $("cOcrResult").textContent=""; });
      $("btnCreateSave").addEventListener("click", saveCreate);

      $("editModal").addEventListener("click",(e)=>{ if(e.target.id==="editModal") showModal("editModal", false); });
      $("btnEditClose").addEventListener("click", ()=>showModal("editModal", false));
      $("btnEditCancel").addEventListener("click", ()=>showModal("editModal", false));
      $("btnEditAll").addEventListener("click", editSelectAll);
      $("btnEditClear").addEventListener("click", editClearAll);
      $("eSearch").addEventListener("input", ()=>{ editSearch=$("eSearch").value.trim(); renderEditUsers(); });
      $("btnEditSave").addEventListener("click", saveEdit);

      $("workEditModal").addEventListener("click",(e)=>{ if(e.target.id==="workEditModal") showModal("workEditModal", false); });
      $("btnWorkClose").addEventListener("click", ()=>showModal("workEditModal", false));
      $("btnWorkCancel").addEventListener("click", ()=>showModal("workEditModal", false));
      $("btnWorkSave").addEventListener("click", saveEditWork);

      // admin
      $("btnAdmin").addEventListener("click", toggleAdminPanel);
      $("adminSearch").addEventListener("input", renderAdminUserCards);
      $("btnAddUser").addEventListener("click", adminAddUser);

      $("btnPrevWork").addEventListener("click", ()=>loadWorkPage(Math.max(0, workPage-1)));
      $("btnNextWork").addEventListener("click", ()=>loadWorkPage(workPage+1));
      $("btnDelAllWork").addEventListener("click", adminDeleteAllWork);
      $("btnDelAllContent").addEventListener("click", adminDeleteAllContent);
      $("btnResetTotals").addEventListener("click", adminResetTotals);

      // chat
      $("btnSendChat").addEventListener("click", sendChat);
      $("btnPostNotice").addEventListener("click", postNotice);

      // tabs
      document.querySelectorAll(".tab").forEach(t=>{
        t.addEventListener("click", ()=>setTab(t.dataset.tab));
      });

      // default tab
      setTab("dashboard");

      // esc close modals
      document.addEventListener("keydown",(e)=>{
        if(e.key==="Escape"){
          ["createModal","editModal","workEditModal","noticeModal"].forEach(id=>$(id).hidden=true);
          lockBody(false);
        }
      });
    });
  </script>
</head>

<body>
  <div id="adminBackdrop" hidden></div>
  <div id="toastHost" aria-live="polite" aria-atomic="true"></div>

  <div class="wrap">
    <div id="loginView" class="card" style="max-width: 520px; margin: 80px auto 0;">
      <div class="row" style="align-items:flex-start;">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <div class="title">도스온라인 국방부 근퇴시스템</div>
            <div class="subtitle">수동 갱신 · 7일 제한 · 0시 필터 · 요약필드 기반(리드 최소화)</div>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:14px;">
        <input id="loginId" class="w220" placeholder="아이디(닉네임)" />
        <input id="loginPw" class="w220" type="password" placeholder="비밀번호" />
        <button id="btnLogin" class="pill primary">로그인</button>
      </div>
      <div class="muted" style="margin-top:10px;">
        • 로그인 시 1회 로드 후, <b>새로고침 버튼</b>을 눌렀을 때만 데이터가 갱신됩니다.<br>
        • 실시간(onSnapshot)은 사용하지 않습니다.
      </div>
    </div>

    <div id="appView" hidden>
      <div class="topbar">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <div class="title">도스온라인 국방부 근퇴시스템</div>
            <div class="subtitle">운영 대시보드 · 리드 최소화 버전</div>
          </div>
        </div>
        <div class="right">
          <div id="who" class="row"></div>
          <button id="btnRefresh" class="pill">새로고침</button>
          <button id="btnAdmin" class="pill primary" hidden>관리</button>
          <button id="btnLogout" class="pill danger">로그아웃</button>
        </div>
      </div>

      <div class="row" style="margin: 6px 4px 14px;">
        <div class="tabs">
          <button class="tab active" data-tab="dashboard">대시보드</button>
          <button class="tab" data-tab="content">컨텐츠 기록</button>
          <button class="tab" data-tab="chat">부서 소통</button>
          <button class="tab" data-tab="graph">그래프</button>
          <button class="tab" data-tab="admin">관리자</button>
        </div>
        <div class="spacer"></div>
        <span id="status" class="tinyStatus"></span>
      </div>

      <div class="grid">
        <!-- LEFT -->
        <div class="card" data-view="dashboard">
          <h3>요약</h3>
          <div class="kpis">
            <div id="kpiOnline" class="kpi"></div>
            <div id="kpiTodayIn" class="kpi"></div>
            <div id="kpiTodaySec" class="kpi"></div>
            <div id="kpiWeekSec" class="kpi"></div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div class="box" style="flex:1;">
              <div class="row">
                <b>출 / 퇴근</b>
                <span class="spacer"></span>
                <span class="tiny">※ 출/퇴 버튼은 요약필드를 업데이트합니다.</span>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="btnIn" class="pill primary">출근</button>
                <button id="btnOut" class="pill">퇴근</button>
              </div>
            </div>

            <div class="box" style="flex:1;">
              <div class="row">
                <b>컨텐츠 작성</b>
                <span class="spacer"></span>
                <span class="tiny">※ 참여자는 체크로 선택합니다.</span>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="btnCreateSupply" class="pill primary">보급</button>
                <button id="btnCreatePlant" class="pill">송전소</button>
                <button id="btnCreateEscort" class="pill">차량수호</button>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div class="box" style="flex:1;">
              <div class="row">
                <b>유저 목록</b>
                <span class="spacer"></span>
                <select id="sortUsers" class="w220">
                  <option value="onlineFirst">정렬: 접속자 우선</option>
                  <option value="rankHigh">정렬: 계급 높은순</option>
                  <option value="rankLow">정렬: 계급 낮은순</option>
                  <option value="onlineOnly">정렬: 온라인만</option>
                </select>
              </div>
              <div class="tableWrap" style="margin-top:10px;">
                <table>
                  <thead>
                    <tr>
                      <th>닉네임</th>
                      <th>계급</th>
                      <th>부서</th>
                      <th>접속</th>
                      <th>마지막</th>
                      <th>주간</th>
                      <th>오늘</th>
                      <th>보급</th>
                      <th>송전소</th>
                      <th>차량</th>
                    </tr>
                  </thead>
                  <tbody id="userTbody"></tbody>
                </table>
              </div>
              
              <div class="row" style="margin-top:10px;">
                <button id="userPrev" class="pill">이전</button>
                <button id="userNext" class="pill">다음</button>
                <span class="chip" id="userPageInfo">1 / 1</span>
                <span class="tinyStatus" id="userCooldown"></span>
              </div>

              <div class="tiny" style="margin-top:10px;">
                • 일반 유저는 숨김 유저가 보이지 않습니다. • 정렬은 새로고침 시 초기화됩니다.
              </div>
            </div>
          </div>
        </div>

        

        <!-- ADMIN SIDE -->
        <div id="adminCol" class="card adminCol" data-view="dashboard" hidden aria-hidden="true">
          <div class="row">
            <h3 style="margin:0;">관리자 패널</h3>
            <span class="spacer"></span>
            <span class="badge role">관리자 전용</span>
          </div>

          <div class="two" style="margin-top:12px;">
            <div class="box">
              <b>유저 추가(화이트리스트)</b>
              <div class="row" style="margin-top:10px;">
                <input id="addNick" class="w220" placeholder="닉네임" />
                <input id="addPw" class="w220" placeholder="비밀번호" />
                <button id="btnAddUser" class="pill primary">추가</button>
              </div>
              <div class="row" style="margin-top:10px;">
                <input id="adminSearch" class="w320" placeholder="유저 검색" />
              </div>
              <div id="adminUserCards"></div>
            </div>

            <div class="box">
              <div class="row">
                <b>근무 기록 관리(최근 7일)</b>
                <span class="spacer"></span>
                <button id="btnDelAllWork" class="pill danger">근무 기록 전체삭제</button>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="btnPrevWork" class="pill">이전</button>
                <button id="btnNextWork" class="pill">다음</button>
                <span id="workPageInfo" class="tinyStatus"></span>
              </div>
              <div class="tableWrap" style="margin-top:10px;">
                <table>
                  <thead>
                    <tr>
                      <th>닉네임</th>
                      <th>출근</th>
                      <th>퇴근</th>
                      <th>시간</th>
                      <th>상태</th>
                      <th>조치</th>
                    </tr>
                  </thead>
                  <tbody id="workTbody"></tbody>
                </table>
              </div>

              <div class="row" style="margin-top:10px;">
                <button id="btnResetTotals" class="pill danger">총 접속시간 초기화</button>
                <button id="btnDelAllContent" class="pill danger">컨텐츠 기록(최근 7일) 전체삭제</button>
              </div>

              <div class="muted" style="margin-top:10px;">
                • “전체 삭제”는 리드 최소화를 위해 최근 7일만 대상으로 합니다.<br>
                • 강제출근/강제퇴근은 users 요약필드와 workRecords를 함께 갱신합니다.
              </div>
            </div>
          </div>
        </div>

      </div><!-- grid -->
    </div><!-- appView -->
  </div><!-- wrap -->

  <!-- Create Modal -->
  <div id="createModal" class="overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mTop">
        <div class="mTitle" id="cTitle">컨텐츠 작성</div>
        <span class="spacer"></span>
        <button id="btnCreateClose" class="pill">닫기</button>
      </div>
      <div class="mBody">
        <div class="two">
          <div class="box">
            <div class="row">
              <b>유저 목록</b>
              <span class="spacer"></span>
              <span class="badge dim">선택 <b id="cCount">0명</b></span>
            </div>
            <div class="row" style="margin-top:10px;">
              <input id="cSearch" class="w320" placeholder="검색" />
              <button id="btnCreateAll" class="pill">전체</button>
              <button id="btnCreateClear" class="pill">해제</button>
            </div>
            <div class="row" style="margin-top:10px;">
              <input id="cOcrFile" type="file" accept="image/*" class="w320" />
              <button id="btnOcr" class="pill">스크린샷 인식</button>
              <span class="tiny" id="cOcrHint">TAB 스크린샷을 올리면 등록된 닉네임을 자동 선택합니다.</span>
            </div>
            <div class="tiny" id="cOcrResult" style="margin-top:8px;"></div>

            <div id="cUserList" class="list"></div>
          </div>
          <div class="box">
            <b>선택된 참여자</b>
            <div id="cSelected" style="margin-top:10px;"></div>
            <div id="cOutcomeBox" class="box" style="margin-top:12px;">
              <div class="row">
                <b>성공 여부</b>
                <span class="spacer"></span>
                <span class="tiny">보급/차량수호만</span>
              </div>
              <div class="row" style="margin-top:10px;">
                <select id="cOutcome" class="w220">
                  <option value="-">-</option>
                  <option value="O">O (성공)</option>
                  <option value="X">X (실패)</option>
                </select>
              </div>
            </div>
            <div class="tiny" style="margin-top:10px;">• 작성자는 자동으로 포함됩니다. • 0명은 저장하지 않습니다.</div>
          </div>
        </div>
      </div>
      <div class="mFoot">
        <button id="btnCreateCancel" class="pill">취소</button>
        <button id="btnCreateSave" class="pill primary">작성</button>
      </div>
    </div>
  </div>

  

<!-- CONTENT VIEW -->
        <div class="card" data-view="content" hidden style="grid-column:1/-1;">
          <div class="row">
            <h3 style="margin:0;">컨텐츠 기록 (최근 7일)</h3>
            <span class="spacer"></span>
            <select id="contentFilter" class="w220">
              <option value="ALL">전체 보기</option>
              <option value="보급">보급만 보기</option>
              <option value="송전소">송전소만 보기</option>
              <option value="차량수호">차량수호만 보기</option>
            </select>
          </div>
          <div class="row" style="margin-top:10px;">
            <button id="btnPrevContent" class="pill">이전</button>
            <button id="btnNextContent" class="pill">다음</button>
            <span id="contentPageInfo" class="tinyStatus"></span>
          </div>
          <div id="contentList" class="timeline" style="margin-top:12px;"></div>
        </div>

        <!-- CHAT VIEW -->
        <div class="card" data-view="chat" hidden style="grid-column:1/-1;">
          <div class="row">
            <h3 style="margin:0;">부서 소통방</h3>
            <span class="spacer"></span>
            <span class="badge dim">부서: <b id="chatDept">-</b></span>
          </div>
          <div class="row" style="margin-top:12px; align-items:flex-start;">
            <div style="flex:1;">
              <div class="box">
                <b>공지</b>
                <div id="noticeBox" style="margin-top:10px;"></div>
                <div id="noticeCompose" hidden style="margin-top:10px;">
                  <textarea id="noticeText" placeholder="공지 내용을 입력합니다."></textarea>
                  <div class="row" style="margin-top:10px;">
                    <button id="btnPostNotice" class="pill primary">공지 등록</button>
                  </div>
                </div>
              </div>
            </div>
            <div style="flex:1;">
              <div class="box">
                <b>채팅</b>
                <div id="chatList" class="timeline" style="margin-top:10px;"></div>
                <div class="row" style="margin-top:10px;">
                  <input id="chatText" class="w320" placeholder="메시지 입력" />
                  <button id="btnSendChat" class="pill primary">전송</button>
                  <span id="chatInfo" class="tinyStatus"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="tiny" style="margin-top:10px;">
            • 채팅/공지는 이 탭을 열었을 때만 읽습니다(수동 갱신). • 부서장/관리자만 공지 등록 가능합니다.
          </div>
        </div>

        <!-- GRAPH VIEW -->
        <div class="card" data-view="graph" hidden style="grid-column:1/-1;">
          <div class="row">
            <h3 style="margin:0;">그래프</h3>
            <span class="spacer"></span>
            <span class="tiny">users 요약필드 기반 (workRecords 스캔 없음)</span>
          </div>
          <div class="box" style="margin-top:12px;">
            <canvas id="chart" height="120"></canvas>
          </div>
        </div>

        <!-- ADMIN VIEW -->
        <!-- Edit Modal -->
  <div id="editModal" class="overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mTop">
        <div class="mTitle" id="eTitle">컨텐츠 수정</div>
        <span class="spacer"></span>
        <button id="btnEditClose" class="pill">닫기</button>
      </div>
      <div class="mBody">
        <div class="two">
          <div class="box">
            <div class="row">
              <b>유저 목록</b>
              <span class="spacer"></span>
              <span class="badge dim">선택 <b id="eCount">0명</b></span>
            </div>
            <div class="row" style="margin-top:10px;">
              <input id="eSearch" class="w320" placeholder="검색" />
              <button id="btnEditAll" class="pill">전체</button>
              <button id="btnEditClear" class="pill">해제</button>
            </div>
            <div id="eUserList" class="list"></div>
          </div>
          <div class="box">
            <b>선택된 참여자</b>
            <div id="eSelected" style="margin-top:10px;"></div>
            <div id="eOutcomeBox" class="box" style="margin-top:12px;">
              <div class="row">
                <b>성공 여부</b>
                <span class="spacer"></span>
                <span class="tiny">보급/차량수호만</span>
              </div>
              <div class="row" style="margin-top:10px;">
                <select id="eOutcome" class="w220">
                  <option value="-">-</option>
                  <option value="O">O (성공)</option>
                  <option value="X">X (실패)</option>
                </select>
              </div>
            </div>
            <div class="tiny" style="margin-top:10px;">• 작성자/관리자만 수정할 수 있습니다.</div>
          </div>
        </div>
      </div>
      <div class="mFoot">
        <button id="btnEditCancel" class="pill">취소</button>
        <button id="btnEditSave" class="pill primary">저장</button>
      </div>
    </div>
  </div>

  <!-- Work Edit Modal -->
  <div id="workEditModal" class="overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mTop">
        <div class="mTitle">근무 기록 수정</div>
        <span class="spacer"></span>
        <button id="btnWorkClose" class="pill">닫기</button>
      </div>
      <div class="mBody">
        <div class="box">
          <div class="row">
            <input id="wNick" class="w220" placeholder="닉네임" />
            <input id="wIn" class="w220" type="datetime-local" />
            <input id="wOut" class="w220" type="datetime-local" />
          </div>
          <div class="tiny" style="margin-top:10px;">• 출근은 필수, 퇴근은 비워두면 OPEN 상태로 저장됩니다.</div>
        </div>
      </div>
      <div class="mFoot">
        <button id="btnWorkCancel" class="pill">취소</button>
        <button id="btnWorkSave" class="pill primary">저장</button>
      </div>
    </div>
  </div>

  <!-- Notice Modal -->
  <div id="noticeModal" class="overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mTop">
        <div class="mTitle">부서 공지</div>
        <span class="spacer"></span>
        <button class="pill" onclick="document.getElementById('noticeModal').hidden=true; document.body.classList.remove('noscroll');">닫기</button>
      </div>
      <div class="mBody">
        <div class="box">
          <div class="row">
            <span class="badge dim">부서 <b id="nDept">-</b></span>
            <span class="badge">작성 <b id="nBy">-</b></span>
            <span class="badge dim" id="nAt">-</span>
          </div>
          <div class="p" style="margin-top:10px;" id="nText"></div>
        </div>
      </div>
      <div class="mFoot">
        <button id="btnNoticeOk" class="pill primary">확인</button>
      </div>
    </div>
  </div>

</body>
</html>

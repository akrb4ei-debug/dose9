<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>도스온라인 국방부 근퇴시스템</title>

<style>
  :root{
    --bg:#0f1217;
    --panel:#171b22;
    --panel2:#1d2330;
    --stroke:rgba(255,255,255,.08);
    --text:#e8ecf3;
    --muted:rgba(232,236,243,.65);
    --good:#4ade80;
    --bad:#fb7185;
    --warn:#fbbf24;
    --steel:#aeb6c6;
    --shadow:0 18px 50px rgba(0,0,0,.45);
    --r:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:
      radial-gradient(1200px 700px at 15% 8%, rgba(173,187,210,.12), transparent 60%),
      radial-gradient(900px 520px at 85% 22%, rgba(205,215,235,.10), transparent 60%),
      linear-gradient(180deg, #0c0f14, #0f1217 35%, #0b0e13);
    color:var(--text);
    overflow-x:hidden;
  }

  /* Top bar */
  .topbar{
    position:sticky; top:0; z-index:50;
    backdrop-filter: blur(10px);
    background:linear-gradient(180deg, rgba(18,22,29,.92), rgba(18,22,29,.72));
    border-bottom:1px solid var(--stroke);
  }
  .topbarInner{
    max-width:1200px; margin:0 auto;
    padding:14px 18px;
    display:flex; align-items:center; justify-content:space-between; gap:14px;
  }
  .brand{
    display:flex; align-items:center; gap:12px;
    font-weight:900; letter-spacing:.2px;
  }
  .brandDot{
    width:12px;height:12px;border-radius:50%;
    background:linear-gradient(180deg, #c7cedc, #7e8aa3);
    box-shadow:0 0 0 6px rgba(174,182,198,.10);
  }
  .topActions{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .pill{
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    color:var(--text);
    padding:10px 12px;
    border-radius:999px;
    font-weight:800;
    cursor:pointer;
    transition:.15s transform ease, .15s background ease, .15s border ease;
    user-select:none;
  }
  .pill:hover{transform:translateY(-1px); background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03))}
  .pill:active{transform:translateY(0)}
  .pill.good{border-color:rgba(74,222,128,.35)}
  .pill.bad{border-color:rgba(251,113,133,.35)}
  .pill.ghost{opacity:.85}
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.04);
    color:var(--muted);
    font-weight:800;
    max-width:560px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .badge b{color:var(--text)}
  .dot{
    width:8px;height:8px;border-radius:50%;
    background:rgba(255,255,255,.18);
  }
  .dot.on{background:var(--good)}
  .dot.off{background:rgba(255,255,255,.20)}

  /* Layout */
  .wrap{max-width:1200px; margin:0 auto; padding:18px}
  .grid{
    display:grid;
    grid-template-columns: 1fr;
    gap:14px;
    align-items:start;
  }
  .grid.adminOpen{
    grid-template-columns: 1fr 520px;
  }
  @media (max-width:1100px){
    .grid.adminOpen{grid-template-columns:1fr}
  }

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--stroke);
    border-radius:var(--r);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .cardHead{
    padding:14px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    border-bottom:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  }
  .cardHead h2,.cardHead h3{margin:0; font-size:14px; letter-spacing:.2px}
  .cardBody{padding:14px 16px}
  .muted{color:var(--muted)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .rowBetween{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
  .sep{height:1px;background:var(--stroke); margin:12px 0}
  .kpi{
    display:grid; grid-template-columns: repeat(3, minmax(0,1fr));
    gap:10px;
  }
  @media (max-width:900px){.kpi{grid-template-columns:1fr}}
  .kpiBox{
    border:1px solid var(--stroke);
    border-radius:14px;
    padding:12px 12px;
    background:rgba(0,0,0,.15);
  }
  .kpiBox .label{font-size:12px; color:var(--muted); font-weight:800}
  .kpiBox .value{font-size:18px; font-weight:1000; margin-top:4px}
  .kpiBox .sub{font-size:12px;color:var(--muted); margin-top:4px}

  /* Inputs */
  input,select,textarea{
    border:1px solid var(--stroke);
    background:rgba(0,0,0,.25);
    color:var(--text);
    padding:10px 12px;
    border-radius:12px;
    outline:none;
    width:100%;
  }
  textarea{min-height:90px; resize:vertical}
  input::placeholder{color:rgba(232,236,243,.45)}
  .field{display:grid; gap:6px}
  .field label{font-size:12px; color:var(--muted); font-weight:900}
  .form2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width:800px){.form2{grid-template-columns:1fr}}
  .btn{
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(199,206,220,.14), rgba(255,255,255,.03));
    color:var(--text);
    padding:10px 12px;
    border-radius:12px;
    font-weight:900;
    cursor:pointer;
    transition:.15s transform ease, .15s background ease;
    user-select:none;
  }
  .btn:hover{transform:translateY(-1px); background:linear-gradient(180deg, rgba(199,206,220,.18), rgba(255,255,255,.04))}
  .btn:active{transform:translateY(0)}
  .btn.good{border-color:rgba(74,222,128,.35)}
  .btn.bad{border-color:rgba(251,113,133,.35)}
  .btn.warn{border-color:rgba(251,191,36,.35)}
  .btn.small{padding:8px 10px; border-radius:11px; font-size:12px}

  /* Tables / lists */
  .list{display:flex; flex-direction:column; gap:10px}
  .item{
    border:1px solid var(--stroke);
    border-radius:14px;
    background:rgba(0,0,0,.14);
    padding:12px 12px;
  }
  .itemTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .itemTitle{display:flex; flex-direction:column; gap:2px}
  .itemTitle b{font-size:14px}
  .itemMeta{font-size:12px; color:var(--muted)}
  .tag{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.04);
    font-size:12px; font-weight:900; color:var(--muted);
  }
  .tag.on{color:#d7ffe4; border-color:rgba(74,222,128,.25)}
  .tag.off{color:rgba(232,236,243,.55)}
  .pillGroup{display:flex; gap:8px; flex-wrap:wrap}
  .pillTab{
    padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);
    background:rgba(255,255,255,.03);
    color:var(--muted);
    font-weight:900;
    cursor:pointer;
  }
  .pillTab.active{color:var(--text); background:rgba(199,206,220,.14)}
  .pager{display:flex; align-items:center; justify-content:center; gap:10px; margin-top:10px}
  .pager span{color:var(--muted); font-weight:800}

  /* Admin panel (inline / floating toggle) */
  .adminCol{position:relative}
  .adminCard{position:sticky; top:84px}
  @media (max-width:1100px){ .adminCard{position:relative; top:auto} }
  .adminFloat{
    position:fixed !important;
    right:20px; top:88px;
    width:520px;
    z-index:60;
    cursor:default;
  }
  .dragHandle{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    cursor:grab;
  }
  .dragHandle:active{cursor:grabbing}

  /* Modal */
  .backdrop{
    position:fixed; inset:0;
    background:rgba(0,0,0,.55);
    backdrop-filter: blur(8px);
    display:none;
    z-index:80;
  }
  .backdrop.show{display:block}
  .modal{
    position:fixed; inset:0;
    display:none; align-items:center; justify-content:center;
    z-index:90;
    padding:18px;
  }
  .modal.show{display:flex}
  .modalBox{
    width:min(900px, 100%);
    max-height:min(86vh, 900px);
    overflow:auto;
    border-radius:20px;
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
    box-shadow:0 35px 90px rgba(0,0,0,.65);
  }
  .modalHead{
    position:sticky; top:0;
    padding:14px 16px;
    border-bottom:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(22,26,34,.92), rgba(22,26,34,.78));
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    border-top-left-radius:20px; border-top-right-radius:20px;
  }
  .modalHead h3{margin:0; font-size:14px}
  .modalBody{padding:14px 16px}
  .checkGrid{
    display:grid; grid-template-columns: repeat(3, minmax(0,1fr));
    gap:10px;
  }
  @media (max-width:860px){ .checkGrid{grid-template-columns:1fr 1fr} }
  @media (max-width:560px){ .checkGrid{grid-template-columns:1fr} }
  .checkItem{
    display:flex; align-items:center; gap:10px;
    padding:10px 10px;
    border:1px solid var(--stroke);
    border-radius:14px;
    background:rgba(0,0,0,.12);
  }
  .checkItem b{font-size:13px}
  .checkItem input{width:auto}
  .strike{ text-decoration: line-through; opacity:.6 }
  .added{ font-weight:1000 }
  .writerBold{ font-weight:1000 }

  /* Context menu */
  .ctx{
    position:fixed;
    z-index:95;
    display:none;
    min-width:220px;
    border:1px solid var(--stroke);
    border-radius:16px;
    background:linear-gradient(180deg, rgba(33,39,51,.96), rgba(20,24,32,.92));
    box-shadow:0 30px 80px rgba(0,0,0,.6);
    overflow:hidden;
  }
  .ctx.show{display:block}
  .ctx button{
    width:100%;
    border:none;
    border-bottom:1px solid rgba(255,255,255,.06);
    background:transparent;
    color:var(--text);
    padding:12px 12px;
    text-align:left;
    font-weight:900;
    cursor:pointer;
  }
  .ctx button:hover{background:rgba(255,255,255,.06)}
  .ctx .danger{color:#ffd2da}

  /* Toasts */
  #toastStack{
    position:fixed; top:18px; right:18px;
    z-index:120;
    display:flex; flex-direction:column; gap:10px;
    pointer-events:none;
  }
  .toast{
    pointer-events:auto;
    min-width:260px;
    max-width:min(460px, calc(100vw - 36px));
    padding:12px 14px;
    border-radius:16px;
    border:1px solid var(--stroke);
    background:linear-gradient(135deg, rgba(44,52,68,.92), rgba(22,26,35,.92));
    box-shadow:0 18px 60px rgba(0,0,0,.55);
    display:flex; gap:10px; align-items:flex-start;
    opacity:0; transform:translateY(-10px);
    transition:.28s ease;
  }
  .toast.show{opacity:1; transform:translateY(0)}
  .toast .tDot{width:10px;height:10px;border-radius:50%; margin-top:4px;background:rgba(255,255,255,.25)}
  .toast.good .tDot{background:var(--good)}
  .toast.bad .tDot{background:var(--bad)}
  .toast.warn .tDot{background:var(--warn)}
  .toast .tMsg{font-weight:900}
  .toast .tSub{font-size:12px; color:var(--muted); margin-top:2px}
</style>
</head>

<body>
<div id="toastStack"></div>
<div id="ctxMenu" class="ctx"></div>
<div id="backdrop" class="backdrop"></div>

<div class="topbar">
  <div class="topbarInner">
    <div class="brand">
      <div class="brandDot"></div>
      <div>도스온라인 국방부 근퇴시스템</div>
    </div>
    <div class="topActions">
      <div id="topUser" class="badge"><span class="dot off"></span><span class="muted">로그인 필요</span></div>
      <button id="btnAdminToggle" class="pill ghost hidden">관리</button>
      <button id="btnLogout" class="pill ghost hidden">로그아웃</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div id="loginCard" class="card">
    <div class="cardHead"><h2>로그인</h2><span class="muted">화이트리스트</span></div>
    <div class="cardBody">
          <div id="mainTabDashboard">
      <div class="form2">
        <div class="field">
          <label>아이디(닉네임)</label>
          <input id="loginId" placeholder="예: LMSTD_23" />
        </div>
        <div class="field">
          <label>비밀번호</label>
          <input id="loginPw" type="password" placeholder="비밀번호" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnLogin" class="btn good">로그인</button>
        <span class="muted">※ 계정은 관리자가 추가합니다.</span>
      </div>
    </div>
  </div>

  <div id="appArea" class="grid hidden">
    <div>
      <div class="card">
        <div class="cardHead">
          <div class="row" style="gap:10px;align-items:center">
            <h2 style="margin-right:6px">대시보드</h2>
            <div class="pillGroup" style="gap:6px">
              <button class="pillTab active" data-main-tab="dashboard">요약</button>
              <button class="pillTab" data-main-tab="work">출퇴근 기록</button>
              <button class="pillTab" data-main-tab="content">컨텐츠 기록</button>
              <button class="pillTab" data-main-tab="stats">통계</button>
              <button class="pillTab" data-main-tab="users">유저목록</button>
            </div>
          </div>
          <div class="row">
            <button id="btnRefresh" class="btn small">새로고침</button>
            <button id="btnTheme" class="btn small">테마</button>
            <button id="btnExportCSV" class="btn small">CSV</button>
            <button id="btnBackup" class="btn small">백업</button>
            <label class="btn small" style="cursor:pointer">
              복구<input id="btnRestore" type="file" accept="application/json" style="display:none"/>
            </label>
            <span id="coolInfo" class="muted" style="font-size:12px"></span>
          </div>
        </div>
        <div class="cardBody">
          <div class="kpi">
            <div class="kpiBox">
              <div class="label">내 상태</div>
              <div id="kpiOnline" class="value">-</div>
              <div id="kpiLast" class="sub">-</div>
            </div>
            <div class="kpiBox">
              <div class="label">이번 주 접속시간</div>
              <div id="kpiWeek" class="value">-</div>
              <div id="kpiToday" class="sub">오늘: -</div>
            </div>
            <div class="kpiBox">
              <div class="label">컨텐츠 참여</div>
              <div id="kpiCnt" class="value">-</div>
              <div id="kpiCntLast" class="sub">-</div>
            </div>
          </div>

          
          <div class="sep"></div>

          <div class="card" style="margin-top:0; box-shadow:none; border:none; background:transparent; padding:0">
            <div class="rowBetween" style="margin-bottom:10px">
              <div>
                <div style="font-weight:1000">내 정보</div>
                <div class="muted" style="font-size:12px">최근 7일 기준 요약입니다.</div>
              </div>
              <button id="btnMyInfoRefresh" class="btn small">내 정보 갱신</button>
            </div>
            <div class="kpi" style="grid-template-columns:repeat(4,minmax(0,1fr))">
              <div class="kpiBox">
                <div class="label">최근 7일 접속시간</div>
                <div id="myWeek" class="value">-</div>
                <div id="myWeekLast" class="sub">마지막 접속: -</div>
              </div>
              <div class="kpiBox">
                <div class="label">송전소</div>
                <div id="myPlant" class="value">-</div>
                <div id="myPlantLast" class="sub">최근 참여: -</div>
              </div>
              <div class="kpiBox">
                <div class="label">보급</div>
                <div id="mySupply" class="value">-</div>
                <div id="mySupplyLast" class="sub">최근 참여: -</div>
              </div>
              <div class="kpiBox">
                <div class="label">차량수호</div>
                <div id="myEscort" class="value">-</div>
                <div id="myEscortLast" class="sub">최근 참여: -</div>
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="card" style="margin-top:0; box-shadow:none; border:none; background:transparent; padding:0">
            <div class="rowBetween" style="margin-bottom:10px">
              <div>
                <div style="font-weight:1000">부서 소통방</div>
                <div class="muted" style="font-size:12px">실시간(onSnapshot) 없이 수동/쿨타임 갱신 방식입니다.</div>
              </div>
              <div class="row" style="gap:8px">
                <select id="chatDept" style="width:220px"></select>
                <button id="btnChatRefresh" class="btn small">채팅 갱신</button>
              </div>
            </div>
            <div class="item" style="max-height:260px; overflow:auto" id="chatBox"></div>
            <div class="row" style="margin-top:10px">
              <input id="chatMsg" placeholder="메시지 입력" />
              <button id="btnChatSend" class="btn good">전송</button>
            </div>
            <div class="rowBetween" style="margin-top:10px">
              <div class="muted" style="font-size:12px" id="noticeInfo">공지: -</div>
              <button id="btnNotice" class="btn small warn hidden">공지 등록</button>
            </div>
          </div>

          <div class="sep"></div>

<div class="sep"></div>

          <div class="row">
            <button id="btnIn" class="btn good">출근</button>
            <button id="btnOut" class="btn bad">퇴근</button>
            <span class="muted">※ 출근/퇴근은 요약필드로 누적됩니다.</span>
          </div>

          <div class="sep"></div>

          <div class="rowBetween">
            <div>
              <div style="font-weight:1000">유저 목록</div>
              <div class="muted" style="font-size:12px">숨김 유저는 관리자 외에는 보이지 않습니다.</div>
            </div>
            <div class="pillGroup">
              <button class="pillTab active" data-sort="rankDesc">계급 높은순</button>
              <button class="pillTab" data-sort="rankAsc">계급 낮은순</button>
              <button class="pillTab" data-sort="onlineFirst">온라인 우선</button>
              <button class="pillTab" data-sort="onlineOnly">온라인만</button>
            </div>
          </div>

          <div id="userList" class="list" style="margin-top:12px"></div>
          <div class="pager">
            <button id="uPrev" class="btn small">이전</button>
            <span id="uPageInfo">-</span>
            <button id="uNext" class="btn small">다음</button>
          </div>
        </div>

          <div id="mainTabWork" class="hidden">
            <div class="rowBetween" style="margin-bottom:10px">
              <div>
                <div style="font-weight:1000">최근 7일 출퇴근 기록</div>
                <div class="muted" style="font-size:12px">기록은 7일만 표시되며, 더보기는 CSV로 내보냅니다.</div>
              </div>
              <button id="btnWorkRefresh" class="btn small">기록 갱신</button>
            </div>
            <div id="workList" class="list"></div>
            <div class="pager">
              <button id="wPrev" class="btn small">이전</button>
              <span id="wPageInfo">-</span>
              <button id="wNext" class="btn small">다음</button>
            </div>
          </div>

          <div id="mainTabContent" class="hidden">
            <div class="rowBetween" style="margin-bottom:10px">
              <div>
                <div style="font-weight:1000">최근 7일 컨텐츠 기록</div>
                <div class="muted" style="font-size:12px">등록/수정/삭제는 여기서 수행합니다.</div>
              </div>
              <div class="row">
                <button id="btnNewSupply2" class="btn small">보급</button>
                <button id="btnNewPlant2" class="btn small">송전소</button>
                <button id="btnNewEscort2" class="btn small">차량수호</button>
                <button id="btnContentRefresh" class="btn small">갱신</button>
              </div>
            </div>
            <div id="contentList2" class="list"></div>
            <div class="pager">
              <button id="cPrev2" class="btn small">이전</button>
              <span id="cPageInfo2">-</span>
              <button id="cNext2" class="btn small">다음</button>
            </div>
          </div>

          <div id="mainTabStats" class="hidden">
            <div class="rowBetween" style="margin-bottom:10px">
              <div>
                <div style="font-weight:1000">통계</div>
                <div class="muted" style="font-size:12px">최근 7일 기준(리드 최소화).</div>
              </div>
              <button id="btnStatsRefresh" class="btn small">통계 갱신</button>
            </div>
            <div class="kpi" style="grid-template-columns:repeat(3,minmax(0,1fr))">
              <div class="kpiBox"><div class="label">평균 주간 접속시간</div><div id="statAvgWeek" class="value">-</div><div class="sub" id="statAvgWeekSub">-</div></div>
              <div class="kpiBox"><div class="label">컨텐츠 참여 합계</div><div id="statContentTotal" class="value">-</div><div class="sub" id="statContentTotalSub">-</div></div>
              <div class="kpiBox"><div class="label">온라인 인원</div><div id="statOnline" class="value">-</div><div class="sub" id="statOnlineSub">-</div></div>
            </div>
            <div class="sep"></div>
            <div class="item">
              <div class="rowBetween"><b>유저별 주간 접속시간(Top 10)</b><span class="muted" style="font-size:12px">캔버스 차트</span></div>
              <div class="sep"></div>
              <canvas id="chartWeek" width="860" height="260" style="width:100%;height:260px"></canvas>
            </div>
            <div class="item" style="margin-top:12px">
              <div class="rowBetween"><b>컨텐츠 참여(Top 10)</b><span class="muted" style="font-size:12px">보급/송전소/차량수호 합</span></div>
              <div class="sep"></div>
              <canvas id="chartContent" width="860" height="260" style="width:100%;height:260px"></canvas>
            </div>
          </div>

          <div id="mainTabUsers" class="hidden">
            <div class="rowBetween" style="margin-bottom:10px">
              <div>
                <div style="font-weight:1000">유저 목록(상세)</div>
                <div class="muted" style="font-size:12px">클릭하면 유저 상세/최근 7일 기록을 확인합니다.</div>
              </div>
              <div class="row" style="gap:8px">
                <input id="uSearch2" placeholder="검색" style="width:180px" />
                <select id="uSort2" style="width:160px">
                  <option value="rankDesc">계급 높은순</option>
                  <option value="rankAsc">계급 낮은순</option>
                  <option value="onlineFirst">온라인 우선</option>
                  <option value="onlineOnly">온라인만</option>
                  <option value="nameAsc">이름순</option>
                </select>
                <button id="btnUsersRefresh" class="btn small">갱신</button>
              </div>
            </div>
            <div id="userList2" class="list"></div>
            <div class="pager">
              <button id="uPrev2" class="btn small">이전</button>
              <span id="uPageInfo2">-</span>
              <button id="uNext2" class="btn small">다음</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card hidden" style="margin-top:14px">
        <div class="cardHead">
          <h2>컨텐츠</h2>
          <div class="row">
            <button id="btnNewSupply" class="btn small">보급</button>
            <button id="btnNewPlant" class="btn small">송전소</button>
            <button id="btnNewEscort" class="btn small">차량수호</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="muted" style="font-size:12px">※ 컨텐츠 기록은 최근 7일만 표시됩니다.</div>
          <div id="contentList" class="list" style="margin-top:12px"></div>
          <div class="pager">
            <button id="cPrev" class="btn small">이전</button>
            <span id="cPageInfo">-</span>
            <button id="cNext" class="btn small">다음</button>
          </div>
        </div>
      </div>
    </div>

    <div class="adminCol">
      <div id="adminCard" class="card adminCard hidden">
        <div class="cardHead dragHandle" id="adminDrag">
          <h2>관리자 패널</h2>
          <div class="row">
            <button id="btnAdminFloat" class="btn small">분리</button>
            <button id="btnAdminClose" class="btn small">닫기</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="pillGroup" style="margin-bottom:12px">
            <button class="pillTab active" data-atab="add">유저 추가</button>
            <button class="pillTab" data-atab="list">유저 리스트</button>
          </div>

          <div id="adminTabAdd">
            <div class="form2">
              <div class="field">
                <label>닉네임(=ID)</label>
                <input id="admNewNick" placeholder="예: new_user" />
              </div>
              <div class="field">
                <label>비밀번호</label>
                <input id="admNewPw" placeholder="예: 1109" />
              </div>
              <div class="field">
                <label>계급</label>
                <select id="admNewRank"></select>
              </div>
              <div class="field">
                <label>부서</label>
                <select id="admNewDept"></select>
              </div>
            </div>
            <div class="row" style="margin-top:12px">
              <button id="admAddUserBtn" class="btn good">유저 추가</button>
              <span class="muted" style="font-size:12px">※ 화이트리스트 방식입니다.</span>
            </div>
          </div>

          <div id="adminTabList" class="hidden">
            <div class="rowBetween">
              <div class="muted" style="font-size:12px">※ 우클릭 미니메뉴(관리자 전용) 지원</div>
              <div class="row" style="gap:8px">
                <select id="admSort">
                  <option value="rankDesc">계급 높은순</option>
                  <option value="rankAsc">계급 낮은순</option>
                  <option value="onlineFirst">온라인 우선</option>
                  <option value="nameAsc">이름순</option>
                </select>
                <input id="admSearch" placeholder="검색" style="width:160px" />
              </div>
            </div>
            <div id="admUserList" class="list" style="margin-top:12px"></div>
            <div class="pager">
              <button id="aPrev" class="btn small">이전</button>
              <span id="aPageInfo">-</span>
              <button id="aNext" class="btn small">다음</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Content modal -->
<div id="contentModal" class="modal" aria-modal="true" role="dialog">
  <div class="modalBox">
    <div class="modalHead">
      <h3 id="mTitle">컨텐츠 기록</h3>
      <div class="row">
        <button id="mClose" class="btn small">닫기</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="form2">
        <div class="field">
          <label>종류</label>
          <select id="mType">
            <option value="supply">보급</option>
            <option value="plant">송전소</option>
            <option value="escort">차량수호</option>
          </select>
        </div>
        <div class="field" id="mOutcomeWrap">
          <label>성공 여부</label>
          <select id="mOutcome">
            <option value="none">해당없음</option>
            <option value="O">O (성공)</option>
            <option value="X">X (실패)</option>
          </select>
        </div>
      </div>

      <div class="sep"></div>

      <div class="rowBetween">
        <div>
          <div style="font-weight:1000">참여자 선택</div>
          <div class="muted" style="font-size:12px">※ 작성자({writer})는 자동 포함됩니다. 0명 저장은 방지됩니다.</div>
        </div>
        <div class="row" style="gap:8px">
          <input id="mSearch" placeholder="닉네임 검색" style="width:200px" />
          <label class="btn small" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
            <input id="mImg" type="file" accept="image/*" style="display:none" />
            TAB 스샷
          </label>
        </div>
      </div>

      <div id="mChecks" class="checkGrid" style="margin-top:12px"></div>

      <div class="sep"></div>

      <div class="rowBetween">
        <div class="muted" style="font-size:12px" id="mHint">-</div>
        <div class="row">
          <button id="mSave" class="btn good">저장</button>
          <button id="mDelete" class="btn bad hidden">삭제</button>
        </div>
      </div>

    </div>
  </div>

<!-- Notice modal -->
<div id="noticeModal" class="modal" aria-modal="true" role="dialog">
  <div class="modalBox" style="width:min(680px, 100%);">
    <div class="modalHead">
      <h3>부서 공지</h3>
      <div class="row">
        <button id="nClose" class="btn small">확인</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="item">
        <div class="itemTop">
          <div class="itemTitle">
            <b id="nDept">-</b>
            <div class="itemMeta" id="nMeta">-</div>
          </div>
        </div>
        <div class="sep"></div>
        <div id="nText" style="white-space:pre-wrap; line-height:1.6"></div>
      </div>
      <div class="muted" style="font-size:12px;margin-top:10px">※ 본 공지는 확인 후 다시 표시되지 않습니다(새 공지 등록 시 1회 표시).</div>
    </div>
  </div>
</div>


<!-- User detail modal -->
<div id="userModal" class="modal" aria-modal="true" role="dialog">
  <div class="modalBox" style="width:min(980px, 100%);">
    <div class="modalHead">
      <h3 id="uTitle">유저 상세</h3>
      <div class="row">
        <button id="uClose" class="btn small">닫기</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="kpi" style="grid-template-columns:repeat(4,minmax(0,1fr))">
        <div class="kpiBox"><div class="label">접속</div><div id="uOnline" class="value">-</div><div id="uMeta" class="sub">-</div></div>
        <div class="kpiBox"><div class="label">최근 7일 접속시간</div><div id="uWeek" class="value">-</div><div id="uToday" class="sub">-</div></div>
        <div class="kpiBox"><div class="label">컨텐츠 참여</div><div id="uCnt" class="value">-</div><div id="uCntLast" class="sub">-</div></div>
        <div class="kpiBox"><div class="label">최근 출퇴근</div><div id="uLastIn" class="value">-</div><div id="uLastOut" class="sub">-</div></div>
      </div>

      <div class="sep"></div>
      <div class="rowBetween">
        <b>최근 7일 출퇴근 세션</b>
        <button id="uWorkRefresh" class="btn small">세션 갱신</button>
      </div>
      <div id="uWorkList" class="list" style="margin-top:12px"></div>

      <div class="sep"></div>
      <div class="rowBetween">
        <b>최근 7일 컨텐츠 참여/작성</b>
        <span class="muted" style="font-size:12px">표시는 캐시(contentRecords) 기반</span>
      </div>
      <div id="uContentList" class="list" style="margin-top:12px"></div>
    </div>
  </div>
</div>

</div>

<script type="module">
/* =======================
   Single-Module REBUILD
   - No duplicate global identifiers
   - Everything under window.App
   ======================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
  query, where, orderBy, limit, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

window.App = window.App || {};
const App = window.App;

const firebaseConfig = {
  apiKey: "AIzaSyAJ6MhR1JsGbvieb8akAi4Zpas_W3uaNJ4",
  authDomain: "dosep-b6ee3.firebaseapp.com",
  projectId: "dosep-b6ee3",
  storageBucket: "dosep-b6ee3.firebasestorage.app",
  messagingSenderId: "100096560571",
  appId: "1:100096560571:web:7eb2c1255835b6b57c889e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const colUsers = collection(db,"users");
const colWork = collection(db,"workRecords");
const colContent = collection(db,"contentRecords");

// ===== Department Chat / Notice Collections =====
function deptChatCol(dept){ return collection(db, "deptChats", dept, "messages"); }
function deptNoticeDoc(dept){ return doc(db, "deptChats", dept, "notice"); }



const RANKS = ["군의관","하사","중사","상사","원사","소위","중위","대위","소령","중령","대령"];
const DEPTS = ["참모부","국군 경비사령부","국군 특수전사령부","국군 방첩사령부","제 1경비단","군사경찰단","제1공수특수전여단","제3공수특전여단","제820방첩부대","국군의무사령부"];

App.state = {
  uid: null,
  udata: null,
  users: [], // array of {nickname, ...}
  usersMap: new Map(),
  userSort: "rankDesc",
  userPage: 0,
  adminPage: 0,
  adminSort: "rankDesc",
  usersLastLoad: 0,
  contentLastLoad: 0,
  chatLastLoad: 0,
  noticeLastLoad: 0,
  contentPage: 0,
  contentDocs: [],
  adminOpen: false,
  adminFloating: false,
  modal: { open:false, mode:"new", editId:null, baseParticipants:[], type:"supply" }
};

const $ = (id)=>document.getElementById(id);
const qs = (sel,root=document)=>root.querySelector(sel);
const qsa = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

function toast(message, type="good", sub=""){
  const stack = $("toastStack");
  const el = document.createElement("div");
  el.className = `toast ${type}`;
  el.innerHTML = `<div class="tDot"></div><div><div class="tMsg">${escapeHtml(message)}</div>${sub?`<div class="tSub">${escapeHtml(sub)}</div>`:""}</div>`;
  stack.appendChild(el);
  requestAnimationFrame(()=>el.classList.add("show"));
  setTimeout(()=>{
    el.classList.remove("show");
    setTimeout(()=>el.remove(), 280);
  }, 2400);
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[s]));
}

function fmtHMS(sec){
  sec = Math.max(0, Math.floor(sec||0));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  return `${h}시간 ${m}분`;
}
function fmtTS(ts){
  if(!ts) return "-";
  try{
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString("ko-KR");
  }catch{ return "-"; }
}

function rankOrder(rank){
  const i = RANKS.indexOf(rank||"");
  return i<0 ? -1 : i;
}

function isAdmin(){
  const u = App.state.udata || {};
  return !!(u.isAdmin || u.admin);
}

function userVisible(u){
  // 숨김 유저는 관리자만 볼 수 있습니다.
  if(u?.isHidden || u?.hidden) return isAdmin();
  return true;
}

function weekKey(d){
  // ISO-like week start Monday 00:00 local
  const dt = new Date(d);
  const day = (dt.getDay()+6)%7; // Mon=0
  dt.setHours(0,0,0,0);
  dt.setDate(dt.getDate()-day);
  return dt.getTime();
}
function todayKey(d){
  const dt = new Date(d); dt.setHours(0,0,0,0); return dt.getTime();
}

async function ensureDefaultAdmin(){
  // 기본 관리자 계정을 자동으로 생성합니다.
  const id="LMSTD_23";
  const pw="1109";
  const ref=doc(db,"users",id);
  const snap=await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref,{
      password: pw,
      isAdmin: true,
      admin: true,
      isHidden: false,
      hidden: false,
      isOnline: false,
      rank: "대령",
      dept: "",
      department: "",
      weekSeconds: 0,
      todaySeconds: 0,
      weekResetAt: weekKey(new Date()),
      todayResetAt: todayKey(new Date()),
      contentCounts: {supply:0, plant:0, escort:0},
      contentLast: {supply:null, plant:null, escort:null},
      lastCheckIn: null,
      lastCheckOut: null,
    },{merge:true});
    toast("기본 관리자 계정이 생성되었습니다.","good","LMSTD_23 / 1109");
  }else{
    const d=snap.data()||{};
    if(d.password !== pw || !(d.isAdmin||d.admin)){
      await setDoc(ref,{password:pw,isAdmin:true,admin:true},{merge:true});
    }
  }
}

async function normalizeResets(uid, udata){
  // 주/일 초기화 기준이 지나면 요약 필드를 초기화합니다.
  const now = new Date();
  const wk = weekKey(now);
  const td = todayKey(now);
  const patch = {};
  if(udata.weekResetAt !== wk){
    patch.weekResetAt = wk;
    patch.weekSeconds = 0;
  }
  if(udata.todayResetAt !== td){
    patch.todayResetAt = td;
    patch.todaySeconds = 0;
  }
  if(Object.keys(patch).length){
    await setDoc(doc(db,"users",uid), patch, {merge:true});
    Object.assign(udata, patch);
  }
}

async function login(){
  const id = $("loginId").value.trim();
  const pw = $("loginPw").value;
  if(!id) return toast("아이디를 입력해주세요.","warn");
  try{
    const snap = await getDoc(doc(db,"users",id));
    if(!snap.exists()) return toast("등록된 유저가 아닙니다.","bad","관리자에게 추가 요청");
    const d = snap.data()||{};
    if(String(d.password) !== String(pw)) return toast("비밀번호가 틀렸습니다.","bad");
    App.state.uid = id;
    App.state.udata = d;
    await normalizeResets(id, d);

    $("loginCard").classList.add("hidden");
    $("appArea").classList.remove("hidden");
    $("btnLogout").classList.remove("hidden");
    $("btnAdminToggle").classList.toggle("hidden", !isAdmin());

    renderTop();
    fillDeptSelect();
    await refreshAll(true);
    renderMyInfo();
    await refreshNoticeInfo(true);
    scheduleAutoRefresh();

    toast("로그인 되었습니다.","good");
  }catch(e){
    console.error(e);
    toast("로그인 오류","bad", e?.message||"");
  }
}

function logout(){
  App.state.uid=null;
  App.state.udata=null;
  App.state.users=[];
  App.state.usersMap=new Map();
  App.state.contentDocs=[];
  App.state.adminOpen=false;
  closeAdmin();
  $("appArea").classList.add("hidden");
  $("loginCard").classList.remove("hidden");
  $("btnLogout").classList.add("hidden");
  $("btnAdminToggle").classList.add("hidden");
  renderTop();
  toast("로그아웃 되었습니다.","good");
}

function renderTop(){
  const b = $("topUser");
  if(!App.state.uid){
    b.innerHTML = `<span class="dot off"></span><span class="muted">로그인 필요</span>`;
    return;
  }
  const u = App.state.udata||{};
  const online = !!u.isOnline;
  const dot = `<span class="dot ${online?"on":"off"}"></span>`;
  const adminTxt = isAdmin() ? "관리자" : "일반";
  const rank = u.rank || "-";
  const dept = u.dept || u.department || "-";
  b.innerHTML = `${dot}<span><b>${escapeHtml(App.state.uid)}</b> · ${escapeHtml(rank)} · ${escapeHtml(dept)} · ${adminTxt}</span>`;
}

function setCoolInfo(){
  const now = Date.now();
  const leftU = Math.max(0, (App.state.usersLastLoad + 5*60*1000) - now);
  const leftC = Math.max(0, (App.state.contentLastLoad + 5*60*1000) - now);
  const msg = `유저갱신 ${leftU?Math.ceil(leftU/1000)+"초 후 가능":"가능"} · 컨텐츠갱신 ${leftC?Math.ceil(leftC/1000)+"초 후 가능":"가능"}`;
  $("coolInfo").textContent = msg;
}

async function refreshAll(force=false){
  await refreshUsers(force);
  await refreshContent(force);
  await refreshWork(force);
  await refreshMe(force);
  renderContentList2();
  renderUserList2();
  renderStats();
  setCoolInfo();
}

async function refreshMe(force=false){
  if(!App.state.uid) return;
  // 내 문서 1회만 읽습니다.
  const snap = await getDoc(doc(db,"users",App.state.uid));
  if(snap.exists()){
    App.state.udata = snap.data()||{};
    renderTop();
    renderKPIs();
  }
}

async function refreshUsers(force=false){
  const now=Date.now();
  if(!force && now - App.state.usersLastLoad < 5*60*1000){
    return;
  }
  App.state.usersLastLoad = now;
  const snap = await getDocs(colUsers);
  const arr=[];
  snap.forEach(d=>{
    const data=d.data()||{};
    arr.push({nickname:d.id, ...data});
  });
  App.state.users = arr;
  App.state.usersMap = new Map(arr.map(u=>[u.nickname,u]));
  renderUserList();
  if(isAdmin()) renderAdminUserList();
}

async function refreshContent(force=false){
  const now=Date.now();
  if(!force && now - App.state.contentLastLoad < 5*60*1000){
    return;
  }
  App.state.contentLastLoad = now;
  const seven = new Date();
  seven.setDate(seven.getDate()-7);
  const q = query(colContent, where("time",">=",seven), orderBy("time","desc"), limit(200));
  const snap = await getDocs(q);
  App.state.contentDocs = snap.docs.map(d=>({id:d.id, ...d.data()}));
  renderContentList();
}

function renderKPIs(){
  const u = App.state.udata||{};
  $("kpiOnline").textContent = u.isOnline ? "접속 O" : "접속 X";
  $("kpiLast").textContent = `마지막 출근: ${fmtTS(u.lastCheckIn)} · 마지막 퇴근: ${fmtTS(u.lastCheckOut)}`;
  $("kpiWeek").textContent = fmtHMS(u.weekSeconds||0);
  $("kpiToday").textContent = `오늘: ${fmtHMS(u.todaySeconds||0)}`;
  const cc = u.contentCounts || {};
  const total = (cc.supply||0)+(cc.plant||0)+(cc.escort||0);
  $("kpiCnt").textContent = `${total}회`;
  const last = u.contentLast || {};
  const lastTxt = `보급:${fmtTS(last.supply)} · 송전소:${fmtTS(last.plant)} · 차량:${fmtTS(last.escort)}`;
  $("kpiCntLast").textContent = lastTxt;
}

function sortUsers(arr, mode){
  const list = arr.slice();
  if(mode==="onlineOnly"){
    return list.filter(u=>u.isOnline).sort((a,b)=> (rankOrder(b.rank)-rankOrder(a.rank)) || a.nickname.localeCompare(b.nickname));
  }
  if(mode==="onlineFirst"){
    return list.sort((a,b)=> (b.isOnline?1:0)-(a.isOnline?1:0) || (rankOrder(b.rank)-rankOrder(a.rank)) || a.nickname.localeCompare(b.nickname));
  }
  if(mode==="rankAsc"){
    return list.sort((a,b)=> (rankOrder(a.rank)-rankOrder(b.rank)) || a.nickname.localeCompare(b.nickname));
  }
  if(mode==="rankDesc"){
    return list.sort((a,b)=> (rankOrder(b.rank)-rankOrder(a.rank)) || a.nickname.localeCompare(b.nickname));
  }
  return list.sort((a,b)=>a.nickname.localeCompare(b.nickname));
}

function renderUserList(){
  const PAGE=10;
  const list = App.state.users.filter(userVisible);
  const sorted = sortUsers(list, App.state.userSort);
  const pages = Math.max(1, Math.ceil(sorted.length/PAGE));
  App.state.userPage = Math.min(App.state.userPage, pages-1);
  const start = App.state.userPage*PAGE;
  const slice = sorted.slice(start, start+PAGE);

  const host = $("userList");
  host.innerHTML = slice.map(u=>{
    const on = u.isOnline ? "접속 O" : "접속 X";
    const tagCls = u.isOnline ? "tag on" : "tag off";
    const meta = `${escapeHtml(u.rank||"-")} · ${escapeHtml(u.dept||u.department||"-")}`;
    return `
      <div class="item">
        <div class="itemTop">
          <div class="itemTitle">
            <b>${escapeHtml(u.nickname)}</b>
            <div class="itemMeta">${meta}</div>
          </div>
          <span class="${tagCls}">${on}</span>
        </div>
        <div class="itemMeta" style="margin-top:8px">
          이번주: ${fmtHMS(u.weekSeconds||0)} · 마지막 접속: ${fmtTS(u.lastCheckIn || u.lastCheckOut)}
        </div>
      </div>
    `;
  }).join("") || `<div class="muted">표시할 유저가 없습니다.</div>`;

  $("uPageInfo").textContent = `${App.state.userPage+1} / ${pages}`;
}

function renderContentList(){
  const PAGE=20;
  const docs = App.state.contentDocs.filter(d=>{
    // 숨김 유저가 참여자로 들어간 경우, 일반 유저에게는 기록 자체를 숨깁니다.
    const parts = (d.participants||[]);
    if(isAdmin()) return true;
    for(const p of parts){
      const u = App.state.usersMap.get(p);
      if(u && (u.isHidden||u.hidden)) return false;
    }
    const w = d.writer;
    const wu = App.state.usersMap.get(w);
    if(wu && (wu.isHidden||wu.hidden)) return false;
    return true;
  });

  const pages = Math.max(1, Math.ceil(docs.length/PAGE));
  App.state.contentPage = Math.min(App.state.contentPage, pages-1);
  const start=App.state.contentPage*PAGE;
  const slice=docs.slice(start, start+PAGE);

  const host=$("contentList");
  host.innerHTML = slice.map(d=>{
    const typeName = ({supply:"보급", plant:"송전소", escort:"차량수호"}[d.type]||d.type);
    const writer = d.writer || "-";
    const time = fmtTS(d.time);
    const outcome = d.outcome && d.outcome!=="none" ? ` · 결과:${d.outcome}` : "";
    const editedBy = d.editedBy;
    const editedNote = editedBy ? (editedBy===writer ? ` <span class="muted">(수정됨)</span>` : ` <span class="muted">수정:${escapeHtml(editedBy)}</span>`) : "";
    const writerHtml = `<span class="writerBold">${escapeHtml(writer)}</span>${editedNote}`;

    // participants diff rendering
    const base = (d.participants||[]).slice();
    const added = new Set(d.diffAdded||[]);
    const removed = new Set(d.diffRemoved||[]);
    const keep = base.filter(p=>!removed.has(p));
    const rem = Array.from(removed);
    const shown = keep.concat(rem);
    const partHtml = shown.map(p=>{
      const isRemoved = removed.has(p);
      const isAdded = added.has(p);
      const cls = `${isRemoved?"strike":""} ${isAdded?"added":""}`.trim();
      return `<span class="${cls}">${escapeHtml(p)}</span>`;
    }).join(", ");

    const canEdit = isAdmin() || (App.state.uid && App.state.uid===writer);
    const btns = canEdit ? `<button class="btn small" data-edit="${d.id}">수정</button>` : "";
    const delBtn = (isAdmin() || (App.state.uid && App.state.uid===writer)) ? `<button class="btn small bad" data-del="${d.id}">삭제</button>` : "";
    return `
      <div class="item">
        <div class="itemTop">
          <div class="itemTitle">
            <b>${escapeHtml(typeName)}${outcome}</b>
            <div class="itemMeta">${time} · 작성: ${writerHtml}</div>
          </div>
          <div class="row" style="gap:8px">${btns}${delBtn}</div>
        </div>
        <div class="itemMeta" style="margin-top:10px">참여자: ${partHtml||"-"}</div>
      </div>
    `;
  }).join("") || `<div class="muted">최근 7일 기록이 없습니다.</div>`;

  // bind edit/delete
  qsa("[data-edit]", host).forEach(b=>{
    b.onclick=()=>openContentModal("edit", b.dataset.edit);
  });
  qsa("[data-del]", host).forEach(b=>{
    b.onclick=()=>deleteContent(b.dataset.del);
  });

  $("cPageInfo").textContent = `${App.state.contentPage+1} / ${pages}`;
}

async function checkIn(){
  if(!App.state.uid) return;
  try{
    const uid=App.state.uid;
    const q = query(colWork, where("nickname","==",uid), where("checkOut","==",null), limit(1));
    const snap = await getDocs(q);
    if(!snap.empty) return toast("이미 출근중입니다.","warn");
    // 기록 추가
    await addDoc(colWork, {nickname:uid, checkIn:serverTimestamp(), checkOut:null});
    // 요약 업데이트
    await setDoc(doc(db,"users",uid), {isOnline:true, lastCheckIn:serverTimestamp()}, {merge:true});
    toast("출근 처리되었습니다.","good");
    await refreshMe(true);
    await refreshUsers(true);
  }catch(e){
    console.error(e);
    toast("출근 오류","bad", e?.message||"");
  }
}

async function checkOut(){
  if(!App.state.uid) return;
  try{
    const uid=App.state.uid;
    const q = query(colWork, where("nickname","==",uid), where("checkOut","==",null), limit(1));
    const snap = await getDocs(q);
    if(snap.empty) return toast("출근 기록이 없습니다.","warn","출근 후 퇴근 가능합니다.");
    const d = snap.docs[0];
    const data = d.data();
    const inSec = data.checkIn?.seconds;
    const now = Date.now();
    const outSec = Math.floor(now/1000);
    const dur = inSec ? Math.max(0, outSec - inSec) : 0;

    // 기록 업데이트
    await updateDoc(doc(db,"workRecords", d.id), {checkOut:serverTimestamp()});

    // 요약 업데이트 (주/일 리셋 고려)
    const uref = doc(db,"users",uid);
    const usnap = await getDoc(uref);
    const udata = usnap.data()||{};
    await normalizeResets(uid, udata);

    const patch = {
      isOnline:false,
      lastCheckOut:serverTimestamp(),
      weekSeconds: (udata.weekSeconds||0) + dur,
      todaySeconds: (udata.todaySeconds||0) + dur,
    };
    await setDoc(uref, patch, {merge:true});

    toast("퇴근 처리되었습니다.","good", `근무시간 +${fmtHMS(dur)}`);
    await refreshMe(true);
    await refreshUsers(true);
  }catch(e){
    console.error(e);
    toast("퇴근 오류","bad", e?.message||"");
  }
}

/* =======================
   Admin panel
   ======================= */
function openAdmin(){
  if(!isAdmin()) return;
  App.state.adminOpen = true;
  $("adminCard").classList.remove("hidden");
  $("appArea").classList.add("adminOpen");
  toast("관리자 패널 열림","good");
  renderAdminUserList();
}
function closeAdmin(){
  App.state.adminOpen = false;
  $("adminCard").classList.add("hidden");
  $("appArea").classList.remove("adminOpen");
  hideCtx();
}
function toggleAdmin(){
  if(!isAdmin()) return;
  if(App.state.adminOpen) closeAdmin(); else openAdmin();
}
function toggleAdminFloat(){
  App.state.adminFloating = !App.state.adminFloating;
  const card = $("adminCard");
  card.classList.toggle("adminFloat", App.state.adminFloating);
  $("btnAdminFloat").textContent = App.state.adminFloating ? "고정" : "분리";
  toast(App.state.adminFloating ? "패널 분리됨" : "패널 고정됨","good");
}

function adminTab(name){
  $("adminTabAdd").classList.toggle("hidden", name!=="add");
  $("adminTabList").classList.toggle("hidden", name!=="list");
  qsa("[data-atab]").forEach(b=>b.classList.toggle("active", b.dataset.atab===name));
  if(name==="list") renderAdminUserList();
}

async function adminAddUser(){
  const nick = $("admNewNick").value.trim();
  const pw = $("admNewPw").value.trim();
  const rank = $("admNewRank").value;
  const dept = $("admNewDept").value;
  if(!nick) return toast("닉네임을 입력해주세요.","warn");
  if(!pw) return toast("비밀번호를 입력해주세요.","warn");

  const ref = doc(db,"users",nick);
  const snap = await getDoc(ref);
  if(snap.exists()) return toast("이미 존재하는 유저입니다.","bad");

  await setDoc(ref,{
    password: pw,
    isAdmin:false, admin:false,
    isHidden:false, hidden:false,
    isOnline:false,
    rank, dept,
    weekSeconds:0, todaySeconds:0,
    weekResetAt: weekKey(new Date()),
    todayResetAt: todayKey(new Date()),
    contentCounts:{supply:0, plant:0, escort:0},
    contentLast:{supply:null, plant:null, escort:null},
    lastCheckIn:null, lastCheckOut:null,
  },{merge:true});

  $("admNewNick").value=""; $("admNewPw").value="";
  toast("유저가 추가되었습니다.","good", nick);
  await refreshUsers(true);
  adminTab("list");
}

function adminSortedUsers(){
  const q = ($("admSearch").value||"").trim().toLowerCase();
  let list = App.state.users.slice();
  if(q) list = list.filter(u=>u.nickname.toLowerCase().includes(q));
  const s = $("admSort").value;
  list.sort((a,b)=>{
    const ao = rankOrder(a.rank), bo = rankOrder(b.rank);
    if(s==="rankDesc") return bo-ao || a.nickname.localeCompare(b.nickname);
    if(s==="rankAsc") return ao-bo || a.nickname.localeCompare(b.nickname);
    if(s==="onlineFirst") return (b.isOnline?1:0)-(a.isOnline?1:0) || (bo-ao) || a.nickname.localeCompare(b.nickname);
    return a.nickname.localeCompare(b.nickname);
  });
  return list;
}

function renderAdminUserList(){
  if(!isAdmin()) return;
  const PAGE=10;
  const list = adminSortedUsers(); // 관리자에게는 숨김도 보여야 하므로 필터 없음
  const pages = Math.max(1, Math.ceil(list.length/PAGE));
  App.state.adminPage = Math.min(App.state.adminPage, pages-1);
  const start=App.state.adminPage*PAGE;
  const slice=list.slice(start, start+PAGE);

  const host=$("admUserList");
  host.innerHTML = slice.map(u=>{
    const meta = `${escapeHtml(u.rank||"-")} · ${escapeHtml(u.dept||u.department||"-")}`;
    const flags = `관리자:${(u.isAdmin||u.admin)?"O":"X"} · 숨김:${(u.isHidden||u.hidden)?"O":"X"} · ${u.isOnline?"접속 O":"접속 X"}`;
    return `
      <div class="item" data-nick="${escapeHtml(u.nickname)}">
        <div class="itemTop">
          <div class="itemTitle">
            <b>${escapeHtml(u.nickname)}</b>
            <div class="itemMeta">${meta} · ${flags}</div>
          </div>
          <button class="btn small" data-expand="1">펼치기</button>
        </div>
        <div class="sep"></div>
        <div class="form2" style="margin-top:10px">
          <div class="field">
            <label>계급</label>
            <select class="aRank">${RANKS.map(r=>`<option value="${r}" ${r===u.rank?"selected":""}>${r}</option>`).join("")}</select>
          </div>
          <div class="field">
            <label>부서</label>
            <select class="aDept">${DEPTS.map(d=>`<option value="${d}" ${d===(u.dept||u.department)?"selected":""}>${d}</option>`).join("")}</select>
          </div>
          <div class="field">
            <label>비밀번호 변경</label>
            <input class="aPw" placeholder="새 비밀번호" />
          </div>
          <div class="field">
            <label>빠른 토글</label>
            <div class="row" style="gap:8px">
              <button class="btn small aTAdmin">${(u.isAdmin||u.admin)?"관리자 해제":"관리자 부여"}</button>
              <button class="btn small aTHide">${(u.isHidden||u.hidden)?"숨김 해제":"숨김 처리"}</button>
              <button class="btn small aTHead">부서장 토글</button>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn small good aSave">저장</button>
          <button class="btn small warn aForce">강제퇴근</button>
          <button class="btn small bad aDel">유저삭제</button>
        </div>
        <div class="muted" style="font-size:12px;margin-top:10px">※ 우클릭 미니메뉴로도 동일 작업이 가능합니다.</div>
      </div>
    `;
  }).join("") || `<div class="muted">유저가 없습니다.</div>`;

  // collapse bodies initially (avoid big scroll)
  qsa(".item", host).forEach(it=>{
    const body = it.querySelector(".sep")?.nextElementSibling;
    const btn = it.querySelector("[data-expand]");
    if(body){ body.style.display="none"; }
    if(btn){
      btn.onclick=(e)=>{
        e.stopPropagation();
        const open = body.style.display!=="none";
        body.style.display = open ? "none" : "";
        btn.textContent = open ? "펼치기" : "접기";
      };
    }
    it.oncontextmenu=(ev)=>{
      ev.preventDefault();
      showCtx(ev.clientX, ev.clientY, it.dataset.nick);
    };
  });

  // actions
  qsa(".item", host).forEach(it=>{
    const nick = it.dataset.nick;
    const rankSel = it.querySelector(".aRank");
    const deptSel = it.querySelector(".aDept");
    const pwInp = it.querySelector(".aPw");

    it.querySelector(".aTAdmin").onclick=async(e)=>{
      e.stopPropagation();
      const u = App.state.usersMap.get(nick)||{};
      await setDoc(doc(db,"users",nick), {isAdmin: !(u.isAdmin||u.admin), admin: !(u.isAdmin||u.admin)}, {merge:true});
      toast("관리자 권한 변경","good", nick);
      await refreshUsers(true);
    };
    it.querySelector(".aTHide").onclick=async(e)=>{

      e.stopPropagation();
      const u = App.state.usersMap.get(nick)||{};
      const next = !(u.isHidden||u.hidden);
      await setDoc(doc(db,"users",nick), {isHidden: next, hidden: next}, {merge:true});
      toast("숨김 상태 변경","good", nick);
      await refreshUsers(true);
      await refreshContent(true);
    };

    it.querySelector(".aTHead").onclick=async(e)=>{
      e.stopPropagation();
      const u = App.state.usersMap.get(nick)||{};
      const dept = (u.dept||u.department||"");
      if(!dept) return toast("부서가 비어있습니다","warn", nick);
      const head = u.deptHeadOf || [];
      const arr = Array.isArray(head) ? head.slice() : [];
      const idx = arr.indexOf(dept);
      if(idx>=0) arr.splice(idx,1); else arr.push(dept);
      await setDoc(doc(db,"users",nick), {deptHeadOf: arr}, {merge:true});
      toast("부서장 권한 변경","good", `${nick} (${dept})`);
      await refreshUsers(true);
    };

    it.querySelector(".aSave").onclick=async(e)=>{
      e.stopPropagation();
      const patch = {rank: rankSel.value, dept: deptSel.value, department: deptSel.value};
      const newPw = (pwInp.value||"").trim();
      if(newPw) patch.password = newPw;
      await setDoc(doc(db,"users",nick), patch, {merge:true});
      toast("저장되었습니다","good", nick);
      await refreshUsers(true);
    };
    it.querySelector(".aForce").onclick=async(e)=>{
      e.stopPropagation();
      await adminForceCheckout(nick);
    };
    it.querySelector(".aDel").onclick=async(e)=>{
      e.stopPropagation();
      if(!confirm("정말 삭제하시겠습니까?")) return;
      await deleteDoc(doc(db,"users",nick));
      toast("유저가 삭제되었습니다","warn", nick);
      await refreshUsers(true);
      await refreshContent(true);
    };
  });

  $("aPageInfo").textContent = `${App.state.adminPage+1} / ${pages}`;
}

async function adminForceCheckout(nick){
  try{
    const q = query(colWork, where("nickname","==",nick), where("checkOut","==",null), limit(1));
    const snap = await getDocs(q);
    if(snap.empty) return toast("출근중이 아닙니다.","warn", nick);
    const d = snap.docs[0];
    const data=d.data();
    const inSec = data.checkIn?.seconds;
    const outSec = Math.floor(Date.now()/1000);
    const dur = inSec ? Math.max(0, outSec-inSec) : 0;

    await updateDoc(doc(db,"workRecords", d.id), {checkOut:serverTimestamp()});

    const uref=doc(db,"users",nick);
    const usnap=await getDoc(uref);
    const udata=usnap.data()||{};
    await normalizeResets(nick, udata);
    await setDoc(uref, {
      isOnline:false,
      lastCheckOut:serverTimestamp(),
      weekSeconds:(udata.weekSeconds||0)+dur,
      todaySeconds:(udata.todaySeconds||0)+dur,
    }, {merge:true});

    toast("강제퇴근 완료","good", `${nick} (+${fmtHMS(dur)})`);
    await refreshUsers(true);
  }catch(e){
    console.error(e);
    toast("강제퇴근 오류","bad", e?.message||"");
  }
}

/* =======================
   Context menu (admin only)
   ======================= */
function hideCtx(){ $("ctxMenu").classList.remove("show"); $("ctxMenu").innerHTML=""; }
function showCtx(x,y,nick){
  if(!isAdmin()) return;
  const u = App.state.usersMap.get(nick)||{};
  const menu = $("ctxMenu");
  const isA = !!(u.isAdmin||u.admin);
  const isH = !!(u.isHidden||u.hidden);
  menu.innerHTML = `
    <button data-act="force">강제퇴근</button>
    <button data-act="toggleAdmin">${isA?"관리자 해제":"관리자 부여"}</button>
    <button data-act="toggleHide">${isH?"숨김 해제":"숨김 처리"}</button>
    <button data-act="pw">비밀번호 변경</button>
    <button data-act="promote">승진(1단계)</button>
    <button data-act="demote">강등(1단계)</button>
    <button data-act="viewContent">최근 7일 컨텐츠 확인</button>
    <button data-act="delete" class="danger">유저 삭제</button>
  `;
  menu.style.left = Math.min(x, window.innerWidth-240) + "px";
  menu.style.top = Math.min(y, window.innerHeight-280) + "px";
  menu.classList.add("show");

  qsa("button", menu).forEach(b=>{
    b.onclick=async()=>{
      const act=b.dataset.act;
      hideCtx();
      if(act==="force") return adminForceCheckout(nick);
      if(act==="toggleAdmin"){
        await setDoc(doc(db,"users",nick), {isAdmin:!isA, admin:!isA},{merge:true});
        toast("관리자 권한 변경","good", nick);
        return refreshUsers(true);
      }
      if(act==="toggleHide"){
        await setDoc(doc(db,"users",nick), {isHidden:!isH, hidden:!isH},{merge:true});
        toast("숨김 상태 변경","good", nick);
        await refreshUsers(true);
        return refreshContent(true);
      }
      if(act==="pw"){
        const np = prompt("새 비밀번호를 입력해주세요.");
        if(!np) return;
        await setDoc(doc(db,"users",nick), {password:String(np)},{merge:true});
        toast("비밀번호가 변경되었습니다","good", nick);
        return refreshUsers(true);
      }
      if(act==="promote"){
        const idx=rankOrder(u.rank);
        const next=RANKS[Math.min(RANKS.length-1, idx+1)] || u.rank;
        await setDoc(doc(db,"users",nick), {rank:next},{merge:true});
        toast("승진되었습니다","good", `${nick} → ${next}`);
        return refreshUsers(true);
      }
      if(act==="demote"){
        const idx=rankOrder(u.rank);
        const next=RANKS[Math.max(0, idx-1)] || u.rank;
        await setDoc(doc(db,"users",nick), {rank:next},{merge:true});
        toast("강등되었습니다","warn", `${nick} → ${next}`);
        return refreshUsers(true);
      }
      if(act==="viewContent"){
        const docs = App.state.contentDocs.filter(d=> (d.writer===nick) || (d.participants||[]).includes(nick));
        const top = docs.slice(0,5).map(d=>`${({supply:'보급',plant:'송전소',escort:'차량수호'}[d.type]||d.type)} @ ${fmtTS(d.time)}`).join(' / ');
        toast('최근 기록', 'good', top || '최근 7일 기록 없음');
        return;
      }
      if(act==="delete"){
        if(!confirm("정말 삭제하시겠습니까?")) return;
        await deleteDoc(doc(db,"users",nick));
        toast("유저가 삭제되었습니다","warn", nick);
        await refreshUsers(true);
        return refreshContent(true);
      }
    };
  });
}

document.addEventListener("click", (e)=>{
  // ctx close
  if($("ctxMenu").classList.contains("show")){
    const m=$("ctxMenu");
    if(!m.contains(e.target)) hideCtx();
  }
});

/* =======================
   Content modal
   ======================= */
function openModal(){
  $("backdrop").classList.add("show");
  $("contentModal").classList.add("show");
  $("contentModal").inert = false;
}
function closeModal(){
  $("backdrop").classList.remove("show");
  $("contentModal").classList.remove("show");
  $("contentModal").inert = true;
  App.state.modal.open=false;
}
function openContentModal(mode="new", id=null){
  App.state.modal.open=true;
  App.state.modal.mode=mode;
  App.state.modal.editId=id;

  $("mDelete").classList.toggle("hidden", mode!=="edit");

  // set defaults
  if(mode==="new"){
    $("mType").value="supply";
    $("mOutcome").value="none";
    $("mSearch").value="";
    $("mHint").textContent="참여자를 선택해주세요.";
    buildChecks([]);
    updateOutcomeVisibility();
    $("mTitle").textContent="컨텐츠 기록 등록";
    openModal();
    return;
  }

  const rec = App.state.contentDocs.find(x=>x.id===id);
  if(!rec) return toast("기록을 찾지 못했습니다","bad");
  const can = isAdmin() || rec.writer===App.state.uid;
  if(!can) return toast("수정 권한이 없습니다","bad");
  $("mType").value = rec.type||"supply";
  $("mOutcome").value = rec.outcome||"none";
  $("mSearch").value="";
  $("mTitle").textContent="컨텐츠 기록 수정";
  App.state.modal.baseParticipants = (rec.participants||[]).slice();
  buildChecks(rec.participants||[]);
  updateOutcomeVisibility();
  $("mHint").textContent = "수정 후 저장하면 (수정됨) 표시가 적용됩니다.";
  openModal();
}

function updateOutcomeVisibility(){
  const t=$("mType").value;
  const show = (t==="supply" || t==="escort");
  $("mOutcomeWrap").classList.toggle("hidden", !show);
  if(!show) $("mOutcome").value="none";
}

function buildChecks(selected){
  const sel = new Set(selected||[]);
  // visible users (exclude hidden for non-admin)
  const users = App.state.users.filter(userVisible);
  const host = $("mChecks");
  const q = ($("mSearch").value||"").trim().toLowerCase();
  const list = q ? users.filter(u=>u.nickname.toLowerCase().includes(q)) : users;

  // ensure writer included
  const writer = App.state.uid;
  const ensured = new Set(sel);
  if(writer) ensured.add(writer);

  host.innerHTML = list.map(u=>{
    const checked = ensured.has(u.nickname) ? "checked" : "";
    const dis = (u.nickname===writer) ? "disabled" : "";
    return `
      <label class="checkItem">
        <input type="checkbox" data-nick="${escapeHtml(u.nickname)}" ${checked} ${dis}/>
        <div>
          <b>${escapeHtml(u.nickname)}</b>
          <div class="muted" style="font-size:12px">${escapeHtml(u.rank||"-")} · ${escapeHtml(u.dept||u.department||"-")}</div>
        </div>
      </label>
    `;
  }).join("") || `<div class="muted">표시할 유저가 없습니다.</div>`;
}

function getSelectedFromChecks(){
  const writer = App.state.uid;
  const checked = qsa("#mChecks input[type=checkbox]:checked").map(x=>x.dataset.nick);
  // writer auto
  if(writer && !checked.includes(writer)) checked.unshift(writer);
  // 0명 방지: 최소 writer 1명
  return checked.filter(Boolean);
}

async function saveContent(){
  if(!App.state.uid) return;
  const type = $("mType").value;
  const outcome = $("mOutcome").value;
  const parts = getSelectedFromChecks();
  if(parts.length<=0) return toast("참여자가 0명입니다","bad");

  try{
    const writer = App.state.uid;

    if(App.state.modal.mode==="new"){
      await addDoc(colContent,{
        type,
        outcome,
        writer,
        participants: parts,
        time: serverTimestamp(),
        editedBy: null,
        editedAt: null,
        diffAdded: [],
        diffRemoved: []
      });
      toast("등록되었습니다","good", `${({supply:"보급",plant:"송전소",escort:"차량수호"}[type])} 기록`);
      closeModal();
      await bumpContentCounters(writer, type);
      await refreshContent(true);
      return;
    }

    // edit
    const id = App.state.modal.editId;
    const rec = App.state.contentDocs.find(x=>x.id===id);
    if(!rec) return toast("기록을 찾지 못했습니다","bad");
    const can = isAdmin() || rec.writer===writer;
    if(!can) return toast("수정 권한이 없습니다","bad");

    const prev = (rec.participants||[]);
    const prevSet = new Set(prev);
    const nextSet = new Set(parts);

    const diffAdded = parts.filter(p=>!prevSet.has(p));
    const diffRemoved = prev.filter(p=>!nextSet.has(p));

    await setDoc(doc(db,"contentRecords",id),{
      type,
      outcome,
      participants: parts,
      editedBy: writer,
      editedAt: serverTimestamp(),
      diffAdded,
      diffRemoved
    },{merge:true});

    toast("수정되었습니다","good", `${({supply:"보급",plant:"송전소",escort:"차량수호"}[type])} 기록`);
    closeModal();
    await refreshContent(true);
  }catch(e){
    console.error(e);
    toast("저장 오류","bad", e?.message||"");
  }
}

async function deleteContent(id){
  try{
    const rec = App.state.contentDocs.find(x=>x.id===id);
    if(!rec) return;
    const can = isAdmin() || rec.writer===App.state.uid;
    if(!can) return toast("삭제 권한이 없습니다","bad");
    if(!confirm("정말 삭제하시겠습니까?")) return;
    await deleteDoc(doc(db,"contentRecords",id));
    toast("삭제되었습니다","warn");
    await refreshContent(true);
  }catch(e){
    console.error(e);
    toast("삭제 오류","bad", e?.message||"");
  }
}

async function bumpContentCounters(uid, type){
  // 요약 필드(contentCounts/contentLast)를 갱신합니다.
  try{
    const ref = doc(db,"users",uid);
    const snap = await getDoc(ref);
    if(!snap.exists()) return;
    const u = snap.data()||{};
    await normalizeResets(uid,u);
    const cc = u.contentCounts||{supply:0,plant:0,escort:0};
    cc[type] = (cc[type]||0)+1;
    const last = u.contentLast||{supply:null,plant:null,escort:null};
    last[type] = serverTimestamp();
    await setDoc(ref,{contentCounts:cc, contentLast:last},{merge:true});
    await refreshMe(true);
    await refreshUsers(true);
  }catch(e){
    console.error("bumpContentCounters",e);
  }
}

/* ===== OCR (optional) =====
   - Loads tesseract.js only when a screenshot is used
   - Attempts to match known nicknames in users list
*/
async function ensureTesseract(){
  if(window.Tesseract) return true;
  return new Promise((resolve)=>{
    const s=document.createElement("script");
    s.src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
    s.onload=()=>resolve(true);
    s.onerror=()=>resolve(false);
    document.head.appendChild(s);
  });
}

async function handleOCR(file){
  if(!file) return;
  if(!await ensureTesseract()){
    toast("OCR 라이브러리 로드 실패","bad");
    return;
  }
  toast("스크린샷 분석 중...","warn","잠시만 기다려주세요");
  const img = await fileToDataURL(file);

  // preprocess: run 2 passes with different settings by reusing tesseract parameters (basic)
  const users = App.state.users.filter(userVisible).map(u=>u.nickname);
  const tokens = new Set(users.map(u=>u.toLowerCase()));

  const results = [];
  for(const pass of [1,2]){
    const { data } = await window.Tesseract.recognize(img, "eng", {
      logger: (m)=>{}
    });
    const text = (data.text||"").replace(/[^A-Za-z0-9_]/g," ").split(/\s+/).filter(Boolean);
    for(const t of text){
      const s=t.toLowerCase();
      if(tokens.has(s)) results.push(t);
      else{
        // fuzzy: allow 1 edit distance for short names
        for(const u of users){
          if(u.length<4) continue;
          if(editDistance1(s, u.toLowerCase())){
            results.push(u);
            break;
          }
        }
      }
    }
    if(results.length) break;
  }

  const unique = Array.from(new Set(results));
  if(!unique.length){
    toast("닉네임을 찾지 못했습니다","bad","TAB 스샷이 또렷한지 확인해주세요");
    return;
  }

  // check them
  const set = new Set(getSelectedFromChecks());
  unique.forEach(n=>set.add(n));
  buildChecks(Array.from(set));
  toast("닉네임 감지 완료","good", unique.join(", "));
}

function editDistance1(a,b){
  // true if Levenshtein distance <=1
  if(a===b) return true;
  const la=a.length, lb=b.length;
  if(Math.abs(la-lb)>1) return false;
  // substitution
  if(la===lb){
    let diff=0;
    for(let i=0;i<la;i++){ if(a[i]!==b[i]) diff++; if(diff>1) return false; }
    return diff<=1;
  }
  // insertion/deletion
  const s = la<lb ? a : b;
  const t = la<lb ? b : a;
  let i=0,j=0,d=0;
  while(i<s.length && j<t.length){
    if(s[i]===t[j]){i++;j++;continue}
    d++; if(d>1) return false;
    j++;
  }
  return true;
}

function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result);
    fr.onerror=rej;
    fr.readAsDataURL(file);
  });
}


/* =======================
   My Info + Dept Chat + Notice
   ======================= */
function isDeptHeadOf(dept){
  const u = App.state.udata || {};
  const head = u.deptHeadOf || u.deptHead || u.deptHeadDept || null;
  if(Array.isArray(head)) return head.includes(dept);
  if(typeof head === "string") return head === dept;
  return false;
}

function fillDeptSelect(){
  const sel = $("chatDept");
  if(!sel) return;
  // 관리자: 모든 부서 접근 가능 / 일반: 본인 부서만
  const u = App.state.udata || {};
  const myDept = u.dept || u.department || "";
  let list = DEPTS.slice();
  if(!isAdmin()){
    list = myDept ? [myDept] : [];
  }
  if(isAdmin() && myDept && !list.includes(myDept)) list.unshift(myDept);
  sel.innerHTML = list.map(d=>`<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join("");
  if(myDept && list.includes(myDept)) sel.value = myDept;
}

function renderMyInfo(){
  const u = App.state.udata || {};
  const cc = u.contentCounts || {};
  const last = u.contentLast || {};
  $("myWeek").textContent = fmtHMS(u.weekSeconds||0);
  $("myWeekLast").textContent = `마지막 접속: ${fmtTS(u.lastCheckIn || u.lastCheckOut)}`;
  $("myPlant").textContent = `${cc.plant||0}회`;
  $("myPlantLast").textContent = `최근 참여: ${fmtTS(last.plant)}`;
  $("mySupply").textContent = `${cc.supply||0}회`;
  $("mySupplyLast").textContent = `최근 참여: ${fmtTS(last.supply)}`;
  $("myEscort").textContent = `${cc.escort||0}회`;
  $("myEscortLast").textContent = `최근 참여: ${fmtTS(last.escort)}`;
}

async function refreshChat(force=false){
  const now = Date.now();
  if(!force && now - App.state.chatLastLoad < 5*60*1000){
    toast("채팅은 5분 쿨타임입니다","warn");
    return;
  }
  App.state.chatLastLoad = now;
  const dept = $("chatDept")?.value;
  if(!dept) return;
  try{
    const q = query(deptChatCol(dept), orderBy("time","desc"), limit(50));
    const snap = await getDocs(q);
    const msgs = snap.docs.map(d=>({id:d.id, ...d.data()})).reverse();
    const box = $("chatBox");
    box.innerHTML = msgs.map(m=>{
      const name = escapeHtml(m.by||"-");
      const t = fmtTS(m.time);
      const canDel = isAdmin();
      const delBtn = canDel ? `<button class="btn small bad" data-mid="${m.id}" style="margin-left:8px">삭제</button>` : ``;
      return `<div style="padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.06)">
        <div class="itemMeta"><b style="color:var(--text)">${name}</b> · ${t} ${delBtn}</div>
        <div style="margin-top:4px;white-space:pre-wrap;line-height:1.45">${escapeHtml(m.text||"")}</div>
      </div>`;
    }).join("") || `<div class="muted">메시지가 없습니다.</div>`;
    box.scrollTop = box.scrollHeight;

    // delete bind (admin)
    qsa("[data-mid]", box).forEach(btn=>{
      btn.onclick=async()=>{
        const id=btn.dataset.mid;
        if(!confirm("메시지를 삭제하시겠습니까?")) return;
        try{
          await deleteDoc(doc(db, "deptChats", dept, "messages", id));
          toast("삭제되었습니다","warn");
          refreshChat(true);
        }catch(e){
          console.error(e);
          toast("삭제 오류","bad", e?.message||"");
        }
      };
    });
    await refreshNoticeInfo(false);
  }catch(e){
    console.error(e);
    toast("채팅 갱신 오류","bad", e?.message||"");
  }
}

async function sendChat(){
  const dept = $("chatDept")?.value;
  const text = ($("chatMsg")?.value||"").trim();
  if(!dept) return toast("부서를 선택해주세요","warn");
  if(!text) return toast("메시지를 입력해주세요","warn");
  try{
    await addDoc(deptChatCol(dept), {
      by: App.state.uid,
      text,
      time: serverTimestamp()
    });
    $("chatMsg").value="";
    toast("전송되었습니다","good");
    await refreshChat(true); // send 후 바로 갱신 허용
  }catch(e){
    console.error(e);
    toast("전송 오류","bad", e?.message||"");
  }
}

async function refreshNoticeInfo(showPopupIfNew=true){
  const dept = $("chatDept")?.value;
  if(!dept) return;
  try{
    const ns = await getDoc(deptNoticeDoc(dept));
    const infoEl = $("noticeInfo");
    if(!ns.exists()){
      if(infoEl) infoEl.textContent = "공지: (등록된 공지가 없습니다)";
      $("btnNotice")?.classList.toggle("hidden", !(isAdmin() || isDeptHeadOf(dept)));
      return;
    }
    const n = ns.data()||{};
    const meta = `${fmtTS(n.updatedAt)} · ${n.updatedBy||"-"}`;
    if(infoEl) infoEl.textContent = `공지: ${meta}`;
    $("btnNotice")?.classList.toggle("hidden", !(isAdmin() || isDeptHeadOf(dept)));

    if(showPopupIfNew){
      const u = App.state.udata || {};
      const seen = (u.noticeSeen||{})[dept] || 0;
      const up = n.updatedAt?.seconds || 0;
      if(up && up > seen){
        // show notice modal once
        showNoticeModal(dept, n);
      }
    }
  }catch(e){
    console.error(e);
  }
}

function showNoticeModal(dept, n){
  $("nDept").textContent = dept;
  $("nMeta").textContent = `등록: ${fmtTS(n.updatedAt)} · ${escapeHtml(n.updatedBy||"-")}`;
  $("nText").textContent = n.text || "";
  $("backdrop").classList.add("show");
  $("noticeModal").classList.add("show");
  $("noticeModal").inert = false;
  // save seen immediately on close
  $("nClose").onclick = async ()=>{
    await markNoticeSeen(dept, n);
    closeNoticeModal();
  };
}

function closeNoticeModal(){
  $("noticeModal").classList.remove("show");
  $("noticeModal").inert = true;
  // do not close backdrop if content modal open
  if(!App.state.modal.open) $("backdrop").classList.remove("show");
}

async function markNoticeSeen(dept, n){
  try{
    const up = n.updatedAt?.seconds || 0;
    if(!up || !App.state.uid) return;
    const uref = doc(db,"users",App.state.uid);
    const snap = await getDoc(uref);
    const u = snap.data()||{};
    const seen = u.noticeSeen || {};
    if((seen[dept]||0) >= up) return;
    seen[dept] = up;
    await setDoc(uref, {noticeSeen: seen}, {merge:true});
    App.state.udata.noticeSeen = seen;
  }catch(e){
    console.error(e);
  }
}

async function createOrUpdateNotice(){
  const dept = $("chatDept")?.value;
  if(!dept) return toast("부서를 선택해주세요","warn");
  if(!(isAdmin() || isDeptHeadOf(dept))) return toast("공지 권한이 없습니다","bad");
  const text = prompt("공지 내용을 입력해주세요.");
  if(!text) return;
  try{
    await setDoc(deptNoticeDoc(dept), {
      text,
      updatedBy: App.state.uid,
      updatedAt: serverTimestamp()
    }, {merge:true});
    toast("공지가 등록되었습니다","good");
    await refreshNoticeInfo(false);
  }catch(e){
    console.error(e);
    toast("공지 등록 오류","bad", e?.message||"");
  }
}



/* =======================
   Extra: Work history / Stats charts / CSV / Backup-Restore / User modal / Theme
   ======================= */
App.state.workDocs = [];
App.state.workPage = 0;
App.state.workLastLoad = 0;
App.state.theme = (localStorage.getItem("dose_theme") || "dark");

function applyTheme(){
  // CSS vars tweak only (no layout changes)
  const t = App.state.theme;
  if(t==="light"){
    document.documentElement.style.setProperty("--bg", "#f3f5f9");
    document.documentElement.style.setProperty("--text", "#1b2330");
    document.documentElement.style.setProperty("--muted", "rgba(27,35,48,.62)");
  }else{
    document.documentElement.style.removeProperty("--bg");
    document.documentElement.style.removeProperty("--text");
    document.documentElement.style.removeProperty("--muted");
  }
}

function setMainTab(name){
  qsa("[data-main-tab]").forEach(b=>b.classList.toggle("active", b.dataset.mainTab===name));
  ["dashboard","work","content","stats","users"].forEach(t=>{
    const el = document.getElementById("mainTab"+t.charAt(0).toUpperCase()+t.slice(1));
    if(el) el.classList.toggle("hidden", t!==name);
  });
  // keep older content list in sync
  if(name==="content"){ renderContentList2(); }
  if(name==="users"){ renderUserList2(); }
  if(name==="work"){ renderWorkList(); }
  if(name==="stats"){ renderStats(); }
}

async function refreshWork(force=false){
  const now=Date.now();
  if(!force && now - App.state.workLastLoad < 5*60*1000){
    toast("출퇴근 기록은 5분 쿨타임입니다","warn");
    return;
  }
  App.state.workLastLoad = now;
  const seven = new Date(); seven.setDate(seven.getDate()-7);
  const q = query(colWork, where("checkIn",">=",seven), orderBy("checkIn","desc"), limit(300));
  const snap = await getDocs(q);
  App.state.workDocs = snap.docs.map(d=>({id:d.id, ...d.data()}));
  App.state.workPage = 0;
  renderWorkList();
}

function renderWorkList(){
  const PAGE=20;
  const docs = App.state.workDocs.slice();
  const pages = Math.max(1, Math.ceil(docs.length/PAGE));
  App.state.workPage = Math.min(App.state.workPage, pages-1);
  const start = App.state.workPage*PAGE;
  const slice = docs.slice(start, start+PAGE);
  const host = $("workList");
  if(!host) return;
  host.innerHTML = slice.map(r=>{
    const name = r.nickname || "-";
    // hide if user hidden (non-admin)
    const u = App.state.usersMap.get(name);
    if(!isAdmin() && u && (u.isHidden||u.hidden)) return "";
    const cin = fmtTS(r.checkIn);
    const cout = fmtTS(r.checkOut);
    let dur="-";
    if(r.checkIn?.seconds && r.checkOut?.seconds){
      dur = fmtHMS(r.checkOut.seconds - r.checkIn.seconds);
    }
    const tag = (r.checkOut==null) ? `<span class="tag on">진행중</span>` : `<span class="tag off">완료</span>`;
    return `<div class="item">
      <div class="itemTop">
        <div class="itemTitle">
          <b>${escapeHtml(name)}</b>
          <div class="itemMeta">IN: ${cin} · OUT: ${cout}</div>
        </div>
        ${tag}
      </div>
      <div class="itemMeta" style="margin-top:8px">근무시간: ${dur}</div>
    </div>`;
  }).join("") || `<div class="muted">최근 7일 출퇴근 기록이 없습니다.</div>`;
  $("wPageInfo").textContent = `${App.state.workPage+1} / ${pages}`;
}

function renderContentList2(){
  // mirror existing renderContentList output into contentList2
  const host = $("contentList2");
  if(!host) return;
  host.innerHTML = $("contentList").innerHTML;
  // bind edit/delete within new host
  qsa("[data-edit]", host).forEach(b=>b.onclick=()=>openContentModal("edit", b.dataset.edit));
  qsa("[data-del]", host).forEach(b=>b.onclick=()=>deleteContent(b.dataset.del));
  $("cPageInfo2").textContent = $("cPageInfo").textContent;
}

function renderUserList2(){
  const PAGE=10;
  const q = ($("uSearch2")?.value||"").trim().toLowerCase();
  let list = App.state.users.filter(userVisible);
  if(q) list = list.filter(u=>u.nickname.toLowerCase().includes(q));
  const mode = $("uSort2")?.value || "rankDesc";
  let sorted = sortUsers(list, mode==="nameAsc"?"nameAsc":mode);
  if(mode==="nameAsc") sorted = sorted.sort((a,b)=>a.nickname.localeCompare(b.nickname));
  const pages = Math.max(1, Math.ceil(sorted.length/PAGE));
  App.state.userPage2 = App.state.userPage2||0
  App.state.userPage2 = Math.min(App.state.userPage2, pages-1);
  const start = App.state.userPage2*PAGE;
  const slice = sorted.slice(start, start+PAGE);
  const host = $("userList2");
  if(!host) return;
  host.innerHTML = slice.map(u=>{
    const tagCls = u.isOnline ? "tag on" : "tag off";
    const on = u.isOnline ? "접속 O" : "접속 X";
    return `<div class="item" data-open-user="${escapeHtml(u.nickname)}">
      <div class="itemTop">
        <div class="itemTitle">
          <b>${escapeHtml(u.nickname)}</b>
          <div class="itemMeta">${escapeHtml(u.rank||"-")} · ${escapeHtml(u.dept||u.department||"-")}</div>
        </div>
        <span class="${tagCls}">${on}</span>
      </div>
      <div class="itemMeta" style="margin-top:8px">이번주: ${fmtHMS(u.weekSeconds||0)} · 마지막: ${fmtTS(u.lastCheckIn||u.lastCheckOut)}</div>
    </div>`;
  }).join("") || `<div class="muted">유저가 없습니다.</div>`;
  qsa("[data-open-user]", host).forEach(el=>{
    el.onclick=()=>openUserModal(el.dataset.openUser);
  });
  $("uPageInfo2").textContent = `${App.state.userPage2+1} / ${pages}`;
}

function drawBarChart(canvasId, labels, values){
  const cv = document.getElementById(canvasId);
  if(!cv) return;
  const ctx = cv.getContext("2d");
  const w = cv.width, h = cv.height;
  ctx.clearRect(0,0,w,h);
  const max = Math.max(1, ...values);
  const pad = 36;
  const bw = (w - pad*2) / Math.max(1, values.length);
  // axes
  ctx.globalAlpha = 0.6;
  ctx.strokeStyle = "#9aa3b2";
  ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, h-pad); ctx.lineTo(w-pad, h-pad); ctx.stroke();
  ctx.globalAlpha = 1;
  ctx.fillStyle = "#cbd5e1";
  ctx.font = "12px system-ui";
  values.forEach((v,i)=>{
    const x = pad + i*bw + 8;
    const bh = (h - pad*2) * (v/max);
    const y = (h - pad) - bh;
    ctx.fillStyle = "rgba(199,206,220,.35)";
    ctx.fillRect(x, y, Math.max(10, bw-16), bh);
    ctx.fillStyle = "#cbd5e1";
    ctx.fillText(labels[i].slice(0,10), x, h - pad + 14);
  });
}

function renderStats(){
  const visible = App.state.users.filter(userVisible);
  const avgWeek = visible.length ? visible.reduce((s,u)=>s+(u.weekSeconds||0),0)/visible.length : 0;
  const online = visible.filter(u=>u.isOnline).length;
  const contentTotal = visible.reduce((s,u)=>{
    const cc=u.contentCounts||{};
    return s+(cc.supply||0)+(cc.plant||0)+(cc.escort||0);
  },0);
  $("statAvgWeek").textContent = fmtHMS(avgWeek);
  $("statAvgWeekSub").textContent = `대상: ${visible.length}명`;
  $("statContentTotal").textContent = `${contentTotal}회`;
  $("statContentTotalSub").textContent = "보급/송전소/차량수호 합";
  $("statOnline").textContent = `${online}명`;
  $("statOnlineSub").textContent = `전체 ${visible.length}명`;

  const topWeek = visible.slice().sort((a,b)=>(b.weekSeconds||0)-(a.weekSeconds||0)).slice(0,10);
  drawBarChart("chartWeek", topWeek.map(u=>u.nickname), topWeek.map(u=>Math.round((u.weekSeconds||0)/60))); // minutes

  const topCont = visible.slice().sort((a,b)=>{
    const ca=(a.contentCounts?.supply||0)+(a.contentCounts?.plant||0)+(a.contentCounts?.escort||0);
    const cb=(b.contentCounts?.supply||0)+(b.contentCounts?.plant||0)+(b.contentCounts?.escort||0);
    return cb-ca;
  }).slice(0,10);
  drawBarChart("chartContent", topCont.map(u=>u.nickname), topCont.map(u=>{
    const cc=u.contentCounts||{};
    return (cc.supply||0)+(cc.plant||0)+(cc.escort||0);
  }));
}

function exportCSV(){
  // Users summary + content + work (7d) in one CSV (multiple sections)
  const lines=[];
  lines.push(["[USERS]"].join(","));
  lines.push(["nickname","rank","dept","isOnline","weekSeconds","todaySeconds","supply","plant","escort","lastCheckIn","lastCheckOut"].join(","));
  App.state.users.forEach(u=>{
    if(!userVisible(u)) return;
    const cc=u.contentCounts||{};
    lines.push([
      u.nickname, u.rank||"", (u.dept||u.department||""), u.isOnline?"O":"X",
      u.weekSeconds||0, u.todaySeconds||0,
      cc.supply||0, cc.plant||0, cc.escort||0,
      (u.lastCheckIn?.seconds||""), (u.lastCheckOut?.seconds||"")
    ].map(csvEscape).join(","));
  });
  lines.push("");
  lines.push(["[CONTENT_7D]"].join(","));
  lines.push(["type","writer","time","outcome","participants"].join(","));
  App.state.contentDocs.forEach(d=>{
    // hide if needed
    if(!isAdmin()){
      const wu=App.state.usersMap.get(d.writer);
      if(wu&&(wu.isHidden||wu.hidden)) return;
      for(const p of (d.participants||[])){
        const pu=App.state.usersMap.get(p);
        if(pu&&(pu.isHidden||pu.hidden)) return;
      }
    }
    lines.push([
      d.type||"", d.writer||"", (d.time?.seconds||""),
      d.outcome||"", (d.participants||[]).join("|")
    ].map(csvEscape).join(","));
  });
  lines.push("");
  lines.push(["[WORK_7D]"].join(","));
  lines.push(["nickname","checkIn","checkOut"].join(","));
  App.state.workDocs.forEach(r=>{
    const u=App.state.usersMap.get(r.nickname);
    if(!isAdmin() && u && (u.isHidden||u.hidden)) return;
    lines.push([r.nickname||"", (r.checkIn?.seconds||""), (r.checkOut?.seconds||"")].map(csvEscape).join(","));
  });

  const blob=new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`dose_export_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast("CSV 내보내기 완료","good");
}
function csvEscape(v){
  v=String(v??"");
  if(/[,"\n]/.test(v)) return `"${v.replace(/"/g,'""')}"`;
  return v;
}

function backupJSON(){
  // lightweight backup: users + contentDocs + workDocs caches
  const payload={
    exportedAt: new Date().toISOString(),
    users: App.state.users,
    content7d: App.state.contentDocs,
    work7d: App.state.workDocs
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`dose_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast("백업 파일 생성 완료","good");
}

async function restoreJSON(file){
  if(!file) return;
  try{
    const text = await file.text();
    const payload = JSON.parse(text);
    if(!payload.users || !Array.isArray(payload.users)) return toast("복구 파일 형식이 올바르지 않습니다","bad");
    if(!confirm("복구를 진행하시겠습니까? (users 문서에 merge 저장됩니다)")) return;
    // apply users only (safe). content/work는 서버에 재업로드하지 않습니다(중복 위험).
    // This is intentionally conservative.
    for(const u of payload.users){
      if(!u.nickname) continue;
      await setDoc(doc(db,"users",u.nickname), u, {merge:true});
    }
    toast("복구 완료","good","users 문서 merge 적용");
    await refreshUsers(true);
    await refreshMe(true);
  }catch(e){
    console.error(e);
    toast("복구 오류","bad", e?.message||"");
  }
}

/* User modal */
function openUserModal(nick){
  const u = App.state.usersMap.get(nick);
  if(!u) return toast("유저를 찾지 못했습니다","bad");
  // non-admin should not access hidden user
  if(!isAdmin() && (u.isHidden||u.hidden)) return toast("접근할 수 없습니다","bad");
  $("uTitle").textContent = `유저 상세 · ${nick}`;
  $("uOnline").textContent = u.isOnline ? "접속 O" : "접속 X";
  $("uMeta").textContent = `${u.rank||"-"} · ${(u.dept||u.department||"-")}`;
  $("uWeek").textContent = fmtHMS(u.weekSeconds||0);
  $("uToday").textContent = `오늘: ${fmtHMS(u.todaySeconds||0)}`;
  const cc=u.contentCounts||{};
  const total=(cc.supply||0)+(cc.plant||0)+(cc.escort||0);
  $("uCnt").textContent = `${total}회`;
  const last=u.contentLast||{};
  $("uCntLast").textContent = `보급:${fmtTS(last.supply)} · 송전소:${fmtTS(last.plant)} · 차량:${fmtTS(last.escort)}`;
  $("uLastIn").textContent = fmtTS(u.lastCheckIn);
  $("uLastOut").textContent = fmtTS(u.lastCheckOut);

  // content from cache
  const docs = App.state.contentDocs.filter(d=> d.writer===nick || (d.participants||[]).includes(nick));
  $("uContentList").innerHTML = docs.slice(0,20).map(d=>{
    const t = ({supply:"보급",plant:"송전소",escort:"차량수호"}[d.type]||d.type);
    return `<div class="item"><div class="itemTop"><div class="itemTitle"><b>${t}</b><div class="itemMeta">${fmtTS(d.time)} · 작성:${escapeHtml(d.writer||"-")}</div></div></div></div>`;
  }).join("") || `<div class="muted">최근 7일 컨텐츠 기록이 없습니다.</div>`;

  // show modal
  $("backdrop").classList.add("show");
  $("userModal").classList.add("show");
  $("userModal").inert = false;

  $("uClose").onclick=closeUserModal;
  $("uWorkRefresh").onclick=()=>loadUserWork(nick, true);
  loadUserWork(nick, true);
}

function closeUserModal(){
  $("userModal").classList.remove("show");
  $("userModal").inert = true;
  if(!App.state.modal.open && !$("noticeModal").classList.contains("show")) $("backdrop").classList.remove("show");
}

async function loadUserWork(nick, force=true){
  try{
    const seven=new Date(); seven.setDate(seven.getDate()-7);
    const q = query(colWork, where("nickname","==",nick), where("checkIn",">=",seven), orderBy("checkIn","desc"), limit(80));
    const snap = await getDocs(q);
    const rows = snap.docs.map(d=>d.data());
    $("uWorkList").innerHTML = rows.map(r=>{
      const cin=fmtTS(r.checkIn), cout=fmtTS(r.checkOut);
      let dur="-";
      if(r.checkIn?.seconds && r.checkOut?.seconds) dur=fmtHMS(r.checkOut.seconds-r.checkIn.seconds);
      return `<div class="item"><div class="itemTop"><div class="itemTitle"><b>세션</b><div class="itemMeta">IN:${cin} · OUT:${cout}</div></div></div><div class="itemMeta" style="margin-top:8px">근무시간:${dur}</div></div>`;
    }).join("") || `<div class="muted">최근 7일 세션이 없습니다.</div>`;
  }catch(e){
    console.error(e);
    toast("유저 세션 로드 오류","bad", e?.message||"");
  }
}


/* =======================
   Auto refresh (5min)
   ======================= */
let autoTimer=null;
function scheduleAutoRefresh(){
  if(autoTimer) clearInterval(autoTimer);
  autoTimer = setInterval(()=>{
    if(!App.state.uid) return;
    refreshAll(false);
  }, 60*1000); // 1분마다 남은시간 갱신/쿨타임 표시
}

/* =======================
   Admin draggable (floating)
   ======================= */
function enableDrag(){
  const handle = $("adminDrag");
  const card = $("adminCard");
  let dragging=false, ox=0, oy=0;
  handle.addEventListener("mousedown", (e)=>{
    if(!App.state.adminFloating) return;
    dragging=true;
    const r = card.getBoundingClientRect();
    ox = e.clientX - r.left;
    oy = e.clientY - r.top;
    e.preventDefault();
  });
  window.addEventListener("mousemove",(e)=>{
    if(!dragging) return;
    const x = Math.max(10, Math.min(window.innerWidth - card.offsetWidth - 10, e.clientX - ox));
    const y = Math.max(10, Math.min(window.innerHeight - card.offsetHeight - 10, e.clientY - oy));
    card.style.left = x + "px";
    card.style.top = y + "px";
    card.style.right = "auto";
  });
  window.addEventListener("mouseup",()=>dragging=false);
}

/* =======================
   Wire up UI
   ======================= */
function initUI(){
  // fill admin selects
  $("admNewRank").innerHTML = RANKS.map(r=>`<option value="${r}">${r}</option>`).join("");
  $("admNewDept").innerHTML = DEPTS.map(d=>`<option value="${d}">${d}</option>`).join("");

  $("btnLogin").onclick = login;
  $("btnLogout").onclick = logout;

  $("btnIn").onclick = checkIn;
  $("btnOut").onclick = checkOut;
  $("btnRefresh").onclick = ()=>refreshAll(true);
  $("btnTheme").onclick = ()=>{ App.state.theme = (App.state.theme==="dark"?"light":"dark"); localStorage.setItem("dose_theme", App.state.theme); applyTheme(); toast("테마 변경","good", App.state.theme); };
  $("btnExportCSV").onclick = ()=>exportCSV();
  $("btnBackup").onclick = ()=>backupJSON();
  $("btnRestore").onchange = (e)=>restoreJSON(e.target.files?.[0]);
  qsa("[data-main-tab]").forEach(b=>b.onclick=()=>setMainTab(b.dataset.mainTab));
  $("btnWorkRefresh").onclick = ()=>refreshWork(true);
  $("wPrev").onclick=()=>{ App.state.workPage=Math.max(0,App.state.workPage-1); renderWorkList(); };
  $("wNext").onclick=()=>{ App.state.workPage=App.state.workPage+1; renderWorkList(); };
  $("btnContentRefresh").onclick = ()=>refreshContent(true);
  $("btnNewSupply2").onclick=()=>{ $("mType").value="supply"; openContentModal("new"); };
  $("btnNewPlant2").onclick=()=>{ $("mType").value="plant"; openContentModal("new"); };
  $("btnNewEscort2").onclick=()=>{ $("mType").value="escort"; openContentModal("new"); };
  $("cPrev2").onclick=()=>{ $("cPrev").click(); renderContentList2(); };
  $("cNext2").onclick=()=>{ $("cNext").click(); renderContentList2(); };
  $("btnStatsRefresh").onclick = ()=>{ renderStats(); toast("통계가 갱신되었습니다","good"); };
  $("btnUsersRefresh").onclick = ()=>{ refreshUsers(true).then(()=>renderUserList2()); };
  $("uPrev2").onclick=()=>{ App.state.userPage2=Math.max(0,(App.state.userPage2||0)-1); renderUserList2(); };
  $("uNext2").onclick=()=>{ App.state.userPage2=(App.state.userPage2||0)+1; renderUserList2(); };
  $("uSearch2").oninput=()=>{ App.state.userPage2=0; renderUserList2(); };
  $("uSort2").onchange=()=>{ App.state.userPage2=0; renderUserList2(); };

  $("uPrev").onclick=()=>{ App.state.userPage=Math.max(0,App.state.userPage-1); renderUserList(); };
  $("uNext").onclick=()=>{ App.state.userPage=App.state.userPage+1; renderUserList(); };

  qsa("[data-sort]").forEach(b=>{
    b.onclick=()=>{
      qsa("[data-sort]").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      App.state.userSort = b.dataset.sort;
      App.state.userPage = 0;
      renderUserList();
    };
  });

  $("cPrev").onclick=()=>{ App.state.contentPage=Math.max(0,App.state.contentPage-1); renderContentList(); };
  $("cNext").onclick=()=>{ App.state.contentPage=App.state.contentPage+1; renderContentList(); };

  $("btnNewSupply").onclick=()=>{ $("mType").value="supply"; openContentModal("new"); };
  $("btnNewPlant").onclick=()=>{ $("mType").value="plant"; openContentModal("new"); };
  $("btnNewEscort").onclick=()=>{ $("mType").value="escort"; openContentModal("new"); };

  $("mClose").onclick=closeModal;
  $("backdrop").onclick=()=>{ hideCtx(); if(App.state.modal.open) closeModal(); if($("noticeModal").classList.contains("show")) closeNoticeModal(); if($("userModal").classList.contains("show")) closeUserModal(); };

  $("mType").onchange=()=>{ updateOutcomeVisibility(); };
  $("mSearch").oninput=()=>buildChecks(getSelectedFromChecks());
  $("mSave").onclick=saveContent;
  $("mDelete").onclick=()=>{ if(App.state.modal.editId) deleteContent(App.state.modal.editId); closeModal(); };
  $("mImg").onchange=(e)=>handleOCR(e.target.files?.[0]);

  $("btnAdminToggle").onclick = toggleAdmin;
  $("btnAdminClose").onclick = closeAdmin;
  $("btnAdminFloat").onclick = toggleAdminFloat;

  qsa("[data-atab]").forEach(b=>b.onclick=()=>adminTab(b.dataset.atab));
  $("admAddUserBtn").onclick = adminAddUser;
  $("admSort").onchange=()=>{ App.state.adminPage=0; renderAdminUserList(); };
  $("admSearch").oninput=()=>{ App.state.adminPage=0; renderAdminUserList(); };
  $("aPrev").onclick=()=>{ App.state.adminPage=Math.max(0,App.state.adminPage-1); renderAdminUserList(); };
  $("aNext").onclick=()=>{ App.state.adminPage=App.state.adminPage+1; renderAdminUserList(); };

  enableDrag();

  // modal inert init
  $("contentModal").inert = true;
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape"){
      hideCtx();
      if(App.state.modal.open) closeModal();
      if($("userModal").classList.contains("show")) closeUserModal();
    }
  });
}

await ensureDefaultAdmin();
applyTheme();
initUI();
setCoolInfo();
</script>
</body>
</html>

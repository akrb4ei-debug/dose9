<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë„ìŠ¤ì˜¨ë¼ì¸ êµ­ë°©ë¶€ ê·¼í‡´ì‹œìŠ¤í…œ</title>
  <link rel="icon" href="data:,">

  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js">
/* =========================
   ğŸ”’ STABILITY PATCH LAYER
   (No feature removed)
========================= */

// Safe DOM getter
const $safe = (id)=>{
  try{
    const el=document.getElementById(id);
    return el||null;
  }catch(e){return null;}
};

// Safe timestamp to Date
function safeToDate(ts){
  try{
    if(!ts) return null;
    if(typeof ts.toDate==="function") return ts.toDate();
    if(ts instanceof Date) return ts;
    return null;
  }catch(e){return null;}
}

// Safe duration calc
function safeDuration(startTs){
  const d=safeToDate(startTs);
  if(!d) return 0;
  const now=new Date();
  return Math.max(0, Math.floor((now.getTime()-d.getTime())/1000));
}

// Safe array
function safeArray(arr){
  return Array.isArray(arr)?arr:[];
}

// Prevent duplicate event binding
(function(){
  if(window.__DOSE_BOUND__) return;
  window.__DOSE_BOUND__=true;
})();

// Firestore index error friendly message
function handleFirestoreError(e){
  if(!e) return;
  const msg=String(e.message||e);
  if(msg.includes("requires an index")){
    alert("Firestore ì¸ë±ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì½˜ì†”ì˜ ë§í¬ë¥¼ ëˆŒëŸ¬ ìƒì„±í•˜ì„¸ìš”.");
  }else{
    alert("ì˜¤ë¥˜ ë°œìƒ: "+msg);
  }
}

// Global async guard
window.addEventListener("unhandledrejection", (e)=>{
  console.error("Unhandled:",e.reason);
  handleFirestoreError(e.reason);
});
window.addEventListener("error", (e)=>{
  console.error("GlobalError:",e.message);
});


</script>

  <style>
    
/* í•„ìˆ˜: ìˆ¨ê¹€ í´ë˜ìŠ¤ */
.hidden{display:none !important;}
[hidden]{display:none !important;}
:root{
  --bg:#0b0c0f;
  --panel:#111318;
  --panel2:#171a20;
  --panel3:#1e222a;
  --stroke: rgba(255,255,255,0.10);
  --stroke2: rgba(255,255,255,0.16);
  --ink: rgba(255,255,255,0.92);
  --muted: rgba(255,255,255,0.62);
  --muted2: rgba(255,255,255,0.44);
  --good:#7CFFA8;
  --bad:#FF7C9A;
  --warn:#FFD36A;
  --accent:#AFC3D8; /* steel */
  --accent2:#7F92A6;
  --shadow: 0 18px 60px rgba(0,0,0,0.55);
  --radius: 18px;
}
    *{ box-sizing:border-box; font-family:'Pretendard',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    [hidden]{ display:none !important; }
    body{
  margin:0; min-height:100vh; color:var(--ink);
  background:
    radial-gradient(1200px 900px at 18% 12%, rgba(175,195,216,0.12), transparent 58%),
    radial-gradient(900px 700px at 85% 18%, rgba(255,255,255,0.06), transparent 62%),
    linear-gradient(180deg, #0b0c0f 0%, #101218 45%, #0b0c0f 100%);
  overflow-x:hidden;
}
body::before{
  content:"";
  position:fixed; inset:0; pointer-events:none;
  background:
    repeating-linear-gradient(90deg, rgba(255,255,255,0.02) 0 1px, transparent 1px 6px),
    repeating-linear-gradient(0deg, rgba(0,0,0,0.08) 0 1px, transparent 1px 5px);
  opacity:0.35;
  mix-blend-mode:overlay;
}

@keyframes steelFlow{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

    /* layout */
    .wrap{ max-width: 1400px; margin: 0 auto; padding: 22px 18px 60px; }
    .topbar{
      position:sticky; top:0; z-index:30;
      background: rgba(10,12,18,0.64);
      backdrop-filter: blur(14px);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px 14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom: 16px;
    }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{
      width:36px; height:36px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.26), transparent 60%),
                  linear-gradient(135deg, rgba(185,198,255,0.75), rgba(46,230,182,0.25));
      border:1px solid rgba(255,255,255,0.22);
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }
    .title{ font-weight:800; letter-spacing: -0.2px; }
    .subtitle{ font-size:12px; color: var(--muted2); margin-top:2px; }
    .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(17,21,32,0.60);
      color: var(--muted);
      font-size: 12px;
    }
    .chip b{ color: var(--ink); }
    .pill{
      appearance:none;
      border: 1px solid var(--stroke2);
      background: rgba(17,21,32,0.68);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      transition: transform .06s ease, border-color .15s ease, background .15s ease;
      box-shadow: 0 10px 24px rgba(0,0,0,0.18);
      font-weight: 700;
    }
    .pill:hover{ border-color: rgba(255,255,255,0.35); background: rgba(17,21,32,0.78); }
    .pill:active{ transform: translateY(1px); }
    .pill.primary{ background: rgba(185,198,255,0.18); border-color: rgba(185,198,255,0.42); }
    .pill.danger{ background: rgba(255,90,120,0.14); border-color: rgba(255,90,120,0.40); }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
      align-items:start;
      max-width: 1180px;
      margin: 0 auto;
    }
    body.admin-open .grid{
      grid-template-columns: 1fr 420px;
      max-width: 1480px;
    }
    .adminCol{
      max-height: calc(100vh - 210px);
      overflow:auto;
      overscroll-behavior: contain;
    }
    body.admin-open [data-view="dashboard"].card:first-of-type{
      transform: translateX(-6px);
      transition: transform .18s ease;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid var(--stroke);
      background: rgba(13,16,24,0.72);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px;
    }
    .card h3{
      margin: 2px 0 10px 0;
      font-weight: 800;
      letter-spacing: -0.2px;
      font-size: 14px;
      color: rgba(255,255,255,0.88);
    }
    .muted{ color: var(--muted); font-size: 12px; line-height: 1.4; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .spacer{ flex:1; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 980px){
      .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .kpi{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(17,21,32,0.58);
      border-radius: 16px;
      padding: 12px 12px;
    }
    .kpi .k{ font-size: 11px; color: var(--muted2); }
    .kpi .v{ font-size: 18px; font-weight: 800; margin-top: 4px; letter-spacing: -0.2px; }
    .good{ color: var(--good); }
    .bad{ color: var(--bad); }
    .warn{ color: var(--warn); }

    /* tables */
    .tableWrap{ overflow:auto; border-radius: 16px; border:1px solid rgba(255,255,255,0.10); }
    table{ width:100%; border-collapse: collapse; min-width: 620px; }
    th,td{ padding: 10px 10px; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 13px; }
    th{ position: sticky; top: 0; z-index: 2; background: rgba(10,12,18,0.75); color: rgba(255,255,255,0.84); }
    tr:hover td{ background: rgba(255,255,255,0.03); }
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 4px 10px; border-radius: 999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      font-size: 12px;
      color: rgba(255,255,255,0.82);
      white-space:nowrap;
    }
    .badge.on{ border-color: rgba(46,230,182,0.40); background: rgba(46,230,182,0.10); color: rgba(46,230,182,0.98); }
    .badge.off{ border-color: rgba(255,90,120,0.40); background: rgba(255,90,120,0.10); color: rgba(255,90,120,0.98); }
    .badge.role{ border-color: rgba(185,198,255,0.40); background: rgba(185,198,255,0.12); }
    .badge.dim{ opacity:.7; }

    /* inputs */
    input,select,textarea{
      background: rgba(17,21,32,0.58);
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--ink);
      padding: 10px 10px;
      border-radius: 14px;
      outline: none;
    }
    textarea{ min-height: 84px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,0.40); }
    .w220{ width: 220px; max-width: 100%; }
    .w320{ width: 320px; max-width: 100%; }

    /* tabs */
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      padding: 9px 12px; border-radius: 999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(17,21,32,0.55);
      color: rgba(255,255,255,0.86);
      cursor:pointer;
      font-weight: 800;
      font-size: 12px;
    }
    .tab.active{ border-color: rgba(185,198,255,0.45); background: rgba(185,198,255,0.12); }

    /* modal */
    body.noscroll{ overflow:hidden !important; height:100vh; }
    .overlay{
      position:fixed; inset:0; z-index:9999;
      background: rgba(0,0,0,0.62);
      display:flex; align-items:center; justify-content:center;
      padding: 18px;
    }
    .modal{
      width: min(1100px, 96vw);
      background: rgba(10,12,18,0.86);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .mTop{ padding: 12px 12px; border-bottom:1px solid rgba(255,255,255,0.10); display:flex; align-items:center; gap:10px; }
    .mTitle{ font-weight: 900; }
    .mBody{ padding: 12px 12px; max-height: 72vh; overflow:auto; overscroll-behavior:contain; }
    .mFoot{ padding: 12px 12px; border-top:1px solid rgba(255,255,255,0.10); display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    .two{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 980px){ .two{ grid-template-columns: 1fr; } }
    .box{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(17,21,32,0.48);
      border-radius: 16px;
      padding: 12px;
    }
    .list{ display:flex; flex-direction:column; gap:8px; margin-top: 10px; }
    .itemRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding: 10px 10px; border-radius: 14px; border:1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.14); }

    /* timeline */
    .timeline{ display:flex; flex-direction:column; gap:10px; }
    .event{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(17,21,32,0.50);
      border-radius: 16px;
      padding: 12px;
    }
    .event .head{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .event .head .t{ font-weight: 900; }
    .event .meta{ color: var(--muted2); font-size: 12px; margin-top: 6px; }
    .event .p{ margin-top: 8px; font-size: 13px; color: rgba(255,255,255,0.88); line-height: 1.5; }

    .tiny{ font-size: 12px; color: var(--muted2); }
    .tinyStatus{ font-size: 12px; color: var(--muted2); margin-left: 8px; }

  
/* Toast / Modal / Context Menu */
.toastWrap{position:fixed; right:16px; bottom:16px; z-index:9999; display:flex; flex-direction:column; gap:10px; width:min(420px, calc(100% - 32px)); pointer-events:none;}
.toast{pointer-events:auto; background:rgba(20,24,32,0.92); border:1px solid var(--stroke2); border-radius:14px; padding:12px 12px 10px; box-shadow: var(--shadow); animation: toastIn .16s ease;}
.toast .tTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
.toast .tTitle{font-weight:800; font-size:13px}
.toast .tMsg{margin-top:6px; color:var(--muted); font-size:12px; line-height:1.35; white-space:pre-wrap}
.toast.good{border-color: rgba(124,255,168,0.45)}
.toast.bad{border-color: rgba(255,124,154,0.45)}
.toast.warn{border-color: rgba(255,211,106,0.45)}
.toast.out{animation: toastOut .16s ease forwards}
@keyframes toastIn{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes toastOut{to{transform:translateY(6px);opacity:0}}

.backdrop{position:fixed; inset:0; z-index:8888; background:rgba(0,0,0,0.55); backdrop-filter: blur(6px); opacity:0; pointer-events:none; transition: opacity .14s ease;}
.backdrop.show{opacity:1; pointer-events:auto}
.modal{position:fixed; inset:0; z-index:8889; display:none; align-items:center; justify-content:center; padding:18px;}
.modal.show{display:flex}
.modalBox{width:min(900px, 100%); background: var(--panel2); border:1px solid var(--stroke2); border-radius: 18px; box-shadow: var(--shadow); overflow:hidden;}
.modalHead{padding:12px 14px; border-bottom:1px solid var(--stroke); display:flex; align-items:center; justify-content:space-between; gap:12px; background: rgba(0,0,0,0.15);}
.modalBody{padding:14px; max-height:70vh; overflow:auto}

.ctxMenu{position:fixed; z-index:99999; width:280px; background: var(--panel2); border:1px solid var(--stroke2); border-radius:14px; box-shadow: var(--shadow); overflow:hidden;}
.ctxMenu button{width:100%; text-align:left; background:transparent; border:none; border-bottom:1px solid var(--stroke); padding:10px 12px; color:var(--ink); cursor:pointer; font-weight:700;}
.ctxMenu button:hover{background: rgba(255,255,255,0.06)}
.ctxMenu button.danger{color: var(--bad)}
.ctxMenu button:last-child{border-bottom:none}

/* Admin user accordion */
.admItem{border:1px solid var(--stroke); border-radius:14px; background: var(--panel2); margin-top:10px; overflow:hidden;}
.admItem summary{list-style:none; cursor:pointer; padding:12px 12px; display:flex; align-items:center; gap:10px;}
.admItem summary::-webkit-details-marker{display:none}
.admItem .admBody{padding:12px 12px 14px; border-top:1px solid var(--stroke); background: rgba(255,255,255,0.02);}


/* ì»¨í…ì¸  ìˆ˜ì • íš¨ê³¼ */
.pAdd{font-weight:900;}
.pDel{text-decoration:line-through; opacity:.75;}

/* ê´€ë¦¬ì íŒ¨ë„ ì˜¤ë²„ë ˆì´ */
.adminBackdrop{position:fixed; inset:0; z-index:7777; background:rgba(0,0,0,.45); backdrop-filter: blur(3px); opacity:0; transition: opacity .18s ease;}
.adminBackdrop.show{opacity:1;}
.adminCol{position:fixed; top:18px; right:18px; bottom:18px; width:min(920px, calc(100% - 36px)); z-index:7778; overflow:auto; border-radius:18px; box-shadow: var(--shadow);}
.adminCol .box{background: rgba(255,255,255,0.03); border:1px solid var(--stroke); border-radius:16px;}
body.admin-open{overflow:hidden;}


  .modalCard.wide{width:min(900px,94vw);}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .grid2 .card{padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);}
  .grid2 .k{font-size:12px;color:var(--muted);margin-top:6px;}
  .grid2 .v{font-size:14px;}
  @media (max-width:820px){.grid2{grid-template-columns:1fr;}}

  .link{cursor:pointer;text-decoration:underline;text-decoration-color:rgba(255,255,255,.35);text-underline-offset:3px;}
  .link:hover{text-decoration-color:rgba(255,255,255,.7);}
</style>

  <script type="module">
    

console.log("BUILD_20260220_042806");
console.log("BUILD_64b5f0ff 2026-02-20 03:53:44");
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
      query, where, orderBy, limit, startAfter, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // âœ… ì‚¬ìš©ì ì œê³µ Firebase ì„¤ì • ë°˜ì˜
    const firebaseConfig = {
      apiKey: "AIzaSyAJ6MhR1JsGbvieb8akAi4Zpas_W3uaNJ4",
      authDomain: "dosep-b6ee3.firebaseapp.com",
      projectId: "dosep-b6ee3",
      storageBucket: "dosep-b6ee3.firebasestorage.app",
      messagingSenderId: "100096560571",
      appId: "1:100096560571:web:7eb2c1255835b6b57c889e"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    
    // ---------- ê¸°ë³¸ ê´€ë¦¬ì ê³„ì • ìë™ ìƒì„±(1íšŒ) ----------
    // - ë¡œê·¸ì¸ ë¶ˆê°€(ìœ ì € ë¬¸ì„œ ì—†ìŒ) ìƒí™©ì„ ëŒ€ë¹„í•˜ì—¬, ê´€ë¦¬ì ê³„ì •(LMSTD_23 / 1109)ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
    // - ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
    async function seedDefaultAdmin(){
      try{
        const id="LMSTD_23";
        const ref=doc(db,"users",id);
        const snap=await getDoc(ref);
        if(snap.exists()) return;
        await setDoc(ref,{
          password:"1109",
          isAdmin:true,
          hidden:false,
          rank:"ëŒ€ë ¹",
          department:"",
          createdAt: serverTimestamp(),
          contentCounts:{supply:0, plant:0, escort:0},
          lastContentAt:{supply:null, plant:null, escort:null},
          isOnline:false
        },{merge:true});
      }catch(e){
        console.warn("[seedDefaultAdmin] failed:", e?.code||e);
      }
    }

const colUsers   = collection(db, "users");
    const colWork    = collection(db, "workRecords");
    const colContent = collection(db, "contentRecords");
    const colDeptChat = (dept)=>collection(db, "deptChats", dept, "messages");
    const docDeptNotice = (dept)=>doc(db, "deptNotices", dept);

    const RANKS = ["êµ°ì˜ê´€","í•˜ì‚¬","ì¤‘ì‚¬","ìƒì‚¬","ì›ì‚¬","ì†Œìœ„","ì¤‘ìœ„","ëŒ€ìœ„","ì†Œë ¹","ì¤‘ë ¹","ëŒ€ë ¹"];
    const DEPTS = ["ì°¸ëª¨ë¶€","êµ­êµ° ê²½ë¹„ì‚¬ë ¹ë¶€","êµ­êµ° íŠ¹ìˆ˜ì „ì‚¬ë ¹ë¶€","êµ­êµ° ë°©ì²©ì‚¬ë ¹ë¶€","ì œ 1ê²½ë¹„ë‹¨","êµ°ì‚¬ê²½ì°°ë‹¨","ì œ1ê³µìˆ˜íŠ¹ìˆ˜ì „ì—¬ë‹¨","ì œ3ê³µìˆ˜íŠ¹ì „ì—¬ë‹¨","ì œ820ë°©ì²©ë¶€ëŒ€","êµ­êµ°ì˜ë¬´ì‚¬ë ¹ë¶€"];

    const PAGE_SIZE = 20;
    let currentUser=null;
    let currentUserData=null;
    let usersCache=new Map();
    let lastUsersLoadAt=0;
    const USERS_COOLDOWN_MS = 5*60*1000;
    const SUMMARY_COOLDOWN_MS = 3*60*1000; // ìš”ì•½ ê°±ì‹  ì¿¨íƒ€ì„(3ë¶„) // 5ë¶„
const USER_PAGE_SIZE = 10;
    let usersPage = 0; // ìœ ì € ëª©ë¡ í˜ì´ì§€(10ëª… ë‹¨ìœ„)

    // content paging
    let contentPage=0;
    let contentFilter="ALL";
    let contentPageCursors=[]; // startAfter cursors
    let contentPageDocs=[];

    // admin work paging
    let workPage=0;
    let workCursors=[];
    let workDocs=[];

    // UI helpers
    const $ = (id)=>document.getElementById(id);
    const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const setStatus=(msg)=>{ const el=$("status"); if(!el) return; el.textContent=msg||""; if(msg) setTimeout(()=>{el.textContent="";},1200); };

    const hardHide = (id)=>{
      const el = $(id);
      if(!el) return;
      el.classList.add("hidden");
      el.hidden = true;
      el.setAttribute("aria-hidden","true");
      try{ el.inert = true; }catch(_){}
    };
    const hardShow = (id)=>{
      const el = $(id);
      if(!el) return;
      el.classList.remove("hidden");
      el.hidden = false;
      el.removeAttribute("aria-hidden");
      try{ el.inert = false; }catch(_){}
    };

    // ì „ì—­ ì˜¤ë¥˜ë¥¼ í† ìŠ¤íŠ¸ë¡œ í‘œì‹œí•˜ì—¬ "ë¬´ë°˜ì‘" ìƒíƒœë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
    window.addEventListener("error",(ev)=>{
      try{ toast("ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜: "+(ev?.message||"")); }catch(_){}
    });
    window.addEventListener("unhandledrejection",(ev)=>{
      try{ toast("ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜¤ë¥˜: "+(ev?.reason?.message||String(ev?.reason||""))); }catch(_){}
    });
    // =============================
    // UI í† ìŠ¤íŠ¸ (ë¸Œë¼ìš°ì € alert ëŒ€ì²´)
    // =============================
    // âœ… í† ìŠ¤íŠ¸: í + ì¤‘ë³µí‚¤ ê°±ì‹  + ìµœëŒ€ 3ê°œ í‘œì‹œ
    const toastQueue = [];
    let toastShowing = false;

    async function toast(message, tone="good", title="ì•Œë¦¼", key=null, ms=2600){

      try{
        const wrap = $("toastWrap");
        if(!wrap) return;

        // ê°™ì€ keyê°€ ìˆìœ¼ë©´ ê¸°ì¡´ í† ìŠ¤íŠ¸ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
        if(key){
          const safeKey = (window.CSS && CSS.escape) ? CSS.escape(String(key)) : String(key).replace(/"/g,'\\"');
          const existing = wrap.querySelector(`.toast[data-key="${safeKey}"]`);
          if(existing){
            const t = existing.querySelector(".tTitle");
            const b = existing.querySelector(".tBody");
            if(t) t.textContent = title || "ì•Œë¦¼";
            if(b) b.textContent = message;
            existing.classList.remove("good","warn","bad");
            existing.classList.add(tone);
            // ë¦¬ì…‹ ì• ë‹ˆë©”ì´ì…˜
            existing.style.animation = "none";
            void existing.offsetWidth;
            existing.style.animation = "";
            // íƒ€ì´ë¨¸ ì¬ì„¤ì •
            clearTimeout(existing._tm);
            existing._tm = setTimeout(()=>removeToast(existing), ms);
            return;
          }
        }

        toastQueue.push({message, tone, title, key, ms});
        processToastQueue();
      }catch(e){
        console.error(e);
      }
    }

    async function processToastQueue(){

      if(toastShowing) return;
      toastShowing = true;

      const wrap = $("toastWrap");
      if(!wrap){ toastQueue.length=0; toastShowing=false; return; }

      while(toastQueue.length){
        const item = toastQueue.shift();
        const el = document.createElement("div");
        el.className = `toast ${item.tone||"good"}`;
        if(item.key!=null) el.dataset.key = String(item.key);
        el.innerHTML = `
          <div class="tTop">
            <div class="tTitle">${esc(item.title||"ì•Œë¦¼")}</div>
            <button class="tX" aria-label="ë‹«ê¸°">Ã—</button>
          </div>
          <div class="tBody">${esc(item.message||"")}</div>
          <div class="tBar"></div>
        `;
        wrap.prepend(el);

        // ìµœëŒ€ 3ê°œ ìœ ì§€
        while(wrap.children.length>3){
          removeToast(wrap.lastElementChild, true);
        }

        el.querySelector(".tX").onclick = ()=>removeToast(el);
        el._tm = setTimeout(()=>removeToast(el), item.ms || 2600);
      }

      toastShowing = false;
    }

    async function removeToast(el, instant=false){

      if(!el) return;
      try{ clearTimeout(el._tm); }catch(e){}
      if(instant){
        el.remove();
        return;
      }
      el.classList.add("out");
      setTimeout(()=>{ try{ el.remove(); }catch(e){} }, 260);
    }

    // âœ… ë¸Œë¼ìš°ì € alert() ëŒ€ì‹ , ì‚¬ì´íŠ¸ í† ìŠ¤íŠ¸ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
    async function alert(msg){

      try{ toast(String(msg), 'warn', 'ì•Œë¦¼', 2600, 'alert'); }
      catch(e){ try{ window.alert(String(msg)); }catch(_){ console.log(msg); } }
    }


    // ë¸Œë¼ìš°ì € alert ëŒ€ì‹  ì‚¬ì´íŠ¸ í† ìŠ¤íŠ¸ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.
    (function(){
      const _a=window.alert;
      window.__nativeAlert=_a;
      window.alert = (m)=>toast(String(m??""),"warn","ì•ˆë‚´",2400,"alert");
    })();
    async function applyTheme(theme){

      const t = theme || localStorage.getItem("dose_theme") || "dark";
      document.documentElement.setAttribute("data-theme", t);
      localStorage.setItem("dose_theme", t);
    }
    async function toggleTheme(){

      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      applyTheme(cur==="dark" ? "light" : "dark");
      toast("í…Œë§ˆê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.","good","í…Œë§ˆ");
    }

    // =============================
    // ìœ ì € ìƒì„¸ ëª¨ë‹¬ (ìµœê·¼ 7ì¼)
    // =============================
    let work7dCache=null;
    let content7dCache=null;
    let content7dLoadedAt=0;
    let work7dLoadedAt=0;
    const CACHE_7D_MS = 60*1000; // 1ë¶„ ìºì‹œ

    async function loadWork7dOnce(){
      const now=Date.now();
      if(work7dCache && (now-work7dLoadedAt)<CACHE_7D_MS) return work7dCache;
      const since = sevenDaysAgo();
      const qy = query(collection(db,"workRecords"), where("checkIn", ">=", since), orderBy("checkIn","desc"));
      const snap = await getDocs(qy);
      work7dCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
      work7dLoadedAt = now;
      return work7dCache;
    }
    async function loadContent7dOnce(){
      const now=Date.now();
      if(content7dCache && (now-content7dLoadedAt)<CACHE_7D_MS) return content7dCache;
      const since = sevenDaysAgo();
      const qy = query(collection(db,"contentRecords"), where("time", ">=", since), orderBy("time","desc"));
      const snap = await getDocs(qy);
      content7dCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
      content7dLoadedAt = now;
      return content7dCache;
    }

    async function openModal(){

      const bd=document.getElementById("backdrop");
      const md=document.getElementById("userModal");
      if(!bd||!md) return;
      bd.classList.add("show");
      md.classList.add("show");
      md.setAttribute("aria-hidden","false");
      lockBody(true);
    }
    async function closeModal(){

      const bd=document.getElementById("backdrop");
      const md=document.getElementById("userModal");
      if(!bd||!md) return;
      bd.classList.remove("show");
      md.classList.remove("show");
      md.setAttribute("aria-hidden","true");
      lockBody(false);
    }

    async function openProfile(userId){

      const u = usersCache.get(userId) || {};
      const body = $("profileBody");
      if(!body) return;
      const wk = u.weekSeconds!=null ? u.weekSeconds : (u.weekWorkSeconds!=null?u.weekWorkSeconds:null);
      const weekH = wk!=null ? (Math.floor(wk/3600)+"ì‹œê°„ "+Math.floor((wk%3600)/60)+"ë¶„") : "ë°ì´í„° ì—†ìŒ";
      const lastIn = u.lastIn ? fmt(u.lastIn) : (u.lastCheckIn?fmt(u.lastCheckIn):"-");
      const lastOut = u.lastOut ? fmt(u.lastOut) : (u.lastCheckOut?fmt(u.lastCheckOut):"-");
      const c1 = u.cntPlant7d ?? u.plant7d ?? "-";
      const c2 = u.cntSupply7d ?? u.supply7d ?? "-";
      const c3 = u.cntEscort7d ?? u.escort7d ?? "-";

      body.innerHTML = `
        <div class="grid2">
          <div class="card">
            <div class="k">ë‹‰ë„¤ì„</div><div class="v"><b>${esc(userId)}</b></div>
            <div class="k">ê³„ê¸‰</div><div class="v">${esc(u.rank||"-")}</div>
            <div class="k">ë¶€ì„œ</div><div class="v">${esc(u.department||"-")}</div>
            <div class="k">ì˜¨ë¼ì¸</div><div class="v">${u.isOnline?"O":"X"}</div>
          </div>
          <div class="card">
            <div class="k">ìµœê·¼ 7ì¼ ê·¼ë¬´</div><div class="v">${esc(weekH)}</div>
            <div class="k">ë§ˆì§€ë§‰ ì¶œê·¼</div><div class="v">${esc(lastIn)}</div>
            <div class="k">ë§ˆì§€ë§‰ í‡´ê·¼</div><div class="v">${esc(lastOut)}</div>
          </div>
        </div>
        <div class="card" style="margin-top:12px;">
          <div class="k">ìµœê·¼ 7ì¼ ì»¨í…ì¸  ì°¸ì—¬</div>
          <div class="v">ì†¡ì „ì†Œ: <b>${esc(String(c1))}</b> Â· ë³´ê¸‰: <b>${esc(String(c2))}</b> Â· ì°¨ëŸ‰ìˆ˜í˜¸: <b>${esc(String(c3))}</b></div>
          <div class="tiny muted" style="margin-top:8px;">â€» ì´ í”„ë¡œí•„ì€ í˜„ì¬ ë¡œë”©ëœ ìš”ì•½/ìœ ì € ë¬¸ì„œ ê¸°ë°˜ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      `;
      showModal("profileModal", true);
    }
async function openUserModal(uid){

      try{
        if(!uid) return;
        document.getElementById("userModalTitle").textContent = `ìœ ì € ìƒì„¸ Â· ${uid}`;
        document.getElementById("userModalBody").innerHTML = `<div class="tiny muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;
        openModal();

        const [w, c] = await Promise.all([loadWork7dOnce(), loadContent7dOnce()]);
        const ws = w.filter(x=>String(x.nickname||"")===uid);
        const cs = c.filter(x=>{
          const ps = x.participants||[];
          return Array.isArray(ps) && ps.includes(uid);
        });

        const workItems = ws.slice(0,30).map(r=>{
          const cin = fmt(r.checkIn);
          const cout = r.checkOut ? fmt(r.checkOut) : "â€”";
          const dur = (r.checkIn && r.checkOut && r.checkIn.seconds && r.checkOut.seconds)
            ? secsToHMS(r.checkOut.seconds-r.checkIn.seconds)
            : (r.checkOut? "":"(ì¶œê·¼ì¤‘)");
          return `<div class="item"><div class="itemTop"><div class="itemTitle"><b>ì¶œê·¼</b> <span class="tiny muted">${esc(cin)}</span></div><span class="tag ${r.checkOut?'on':'off'}">${r.checkOut?'í‡´ê·¼':'ì¶œê·¼ì¤‘'}</span></div><div class="itemMeta">í‡´ê·¼: ${esc(cout)} Â· ${esc(dur)}</div></div>`;
        }).join("") || `<div class="item"><div class="itemMeta">ìµœê·¼ 7ì¼ ì¶œí‡´ê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>`;

        const contentItems = cs.slice(0,30).map(r=>{
          const t = fmt(r.time);
          const type = r.type || "-";
          const wri = r.writer || "-";
          return `<div class="item"><div class="itemTop"><div class="itemTitle"><b>${esc(type)}</b> <span class="tiny muted">${esc(t)}</span></div><span class="tag">${esc(wri)}</span></div><div class="itemMeta">ì°¸ì—¬ì: ${(r.participants||[]).map(esc).join(", ")}</div></div>`;
        }).join("") || `<div class="item"><div class="itemMeta">ìµœê·¼ 7ì¼ ì»¨í…ì¸  ì°¸ì—¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>`;

        document.getElementById("userModalBody").innerHTML = `
          <div class="cardSoft">
            <div class="rowBetween"><b>ìµœê·¼ 7ì¼ ì¶œí‡´ê·¼</b><span class="tiny muted">ìµœì‹  30ê±´ í‘œì‹œ</span></div>
            <div class="sep"></div>
            <div class="list">${workItems}</div>
          </div>
          <div style="height:12px"></div>
          <div class="cardSoft">
            <div class="rowBetween"><b>ìµœê·¼ 7ì¼ ì»¨í…ì¸  ì°¸ì—¬</b><span class="tiny muted">ìµœì‹  30ê±´ í‘œì‹œ</span></div>
            <div class="sep"></div>
            <div class="list">${contentItems}</div>
          </div>
        `;
      }catch(e){
        console.error(e);
        document.getElementById("userModalBody").innerHTML = `<div class="item"><div class="itemMeta">ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</div></div>`;
      }
    }

    // =============================
    // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ (ê´€ë¦¬ì ì „ìš©)
    // =============================
    async function hideCtxMenu(){

      const m=document.getElementById("ctxMenu");
      if(!m) return;
      m.classList.add("hidden");
      m.innerHTML="";
    }
    async function showCtxMenu(x,y,uid){

      if(!isAdmin()) return;
      const m=document.getElementById("ctxMenu");
      if(!m) return;
      m.innerHTML = `
        <button data-act="view7d">ìµœê·¼ 7ì¼ ê¸°ë¡</button>
        <button data-act="forceout">ê°•ì œ í‡´ê·¼</button>
        <button data-act="toggleadmin">ê´€ë¦¬ì í† ê¸€</button>
        <button data-act="togglehidden">ìˆ¨ê¹€ í† ê¸€</button>
        <button data-act="pw">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        <button class="danger" data-act="delete">ìœ ì € ì‚­ì œ</button>
      `;
      m.style.left = Math.max(10, Math.min(window.innerWidth-290, x))+"px";
      m.style.top  = Math.max(10, Math.min(window.innerHeight-220, y))+"px";
      m.classList.remove("hidden");
      m.querySelectorAll("button").forEach(b=>{
        b.onclick = async function(){
          const act=b.getAttribute("data-act");
          hideCtxMenu();
          if(act==="view7d") return openUserModal(uid);
          if(act==="forceout") return adminForceOut(uid);
          if(act==="toggleadmin"){
            const u=usersCache.get(uid); if(!u) return;
            await updateDoc(doc(db,"users",uid),{isAdmin:!u.isAdmin});
            toast("ê´€ë¦¬ì ê¶Œí•œì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.","good","ê´€ë¦¬");
            await loadUsersOnce({force:true, reason:"admin"});
            await loadUserTable();
            await renderAdminUserCards();
            return;
          }
          if(act==="togglehidden"){
            const u=usersCache.get(uid); if(!u) return;
            await updateDoc(doc(db,"users",uid),{isHidden:!u.isHidden});
            toast("ìˆ¨ê¹€ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.","good","ê´€ë¦¬");
            await loadUsersOnce({force:true, reason:"admin"});
            await loadUserTable();
            await renderAdminUserCards();
            return;
          }
          if(act==="pw"){
            const np=prompt("ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            if(!np) return;
            await updateDoc(doc(db,"users",uid),{password:String(np)});
            toast("ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.","good","ê´€ë¦¬");
            await loadUsersOnce({force:true, reason:"admin"});
            await renderAdminUserCards();
            return;
          }
          if(act==="delete"){
            if(!confirm(`${uid} ìœ ì €ë¥¼ ì‚­ì œí• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)`)) return;
            await adminDeleteUser(uid);
            return;
          }
        }
      });
    }

    async function adminDeleteUser(uid){
      if(!isAdmin()) return;
      if(uid===currentUser) return toast("ë³¸ì¸ ê³„ì •ì€ ì—¬ê¸°ì„œ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.","warn","ê´€ë¦¬");
      await deleteDoc(doc(db,"users",uid));
      toast("ìœ ì €ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.","good","ê´€ë¦¬");
      await loadUsersOnce({force:true, reason:"admin"});
      await loadDashKpis();
      await loadUserTable();
      await renderAdminUserCards();
      try{ await loadDashKpis(); await loadUserTable(); }catch(e){}
      try{ if(typeof loadWorkPage==="function") await loadWorkPage(0); }catch(e){}
    }

    // =============================
    // ê´€ë¦¬ì íŒ¨ë„ ë“œë˜ê·¸ ì´ë™ (ê°œì¸ ì„¤ì •)
    // =============================
    async function initAdminDrag(){

      const dock=document.getElementById("adminCol");
      if(!dock) return;
      const head=dock.querySelector(".row") || dock;
      let dragging=false, sx=0, sy=0, ox=0, oy=0;
      const saved = localStorage.getItem("dose_admin_pos");
      if(saved){
        try{
          const p=JSON.parse(saved);
          if(typeof p.left==="number") dock.style.left=p.left+"px";
          if(typeof p.top==="number") dock.style.top=p.top+"px";
          dock.style.right="auto";
        }catch(e){}
      }
      head.addEventListener("pointerdown",(ev)=>{
        if(ev.button!==0) return;
        dragging=true;
        sx=ev.clientX; sy=ev.clientY;
        const r=dock.getBoundingClientRect();
        ox=r.left; oy=r.top;
        head.setPointerCapture(ev.pointerId);
      });
      head.addEventListener("pointermove",(ev)=>{
        if(!dragging) return;
        const dx=ev.clientX-sx, dy=ev.clientY-sy;
        dock.style.left=Math.max(8, ox+dx)+"px";
        dock.style.top=Math.max(8, oy+dy)+"px";
        dock.style.right="auto";
      });
      head.addEventListener("pointerup",()=>{
        if(!dragging) return;
        dragging=false;
        const r=dock.getBoundingClientRect();
        localStorage.setItem("dose_admin_pos", JSON.stringify({left:r.left, top:r.top}));
      });
    }

    const lockBody=(on)=>document.body.classList.toggle("noscroll", !!on);

    async function normalizeUser(d){

      const u={...d};
      if(u.isadmin!==undefined && u.isAdmin===undefined) u.isAdmin=u.isadmin;
      if(u.ishidden!==undefined && u.isHidden===undefined) u.isHidden=u.ishidden;
      if(u.hidden!==undefined && u.isHidden===undefined) u.isHidden=u.hidden;
      if(u.dept!==undefined && u.department===undefined) u.department=u.dept;
      if(u.rankname!==undefined && u.rank===undefined) u.rank=u.rankname;
      if(!Array.isArray(u.deptLeaderOf)) u.deptLeaderOf = Array.isArray(u.deptLeads)?u.deptLeads:(u.deptLeaderOf||[]);
      return u;
    }

// âœ… ë¡œê·¸ì¸ ì‹œ 1íšŒ: ìœ ì € ë¬¸ì„œ ìŠ¤í‚¤ë§ˆ ëˆ„ë½ ìë™ ë³´ì • + ì˜¤ëŠ˜/ì£¼ê°„ í‚¤ ë¡¤ì˜¤ë²„ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
// - ì´ ê³¼ì •ì€ "ì½ê¸°(read)"ë¥¼ ëŠ˜ë¦¬ì§€ ì•Šê³ , í•„ìš”í•  ë•Œë§Œ updateDocì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
async function ensureUserDocDefaultsOnce(userId, userData){
  try{
    const tKey = dayKey(todayStart());       // ì˜¤ëŠ˜ 0ì‹œ ê¸°ì¤€ í‚¤(YYYY-MM-DD)
    const wsKey = dayKey(weekStartMonday0()); // ì´ë²ˆ ì£¼ ì‹œì‘(ì›”) í‚¤(YYYY-MM-DD)

    const patch = {};

    // í•„ìˆ˜ í•„ë“œ ê¸°ë³¸ê°’
    if(userData.isAdmin === undefined) patch.isAdmin = false;
    if(userData.isHidden === undefined) patch.isHidden = false;
    if(userData.rank === undefined) patch.rank = "";
    if(userData.department === undefined) patch.department = "";
    if(!Array.isArray(userData.deptLeaderOf)) patch.deptLeaderOf = [];

    if(userData.seenNotices === undefined || typeof userData.seenNotices !== "object") patch.seenNotices = {};
    if(userData.contentCounts === undefined || typeof userData.contentCounts !== "object") patch.contentCounts = {supply:0, plant:0, escort:0};
    if(userData.lastContentAt === undefined || typeof userData.lastContentAt !== "object") patch.lastContentAt = {supply:null, plant:null, escort:null};

    // ìš”ì•½í•„ë“œ(í†µê³„/ì ‘ì†ìš©)
    if(userData.isOnline === undefined) patch.isOnline = false;
    if(userData.weekStart === undefined) patch.weekStart = wsKey;
    if(userData.weekSeconds === undefined) patch.weekSeconds = 0;
    if(userData.todayKey === undefined) patch.todayKey = tKey;
    if(userData.todaySeconds === undefined) patch.todaySeconds = 0;
    if(userData.todayCheckIns === undefined) patch.todayCheckIns = 0;

    // 0ì‹œ í•„í„° / ì£¼ê°„ í•„í„°: í‚¤ê°€ ë°”ë€Œë©´ ìë™ ì´ˆê¸°í™”
    if(userData.todayKey && userData.todayKey !== tKey){
      patch.todayKey = tKey;
      patch.todaySeconds = 0;
      patch.todayCheckIns = 0;
    }
    if(userData.weekStart && userData.weekStart !== wsKey){
      patch.weekStart = wsKey;
      patch.weekSeconds = 0;
    }

    // patchê°€ ë¹„ì–´ìˆì§€ ì•Šë‹¤ë©´ ì—…ë°ì´íŠ¸
    if(Object.keys(patch).length){
      await updateDoc(doc(db,"users",userId), patch);
      // ë¡œì»¬ì—ë„ ë°˜ì˜(ì¦‰ì‹œ UI ì•ˆì •í™”)
      Object.assign(userData, patch);
    }
  }catch(e){
    console.warn("ensureUserDocDefaultsOnce failed:", e);
  }
}
    function isAdmin(){ return !!currentUserData?.isAdmin; }
    function isDeptLeaderOf(dept){
      if(isAdmin()) return true;
      const arr=currentUserData?.deptLeaderOf||[];
      return arr.includes(dept);
    }

    // ë‚ ì§œí‚¤ (KST ê¸°ì¤€)
    function kstNow(){
      // ë¸Œë¼ìš°ì €ê°€ KSTê°€ ì•„ë‹ ìˆ˜ë„ ìˆìœ¼ë‚˜, ì„œë²„ê°€ í•œêµ­ ê¸°ì¤€ ìš´ì˜ì´ë¼ ê°€ì •.
      // ë³´ì •ì´ í•„ìš”í•˜ë©´, ì—¬ê¸°ì„œ UTC+9 ì˜¤í”„ì…‹ì„ ê°•ì œí•  ìˆ˜ ìˆìŒ.
      return new Date();
    }
    function dayKey(d){
      const yyyy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,"0");
      const dd=String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function todayStart(){
      const d=kstNow();
      return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0);
    }
    function weekStartMonday0(){
      const d=todayStart();
      const day=d.getDay(); // 0 Sun ... 6 Sat
      const diff=(day===0?6:day-1); // monday=0
      const ws=new Date(d); ws.setDate(d.getDate()-diff);
      return ws; // 00:00
    }
    function fmt(ts){
      if(!ts) return "-";
      const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
      if(!d) return "-";
      const p=(n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
    }
    function secsToHMS(sec){
      sec=Math.max(0, Math.floor(sec||0));
      const h=Math.floor(sec/3600);
      const m=Math.floor((sec%3600)/60);
      return `${h}ì‹œê°„ ${m}ë¶„`;
    }

    // ---------- LOGIN ----------
    async function login(){
      try{
        const id=$("loginId").value.trim();
        const pw=$("loginPw").value;
        if(!id||!pw) { toast("ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.","warn"); return; }

        const s=await getDoc(doc(db,"users",id));
        if(!s.exists()) { toast("ë“±ë¡ëœ ìœ ì €ê°€ ì•„ë‹™ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë“±ë¡ì„ ìš”ì²­í•´ ì£¼ì„¸ìš”.","bad"); return; }
        const u=normalizeUser(s.data());
        if(String(u.password??"")!==String(pw)) { toast("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.","bad"); return; }

        currentUser=id;
        currentUserData=u;

        await ensureUserDocDefaultsOnce(id, currentUserData);

        $("who").innerHTML = `
          <span class="chip">ID <b class="link" data-profile="${esc(id)}">${esc(id)}</b></span>
          <span class="chip">ê³„ê¸‰ <b>${esc(u.rank||"-")}</b></span>
          <span class="chip">ë¶€ì„œ <b>${esc(u.department||"-")}</b></span>
          <span class="chip">ê´€ë¦¬ì <b>${u.isAdmin?"O":"X"}</b></span>
        `;
        $("btnAdmin").hidden = !u.isAdmin;

        $("loginView").hidden=true;
        $("appView").hidden=false;

        await refreshAll({silent:true});
        await maybeShowNoticeOnce();
      }catch(e){
        console.error(e);
        alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” í™•ì¸)");
      }
    }
    function logout(){
      currentUser=null; currentUserData=null;
      usersCache=new Map();
      $("loginPw").value="";
      $("appView").hidden=true;
      $("loginView").hidden=false;
      setStatus("");
    }

    // ---------- READ MINIMIZATION CORE ----------
    // âœ… ì›ì¹™: onSnapshot ì‚¬ìš©í•˜ì§€ ì•ŠìŒ. (ìë™ ë¦¬ë“œ ì—†ìŒ)
    // âœ… ë¡œê·¸ì¸ ì‹œ 1íšŒ ë¡œë“œ, ì´í›„ "ìƒˆë¡œê³ ì¹¨" ë²„íŠ¼ìœ¼ë¡œë§Œ ê°±ì‹ .

    async function refreshSummary({silent}={}){
      if(!currentUser) return;
      const key = `dose_sum_last_${currentUser}`;
      const last = Number(localStorage.getItem(key)||0);
      const now = Date.now();
      if(last && (now-last) < SUMMARY_COOLDOWN_MS){
        const remain = Math.ceil((SUMMARY_COOLDOWN_MS-(now-last))/1000);
        toast(`ìš”ì•½ ê°±ì‹  ì¿¨íƒ€ì„: ${remain}ì´ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤.`,"warn","ìš”ì•½ ê°±ì‹ ");
        if(!silent) setStatus(`ìš”ì•½ ê°±ì‹  ì¿¨íƒ€ì„: ${remain}ì´ˆ`);
        return;
      }
      localStorage.setItem(key, String(now));
      // ìš”ì•½ë§Œ ê°±ì‹ : ìœ ì € + KPI + ìœ ì €í‘œ (ì»¨í…ì¸ ëŠ” ê°±ì‹ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤)
      await loadUsersOnce({force:true, reason:"admin"});
      await loadDashKpis();
      await loadUserTable();
      toast("ìš”ì•½ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.","good","ìš”ì•½");
      if(!silent) setStatus("ìš”ì•½ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    async function refreshAll({silent}={}){
      await loadUsersOnce({force:true, reason:"admin"});
      await loadDashKpis();
      await loadUserTable();
      await loadContentPage(0);
      if(!silent) setStatus("ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    async function loadUsersOnce({force=false, reason=""}={}){
      const now=Date.now();
      const bypass = (isAdmin() && reason==="admin");
      if(!bypass && !force && lastUsersLoadAt && (now-lastUsersLoadAt)<USERS_COOLDOWN_MS){
        const remain=Math.ceil((USERS_COOLDOWN_MS-(now-lastUsersLoadAt))/1000);
        setStatus(`ìœ ì € ëª©ë¡ ê°±ì‹  ì¿¨íƒ€ì„: ${remain}ì´ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤.`);
        toast(`ìœ ì € ëª©ë¡ ê°±ì‹  ì¿¨íƒ€ì„: ${remain}ì´ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤.`, "warn", "ì¿¨íƒ€ì„");
        return;
      }
      const s=await getDocs(colUsers);
      usersCache=new Map();
      s.forEach(d=>usersCache.set(d.id, normalizeUser(d.data())));
      // ë‚´ data ìµœì‹  ë°˜ì˜
      const mine=usersCache.get(currentUser);
      if(mine) currentUserData=mine;
      lastUsersLoadAt = Date.now();
    }

    // KPI: ì˜¨ë¼ì¸ ìˆ˜ / ì˜¤ëŠ˜ ì¶œê·¼(ì¹´ìš´íŠ¸) / ì˜¤ëŠ˜ ëˆ„ì  / ì£¼ê°„ ëˆ„ì 
    async function loadDashKpis(){
      const online = Array.from(usersCache.values()).filter(u=>u.isOnline && (!u.isHidden || isAdmin())).length;
      const tKey = dayKey(todayStart());
      let todayIns=0, todaySec=0, weekSec=0;

      const wsKey=dayKey(weekStartMonday0());

      for(const [id,u] of usersCache.entries()){
        if(!isAdmin() && u.isHidden) continue;
        // ì˜¤ëŠ˜
        if(u.todayKey===tKey){
          todayIns += Number(u.todayCheckIns||0);
          todaySec += Number(u.todaySeconds||0);
        }
        // ì£¼ê°„(ìš”ì•½í•„ë“œê°€ ì£¼ì°¨ê°€ ë‹¤ë¥´ë©´ 0ìœ¼ë¡œ ì·¨ê¸‰)
        if(u.weekStart===wsKey){
          weekSec += Number(u.weekSeconds||0);
        }
      }

      $("kpiOnline").innerHTML = `<div class="k">í˜„ì¬ ì ‘ì†</div><div class="v ${online? "good":""}">${online}ëª…</div>`;
      $("kpiTodayIn").innerHTML = `<div class="k">ì˜¤ëŠ˜ ì¶œê·¼ íšŸìˆ˜</div><div class="v">${todayIns}</div>`;
      $("kpiTodaySec").innerHTML = `<div class="k">ì˜¤ëŠ˜ ëˆ„ì  ì ‘ì†</div><div class="v">${secsToHMS(todaySec)}</div>`;
      $("kpiWeekSec").innerHTML = `<div class="k">ì´ë²ˆì£¼ ëˆ„ì  ì ‘ì†</div><div class="v">${secsToHMS(weekSec)}</div>`;
    }

    // ìœ ì € í…Œì´ë¸”: usersë§Œ ì½ì–´ì„œ í‘œì‹œ(ë¦¬ë“œ ìµœì†Œ)
    async function loadUserTable(){
      const rows=[];
      for(const [id,u] of usersCache.entries()){
        if(!isAdmin() && u.isHidden) continue;
        rows.push({id,u});
      }

      const sort=$("sortUsers").value;

      // "ì˜¨ë¼ì¸ë§Œ" ì˜µì…˜ì€ ëª©ë¡ ìì²´ë¥¼ í•„í„°ë§í•©ë‹ˆë‹¤.
      if(sort==="onlineOnly"){
        for(let i=rows.length-1;i>=0;i--){
          if(!rows[i].u.isOnline) rows.splice(i,1);
        }
      }

      rows.sort((a,b)=>{
        const ra=RANKS.indexOf(a.u.rank||"");
        const rb=RANKS.indexOf(b.u.rank||"");
        const onlineA=!!a.u.isOnline, onlineB=!!b.u.isOnline;

        if(sort==="onlineFirst"){
          if(onlineA!==onlineB) return onlineB-onlineA;
        }

        if(sort==="rankHigh"){
          if(ra!==rb) return rb-ra; // ëŒ€ë ¹(ë†’ìŒ)ì´ ë¨¼ì €
        }else if(sort==="rankLow"){
          if(ra!==rb) return ra-rb;
        }

        return a.id.localeCompare(b.id,"ko");
      });

      // âœ… 10ëª… ë‹¨ìœ„ í˜ì´ì§€ë„¤ì´ì…˜
      const total = rows.length;
      const totalPages = Math.max(1, Math.ceil(total / USER_PAGE_SIZE));
      usersPage = Math.min(usersPage, totalPages-1);
      const start = usersPage * USER_PAGE_SIZE;
      const pageRows = rows.slice(start, start + USER_PAGE_SIZE);

      const tKey=dayKey(todayStart());
      const wsKey=dayKey(weekStartMonday0());

      const tb = pageRows.map(({id,u})=>{
        const on = u.isOnline ? `<span class="badge on">ì ‘ì† O</span>` : `<span class="badge off">ì ‘ì† X</span>`;
        const rank = `<span class="badge role">${esc(u.rank||"-")}</span>`;
        const dept = `<span class="badge dim">${esc(u.department||"-")}</span>`;
        const last = `<span class="tiny">${esc(fmt(u.isOnline?u.lastCheckIn:u.lastCheckOut))}</span>`;
        const week = (u.weekStart===wsKey) ? secsToHMS(u.weekSeconds||0) : "0ì‹œê°„ 0ë¶„";
        const today = (u.todayKey===tKey) ? secsToHMS(u.todaySeconds||0) : "0ì‹œê°„ 0ë¶„";
        const sup=u.contentCounts?.supply||0;
        const pl=u.contentCounts?.plant||0;
        const es=u.contentCounts?.escort||0;
        return `<tr class="uRow" data-user="${esc(id)}">
          <td><b>${esc(id)}</b></td>
          <td>${rank}</td>
          <td>${dept}</td>
          <td>${on}</td>
          <td>${last}</td>
          <td>${week}</td>
          <td>${today}</td>
          <td>${sup}</td>
          <td>${pl}</td>
          <td>${es}</td>
        </tr>`;
      }).join("");

      $("userTbody").innerHTML = tb || `<tr><td colspan="10" class="tiny">í‘œì‹œí•  ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;

      // í˜ì´ì§€ UI
      const pInfo=$("userPageInfo");
      if(pInfo) pInfo.textContent = `${usersPage+1} / ${totalPages} (ì´ ${total}ëª…)`;
      const prev=$("userPrev"), next=$("userNext");
      if(prev) prev.disabled = usersPage<=0;
      if(next) next.disabled = usersPage>=totalPages-1;

      // ì¿¨íƒ€ì„ í‘œì‹œ(ìœ ì € ëª©ë¡ ì½ê¸° ì¿¨íƒ€ì„)
      const now=Date.now();
      const remain=Math.max(0, USERS_COOLDOWN_MS-(now-lastUsersLoadAt));
      const cd=$("userCooldown");
      if(cd) cd.textContent = lastUsersLoadAt ? (remain>0?`ë‹¤ìŒ ê°±ì‹ ê¹Œì§€ ${Math.ceil(remain/1000)}ì´ˆ`:"ì§€ê¸ˆ ê°±ì‹  ê°€ëŠ¥í•©ë‹ˆë‹¤.") : "";
    }


    // ---------- CHECK IN/OUT with SUMMARY FIELDS ----------
    async function checkIn(){
      try{
        // 1) ë‚´ users ë¬¸ì„œ 1íšŒ ì½ê¸° (ìµœì‹  ìƒíƒœ)
        const uSnap=await getDoc(doc(db,"users",currentUser));
        if(!uSnap.exists()) return alert("ìœ ì € ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.");
        const u=normalizeUser(uSnap.data());

        if(u.isOnline===true && u.openWorkId){
          return alert("ì´ë¯¸ ì¶œê·¼ì¤‘ì…ë‹ˆë‹¤.");
        }

        const now = kstNow();
        const tKey = dayKey(todayStart());
        const wsKey = dayKey(weekStartMonday0());

        // 2) workRecords 1ê±´ ì¶”ê°€ (write)
        const wr = await addDoc(colWork, {
          nickname: currentUser,
          checkIn: serverTimestamp(),
          checkOut: null,
          durationSec: null,
          dayKey: tKey,
          weekStart: wsKey
        });

        // 3) users ìš”ì•½ í•„ë“œ ì—…ë°ì´íŠ¸ (write) â€” ë¦¬ë“œ ì¶”ê°€ ì—†ìŒ
        const updates={
          isOnline:true,
          openWorkId: wr.id,
          openCheckInAt: serverTimestamp(),
          lastCheckIn: serverTimestamp()
        };

        // 0ì‹œ í•„í„°(ì˜¤ëŠ˜í‚¤ê°€ ë°”ë€Œë©´ ì˜¤ëŠ˜ ìš”ì•½ ì´ˆê¸°í™”)
        if(u.todayKey !== tKey){
          updates.todayKey = tKey;
          updates.todaySeconds = 0;
          updates.todayCheckIns = 0;
        }
        updates.todayCheckIns = increment(1);

        // ì£¼ê°„í‚¤ê°€ ë°”ë€Œë©´ ì£¼ê°„ ìš”ì•½ ì´ˆê¸°í™”(í•´ë‹¹ ìœ ì €ë§Œ)
        if(u.weekStart !== wsKey){
          updates.weekStart = wsKey;
          updates.weekSeconds = 0;
        }

        await updateDoc(doc(db,"users",currentUser), updates);

        toast("ì¶œê·¼ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.","good","ì¶œê·¼",1800,"checkin");
        await refreshAll({silent:true});
      }catch(e){
        console.error(e);
        alert("ì¶œê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    async function checkOut(){
      try{
        const uSnap=await getDoc(doc(db,"users",currentUser));
        if(!uSnap.exists()) return alert("ìœ ì € ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.");
        const u=normalizeUser(uSnap.data());

        if(!u.isOnline || !u.openWorkId){
          return alert("ì¶œê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
        }

        // openCheckInAtê°€ ì—†ìœ¼ë©´ workRecordsì—ì„œ 1íšŒ ë” ì½ì–´ì•¼ í•´ì„œ ë¦¬ë“œ ì¦ê°€
        // â†’ ì•ˆì „ì¥ì¹˜ë¡œ workRecordsë¥¼ 1íšŒ ì½ì–´ì„œ durationì„ ê³„ì‚°í•©ë‹ˆë‹¤.
        const wrRef = doc(db,"workRecords",u.openWorkId);
        const wrSnap = await getDoc(wrRef); // 1 read
        if(!wrSnap.exists()) return alert("ì¶œê·¼ ê¸°ë¡ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        const wr = wrSnap.data();
        const ci = wr.checkIn?.toDate ? wr.checkIn.toDate() : null;
        if(!ci) return alert("ì¶œê·¼ ì‹œê°„ì´ ì•„ì§ í™•ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");

        const co = kstNow();
        const durSec = Math.max(0, Math.floor((co.getTime()-ci.getTime())/1000));

        const tKey = dayKey(todayStart());
        const wsKey = dayKey(weekStartMonday0());

        // workRecords ë§ˆê°
        await updateDoc(wrRef, {
          checkOut: serverTimestamp(),
          durationSec: durSec
        });

        // users ìš”ì•½ ì—…ë°ì´íŠ¸
        const updates={
          isOnline:false,
          openWorkId: null,
          openCheckInAt: null,
          lastCheckOut: serverTimestamp()
        };

        // ì˜¤ëŠ˜í‚¤/ì£¼ê°„í‚¤ ë§ì¶°ì„œ ëˆ„ì 
        if(u.todayKey !== tKey){
          updates.todayKey = tKey;
          updates.todaySeconds = 0;
          updates.todayCheckIns = 0;
        }
        if(u.weekStart !== wsKey){
          updates.weekStart = wsKey;
          updates.weekSeconds = 0;
        }

        updates.todaySeconds = increment(durSec);
        updates.weekSeconds = increment(durSec);

        await updateDoc(doc(db,"users",currentUser), updates);

        toast("í‡´ê·¼ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.","good","í‡´ê·¼",1800,"checkout");
        await refreshAll({silent:true});
      }catch(e){
        console.error(e);
        alert("í‡´ê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // ê´€ë¦¬ì ê°•ì œ ì¶œê·¼/í‡´ê·¼
    async function adminForceIn(nick){
      if(!isAdmin()) return;
      const s=await getDoc(doc(db,"users",nick));
      if(!s.exists()) return alert("ìœ ì € ì—†ìŒ");
      const u=normalizeUser(s.data());
      if(u.isOnline && u.openWorkId) return alert("ì´ë¯¸ ì¶œê·¼ì¤‘");
      // ê°•ì œ ì¶œê·¼ë„ ë™ì¼ ì²˜ë¦¬
      const tKey=dayKey(todayStart());
      const wsKey=dayKey(weekStartMonday0());
      const wr=await addDoc(colWork,{nickname:nick,checkIn:serverTimestamp(),checkOut:null,durationSec:null,dayKey:tKey,weekStart:wsKey});
      const updates={ isOnline:true, openWorkId:wr.id, openCheckInAt:serverTimestamp(), lastCheckIn:serverTimestamp() };
      if(u.todayKey!==tKey){ updates.todayKey=tKey; updates.todaySeconds=0; updates.todayCheckIns=0; }
      updates.todayCheckIns=increment(1);
      if(u.weekStart!==wsKey){ updates.weekStart=wsKey; updates.weekSeconds=0; }
      await updateDoc(doc(db,"users",nick), updates);
      toast("ê°•ì œ ì¶œê·¼ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.","good","ê´€ë¦¬"); setStatus("ê°•ì œ ì¶œê·¼ ì™„ë£Œ");
    }
    async function adminForceOut(nick){
      if(!isAdmin()) return;
      const s=await getDoc(doc(db,"users",nick));
      if(!s.exists()) return alert("ìœ ì € ì—†ìŒ");
      const u=normalizeUser(s.data());
      if(!u.isOnline || !u.openWorkId) return alert("ì¶œê·¼ì¤‘ì´ ì•„ë‹˜");
      const wrRef=doc(db,"workRecords",u.openWorkId);
      const wrSnap=await getDoc(wrRef);
      if(!wrSnap.exists()) return alert("ì¶œê·¼ ê¸°ë¡ ì—†ìŒ");
      const wr=wrSnap.data();
      const ci=wr.checkIn?.toDate?wr.checkIn.toDate():null;
      if(!ci) return alert("ì¶œê·¼ ì‹œê°„ í™•ì • ì „");
      const durSec=Math.max(0, Math.floor((kstNow().getTime()-ci.getTime())/1000));
      await updateDoc(wrRef,{checkOut:serverTimestamp(),durationSec:durSec});
      const tKey=dayKey(todayStart());
      const wsKey=dayKey(weekStartMonday0());
      const updates={ isOnline:false, openWorkId:null, openCheckInAt:null, lastCheckOut:serverTimestamp() };
      if(u.todayKey!==tKey){ updates.todayKey=tKey; updates.todaySeconds=0; updates.todayCheckIns=0; }
      if(u.weekStart!==wsKey){ updates.weekStart=wsKey; updates.weekSeconds=0; }
      updates.todaySeconds=increment(durSec);
      updates.weekSeconds=increment(durSec);
      await updateDoc(doc(db,"users",nick), updates);
      toast("ê°•ì œ í‡´ê·¼ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.","good","ê´€ë¦¬"); setStatus("ê°•ì œ í‡´ê·¼ ì™„ë£Œ");
    }

    // ---------- CONTENT (7ì¼ ì œí•œ + í˜ì´ì§€ë„¤ì´ì…˜ + ì‘ì„± ëª¨ë‹¬) ----------
    function needsOutcome(type){ return type==="ë³´ê¸‰" || type==="ì°¨ëŸ‰ìˆ˜í˜¸"; }

    function contentBaseQuery(){
      const since = new Date(kstNow().getTime());
      since.setDate(since.getDate()-7);
      // âœ… 7ì¼ ì œí•œ
      let qy = query(colContent, where("time", ">=", since), orderBy("time","desc"), limit(PAGE_SIZE));
      if(contentFilter!=="ALL"){
        qy = query(colContent, where("time", ">=", since), where("type","==",contentFilter), orderBy("time","desc"), limit(PAGE_SIZE));
      }
      return qy;
    }

    async function loadContentPage(pageIndex){
      contentPage = pageIndex;
      const since = new Date(kstNow().getTime()); since.setDate(since.getDate()-7);

      let qy;
      if(pageIndex===0){
        qy = contentBaseQuery();
      }else{
        const cursor = contentPageCursors[pageIndex-1];
        if(!cursor){
          // ì»¤ì„œê°€ ì—†ìœ¼ë©´ ì´ì „ í˜ì´ì§€ë¶€í„° ë‹¤ì‹œ ê³„ì‚°
          return loadContentPage(0);
        }
        if(contentFilter==="ALL"){
          qy = query(colContent, where("time", ">=", since), orderBy("time","desc"), startAfter(cursor), limit(PAGE_SIZE));
        }else{
          qy = query(colContent, where("time", ">=", since), where("type","==",contentFilter), orderBy("time","desc"), startAfter(cursor), limit(PAGE_SIZE));
        }
      }

      const snap = await getDocs(qy);
      contentPageDocs = snap.docs;
      // ë‹¤ìŒ í˜ì´ì§€ ì»¤ì„œ ì €ì¥
      if(snap.docs.length>0){
        contentPageCursors[pageIndex] = snap.docs[snap.docs.length-1];
      }

      renderContentTimeline();
    }

    function renderContentTimeline(){
      const list = $("contentList");
      if(!list) return;
      const items = contentPageDocs.map(d=>{
        const r=d.data();
        const type = r.type || "-";
        const out = needsOutcome(type) ? (r.outcome===true?"O":(r.outcome===false?"X":"-")) : "-";
        const writer = r.writer || "-";
        const writerHidden = (!isAdmin() && usersCache.get(writer)?.isHidden);
        if(writerHidden) return null;
        const time = fmt(r.time);
        let parts = Array.isArray(r.participants)?r.participants:[];
        if(!isAdmin()){
          parts = parts.filter(n=>!(usersCache.get(n)?.isHidden));
          if(parts.length===0) return null;
        }
        const boldWriter = `<b style="font-weight:900;">${esc(writer)}</b>`;
        const edited = r.edited?.mode==="admin" ? `<span class="tiny">ìˆ˜ì •:${esc(r.edited.by||"-")}</span>` :
                      r.edited?.mode==="self" ? `<span class="tiny">(ìˆ˜ì •ë¨)</span>` : "";
        const canEdit = isAdmin() || writer===currentUser;
        const canDelete = isAdmin() || writer===currentUser;
        return `
          <div class="event">
            <div class="head">
              <span class="badge">${esc(type)}</span>
              ${needsOutcome(type)?`<span class="badge">${out}</span>`:""}
              <span class="spacer"></span>
              <span class="tiny">${esc(time)}</span>
            </div>
            <div class="meta">${boldWriter} ${edited}</div>
            <div class="p">ì°¸ì—¬ì: ${renderParticipants(parts, r.edited?.added, r.edited?.removed)}</div>
            <div class="row" style="margin-top:10px;">
              ${canEdit?`<button class="pill" data-edit="${d.id}">ìˆ˜ì •</button>`:""}
              ${canDelete?`<button class="pill danger" data-del="${d.id}">ì‚­ì œ</button>`:""}
            </div>
          </div>
        `;
      }).join("");

      list.innerHTML = items || `<div class="tiny">ìµœê·¼ 7ì¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;

      // paging buttons
      $("contentPageInfo").textContent = `${contentPage+1} í˜ì´ì§€`;
      $("btnPrevContent").disabled = contentPage===0;
      $("btnNextContent").disabled = contentPageDocs.length < PAGE_SIZE;

      // bind edit/delete
      list.querySelectorAll("[data-edit]").forEach(b=>{
        b.onclick=()=>openEditContent(b.getAttribute("data-edit"));
      });
      list.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick=()=>deleteContent(b.getAttribute("data-del"));
      });
    }

    // create content modal
    let createType=null, createSelected=new Set(), createSearch="";
    async function openCreate(type){
      if(!currentUser){ toast("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.","warn","ì•ˆë‚´"); return; }
      await loadUsersOnce({force:false, reason: isAdmin()? "admin": ""});
      createType=type;
      createSelected=new Set([currentUser]); // ì‘ì„±ì ìë™ í¬í•¨
      createSearch="";
      $("cTitle").textContent = `ì»¨í…ì¸  ì‘ì„± Â· ${type}`;
      $("cSearch").value="";
      $("cOutcomeBox").hidden = !needsOutcome(type);
      $("cOutcome").value="-";
      renderCreateUsers();
      renderCreateSelected();
      showModal("createModal", true);
    }
    function renderCreateUsers(){
      const q=(createSearch||"").toLowerCase();
      const names=Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b,"ko"));
      const filtered=q?names.filter(n=>n.toLowerCase().includes(q)):names;
      $("cUserList").innerHTML = filtered.map(n=>{
        const checked=createSelected.has(n)?"checked":"";
        return `<label class="itemRow" style="cursor:pointer;">
          <span><b>${esc(n)}</b></span>
          <input type="checkbox" data-cpick="${esc(n)}" ${checked}/>
        </label>`;
      }).join("");
      $("cUserList").querySelectorAll("input[data-cpick]").forEach(cb=>{
        cb.onchange=()=>{
          const n=cb.getAttribute("data-cpick");
          if(cb.checked) createSelected.add(n); else createSelected.delete(n);
          createSelected.add(currentUser);
          renderCreateSelected();
        };
      });
    }
    function renderCreateSelected(){
      const arr=Array.from(createSelected).sort((a,b)=>a.localeCompare(b,"ko"));
      $("cSelected").innerHTML = arr.map(n=>`<span class="badge">${esc(n)}</span>`).join(" ") || `<span class="tiny">ì„ íƒ ì—†ìŒ</span>`;
      $("cCount").textContent = `${arr.length}ëª…`;
    }
    // ---------- OCR (TAB ìŠ¤í¬ë¦°ìƒ· â†’ ë‹‰ë„¤ì„ ìë™ ì„ íƒ) ----------
    // - ë¦¬ë“œ/ì„±ëŠ¥ ì˜í–¥ì´ ì—†ë„ë¡, ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
    let _tesseractLoaded = false;
    async function ensureTesseract(){
      if(_tesseractLoaded) return;
      await new Promise((resolve, reject)=>{
        const s=document.createElement("script");
        s.src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
        s.onload=()=>resolve();
        s.onerror=()=>reject(new Error("tesseract load failed"));
        document.head.appendChild(s);
      });
      _tesseractLoaded = true;
    }

    function _normUserToken(str){
      return String(str||"")
        .toLowerCase()
        .replace(/[^a-z0-9_]/g,"");
    }
    function _canon(str){
      return _normUserToken(str)
        .replace(/[o0]/g,"0")
        .replace(/[il1]/g,"1")
        .replace(/[s5]/g,"5")
        .replace(/[z2]/g,"2")
        .replace(/[b8]/g,"8")
        .replace(/[g6]/g,"6");
    }
    function _lev(a,b){
      a=String(a); b=String(b);
      const al=a.length, bl=b.length;
      if(!al) return bl;
      if(!bl) return al;
      const dp=new Array(bl+1);
      for(let j=0;j<=bl;j++) dp[j]=j;
      for(let i=1;i<=al;i++){
        let prev=dp[0]; dp[0]=i;
        for(let j=1;j<=bl;j++){
          const tmp=dp[j];
          const cost = a[i-1]===b[j-1] ? 0 : 1;
          dp[j]=Math.min(dp[j]+1, dp[j-1]+1, prev+cost);
          prev=tmp;
        }
      }
      return dp[bl];
    }

    function pickNamesFromText(text){
      // OCR ê²°ê³¼ë¥¼ ë” "ë¯¼ê°í•˜ê²Œ" ë§¤ì¹­í•©ë‹ˆë‹¤.
      // 1) ì›ë¬¸ í¬í•¨(ê¸°ì¡´)
      // 2) í† í°(ê³µë°±/ì¤„ë°”ê¿ˆ ë¶„ë¦¬) + ë ˆë²¤ìŠˆíƒ€ì¸ ê±°ë¦¬
      // 3) OCR í”í•œ ì˜¤ì¸ì‹(0/O, 1/I/l ë“±) ë³´ì • ë¹„êµ
      const raw = String(text||"").replace(/\s+/g," ").toLowerCase();
      const tokens = raw.split(/[^a-z0-9_]+/i).filter(Boolean);

      const names = Array.from(usersCache.keys());
      const found = new Set();

      for(const name of names){
        const n0=String(name);
        const n=n0.toLowerCase();
        if(raw.includes(n)) { found.add(n0); continue; }

        const cn=_canon(n0);
        const len=cn.length;
        const tol = len>=10 ? 2 : (len>=6 ? 1 : 0);

        for(const t of tokens){
          if(t.length < Math.max(3, Math.floor(len*0.55))) continue;

          const ct=_canon(t);
          if(ct===cn){ found.add(n0); break; }
          if(tol>0 && Math.abs(ct.length-len)<=2 && _lev(ct, cn) <= tol){
            found.add(n0); break;
          }
        }
      }

      return Array.from(found).sort((a,b)=>b.length-a.length);
    }

    async function runOcrForCreate(){
      try{
        const file=$("cOcrFile")?.files?.[0];
        if(!file){ toast("ìŠ¤í¬ë¦°ìƒ· íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.","warn"); return; }

        $("cOcrResult").textContent = "ì¸ì‹ ì¤‘ì…ë‹ˆë‹¤â€¦ (ì„ ëª…ë„/í•´ìƒë„ì— ë”°ë¼ 5~15ì´ˆ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)";
        await ensureTesseract();

        // ---------- ì „ì²˜ë¦¬(ê°ë„ ìƒìŠ¹) ----------
        // 1) 2ë°° ì—…ìŠ¤ì¼€ì¼
        // 2) í‘ë°±/ëŒ€ë¹„ ê°•í™”
        // 3) TAB ëª©ë¡ì²˜ëŸ¼ ê¸€ì ëŒ€ë¹„ê°€ í° ì´ë¯¸ì§€ì— ìœ ë¦¬í•©ë‹ˆë‹¤.
        let imgBitmap=null;
        try{ imgBitmap = await createImageBitmap(file); }catch(_e){}
        let input = file;

        if(imgBitmap){
          const scale = 2;
          const c = document.createElement("canvas");
          c.width = imgBitmap.width*scale;
          c.height= imgBitmap.height*scale;
          const ctx=c.getContext("2d", { willReadFrequently:true });
          ctx.imageSmoothingEnabled = false;
          ctx.filter = "grayscale(1) contrast(1.75) brightness(1.1)";
          ctx.drawImage(imgBitmap, 0, 0, c.width, c.height);

          // ì•½í•œ ì´ì§„í™”(ë„ˆë¬´ ì„¸ê²Œ í•˜ë©´ ê¸€ìê°€ ë­‰ê°œì ¸ì„œ, ì¤‘ê°„ê°’ë§Œ ì‚´ì§)
          const img=ctx.getImageData(0,0,c.width,c.height);
          const d=img.data;
          for(let i=0;i<d.length;i+=4){
            const v = d[i]; // grayscale
            const t = v>160 ? 255 : (v<80 ? 0 : v);
            d[i]=d[i+1]=d[i+2]=t;
          }
          ctx.putImageData(img,0,0);
          input = c;
        }

        const { data } = await Tesseract.recognize(
          input,
          "eng",
          {
            tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_",
            preserve_interword_spaces: "1"
          }
        );

        const txt = data?.text || "";
        const picked = pickNamesFromText(txt);

        if(picked.length===0){
          $("cOcrResult").textContent =
            "ì¸ì‹ ê²°ê³¼ì—ì„œ ë“±ë¡ëœ ë‹‰ë„¤ì„ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (TAB ìŠ¤í¬ë¦°ìƒ·ì„ ë” ì„ ëª…í•˜ê²Œ/í™•ëŒ€í•´ì„œ ì°ì–´ ì£¼ì„¸ìš”)";
          toast("ë‹‰ë„¤ì„ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.","warn");
          return;
        }

        picked.forEach(n=>createSelected.add(n));
        createSelected.add(currentUser);
        renderCreateUsers();
        renderCreateSelected();

        $("cOcrResult").innerHTML =
          `ì¶”ì²œ ì„ íƒ: ${picked.map(n=>`<span class="badge">${esc(n)}</span>`).join(" ")}`;
        toast(`ë‹‰ë„¤ì„ ${picked.length}ëª… ìë™ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`,"ok");
      }catch(e){
        console.error(e);
        $("cOcrResult").textContent = "OCR ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” í™•ì¸)";
        toast("OCR ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.","bad");
      }
    }

    function createSelectAll(){
      Array.from(usersCache.keys()).forEach(n=>createSelected.add(n));
      createSelected.add(currentUser);
      renderCreateSelected(); renderCreateUsers();
    }
    function createClearAll(){
      createSelected=new Set([currentUser]);
      renderCreateSelected(); renderCreateUsers();
    }
    async function saveCreate(){
      if(!createType) return;
      const parts=Array.from(createSelected).map(s=>s.trim()).filter(Boolean);
      if(parts.length===0) return alert("0ëª…ì€ ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      let outcome=null;
      if(needsOutcome(createType)){
        const v=$("cOutcome").value;
        if(v==="O") outcome=true; else if(v==="X") outcome=false; else outcome=null;
      }
      await addDoc(colContent,{
        type:createType,
        writer: currentUser,
        participants: parts,
        outcome,
        time: serverTimestamp(),
        edited: null
      });

      // âœ… users ìš”ì•½: ì»¨í…ì¸  ì¹´ìš´íŠ¸/ë§ˆì§€ë§‰ ì°¸ì—¬ ì—…ë°ì´íŠ¸ (ìš”ì•½í•„ë“œ)
      const countField = createType==="ë³´ê¸‰" ? "contentCounts.supply" : (createType==="ì†¡ì „ì†Œ" ? "contentCounts.plant" : "contentCounts.escort");
      const lastField  = createType==="ë³´ê¸‰" ? "contentLast.supply" : (createType==="ì†¡ì „ì†Œ" ? "contentLast.plant" : "contentLast.escort");

      // ì‘ì„±ì í¬í•¨ ì°¸ì—¬ìë“¤ì˜ ì¹´ìš´íŠ¸ë„ ì˜¬ë¦´ì§€? (ë¦¬ë“œ ìµœì†Œ ìœ„í•´ writeë§Œ)
      // ìš”êµ¬ì‚¬í•­: "ì°¸ì—¬ íšŸìˆ˜"ëŠ” ìœ ì € í†µê³„ì— ë³´ì—¬ì•¼ í•¨ â†’ ì°¸ì—¬ì ì „ì› ì—…ë°ì´íŠ¸.
      // 20~30ëª…ì´ë¼ë„ ì°¸ì—¬ì ìˆ˜ê°€ ë§ìœ¼ë©´ writesê°€ ëŠ˜ì§€ë§Œ readsëŠ” ëŠ˜ì§€ ì•ŠìŒ.
      // (ë¬´ë£Œ í•œë„ì—ì„œ readsê°€ ë¨¼ì € í„°ì§€ëŠ” ìƒí™©ì´ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” writes ì¦ê°€ë¥¼ ê°ìˆ˜)
      const uniq = Array.from(new Set(parts));
      for(const nick of uniq){
        await updateDoc(doc(db,"users",nick), {
          [countField]: increment(1),
          [lastField]: serverTimestamp(),
          lastContentAt: serverTimestamp()
        }).catch(()=>{});
      }

      showModal("createModal", false);
      setStatus("ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadUsersOnce({force:true, reason:"admin"});
      await loadDashKpis();
      await loadUserTable();
      await loadContentPage(0);
    }

    // edit content modal (participants ìˆ˜ì • + outcome ìˆ˜ì •, ê¶Œí•œ: ì‘ì„±ì ë˜ëŠ” ê´€ë¦¬ì)
    let editId=null, editData=null, editSelected=new Set(), editSearch="";
    async function openEditContent(id){
      const s=await getDoc(doc(db,"contentRecords",id));
      if(!s.exists()) return alert("ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
      const r=s.data();
      if(!(isAdmin() || r.writer===currentUser)) return alert("ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");

      editId=id; editData=r;
      editSelected=new Set((Array.isArray(r.participants)?r.participants:[]));
      editSelected.add(r.writer||currentUser);
      editSearch="";

      $("eTitle").textContent = `ì»¨í…ì¸  ìˆ˜ì • Â· ${r.type}`;
      $("eSearch").value="";
      $("eOutcomeBox").hidden = !needsOutcome(r.type);
      $("eOutcome").value = (r.outcome===true?"O":(r.outcome===false?"X":"-"));

      renderEditUsers();
      renderEditSelected();

      showModal("editModal", true);
    }
    function renderEditUsers(){
      const q=(editSearch||"").toLowerCase();
      const names=Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b,"ko"));
      const filtered=q?names.filter(n=>n.toLowerCase().includes(q)):names;
      $("eUserList").innerHTML = filtered.map(n=>{
        const checked=editSelected.has(n)?"checked":"";
        return `<label class="itemRow" style="cursor:pointer;">
          <span><b>${esc(n)}</b></span>
          <input type="checkbox" data-epick="${esc(n)}" ${checked}/>
        </label>`;
      }).join("");
      $("eUserList").querySelectorAll("input[data-epick]").forEach(cb=>{
        cb.onchange=()=>{
          const n=cb.getAttribute("data-epick");
          if(cb.checked) editSelected.add(n); else editSelected.delete(n);
          editSelected.add(editData.writer||currentUser);
          renderEditSelected();
        };
      });
    }
    function renderEditSelected(){
      const arr=Array.from(editSelected).sort((a,b)=>a.localeCompare(b,"ko"));
      $("eSelected").innerHTML = arr.map(n=>`<span class="badge">${esc(n)}</span>`).join(" ") || `<span class="tiny">ì„ íƒ ì—†ìŒ</span>`;
      $("eCount").textContent = `${arr.length}ëª…`;
    }
    function editSelectAll(){ Array.from(usersCache.keys()).forEach(n=>editSelected.add(n)); editSelected.add(editData.writer||currentUser); renderEditSelected(); renderEditUsers(); }
    function editClearAll(){ editSelected=new Set([editData.writer||currentUser]); renderEditSelected(); renderEditUsers(); }

    async function saveEdit(){
      if(!editId||!editData) return;
      const parts=Array.from(editSelected).map(s=>s.trim()).filter(Boolean);
      if(parts.length===0) return alert("0ëª…ì€ ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

      let outcome=editData.outcome ?? null;
      if(needsOutcome(editData.type)){
        const v=$("eOutcome").value;
        if(v==="O") outcome=true; else if(v==="X") outcome=false; else outcome=null;
      }

      // ë³€ê²½ ì‚¬í•­(ì¶”ê°€/ì‚­ì œ)ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
      const oldPartsArr = Array.isArray(editData.participants)?editData.participants:[];
      const oldSet = new Set(oldPartsArr.map(x=>String(x||"").trim()).filter(Boolean));
      if(editData.writer) oldSet.add(String(editData.writer));
      const newSet = new Set(parts.map(x=>String(x||"").trim()).filter(Boolean));

      const added = Array.from(newSet).filter(x=>!oldSet.has(x));
      const removed = Array.from(oldSet).filter(x=>!newSet.has(x));

      const edited = (isAdmin() && editData.writer!==currentUser)
        ? {mode:"admin", by: currentUser, at: serverTimestamp(), added, removed}
        : {mode:"self", by: editData.writer||currentUser, at: serverTimestamp(), added, removed};

      await updateDoc(doc(db,"contentRecords",editId),{
        participants: parts,
        outcome,
        edited
      });

      showModal("editModal", false);
      toast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.","good","ì»¨í…ì¸  ìˆ˜ì •"); setStatus("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadContentPage(0);
    }

    async function deleteContent(id){
      const s=await getDoc(doc(db,"contentRecords",id));
      if(!s.exists()) return;
      const r=s.data();
      if(!(isAdmin() || r.writer===currentUser)) return alert("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
      if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      await deleteDoc(doc(db,"contentRecords",id));
      setStatus("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadContentPage(0);
    }
    async function adminDeleteAllContent(){
      if(!isAdmin()) return;
      if(!confirm("ì»¨í…ì¸  ê¸°ë¡ì„ ì „ì²´ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) return;
      // ìµœê·¼ 7ì¼ë§Œ ë³´ì§€ë§Œ, ì „ì²´ ì‚­ì œëŠ” contentRecords ì „ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•´ì•¼ í•¨.
      // ë¦¬ë“œ ìµœì†Œí™” ëª©ì ìƒ, ì—¬ê¸°ì„œëŠ” "ìµœê·¼ 7ì¼"ë§Œ ì‚­ì œ ì˜µì…˜ìœ¼ë¡œ ì œí•œí•©ë‹ˆë‹¤.
      if(!confirm("ìµœê·¼ 7ì¼ ê¸°ë¡ë§Œ ì‚­ì œí•©ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      const since=new Date(kstNow().getTime()); since.setDate(since.getDate()-7);
      const qy=query(colContent, where("time",">=",since), orderBy("time","desc"), limit(500));
      const snap=await getDocs(qy);
      for(const d of snap.docs){
        await deleteDoc(doc(db,"contentRecords",d.id));
      }
      setStatus("ìµœê·¼ 7ì¼ ê¸°ë¡ ì‚­ì œ ì™„ë£Œ");
      await loadContentPage(0);
    }

    // ---------- ADMIN: WORK RECORDS MANAGE (3-A,B,C,D ì ìš© ì¤‘ A) ----------
    function workBaseQuery(){
      const since=new Date(kstNow().getTime()); since.setDate(since.getDate()-7);
      return query(colWork, where("checkIn", ">=", since), orderBy("checkIn","desc"), limit(PAGE_SIZE));
    }
    async function loadWorkPage(pageIndex){
      workPage=pageIndex;
      const since=new Date(kstNow().getTime()); since.setDate(since.getDate()-7);

      let qy;
      if(pageIndex===0){
        qy=workBaseQuery();
      }else{
        const cursor=workCursors[pageIndex-1];
        if(!cursor) return loadWorkPage(0);
        qy=query(colWork, where("checkIn", ">=", since), orderBy("checkIn","desc"), startAfter(cursor), limit(PAGE_SIZE));
      }
      const snap=await getDocs(qy);
      workDocs=snap.docs;
      if(snap.docs.length>0) workCursors[pageIndex]=snap.docs[snap.docs.length-1];
      renderWorkTable();
    }
    function renderWorkTable(){
      $("workPageInfo").textContent=`${workPage+1} í˜ì´ì§€`;
      $("btnPrevWork").disabled = workPage===0;
      $("btnNextWork").disabled = workDocs.length < PAGE_SIZE;

      $("workTbody").innerHTML = workDocs.map(d=>{
        const r=d.data();
        const nick=r.nickname||"-";
        const ci=fmt(r.checkIn);
        const co=fmt(r.checkOut);
        const dur = (r.durationSec!=null) ? secsToHMS(r.durationSec) : "-";
        const open = r.checkOut==null ? `<span class="badge on">OPEN</span>` : `<span class="badge dim">CLOSED</span>`;
        return `<tr>
          <td><b>${esc(nick)}</b></td>
          <td>${esc(ci)}</td>
          <td>${esc(co)}</td>
          <td>${dur}</td>
          <td>${open}</td>
          <td>
            <button class="pill" data-wedit="${d.id}">ìˆ˜ì •</button>
            <button class="pill danger" data-wdel="${d.id}">ì‚­ì œ</button>
            ${r.checkOut==null?`<button class="pill danger" data-wforce="${esc(nick)}">ê°•ì œí‡´ê·¼</button>`:""}
          </td>
        </tr>`;
      }).join("") || `<tr><td colspan="6" class="tiny">ìµœê·¼ 7ì¼ ê·¼ë¬´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;

      $("workTbody").querySelectorAll("[data-wdel]").forEach(b=>{
        b.onclick=()=>adminDeleteWork(b.getAttribute("data-wdel"));
      });
      $("workTbody").querySelectorAll("[data-wforce]").forEach(b=>{
        b.onclick=()=>adminForceOut(b.getAttribute("data-wforce"));
      });
      $("workTbody").querySelectorAll("[data-wedit]").forEach(b=>{
        b.onclick=()=>openEditWork(b.getAttribute("data-wedit"));
      });
    }

    async function adminDeleteWork(id){
      if(!isAdmin()) return;
      if(!confirm("ì´ ê·¼ë¬´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      await deleteDoc(doc(db,"workRecords",id));
      setStatus("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadWorkPage(workPage);
    }
    async function adminDeleteAllWork(){
      if(!isAdmin()) return;
      if(!confirm("ìµœê·¼ 7ì¼ ê·¼ë¬´ ê¸°ë¡ì„ ì „ì²´ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      const since=new Date(kstNow().getTime()); since.setDate(since.getDate()-7);
      const qy=query(colWork, where("checkIn",">=",since), orderBy("checkIn","desc"), limit(500));
      const snap=await getDocs(qy);
      for(const d of snap.docs){
        await deleteDoc(doc(db,"workRecords",d.id));
      }
      setStatus("ìµœê·¼ 7ì¼ ê·¼ë¬´ ê¸°ë¡ ì‚­ì œ ì™„ë£Œ");
      await loadWorkPage(0);
    }

    // edit work record modal: ê´€ë¦¬ìë§Œ
    let wEditId=null;
    async function openEditWork(id){
      if(!isAdmin()) return;
      const s=await getDoc(doc(db,"workRecords",id));
      if(!s.exists()) return alert("ê¸°ë¡ ì—†ìŒ");
      wEditId=id;
      const r=s.data();
      $("wNick").value=r.nickname||"";
      $("wIn").value = toLocalInput(r.checkIn);
      $("wOut").value = toLocalInput(r.checkOut);
      showModal("workEditModal", true);
    }
    function toLocalInput(ts){
      if(!ts) return "";
      const d=ts.toDate?ts.toDate():null; if(!d) return "";
      const p=n=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
    }
    async function saveEditWork(){
      if(!isAdmin()||!wEditId) return;
      const nick=$("wNick").value.trim();
      const inV=$("wIn").value;
      const outV=$("wOut").value;
      if(!nick||!inV) return alert("ë‹‰ë„¤ì„/ì¶œê·¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
      const ci=new Date(inV);
      const co=outV?new Date(outV):null;
      const dur = co ? Math.max(0, Math.floor((co.getTime()-ci.getTime())/1000)) : null;
      await updateDoc(doc(db,"workRecords",wEditId),{
        nickname:nick,
        checkIn: ci,
        checkOut: co,
        durationSec: dur
      });
      showModal("workEditModal", false);
      setStatus("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      await loadWorkPage(workPage);
    }

    // total reset(3-1 confirm): users ìš”ì•½ ë¦¬ì…‹
    async function adminResetTotals(){
      if(!isAdmin()) return;
      if(!confirm("ì´ ì¶œê·¼(ì ‘ì†)ì‹œê°„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      if(!confirm("ì •ë§ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) return;

      // 20~30ëª… ê·œëª¨ì´ë¯€ë¡œ ì „ì²´ users ë¬¸ì„œ ì—…ë°ì´íŠ¸ ê°€ëŠ¥(ì“°ê¸° ë§ì§€ë§Œ reads ì¤„ì´ê¸° ëª©ì )
      for(const [id,u] of usersCache.entries()){
        await updateDoc(doc(db,"users",id),{
          weekSeconds: 0,
          todaySeconds: 0,
          todayCheckIns: 0
        }).catch(()=>{});
      }
      setStatus("ì´ˆê¸°í™” ì™„ë£Œ");
      await loadUsersOnce({force:true, reason:"admin"});
      await loadDashKpis();
      await loadUserTable();
    }

    // ---------- ADMIN: USER MANAGEMENT (í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸/ê³„ê¸‰/ë¶€ì„œ/ìˆ¨ê¹€/ê¶Œí•œ/ë¶€ì„œì¥) ----------
    async function adminAddUser(){
      if(!isAdmin()) return;
      const id=$("addNick").value.trim();
      const pw=$("addPw").value.trim();
      if(!id||!pw) return alert("ë‹‰ë„¤ì„/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      const s=await getDoc(doc(db,"users",id));
      if(s.exists()) return alert("ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.");
      await setDoc(doc(db,"users",id),{
        password: pw,
        isAdmin:false,
        isHidden:false,
        rank:"",
        department:"",
        deptLeaderOf: [],
        // ìš”ì•½í•„ë“œ ê¸°ë³¸ê°’
        isOnline:false,
        openWorkId:null,
        lastCheckIn:null,
        lastCheckOut:null,
        weekStart: dayKey(weekStartMonday0()),
        weekSeconds: 0,
        todayKey: dayKey(todayStart()),
        todaySeconds: 0,
        todayCheckIns: 0,
        contentCounts: {supply:0, plant:0, escort:0},
        contentLast: {supply:null, plant:null, escort:null},
        lastContentAt: null
      });
      $("addNick").value=""; $("addPw").value="";
      setStatus("ìœ ì € ì¶”ê°€ ì™„ë£Œ");
      await loadUsersOnce({force:true, reason:"admin"});
      await loadDashKpis();
      await loadUserTable();
      await renderAdminUserCards();
      try{ await loadDashKpis(); await loadUserTable(); }catch(e){}
      try{ if(typeof loadWorkPage==="function") await loadWorkPage(0); }catch(e){}
    }

    function renderAdminUserCards(){
      if(!isAdmin()) return;
      const wrap = $("adminUserCards");
      if(!wrap) return;

      const sortSel=$("adminSort");
      if(sortSel && !sortSel._init){
        sortSel._init=true;
        sortSel.innerHTML = `
          <option value="rankDesc">ê³„ê¸‰ ë†’ì€ìˆœ</option>
          <option value="rankAsc">ê³„ê¸‰ ë‚®ì€ìˆœ</option>
          <option value="onlineFirst">ì ‘ì†ì ìš°ì„ </option>
          <option value="onlineOnly">ì˜¨ë¼ì¸ë§Œ</option>
          <option value="nameAsc">ì´ë¦„ Aâ†’Z</option>
          <option value="nameDesc">ì´ë¦„ Zâ†’A</option>
        `;
        sortSel.value = localStorage.getItem("dose_admin_sort") || "rankDesc";
        sortSel.onchange=()=>{ localStorage.setItem("dose_admin_sort", sortSel.value); adminPage=0; renderAdminUserCards(); };
      }

      const q = ($("adminSearch")?.value||"").trim().toLowerCase();
      const mode = sortSel?.value || "rankDesc";

      let arr = Array.from(usersCache.entries()).map(([id,u])=>[id, u||{}]);
      if(q){
        arr = arr.filter(([id,u])=>{
          const hay = `${id} ${u.rank||""} ${u.department||""}`.toLowerCase();
          return hay.includes(q);
        });
      }

      const rankOrder = {"êµ°ì˜ê´€":100,"í•˜ì‚¬":10,"ì¤‘ì‚¬":20,"ìƒì‚¬":30,"ì›ì‚¬":40,"ì†Œìœ„":50,"ì¤‘ìœ„":60,"ëŒ€ìœ„":70,"ì†Œë ¹":80,"ì¤‘ë ¹":90,"ëŒ€ë ¹":110};
      const getRank=(u)=>rankOrder[String(u.rank||"")]||0;

      if(mode==="rankDesc") arr.sort((a,b)=>getRank(b[1])-getRank(a[1]));
      if(mode==="rankAsc") arr.sort((a,b)=>getRank(a[1])-getRank(b[1]));
      if(mode==="onlineFirst") arr.sort((a,b)=>Number(!!b[1].isOnline)-Number(!!a[1].isOnline) || getRank(b[1])-getRank(a[1]));
      if(mode==="onlineOnly") arr = arr.filter(([id,u])=>!!u.isOnline);
      if(mode==="nameAsc") arr.sort((a,b)=>String(a[0]).localeCompare(String(b[0])));
      if(mode==="nameDesc") arr.sort((a,b)=>String(b[0]).localeCompare(String(a[0])));

      const total = arr.length;
      const maxPage = Math.max(1, Math.ceil(total/ADMIN_PAGE_SIZE));
      adminPage = Math.max(0, Math.min(adminPage, maxPage-1));
      const slice = arr.slice(adminPage*ADMIN_PAGE_SIZE, (adminPage+1)*ADMIN_PAGE_SIZE);

      const rankOptsTpl=(val)=>RANKS.map(r=>`<option value="${esc(r)}" ${String(val)===String(r)?"selected":""}>${esc(r)}</option>`).join("");
      const deptOptsTpl=(val)=>DEPTS.map(d=>`<option value="${esc(d)}" ${String(val)===String(d)?"selected":""}>${esc(d)}</option>`).join("");

      wrap.innerHTML = slice.map(([id,u])=>{
        const admin = u.isAdmin ? "checked" : "";
        const hidden = u.isHidden ? "checked" : "";
        const leadArr = Array.isArray(u.deptLeaderOf)?u.deptLeaderOf:[];
        const lead = leadArr.join(", ");
        const leaderBadge = leadArr.length ? `<span class="badge">ë¶€ì„œì¥</span>` : ``;

        const rankOpts = `<option value="">(ê³„ê¸‰)</option>` + rankOptsTpl(u.rank||"");
        const deptOpts = `<option value="">(ë¶€ì„œ)</option>` + deptOptsTpl(u.department||"");

        return `<details class="admItem" data-adm="${esc(id)}">
          <summary>
            <span class="badge">${esc(id)}</span>
            ${leaderBadge}
            <span class="badge role">${esc(u.rank||"-")}</span>
            <span class="badge dim">${esc(u.department||"-")}</span>
            <span class="spacer"></span>
            <span class="tiny">${u.isAdmin?"ê´€ë¦¬ì":"ì¼ë°˜"}</span>
          </summary>
          <div class="admBody">
            <div class="row">
              <label class="tiny"><input type="checkbox" data-admin="${esc(id)}" ${admin}/> ê´€ë¦¬ì</label>
              <label class="tiny"><input type="checkbox" data-hidden="${esc(id)}" ${hidden}/> ìˆ¨ê¹€</label>
              <span class="spacer"></span>
              <button class="pill" data-forcein="${esc(id)}">ê°•ì œ ì¶œê·¼</button>
              <button class="pill" data-forceout="${esc(id)}">ê°•ì œ í‡´ê·¼</button>
              <button class="pill danger" data-deluser="${esc(id)}">ìœ ì € ì‚­ì œ</button>
            </div>

            <div class="row" style="margin-top:10px; flex-wrap:wrap;">
              <select class="w220" data-rank="${esc(id)}">${rankOpts}</select>
              <select class="w320" data-dept="${esc(id)}">${deptOpts}</select>
              <input class="w220" placeholder="ë¹„ë°€ë²ˆí˜¸ ë³€ê²½" data-pw="${esc(id)}"/>
              <button class="pill" data-save="${esc(id)}">ì €ì¥</button>
            </div>

            <div class="row" style="margin-top:10px; flex-wrap:wrap;">
              <input class="w320" placeholder="ë¶€ì„œì¥ ê¶Œí•œ (ì‰¼í‘œë¡œ ë¶€ì„œëª…)" data-lead="${esc(id)}" value="${esc(lead)}"/>
              <button class="pill" data-savelead="${esc(id)}">ë¶€ì„œì¥ ì €ì¥</button>
              <span class="spacer"></span>
              <button class="pill" data-view7d="${esc(id)}">ìµœê·¼ 7ì¼ ê¸°ë¡</button>
            </div>
          </div>
        </details>`;
      }).join("") || `<div class="tiny muted">í‘œì‹œí•  ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;

      const pi=$("adminPageInfo");
      if(pi) pi.textContent = `${adminPage+1} / ${maxPage} Â· ${total}ëª…`;

      $("adminPrev")?.toggleAttribute("disabled", adminPage<=0);
      $("adminNext")?.toggleAttribute("disabled", adminPage>=maxPage-1);

      if($("adminPrev")) $("adminPrev").onclick=()=>{ adminPage=Math.max(0, adminPage-1); renderAdminUserCards(); };
      if($("adminNext")) $("adminNext").onclick=()=>{ adminPage=Math.min(maxPage-1, adminPage+1); renderAdminUserCards(); };

      wrap.querySelectorAll("[data-save]").forEach(b=>{ b.onclick=()=>adminSaveUser(b.getAttribute("data-save")); });
      wrap.querySelectorAll("[data-savelead]").forEach(b=>{ b.onclick=()=>adminSaveLeader(b.getAttribute("data-savelead")); });
      wrap.querySelectorAll("[data-forcein]").forEach(b=>{ b.onclick=()=>adminForceIn(b.getAttribute("data-forcein")); });
      wrap.querySelectorAll("[data-forceout]").forEach(b=>{ b.onclick=()=>adminForceOut(b.getAttribute("data-forceout")); });
      wrap.querySelectorAll("[data-deluser]").forEach(b=>{ b.onclick=()=>adminDeleteUser(b.getAttribute("data-deluser")); });
      wrap.querySelectorAll("[data-view7d]").forEach(b=>{ b.onclick=()=>openUserModal(b.getAttribute("data-view7d")); });
    }

    async function adminSaveUser(id){
      if(!isAdmin()) return;
      const isA = $("adminUserCards").querySelector(`input[data-admin="${cssEsc(id)}"]`)?.checked || false;
      const isH = $("adminUserCards").querySelector(`input[data-hidden="${cssEsc(id)}"]`)?.checked || false;
      const rank = $("adminUserCards").querySelector(`select[data-rank="${cssEsc(id)}"]`)?.value || "";
      const dept = $("adminUserCards").querySelector(`select[data-dept="${cssEsc(id)}"]`)?.value || "";
      const pwEl = $("adminUserCards").querySelector(`input[data-pw="${cssEsc(id)}"]`);
      const pw = (pwEl?.value||"").trim();

      const updates={ isAdmin:isA, isHidden:isH, rank, department:dept };
      if(pw) updates.password=pw;

      await updateDoc(doc(db,"users",id), updates);
      if(pwEl) pwEl.value="";
      toast("ì €ì¥ ì™„ë£Œ","good","ê´€ë¦¬",1800,"admin_saved"); toast("ìœ ì € ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.","good","ê´€ë¦¬"); setStatus("ì €ì¥ ì™„ë£Œ");
      await loadUsersOnce({force:true, reason:"admin"});
      await loadDashKpis();
      await loadUserTable();
      await renderAdminUserCards();
      try{ await loadDashKpis(); await loadUserTable(); }catch(e){}
      try{ if(typeof loadWorkPage==="function") await loadWorkPage(0); }catch(e){}
    }

    async function adminSaveLeader(id){
      if(!isAdmin()) return;
      const el = $("adminUserCards").querySelector(`input[data-lead="${cssEsc(id)}"]`);
      const raw=(el?.value||"").trim();
      const arr=raw?raw.split(",").map(s=>s.trim()).filter(Boolean):[];
      // ì—†ëŠ” ë¶€ì„œ ì…ë ¥ë„ í—ˆìš©(ììœ ), ëŒ€ì‹  í‘œì¤€ ë¶€ì„œë§Œ ì“°ê¸¸ ê¶Œì¥
      await updateDoc(doc(db,"users",id), { deptLeaderOf: arr });
      toast("ë¶€ì„œì¥ ê¶Œí•œì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.","good","ê´€ë¦¬"); setStatus("ë¶€ì„œì¥ ê¶Œí•œ ì €ì¥");
      await loadUsersOnce({force:true, reason:"admin"});
      await renderAdminUserCards();
      try{ await loadDashKpis(); await loadUserTable(); }catch(e){}
      try{ if(typeof loadWorkPage==="function") await loadWorkPage(0); }catch(e){}
    }

    // ---------- CHAT/NOTICE (3-D) ----------
    async function loadChat(){
      const dept=currentUserData?.department;
      if(!dept) { $("chatInfo").textContent="ë¶€ì„œê°€ ì„¤ì •ë˜ì–´ì•¼ ì±„íŒ…ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."; return; }
      $("chatDept").textContent = dept;
      // ìµœê·¼ 50ê°œë§Œ
      const qy=query(colDeptChat(dept), orderBy("time","desc"), limit(50));
      const snap=await getDocs(qy);
      const msgs=snap.docs.map(d=>d.data()).reverse();
      $("chatList").innerHTML = msgs.map(m=>{
        const mine=(m.by===currentUser);
        return `<div class="event" style="background:${mine?'rgba(185,198,255,0.10)':'rgba(17,21,32,0.50)'}">
          <div class="head"><span class="badge">${esc(m.by||"-")}</span><span class="spacer"></span><span class="tiny">${esc(fmt(m.time))}</span></div>
          <div class="p">${esc(m.text||"")}</div>
        </div>`;
      }).join("") || `<div class="tiny">ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;

      // ê³µì§€
      const ns=await getDoc(docDeptNotice(dept));
      if(ns.exists()){
        const n=ns.data();
        $("noticeBox").innerHTML = `
          <div class="event">
            <div class="head"><span class="badge role">ê³µì§€</span><span class="badge">${esc(n.by||"-")}</span><span class="spacer"></span><span class="tiny">${esc(fmt(n.at))}</span></div>
            <div class="p">${esc(n.text||"")}</div>
          </div>`;
      }else{
        $("noticeBox").innerHTML = `<div class="tiny">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      }

      $("noticeCompose").hidden = !isDeptLeaderOf(dept);
    }

    async function sendChat(){
      const dept=currentUserData?.department;
      if(!dept) return alert("ë¶€ì„œê°€ ì—†ìŠµë‹ˆë‹¤.");
      const text=$("chatText").value.trim();
      if(!text) return;
      await addDoc(colDeptChat(dept), { by: currentUser, text, time: serverTimestamp() });
      $("chatText").value="";
      setStatus("ì „ì†¡ë¨");
      await loadChat();
    }

    async function postNotice(){
      const dept=currentUserData?.department;
      if(!dept) return;
      if(!isDeptLeaderOf(dept)) return toast("ë¶€ì„œì¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.","bad","ê³µì§€");
      const text=$("noticeText").value.trim();
      if(!text) return toast("ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.","warn","ê³µì§€");
      await setDoc(docDeptNotice(dept), { text, by: currentUser, at: serverTimestamp(), id: `${Date.now()}_${Math.random().toString(16).slice(2)}` }, {merge:true});
      $("noticeText").value="";
      toast("ê³µì§€ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.","good","ê³µì§€"); setStatus("ê³µì§€ ë“±ë¡ë¨");
      await loadChat();
    }

    async function maybeShowNoticeOnce(){
      const dept=currentUserData?.department;
      if(!dept) return;
      const ns=await getDoc(docDeptNotice(dept));
      if(!ns.exists()) return;
      const n=ns.data();
      if(!n?.id) return;

      // users ë¬¸ì„œì˜ seenNotice.{dept}ì— id ì €ì¥í•´ì„œ 1íšŒë§Œ í‘œì‹œ
      const seen = currentUserData?.seenNotices || {};
      if(seen[dept] === n.id) return;

      // ëª¨ë‹¬ë¡œ ë„ì›€
      $("nDept").textContent = dept;
      $("nBy").textContent = n.by||"-";
      $("nAt").textContent = fmt(n.at);
      $("nText").textContent = n.text||"";
      showModal("noticeModal", true);

      // í™•ì¸ ëˆ„ë¥´ë©´ ì €ì¥
      $("btnNoticeOk").onclick = async function(){
        const patch = { seenNotices: { ...(currentUserData?.seenNotices||{}), [dept]: n.id } };
        await updateDoc(doc(db,"users",currentUser), patch).catch(()=>{});
        currentUserData.seenNotices = patch.seenNotices;
        showModal("noticeModal", false);
      };
    }

    // ---------- MODAL CONTROL ----------
    function showModal(id, on){
      const el=$(id);
      if(!el) return;
      if(on){
        lockBody(true);
        el.hidden=false;
      }else{
        // blur focus
        const active=document.activeElement;
        if(active && el.contains(active)) active.blur?.();
        el.hidden=true;
        lockBody(false);
      }
    }

    // ---------- GRAPH (3-A ê·¸ë˜í”„: users ìš”ì•½ ê¸°ë°˜) ----------
    let chart=null;
    function renderGraph(){
      // í‰ê·  ì£¼ê°„/ì˜¤ëŠ˜/ì˜¨ë¼ì¸ ë“± ê°„ë‹¨ ê·¸ë˜í”„
      const wsKey=dayKey(weekStartMonday0());
      const tKey=dayKey(todayStart());
      const rows=Array.from(usersCache.entries()).filter(([id,u])=>isAdmin()||!u.isHidden);

      const labels=rows.map(([id])=>id);
      const week=rows.map(([id,u])=> (u.weekStart===wsKey)?(u.weekSeconds||0)/3600:0);
      const today=rows.map(([id,u])=> (u.todayKey===tKey)?(u.todaySeconds||0)/3600:0);

      const ctx=$("chart")?.getContext("2d");
      if(!ctx) return;
      if(chart) chart.destroy();
      chart = new Chart(ctx,{
        type:"bar",
        data:{
          labels,
          datasets:[
            { label:"ì´ë²ˆì£¼ ì‹œê°„(ì‹œê°„)", data:week },
            { label:"ì˜¤ëŠ˜ ì‹œê°„(ì‹œê°„)", data:today }
          ]
        },
        options:{
          responsive:true,
          plugins:{ legend:{ labels:{ color:"rgba(255,255,255,0.75)" } } },
          scales:{
            x:{ ticks:{ color:"rgba(255,255,255,0.65)" }, grid:{ color:"rgba(255,255,255,0.06)" } },
            y:{ ticks:{ color:"rgba(255,255,255,0.65)" }, grid:{ color:"rgba(255,255,255,0.06)" } }
          }
        }
      });
    }

    // ---------- EVENTS ----------

    let lastNonAdminTab = "dashboard";
    function closeAdminPanel(){
      document.body.classList.remove("admin-open");
      const admin=$("adminCol");
      if(admin){
        // í¬ì»¤ìŠ¤ê°€ íŒ¨ë„ ì•ˆì— ìˆìœ¼ë©´ ë¨¼ì € í•´ì œí•©ë‹ˆë‹¤.
        const active=document.activeElement;
        if(active && admin.contains(active)) active.blur?.();
        admin.hidden=true;
        admin.setAttribute("aria-hidden","true");
        const bd=$("adminBackdrop"); if(bd){ bd.classList.remove("show"); bd.hidden=true; }
        lockBody(false);
      }
    }
    function openAdminPanel(){
      if(!isAdmin()) return;
      document.body.classList.add("admin-open");
      const admin=$("adminCol");
      if(admin){
        admin.hidden=false;
        admin.setAttribute("aria-hidden","false");
        const bd=$("adminBackdrop"); if(bd){ bd.hidden=false; bd.classList.add("show"); }
        lockBody(true);
        // ê´€ë¦¬ì ì¹´ë“œ ë Œë”ëŠ” ì—´ë¦´ ë•Œë§Œ ìˆ˜í–‰í•˜ì—¬ ë ‰ì„ ì¤„ì…ë‹ˆë‹¤.
        renderAdminUserCards();
        loadWorkPage(0);
        admin.scrollTop=0;
      }
    }
    function toggleAdminPanel(){
      if(!isAdmin()) return;
      const open = document.body.classList.contains("admin-open");
      if(open) closeAdminPanel();
      else }

    function setTab(name){
      if(name==="admin"){
        // ê´€ë¦¬ì íƒ­ì€ "ëŒ€ì‹œë³´ë“œ ìœ ì§€ + ìš°ì¸¡ íŒ¨ë„ í† ê¸€" ë°©ì‹ì…ë‹ˆë‹¤.
        toggleAdminPanel();
        // íƒ­ í‘œì‹œ ìƒíƒœëŠ” ë§ˆì§€ë§‰ ì¼ë°˜ íƒ­ì„ ìœ ì§€í•©ë‹ˆë‹¤.
        document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===lastNonAdminTab));
        return;
      }
      lastNonAdminTab = name;
      closeAdminPanel();
      document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
      document.querySelectorAll("[data-view]").forEach(v=>v.hidden = v.dataset.view!==name);
      if(name==="chat") loadChat();
      if(name==="graph") renderGraph();
    }

    window.addEventListener("DOMContentLoaded", async ()=>{
      await seedDefaultAdmin();
      // ì´ˆê¸° ë¡œë“œì‹œ ê´€ë¦¬ì íŒ¨ë„ì´ ìë™ìœ¼ë¡œ ì—´ë¦¬ì§€ ì•Šë„ë¡ í•­ìƒ ë‹«í˜ ìƒíƒœë¡œ ì‹œì‘í•©ë‹ˆë‹¤.
      try{ closeAdminPanel(); }catch(e){}

      $("btnLogin").addEventListener("click", login);
      $("btnLogout").addEventListener("click", logout);

      $("btnAdminClose")?.addEventListener("click", closeAdminPanel);
      $("adminBackdrop")?.addEventListener("click", closeAdminPanel);
      $("btnProfileClose")?.addEventListener("click", ()=>showModal("profileModal", false));
      document.addEventListener("keydown", (e)=>{
        if(e.key==="Escape"){
          try{ closeAdminPanel(); }catch(_){ }
          try{ showModal("createModal", false); }catch(_){ }
        }
      });

      $("btnSummary").addEventListener("click", ()=>refreshSummary({silent:false}));

      $("btnRefresh").addEventListener("click", ()=>refreshAll({silent:false}));

      $("btnIn").addEventListener("click", checkIn);
      $("btnOut").addEventListener("click", checkOut);

      // create
      $("btnCreateSupply").addEventListener("click", ()=>openCreate("ë³´ê¸‰"));
      $("btnCreatePlant").addEventListener("click", ()=>openCreate("ì†¡ì „ì†Œ"));
      $("btnCreateEscort").addEventListener("click", ()=>openCreate("ì°¨ëŸ‰ìˆ˜í˜¸"));

      $("contentFilter").addEventListener("change", async function(){
        contentFilter=$("contentFilter").value;
        contentPage=0;
        contentPageCursors=[];
        await loadContentPage(0);
      });
      $("btnPrevContent").addEventListener("click", ()=>loadContentPage(Math.max(0, contentPage-1)));
      $("btnNextContent").addEventListener("click", ()=>loadContentPage(contentPage+1));

      $("sortUsers").addEventListener("change", ()=>{ usersPage=0; loadUserTable(); });

      $("userPrev").addEventListener("click", ()=>{ usersPage=Math.max(0, usersPage-1); loadUserTable(); });
      $("userNext").addEventListener("click", ()=>{ usersPage=usersPage+1; loadUserTable(); });

      // modals
      $("createModal").addEventListener("click",(e)=>{ if(e.target.id==="createModal") showModal("createModal", false); });
      $("btnCreateClose").addEventListener("click", ()=>showModal("createModal", false));
      $("btnCreateCancel").addEventListener("click", ()=>showModal("createModal", false));
      $("btnCreateAll").addEventListener("click", createSelectAll);
      $("btnCreateClear").addEventListener("click", createClearAll);
      $("cSearch").addEventListener("input", ()=>{ createSearch=$("cSearch").value.trim(); renderCreateUsers(); });
      $("btnOcr").addEventListener("click", runOcrForCreate);
      $("cOcrFile").addEventListener("change", ()=>{ $("cOcrResult").textContent=""; });
      $("btnCreateSave").addEventListener("click", saveCreate);

      $("editModal").addEventListener("click",(e)=>{ if(e.target.id==="editModal") showModal("editModal", false); });
      $("btnEditClose").addEventListener("click", ()=>showModal("editModal", false));
      $("btnEditCancel").addEventListener("click", ()=>showModal("editModal", false));
      $("btnEditAll").addEventListener("click", editSelectAll);
      $("btnEditClear").addEventListener("click", editClearAll);
      $("eSearch").addEventListener("input", ()=>{ editSearch=$("eSearch").value.trim(); renderEditUsers(); });
      $("btnEditSave").addEventListener("click", saveEdit);

      $("workEditModal").addEventListener("click",(e)=>{ if(e.target.id==="workEditModal") showModal("workEditModal", false); });
      $("btnWorkClose").addEventListener("click", ()=>showModal("workEditModal", false));
      $("btnWorkCancel").addEventListener("click", ()=>showModal("workEditModal", false));
      $("btnWorkSave").addEventListener("click", saveEditWork);

      // admin
      $("btnAdmin").addEventListener("click", toggleAdminPanel);
      $("adminSearch").addEventListener("input", renderAdminUserCards);
      $("btnAddUser").addEventListener("click", adminAddUser);

      $("btnPrevWork").addEventListener("click", ()=>loadWorkPage(Math.max(0, workPage-1)));
      $("btnNextWork").addEventListener("click", ()=>loadWorkPage(workPage+1));
      $("btnDelAllWork").addEventListener("click", adminDeleteAllWork);
      $("btnDelAllContent").addEventListener("click", adminDeleteAllContent);
      $("btnResetTotals").addEventListener("click", adminResetTotals);

      // chat
      $("btnSendChat").addEventListener("click", sendChat);
      $("btnPostNotice").addEventListener("click", postNotice);

      // tabs
      document.querySelectorAll(".tab").forEach(t=>{
        t.addEventListener("click", ()=>setTab(t.dataset.tab));
      });

      // default tab
      setTab("dashboard");

      // esc close modals
      document.addEventListener("keydown",(e)=>{
        if(e.key==="Escape"){
          ["createModal","editModal","workEditModal","noticeModal"].forEach(id=>$(id).hidden=true);
          lockBody(false);
        }
      });
    });
  
/* =========================
   ğŸ”’ STABILITY PATCH LAYER
   (No feature removed)
========================= */

// Safe DOM getter
const $safe = (id)=>{
  try{
    const el=document.getElementById(id);
    return el||null;
  }catch(e){return null;}
};

// Safe timestamp to Date
function safeToDate(ts){
  try{
    if(!ts) return null;
    if(typeof ts.toDate==="function") return ts.toDate();
    if(ts instanceof Date) return ts;
    return null;
  }catch(e){return null;}
}

// Safe duration calc
function safeDuration(startTs){
  const d=safeToDate(startTs);
  if(!d) return 0;
  const now=new Date();
  return Math.max(0, Math.floor((now.getTime()-d.getTime())/1000));
}

// Safe array
function safeArray(arr){
  return Array.isArray(arr)?arr:[];
}

// Prevent duplicate event binding
(function(){
  if(window.__DOSE_BOUND__) return;
  window.__DOSE_BOUND__=true;
})();

// Firestore index error friendly message
function handleFirestoreError(e){
  if(!e) return;
  const msg=String(e.message||e);
  if(msg.includes("requires an index")){
    alert("Firestore ì¸ë±ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì½˜ì†”ì˜ ë§í¬ë¥¼ ëˆŒëŸ¬ ìƒì„±í•˜ì„¸ìš”.");
  }else{
    alert("ì˜¤ë¥˜ ë°œìƒ: "+msg);
  }
}

// Global async guard
window.addEventListener("unhandledrejection", (e)=>{
  console.error("Unhandled:",e.reason);
  handleFirestoreError(e.reason);
});
window.addEventListener("error", (e)=>{
  console.error("GlobalError:",e.message);
});


</script>
  <!-- BUILD_STAMP 2026-02-20 04:12:27 -->
</head>

<body>
  <div class="wrap">
    <div id="loginView" class="card" style="max-width: 520px; margin: 80px auto 0;">
      <div class="row" style="align-items:flex-start;">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <div class="title">ë„ìŠ¤ì˜¨ë¼ì¸ êµ­ë°©ë¶€ ê·¼í‡´ì‹œìŠ¤í…œ</div>
            <div class="subtitle">ìˆ˜ë™ ê°±ì‹  Â· 7ì¼ ì œí•œ Â· 0ì‹œ í•„í„° Â· ìš”ì•½í•„ë“œ ê¸°ë°˜(ë¦¬ë“œ ìµœì†Œí™”)</div>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:14px;">
        <input id="loginId" class="w220" placeholder="ì•„ì´ë””(ë‹‰ë„¤ì„)" />
        <input id="loginPw" class="w220" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
        <button id="btnLogin" class="pill primary">ë¡œê·¸ì¸</button>
      </div>
      <div class="muted" style="margin-top:10px;">
        â€¢ ë¡œê·¸ì¸ ì‹œ 1íšŒ ë¡œë“œ í›„, <b>ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼</b>ì„ ëˆŒë €ì„ ë•Œë§Œ ë°ì´í„°ê°€ ê°±ì‹ ë©ë‹ˆë‹¤.<br>
        â€¢ ì‹¤ì‹œê°„(onSnapshot)ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </div>
    </div>

    <div id="appView" hidden>
      <div class="topbar">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <div class="title">ë„ìŠ¤ì˜¨ë¼ì¸ êµ­ë°©ë¶€ ê·¼í‡´ì‹œìŠ¤í…œ</div>
            <div class="subtitle">ìš´ì˜ ëŒ€ì‹œë³´ë“œ Â· ë¦¬ë“œ ìµœì†Œí™” ë²„ì „</div>
          </div>
        </div>
        <div class="right">
          <div id="who" class="row"></div>
          <button id="btnSummary" class="pill">ìš”ì•½ ê°±ì‹ </button>
          <button id="btnRefresh" class="pill">ìƒˆë¡œê³ ì¹¨</button>
          <button id="btnAdmin" class="pill primary" hidden>ê´€ë¦¬</button>
          <button id="btnLogout" class="pill danger">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <div class="row" style="margin: 6px 4px 14px;">
        <div class="tabs">
          <button class="tab active" data-tab="dashboard">ëŒ€ì‹œë³´ë“œ</button>
          <button class="tab" data-tab="content">ì»¨í…ì¸  ê¸°ë¡</button>
          <button class="tab" data-tab="chat">ë¶€ì„œ ì†Œí†µ</button>
          <button class="tab" data-tab="graph">ê·¸ë˜í”„</button>
          <button class="tab" data-tab="admin">ê´€ë¦¬ì</button>
        </div>
        <div class="spacer"></div>
        <span id="status" class="tinyStatus"></span>
      </div>

      <div class="grid">
        <!-- LEFT -->
        <div class="card" data-view="dashboard">
          <h3>ìš”ì•½</h3>
          <div class="kpis">
            <div id="kpiOnline" class="kpi"></div>
            <div id="kpiTodayIn" class="kpi"></div>
            <div id="kpiTodaySec" class="kpi"></div>
            <div id="kpiWeekSec" class="kpi"></div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div class="box" style="flex:1;">
              <div class="row">
                <b>ì¶œ / í‡´ê·¼</b>
                <span class="spacer"></span>
                <span class="tiny">â€» ì¶œ/í‡´ ë²„íŠ¼ì€ ìš”ì•½í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.</span>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="btnIn" class="pill primary">ì¶œê·¼</button>
                <button id="btnOut" class="pill">í‡´ê·¼</button>
              </div>
            </div>

            <div class="box" style="flex:1;">
              <div class="row">
                <b>ì»¨í…ì¸  ì‘ì„±</b>
                <span class="spacer"></span>
                <span class="tiny">â€» ì°¸ì—¬ìëŠ” ì²´í¬ë¡œ ì„ íƒí•©ë‹ˆë‹¤.</span>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="btnCreateSupply" class="pill primary">ë³´ê¸‰</button>
                <button id="btnCreatePlant" class="pill">ì†¡ì „ì†Œ</button>
                <button id="btnCreateEscort" class="pill">ì°¨ëŸ‰ìˆ˜í˜¸</button>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div class="box" style="flex:1;">
              <div class="row">
                <b>ìœ ì € ëª©ë¡</b>
                <span class="spacer"></span>
                <select id="sortUsers" class="w220">
                  <option value="onlineFirst">ì •ë ¬: ì ‘ì†ì ìš°ì„ </option>
                  <option value="rankHigh">ì •ë ¬: ê³„ê¸‰ ë†’ì€ìˆœ</option>
                  <option value="rankLow">ì •ë ¬: ê³„ê¸‰ ë‚®ì€ìˆœ</option>
                  <option value="onlineOnly">ì •ë ¬: ì˜¨ë¼ì¸ë§Œ</option>
                </select>
              </div>
              <div class="tableWrap" style="margin-top:10px;">
                <table>
                  <thead>
                    <tr>
                      <th>ë‹‰ë„¤ì„</th>
                      <th>ê³„ê¸‰</th>
                      <th>ë¶€ì„œ</th>
                      <th>ì ‘ì†</th>
                      <th>ë§ˆì§€ë§‰</th>
                      <th>ì£¼ê°„</th>
                      <th>ì˜¤ëŠ˜</th>
                      <th>ë³´ê¸‰</th>
                      <th>ì†¡ì „ì†Œ</th>
                      <th>ì°¨ëŸ‰</th>
                    </tr>
                  </thead>
                  <tbody id="userTbody"></tbody>
                </table>
              </div>
              
              <div class="row" style="margin-top:10px;">
                <button id="userPrev" class="pill">ì´ì „</button>
                <button id="userNext" class="pill">ë‹¤ìŒ</button>
                <span class="chip" id="userPageInfo">1 / 1</span>
                <span class="tinyStatus" id="userCooldown"></span>
              </div>

              <div class="tiny" style="margin-top:10px;">
                â€¢ ì¼ë°˜ ìœ ì €ëŠ” ìˆ¨ê¹€ ìœ ì €ê°€ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. â€¢ ì •ë ¬ì€ ìƒˆë¡œê³ ì¹¨ ì‹œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
              </div>
            </div>
          </div>
        </div>

        

        <!-- ADMIN SIDE -->
        <div id="adminBackdrop" class="adminBackdrop" hidden></div>
        <div id="adminCol" class="card adminCol" data-view="adminpanel" hidden aria-hidden="true">
          <div class="row">
            <h3 style="margin:0;">ê´€ë¦¬ì íŒ¨ë„</h3>
            <span class="spacer"></span>
            <span class="badge role">ê´€ë¦¬ì ì „ìš©</span>
            <button id="btnAdminClose" class="pill">ë‹«ê¸°</button>
          </div>

          <div class="two" style="margin-top:12px;">
            <div class="box">
              <b>ìœ ì € ì¶”ê°€(í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)</b>
              <div class="row" style="margin-top:10px;">
                <input id="addNick" class="w220" placeholder="ë‹‰ë„¤ì„" />
                <input id="addPw" class="w220" placeholder="ë¹„ë°€ë²ˆí˜¸" />
                <button id="btnAddUser" class="pill primary">ì¶”ê°€</button>
              </div>
              <div class="row" style="margin-top:10px;">
                <input id="adminSearch" class="w320" placeholder="ìœ ì € ê²€ìƒ‰" />
                <span class="spacer"></span>
                <select id="adminSort" class="w220"></select>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="adminPrev" class="pill">ì´ì „</button>
                <button id="adminNext" class="pill">ë‹¤ìŒ</button>
                <span id="adminPageInfo" class="tinyStatus"></span>
              </div>
              <div id="adminUserCards"></div>
            </div>

            <div class="box">
              <div class="row">
                <b>ê·¼ë¬´ ê¸°ë¡ ê´€ë¦¬(ìµœê·¼ 7ì¼)</b>
                <span class="spacer"></span>
                <button id="btnDelAllWork" class="pill danger">ê·¼ë¬´ ê¸°ë¡ ì „ì²´ì‚­ì œ</button>
              </div>
              <div class="row" style="margin-top:10px;">
                <button id="btnPrevWork" class="pill">ì´ì „</button>
                <button id="btnNextWork" class="pill">ë‹¤ìŒ</button>
                <span id="workPageInfo" class="tinyStatus"></span>
              </div>
              <div class="tableWrap" style="margin-top:10px;">
                <table>
                  <thead>
                    <tr>
                      <th>ë‹‰ë„¤ì„</th>
                      <th>ì¶œê·¼</th>
                      <th>í‡´ê·¼</th>
                      <th>ì‹œê°„</th>
                      <th>ìƒíƒœ</th>
                      <th>ì¡°ì¹˜</th>
                    </tr>
                  </thead>
                  <tbody id="workTbody"></tbody>
                </table>
              </div>

              <div class="row" style="margin-top:10px;">
                <button id="btnResetTotals" class="pill danger">ì´ ì ‘ì†ì‹œê°„ ì´ˆê¸°í™”</button>
                <button id="btnDelAllContent" class="pill danger">ì»¨í…ì¸  ê¸°ë¡(ìµœê·¼ 7ì¼) ì „ì²´ì‚­ì œ</button>
              </div>

              <div class="muted" style="margin-top:10px;">
                â€¢ â€œì „ì²´ ì‚­ì œâ€ëŠ” ë¦¬ë“œ ìµœì†Œí™”ë¥¼ ìœ„í•´ ìµœê·¼ 7ì¼ë§Œ ëŒ€ìƒìœ¼ë¡œ í•©ë‹ˆë‹¤.<br>
                â€¢ ê°•ì œì¶œê·¼/ê°•ì œí‡´ê·¼ì€ users ìš”ì•½í•„ë“œì™€ workRecordsë¥¼ í•¨ê»˜ ê°±ì‹ í•©ë‹ˆë‹¤.
              </div>
            </div>
          </div>
        </div>

      </div><!-- grid -->
    </div><!-- appView -->
  </div><!-- wrap -->

  <!-- Create Modal -->
  <div id="createModal" class="overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mTop">
        <div class="mTitle" id="cTitle">ì»¨í…ì¸  ì‘ì„±</div>
        <span class="spacer"></span>
        <button id="btnCreateClose" class="pill">ë‹«ê¸°</button>
      </div>
      <div class="mBody">
        <div class="two">
          <div class="box">
            <div class="row">
              <b>ìœ ì € ëª©ë¡</b>
              <span class="spacer"></span>
              <span class="badge dim">ì„ íƒ <b id="cCount">0ëª…</b></span>
            </div>
            <div class="row" style="margin-top:10px;">
              <input id="cSearch" class="w320" placeholder="ê²€ìƒ‰" />
              <button id="btnCreateAll" class="pill">ì „ì²´</button>
              <button id="btnCreateClear" class="pill">í•´ì œ</button>
            </div>
            <div class="row" style="margin-top:10px;">
              <input id="cOcrFile" type="file" accept="image/*" class="w320" />
              <button id="btnOcr" class="pill">ìŠ¤í¬ë¦°ìƒ· ì¸ì‹</button>
              <span class="tiny" id="cOcrHint">TAB ìŠ¤í¬ë¦°ìƒ·ì„ ì˜¬ë¦¬ë©´ ë“±ë¡ëœ ë‹‰ë„¤ì„ì„ ìë™ ì„ íƒí•©ë‹ˆë‹¤.</span>
            </div>
            <div class="tiny" id="cOcrResult" style="margin-top:8px;"></div>

            <div id="cUserList" class="list"></div>
          </div>
          <div class="box">
            <b>ì„ íƒëœ ì°¸ì—¬ì</b>
            <div id="cSelected" style="margin-top:10px;"></div>
            <div id="cOutcomeBox" class="box" style="margin-top:12px;">
              <div class="row">
                <b>ì„±ê³µ ì—¬ë¶€</b>
                <span class="spacer"></span>
                <span class="tiny">ë³´ê¸‰/ì°¨ëŸ‰ìˆ˜í˜¸ë§Œ</span>
              </div>
              <div class="row" style="margin-top:10px;">
                <select id="cOutcome" class="w220">
                  <option value="-">-</option>
                  <option value="O">O (ì„±ê³µ)</option>
                  <option value="X">X (ì‹¤íŒ¨)</option>
                </select>
              </div>
            </div>
            <div class="tiny" style="margin-top:10px;">â€¢ ì‘ì„±ìëŠ” ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤. â€¢ 0ëª…ì€ ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>
      <div class="mFoot">
        <button id="btnCreateCancel" class="pill">ì·¨ì†Œ</button>
        <button id="btnCreateSave" class="pill primary">ì‘ì„±</button>
      </div>
    </div>
  </div>

  

<!-- CONTENT VIEW -->
        <div class="card" data-view="content" hidden style="grid-column:1/-1;">
          <div class="row">
            <h3 style="margin:0;">ì»¨í…ì¸  ê¸°ë¡ (ìµœê·¼ 7ì¼)</h3>
            <span class="spacer"></span>
            <select id="contentFilter" class="w220">
              <option value="ALL">ì „ì²´ ë³´ê¸°</option>
              <option value="ë³´ê¸‰">ë³´ê¸‰ë§Œ ë³´ê¸°</option>
              <option value="ì†¡ì „ì†Œ">ì†¡ì „ì†Œë§Œ ë³´ê¸°</option>
              <option value="ì°¨ëŸ‰ìˆ˜í˜¸">ì°¨ëŸ‰ìˆ˜í˜¸ë§Œ ë³´ê¸°</option>
            </select>
          </div>
          <div class="row" style="margin-top:10px;">
            <button id="btnPrevContent" class="pill">ì´ì „</button>
            <button id="btnNextContent" class="pill">ë‹¤ìŒ</button>
            <span id="contentPageInfo" class="tinyStatus"></span>
          </div>
          <div id="contentList" class="timeline" style="margin-top:12px;"></div>
        </div>

        <!-- CHAT VIEW -->
        <div class="card" data-view="chat" hidden style="grid-column:1/-1;">
          <div class="row">
            <h3 style="margin:0;">ë¶€ì„œ ì†Œí†µë°©</h3>
            <span class="spacer"></span>
            <span class="badge dim">ë¶€ì„œ: <b id="chatDept">-</b></span>
          </div>
          <div class="row" style="margin-top:12px; align-items:flex-start;">
            <div style="flex:1;">
              <div class="box">
                <b>ê³µì§€</b>
                <div id="noticeBox" style="margin-top:10px;"></div>
                <div id="noticeCompose" hidden style="margin-top:10px;">
                  <textarea id="noticeText" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•©ë‹ˆë‹¤."></textarea>
                  <div class="row" style="margin-top:10px;">
                    <button id="btnPostNotice" class="pill primary">ê³µì§€ ë“±ë¡</button>
                  </div>
                </div>
              </div>
            </div>
            <div style="flex:1;">
              <div class="box">
                <b>ì±„íŒ…</b>
                <div id="chatList" class="timeline" style="margin-top:10px;"></div>
                <div class="row" style="margin-top:10px;">
                  <input id="chatText" class="w320" placeholder="ë©”ì‹œì§€ ì…ë ¥" />
                  <button id="btnSendChat" class="pill primary">ì „ì†¡</button>
                  <span id="chatInfo" class="tinyStatus"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="tiny" style="margin-top:10px;">
            â€¢ ì±„íŒ…/ê³µì§€ëŠ” ì´ íƒ­ì„ ì—´ì—ˆì„ ë•Œë§Œ ì½ìŠµë‹ˆë‹¤(ìˆ˜ë™ ê°±ì‹ ). â€¢ ë¶€ì„œì¥/ê´€ë¦¬ìë§Œ ê³µì§€ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>
        </div>

        <!-- GRAPH VIEW -->
        <div class="card" data-view="graph" hidden style="grid-column:1/-1;">
          <div class="row">
            <h3 style="margin:0;">ê·¸ë˜í”„</h3>
            <span class="spacer"></span>
            <span class="tiny">users ìš”ì•½í•„ë“œ ê¸°ë°˜ (workRecords ìŠ¤ìº” ì—†ìŒ)</span>
          </div>
          <div class="box" style="margin-top:12px;">
            <canvas id="chart" height="120"></canvas>
          </div>
        </div>

        <!-- ADMIN VIEW -->
        <!-- Edit Modal -->
  <div id="editModal" class="overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mTop">
        <div class="mTitle" id="eTitle">ì»¨í…ì¸  ìˆ˜ì •</div>
        <span class="spacer"></span>
        <button id="btnEditClose" class="pill">ë‹«ê¸°</button>
      </div>
      <div class="mBody">
        <div class="two">
          <div class="box">
            <div class="row">
              <b>ìœ ì € ëª©ë¡</b>
              <span class="spacer"></span>
              <span class="badge dim">ì„ íƒ <b id="eCount">0ëª…</b></span>
            </div>
            <div class="row" style="margin-top:10px;">
              <input id="eSearch" class="w320" placeholder="ê²€ìƒ‰" />
              <button id="btnEditAll" class="pill">ì „ì²´</button>
              <button id="btnEditClear" class="pill">í•´ì œ</button>
            </div>
            <div id="eUserList" class="list"></div>
          </div>
          <div class="box">
            <b>ì„ íƒëœ ì°¸ì—¬ì</b>
            <div id="eSelected" style="margin-top:10px;"></div>
            <div id="eOutcomeBox" class="box" style="margin-top:12px;">
              <div class="row">
                <b>ì„±ê³µ ì—¬ë¶€</b>
                <span class="spacer"></span>
                <span class="tiny">ë³´ê¸‰/ì°¨ëŸ‰ìˆ˜í˜¸ë§Œ</span>
              </div>
              <div class="row" style="margin-top:10px;">
                <select id="eOutcome" class="w220">
                  <option value="-">-</option>
                  <option value="O">O (ì„±ê³µ)</option>
                  <option value="X">X (ì‹¤íŒ¨)</option>
                </select>
              </div>
            </div>
            <div class="tiny" style="margin-top:10px;">â€¢ ì‘ì„±ì/ê´€ë¦¬ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>
      <div class="mFoot">
        <button id="btnEditCancel" class="pill">ì·¨ì†Œ</button>
        <button id="btnEditSave" class="pill primary">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- Work Edit Modal -->
  <div id="workEditModal" class="overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mTop">
        <div class="mTitle">ê·¼ë¬´ ê¸°ë¡ ìˆ˜ì •</div>
        <span class="spacer"></span>
        <button id="btnWorkClose" class="pill">ë‹«ê¸°</button>
      </div>
      <div class="mBody">
        <div class="box">
          <div class="row">
            <input id="wNick" class="w220" placeholder="ë‹‰ë„¤ì„" />
            <input id="wIn" class="w220" type="datetime-local" />
            <input id="wOut" class="w220" type="datetime-local" />
          </div>
          <div class="tiny" style="margin-top:10px;">â€¢ ì¶œê·¼ì€ í•„ìˆ˜, í‡´ê·¼ì€ ë¹„ì›Œë‘ë©´ OPEN ìƒíƒœë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
        </div>
      </div>
      <div class="mFoot">
        <button id="btnWorkCancel" class="pill">ì·¨ì†Œ</button>
        <button id="btnWorkSave" class="pill primary">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- Notice Modal -->
  <div id="noticeModal" class="overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mTop">
        <div class="mTitle">ë¶€ì„œ ê³µì§€</div>
        <span class="spacer"></span>
        <button class="pill" onclick="document.getElementById('noticeModal').hidden=true; document.body.classList.remove('noscroll');">ë‹«ê¸°</button>
      </div>
      <div class="mBody">
        <div class="box">
          <div class="row">
            <span class="badge dim">ë¶€ì„œ <b id="nDept">-</b></span>
            <span class="badge">ì‘ì„± <b id="nBy">-</b></span>
            <span class="badge dim" id="nAt">-</span>
          </div>
          <div class="p" style="margin-top:10px;" id="nText"></div>
        </div>
      </div>
      <div class="mFoot">
        <button id="btnNoticeOk" class="pill primary">í™•ì¸</button>
      </div>
    </div>
  </div>

  <div id="toastWrap" class="toastWrap"></div>

  <!-- ì‚¬ìš©ì ìƒì„¸ ëª¨ë‹¬ -->
  <div id="backdrop" class="backdrop"></div>
  <div id="userModal" class="modal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHead">
        <h3 id="userModalTitle">ìœ ì € ìƒì„¸</h3>
        <button class="btn small" id="userModalClose">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div id="userModalBody" class="list"></div>
      </div>
    </div>
  </div>

  <!-- ìš°í´ë¦­ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´(ê´€ë¦¬ì ì „ìš©) -->
  <div id="ctxMenu" class="ctxMenu hidden"></div>

  <!-- í”„ë¡œí•„ ëª¨ë‹¬ -->
  <div id="profileModal" class="modalBack hidden" role="dialog" aria-modal="true">
    <div class="modalCard wide">
      <div class="modalHead">
        <div class="modalTitle">ìœ ì € í”„ë¡œí•„</div>
        <button class="pill" id="btnProfileClose">ë‹«ê¸°</button>
      </div>
      <div id="profileBody" class="modalBody"></div>
    </div>
  </div>

</body>
</html>

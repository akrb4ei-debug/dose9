<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>도스온라인 국방부 근퇴시스템</title>

<!-- TAB 스샷 OCR: 필요할 때만 사용 (브라우저에서 돌아가며 서버 필요 없음) -->
<script defer src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
  :root{
    --bg:#0b0f14; --panel:#161b22; --panel2:#0d1117; --border:#30363d; --text:#e6edf3;
    --muted:#9aa4b2; --btn:#21262d; --btnH:#30363d; --brand:#1f6feb;
    --good:#2ea043; --bad:#f85149; --warn:#d29922;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 20% -10%, rgba(31,111,235,.18), transparent 55%), radial-gradient(900px 700px at 90% 10%, rgba(46,160,67,.10), transparent 55%), var(--bg);color:var(--text);font-family:Segoe UI,system-ui,-apple-system,sans-serif;}
  .topbar{position:sticky;top:0;z-index:10;background:rgba(22,27,34,.92);backdrop-filter: blur(8px);
    padding:14px 22px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);}
  .brand{font-weight:800;letter-spacing:.2px}
  .pill{display:inline-flex;gap:10px;align-items:center;color:var(--muted);font-size:13px;flex-wrap:wrap}
  .pill b{color:var(--text)}
  .wrap{max-width:1860px;margin:0 auto;padding:22px}
  .grid{display:grid;grid-template-columns: 1fr 1fr; gap:18px}
  @media (max-width:1150px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
  .card h2{margin:0 0 10px 0;font-size:16px;border-bottom:1px solid var(--border);padding-bottom:10px;display:flex;align-items:center;gap:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .right{margin-left:auto}
  button{background:var(--btn);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
  button:hover{background:var(--btnH)}
  button.primary{background:var(--brand);border-color:var(--brand)}
  button.primary:hover{filter:brightness(1.05)}
  button.danger{background:#8b1e1e;border-color:#a93737}
  button.danger:hover{filter:brightness(1.07)}
  button.ghost{background:transparent}
  input,select,textarea{background:var(--panel2);border:1px solid var(--border);color:var(--text);
    padding:8px 10px;border-radius:10px;outline:none}
  textarea{min-height:70px;resize:vertical;width:100%}
  .hidden{display:none !important}
  .muted{color:var(--muted);font-size:13px}
  .mini{color:var(--muted);font-size:12px}
  .sep{height:1px;background:var(--border);margin:10px 0}
  .toast{font-size:12px;color:var(--muted);margin-left:6px}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px}
  .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.on{background:var(--good)} .dot.off{background:var(--bad)}
  .dot.warn{background:var(--warn)}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--panel2);font-size:12px}
  .chip u{ text-underline-offset:2px }
  .chip s{ opacity:.8 }
  .two{display:grid;grid-template-columns: 1.2fr .8fr; gap:12px}
  @media (max-width:900px){ .two{grid-template-columns:1fr} }
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:transparent;color:var(--muted);cursor:pointer}
  .tab.active{background:rgba(31,111,235,.18);border-color:rgba(31,111,235,.45);color:var(--text)}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size:12px;padding:2px 6px;border:1px solid var(--border);border-radius:6px;background:rgba(0,0,0,.2)}
  canvas{background:transparent;border:1px solid var(--border);border-radius:12px}
  .pager{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .pagebtn{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer}
  .pagebtn.active{background:rgba(31,111,235,.18);border-color:rgba(31,111,235,.45);color:var(--text)}
  .warnbox{border:1px dashed rgba(210,153,34,.6);background:rgba(210,153,34,.06);border-radius:12px;padding:10px}
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
    query, where, orderBy, limit, startAfter, serverTimestamp, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ✅ 사용자 설정 반영
  const firebaseConfig = {
    apiKey: "AIzaSyAJ6MhR1JsGbvieb8akAi4Zpas_W3uaNJ4",
    authDomain: "dosep-b6ee3.firebaseapp.com",
    projectId: "dosep-b6ee3",
    storageBucket: "dosep-b6ee3.firebasestorage.app",
    messagingSenderId: "100096560571",
    appId: "1:100096560571:web:7eb2c1255835b6b57c889e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const colUsers = collection(db, "users");
  const colWork = collection(db, "workRecords");
  const colContent = collection(db, "contentRecords");
  const colAnnouncements = collection(db, "announcements");

  // ===== State =====
  let currentUser = null;
  let currentUserData = null;
  let usersCache = new Map();

  let onlineTimer = null;
  let statsTimer = null;

  // chat
  let chatUnsub = null;
  let chatDept = null;

  // content paging/filter (numbered paging)
  let contentFilter = "ALL"; // ALL | 보급 | 송전소 | 차량수호
  const CONTENT_PAGE = 20;
  let contentCursors = [null]; // page 0 cursor = null
  let contentPage = 0;
  let contentHasMore = true;

  // admin content paging (separate)
  let adminContentCursors = [null];
  let adminContentPage = 0;
  let adminContentHasMore = true;

  // summary cache (최근7일)
  let contentSummaryCache = null; // { byUser, lastByUser, lastByType, counts, writerCounts }

  const rankOrder = ["군의관","하사","중사","상사","원사","소위","중위","대위","소령","중령","대령"];
  const deptList = [
    "참모부","국군 경비사령부","국군 특수전사령부","국군 방첩사령부","제 1경비단","군사경찰단",
    "제1공수특수전여단","제3공수특전여단","제820방첩부대","국군의무사령부"
  ];

  // ===== Utils =====
  const $ = (id)=>document.getElementById(id);
  function isAdmin(){ return !!currentUserData?.isAdmin; }
  function isDeptLeader(){ return !!currentUserData?.isDeptLeader; }

  function setToast(msg){
    $("toast").textContent = msg || "";
    if(msg) setTimeout(()=>{ if($("toast").textContent===msg) $("toast").textContent=""; }, 3500);
  }
  function describeFsError(e){
    const code = e?.code ? String(e.code) : "";
    const msg = e?.message ? String(e.message) : String(e||"");
    if(code.includes("permission-denied") || msg.includes("permission-denied")){
      return "Firestore 권한이 거부되었습니다. (Rules 확인 필요)";
    }
    if(code.includes("resource-exhausted") || msg.includes("resource-exhausted") || msg.toLowerCase().includes("quota")){
      return "Firestore 할당량(읽기/쓰기) 한도를 초과했습니다. (오늘 0시 이후 복구되거나 Blaze 업그레이드 필요)";
    }
    if(code.includes("failed-precondition") || msg.includes("failed-precondition")){
      return "필요한 Firestore 인덱스가 없습니다. (콘솔 에러에 뜨는 index 링크를 눌러 생성 필요)";
    }
    if(code.includes("unavailable") || msg.includes("unavailable")){
      return "네트워크/Firestore가 일시적으로 불안정합니다. 잠시 후 재시도해 주세요.";
    }
    return "알 수 없는 오류가 발생했습니다. (F12 콘솔 확인 필요)";
  }

  async function safe(label, fn){
    try{
      return await fn();
    }catch(e){
      console.error("[ERROR]", label, e);
      alert(`${label} 중 오류가 발생했습니다.\n\n${describeFsError(e)}\n\n자세한 내용은 F12 콘솔을 확인해 주세요.`);
      throw e;
    }
  }


  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function toLocale(tsSeconds){
    return tsSeconds ? new Date(tsSeconds*1000).toLocaleString() : "-";
  }

  function nowSec(){ return Math.floor(Date.now()/1000); }

  function startOfTodaySec(){
    const d = new Date();
    d.setHours(0,0,0,0);
    return Math.floor(d.getTime()/1000);
  }

  // ===== Users =====
  async function loadUsers(){
    const snap = await getDocs(colUsers);
    const m = new Map();
    snap.forEach(d=>m.set(d.id, d.data()));
    usersCache = m;
    renderDeptSelects();
    renderAdminWorkUserSelect();
  }

  function renderTop(){
    $("me").innerHTML = `<b>${escapeHtml(currentUser)}</b> · ${escapeHtml(currentUserData?.rank||"-")} · 관리자 ${isAdmin()?"O":"X"} · 부서 ${escapeHtml(currentUserData?.department||"-")} · 부서장 ${isDeptLeader()?"O":"X"}`;

    // ✅ 일부 섹션은 버전에 따라 존재하지 않을 수 있으므로 null 체크 후 처리합니다.
    const toggle = (id, show) => {
      const el = $(id);
      if(!el) return;
      el.classList.toggle("hidden", !show);
    };

    toggle("adminBlock", isAdmin());
    toggle("adminQuick", isAdmin());
    toggle("adminWorkBlock", isAdmin());
    toggle("adminContentBlock", isAdmin()); // (없어도 무시됩니다)
    toggle("adminPwdBlock", isAdmin());
  }

  // ===== Login =====
  async function login(){
    const id = $("loginId").value.trim();
    const pw = $("loginPw").value;

    if(!id) return alert("아이디(닉네임)를 입력해 주세요.");
    if(!pw) return alert("비밀번호를 입력해 주세요.");

    try{
      const snap = await getDoc(doc(db,"users",id));
      if(!snap.exists()) return alert("등록되지 않은 유저입니다.");
      const data = snap.data();

      // ✅ 비밀번호는 Firestore에 문자열/숫자로 저장될 수 있으므로 문자열로 통일해 비교합니다.
      if(String(data.password ?? "") !== String(pw)) return alert("비밀번호가 올바르지 않습니다.");

      currentUser = id;
    currentUserData = data;

    await loadUsers();
    renderTop();

    $("loginBox").classList.add("hidden");
    $("appBox").classList.remove("hidden");

    startOnlinePolling();
    startStatsAutoRefresh();

    await refreshAll(); // ✅ 로그인 1회 풀로드
    openChatSmart();    // ✅ 내 부서 채팅 자동 오픈
    await checkNoticeOnLoginOnce();
    }catch(e){
      console.error(e);
      const msg = (e && e.code) ? String(e.code) : String(e);
      if(msg.includes("permission-denied")){
        alert(`로그인에 실패했습니다. (Firestore 권한 거부)

Firebase 콘솔 → Firestore Database → 규칙(Rules)에서
읽기/쓰기가 허용되어 있는지 확인해 주세요.

테스트 단계에서는 임시로 allow read, write: if true; 로 설정할 수 있습니다.`);
      }else if(msg.includes("unavailable")){
        alert(`로그인에 실패했습니다. (네트워크/Firestore 일시 장애)
잠시 후 다시 시도해 주세요.`);
      }else{
        alert(`로그인에 실패했습니다.
콘솔(F12) 에러를 확인해 주세요.`);
      }
      return;
    }
  }
  window.login = login;

  // ===== Refresh =====
  async function refreshAll(){
    // ✅ 일부 로드가 실패해도 나머지는 계속 진행되도록 개별 try/catch로 실행합니다.
    const tasks = [
      ["유저 통계 갱신", async()=>{ await loadStatsOnce(); }],
      ["접속 목록 갱신", async()=>{ await loadOnlineOnce(); }],
      ["컨텐츠 요약 갱신", async()=>{ await refreshContentSummary(); }],
      ["컨텐츠 목록 갱신", async()=>{ await resetContentPagingAndLoad(); }],
    ];

    for(const [label, fn] of tasks){
      try{ await fn(); }
      catch(e){ console.error("refreshAll partial fail:", label, e); }
    }

    if(isAdmin()){
      try{ await resetAdminContentPagingAndLoad(); }catch(e){ console.error("admin content refresh fail", e); }
    }

    try{ renderMyInfo(); }catch(e){ console.error(e); }
    try{ renderUserDirectory(); }catch(e){ console.error(e); }

    setToast("갱신 되었습니다.");
  }
  window.refreshAll = refreshAll;

  // ===== Work =====
  async function checkIn(){
    const q = query(colWork, where("nickname","==",currentUser), where("checkOut","==",null));
    const snap = await getDocs(q);
    if(!snap.empty) return alert("이미 출근 중입니다.");
    await addDoc(colWork, { nickname: currentUser, checkIn: serverTimestamp(), checkOut: null });
    await refreshAll();
  }
  window.checkIn = checkIn;

  async function checkOut(){
    const q = query(colWork, where("nickname","==",currentUser), where("checkOut","==",null));
    const snap = await getDocs(q);
    if(snap.empty) return alert("출근하지 않았습니다.");
    await updateDoc(doc(db,"workRecords", snap.docs[0].id), { checkOut: serverTimestamp() });
    await refreshAll();
  }
  window.checkOut = checkOut;

  async function forceCheckOut(nickname){
    if(!isAdmin()) return;
    const q = query(colWork, where("nickname","==",nickname), where("checkOut","==",null));
    const snap = await getDocs(q);
    for(const d of snap.docs){
      await updateDoc(doc(db,"workRecords", d.id), { checkOut: serverTimestamp() });
    }
    await refreshAll();
  }
  window.forceCheckOut = forceCheckOut;

  async function confirmResetTotalTime(nickname){
    if(!isAdmin()) return;
    const ok = confirm("정말로 총 출근시간을 초기화하시겠습니까? (되돌릴 수 없습니다)");
    if(!ok) return;
    const q = query(colWork, where("nickname","==",nickname));
    const snap = await getDocs(q);
    for(const d of snap.docs){
      await deleteDoc(doc(db,"workRecords", d.id));
    }
    await refreshAll();
  }
  window.confirmResetTotalTime = confirmResetTotalTime;

  // ✅ 근태 기록 관리 (관리자): 유저 선택 → 최근 기록 조회/수정/삭제
  async function adminLoadWorkRecords(){
    if(!isAdmin()) return;
    const who = $("adminWorkUser").value;
    if(!who) return;

    const snap = await getDocs(query(colWork, where("nickname","==",who), orderBy("checkIn","desc"), limit(50)));
    let html = "";
    snap.forEach(d=>{
      const r = d.data();
      const inS = r.checkIn?.seconds || null;
      const outS = r.checkOut?.seconds || null;
      html += `<div class="item">
        <div class="row">
          <b>${escapeHtml(who)}</b>
          <span class="mini">ID: ${d.id}</span>
          <div class="right">
            <button class="danger" onclick="adminDeleteWorkRecord('${d.id}')">삭제</button>
          </div>
        </div>
        <div class="row">
          <label class="mini">출근</label>
          <input id="wi_${d.id}" type="datetime-local" value="${secToLocalInput(inS)}" />
          <label class="mini">퇴근</label>
          <input id="wo_${d.id}" type="datetime-local" value="${secToLocalInput(outS)}" />
          <button class="primary" onclick="adminUpdateWorkRecord('${d.id}')">수정</button>
        </div>
        <div class="mini muted">※ 퇴근이 비어있으면 '출근 중' 상태가 됩니다.</div>
      </div>`;
    });

    $("adminWorkList").innerHTML = html || `<div class="muted">기록이 없습니다.</div>`;
  }
  window.adminLoadWorkRecords = adminLoadWorkRecords;

  function secToLocalInput(sec){
    if(!sec) return "";
    const d = new Date(sec*1000);
    const pad = (n)=>String(n).padStart(2,"0");
    const yyyy = d.getFullYear();
    const mm = pad(d.getMonth()+1);
    const dd = pad(d.getDate());
    const hh = pad(d.getHours());
    const mi = pad(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }
  function localInputToSec(v){
    if(!v) return null;
    const d = new Date(v);
    return Math.floor(d.getTime()/1000);
  }

  async function adminUpdateWorkRecord(docId){
    if(!isAdmin()) return;
    const inV = $("wi_"+docId).value;
    const outV = $("wo_"+docId).value;

    const inSec = localInputToSec(inV);
    const outSec = localInputToSec(outV);

    if(!inSec) return alert("출근 시간이 필요합니다.");
    if(outSec && outSec < inSec) return alert("퇴근 시간은 출근 시간보다 빠를 수 없습니다.");

    // Firestore Timestamp로 저장하려면 serverTimestamp가 아니라 Timestamp 필요하지만,
    // 여기서는 '초'로 저장하는 별도 필드 없이 기존 Timestamp를 유지해야 합니다.
    // ✅ 해결: Date → JS Date를 그대로 넣으면 Firestore가 Timestamp로 변환합니다.
    const payload = {
      checkIn: new Date(inSec*1000),
      checkOut: outSec ? new Date(outSec*1000) : null
    };
    await updateDoc(doc(db,"workRecords",docId), payload);
    await refreshAll();
    await adminLoadWorkRecords();
  }
  window.adminUpdateWorkRecord = adminUpdateWorkRecord;

  async function adminDeleteWorkRecord(docId){
    if(!isAdmin()) return;
    const ok = confirm("이 근태 기록을 삭제하시겠습니까?");
    if(!ok) return;
    await deleteDoc(doc(db,"workRecords",docId));
    await refreshAll();
    await adminLoadWorkRecords();
  }
  window.adminDeleteWorkRecord = adminDeleteWorkRecord;

  async function adminDeleteAllWorkOfUser(){
    if(!isAdmin()) return;
    const who = $("adminWorkUser").value;
    if(!who) return;
    const ok = confirm(`${who}의 근태 기록을 전부 삭제하시겠습니까?`);
    if(!ok) return;
    const snap = await getDocs(query(colWork, where("nickname","==",who)));
    for(const d of snap.docs){
      await deleteDoc(doc(db,"workRecords", d.id));
    }
    await refreshAll();
    await adminLoadWorkRecords();
  }
  window.adminDeleteAllWorkOfUser = adminDeleteAllWorkOfUser;

  // ===== Online polling (60s) =====
  async function loadOnlineOnce(){
    const snap = await getDocs(query(colWork, where("checkOut","==",null)));
    const online = [];
    snap.forEach(d=>{
      const n = d.data().nickname;
      const u = usersCache.get(n);
      if(!u) return;
      if(!isAdmin() && u.isHidden) return;
      online.push(n);
    });
    $("onlineList").textContent = online.length ? online.join(", ") : "없음";
  }

  function startOnlinePolling(){
    if(onlineTimer) return;
    loadOnlineOnce();
    onlineTimer = setInterval(loadOnlineOnce, 60000);
  }

  // ===== Stats =====
  // ✅ 이번주(최근7일) 집계 포함: last7Sec / sessions7
  async function loadStatsOnce(){
    const snap = await getDocs(colWork);

    const map = new Map(); // nickname -> {totalSecAll, open, lastIn, lastOut, sec7, sessions7, avgInMin, avgOutMin, inCount, outCount}
    const sevenAgo = nowSec() - 7*24*3600;

    snap.forEach(d=>{
      const r = d.data();
      const n = r.nickname;
      if(!map.has(n)) map.set(n, { totalSecAll:0, open:false, lastIn:null, lastOut:null, sec7:0, sessions7:0,
                                   avgInMin:0, avgOutMin:0, inCount:0, outCount:0 });
      const s = map.get(n);
      const inSec = r.checkIn?.seconds || null;
      const outSec = r.checkOut?.seconds || null;

      if(inSec) s.lastIn = Math.max(s.lastIn||0, inSec);
      if(outSec) s.lastOut = Math.max(s.lastOut||0, outSec);

      if(inSec && outSec){
        const dur = outSec - inSec;
        s.totalSecAll += dur;

        // 최근7일: 체크인 또는 체크아웃이 7일 내에 걸치면 대략 포함
        // 정확한 교차 계산은 복잡하므로(가볍게) overlap 방식 적용
        const overlapStart = Math.max(inSec, sevenAgo);
        const overlapEnd = Math.min(outSec, nowSec());
        if(overlapEnd > overlapStart){
          s.sec7 += (overlapEnd - overlapStart);
          s.sessions7 += 1; // 간단 카운트
        }

        // 평균 출근/퇴근 시간(분 단위, time-of-day)
        const inD = new Date(inSec*1000);
        const outD = new Date(outSec*1000);
        s.avgInMin += (inD.getHours()*60 + inD.getMinutes()); s.inCount += 1;
        s.avgOutMin += (outD.getHours()*60 + outD.getMinutes()); s.outCount += 1;
      }else if(inSec && !outSec){
        s.open = true;
        // 출근중 기록이 최근7일에 걸치면 sec7 추정 포함
        const overlapStart = Math.max(inSec, sevenAgo);
        const overlapEnd = nowSec();
        if(overlapEnd > overlapStart){
          s.sec7 += (overlapEnd - overlapStart);
        }
        const inD = new Date(inSec*1000);
        s.avgInMin += (inD.getHours()*60 + inD.getMinutes()); s.inCount += 1;
      }
    });

    renderStats(map);
    renderAdminGraph(map);
    window.__workMap = map;
  }

  function startStatsAutoRefresh(){
    if(statsTimer) return;
    statsTimer = setInterval(async ()=>{
      await Promise.all([loadStatsOnce(), loadOnlineOnce(), refreshContentSummary()]);
      renderMyInfo();
      renderUserDirectory();
    }, 60000);
  }

  function renderStats(map){
    const sort = $("sortSelect").value;
    let users = Array.from(usersCache.entries()).filter(([name,u])=> isAdmin() ? true : !u.isHidden);

    if(sort==="rank_desc"){
      users.sort((a,b)=> (rankOrder.indexOf(b[1].rank||"하사") - rankOrder.indexOf(a[1].rank||"하사")));
    }else if(sort==="rank_asc"){
      users.sort((a,b)=> (rankOrder.indexOf(a[1].rank||"하사") - rankOrder.indexOf(b[1].rank||"하사")));
    }else if(sort==="online"){
      users.sort((a,b)=>{
        const ao = map.get(a[0])?.open ? 1 : 0;
        const bo = map.get(b[0])?.open ? 1 : 0;
        if(bo!==ao) return bo-ao;
        return (rankOrder.indexOf(b[1].rank||"하사") - rankOrder.indexOf(a[1].rank||"하사"));
      });
    }

    const sum = contentSummaryCache;

    let html = "";
    for(const [name,u] of users){
      const s = map.get(name) || { totalSecAll:0, open:false, lastIn:null, lastOut:null, sec7:0, sessions7:0, avgInMin:0, avgOutMin:0, inCount:0, outCount:0 };
      const dot = s.open ? "on" : "off";
      const totalAllH = Math.floor(s.totalSecAll/3600);
      const total7H = Math.floor((s.sec7||0)/3600);
      const lastIn = toLocale(s.lastIn);
      const lastOut = toLocale(s.lastOut);

      const c = sum?.byUser?.get(name) || { 보급:0, 송전소:0, 차량수호:0 };

      html += `<div class="item">
        <div class="row">
          <span class="tag"><span class="dot ${dot}"></span>접속 ${s.open?"O":"X"}</span>
          <div><b>${escapeHtml(name)}</b> <span class="mini">(${escapeHtml(u.rank||"-")} · ${escapeHtml(u.department||"-")})</span></div>
          <div class="right mini">최근7일 ${total7H}h · 누적 ${totalAllH}h</div>
        </div>
        <div class="mini">마지막 출근: ${lastIn} · 마지막 퇴근: ${lastOut}</div>
        <div class="mini">컨텐츠(7일): 송전소 ${c.송전소||0} · 보급 ${c.보급||0} · 차량수호 ${c.차량수호||0}</div>
        ${isAdmin()?`
          <div class="row" style="margin-top:8px">
            <button onclick="forceCheckOut('${escapeHtml(name)}')">강제 퇴근</button>
            <button onclick="openRankModal('${escapeHtml(name)}')">계급</button>
            <button onclick="toggleAdminRole('${escapeHtml(name)}')">${u.isAdmin?"관리자 해임":"관리자 임명"}</button>
            <button onclick="toggleHiddenUser('${escapeHtml(name)}')">${u.isHidden?"숨김 해제":"숨김"}</button>
            <button onclick="openDeptModal('${escapeHtml(name)}')">부서/부서장</button>
            <button onclick="openPasswordModal('${escapeHtml(name)}')">비밀번호</button>
            <button class="danger" onclick="confirmResetTotalTime('${escapeHtml(name)}')">총시간 초기화</button>
          </div>
        `:""}
      </div>`;
    }

    $("statsList").innerHTML = html || `<div class="muted">표시할 유저가 없습니다.</div>`;
  }

  // ===== User Directory (일반 유저 전용 유저목록 업그레이드) =====
  function renderUserDirectory(){
    const map = window.__workMap || new Map();
    const sum = contentSummaryCache;
    const users = Array.from(usersCache.entries()).filter(([name,u])=> isAdmin()?true:!u.isHidden);

    let html = "";
    for(const [name,u] of users){
      const s = map.get(name) || { open:false };
      const dot = s.open ? "on" : "off";
      const lastContent = sum?.lastByUser?.get(name) || null;

      html += `<div class="item">
        <div class="row">
          <span class="tag"><span class="dot ${dot}"></span>${s.open?"온라인":"오프라인"}</span>
          <div><b>${escapeHtml(name)}</b> <span class="mini">(${escapeHtml(u.rank||"-")} · ${escapeHtml(u.department||"-")})</span></div>
          <div class="right mini">마지막 컨텐츠: ${lastContent ? toLocale(lastContent) : "-"}</div>
        </div>
      </div>`;
    }
    $("userDirList").innerHTML = html || `<div class="muted">유저가 없습니다.</div>`;
  }

  // ===== My Info =====
  function renderMyInfo(){
    const map = window.__workMap || new Map();
    const s = map.get(currentUser) || { sec7:0 };
    const sum = contentSummaryCache;

    const my = sum?.byUser?.get(currentUser) || { 보급:0, 송전소:0, 차량수호:0 };
    const myLast = sum?.lastByType?.get(currentUser) || { 보급:null, 송전소:null, 차량수호:null };

    $("myWorkWeek").textContent = `${Math.floor((s.sec7||0)/3600)}h`;
    $("mySupply").innerHTML = `${my.보급||0} <span class="mini">최근 참여: ${myLast.보급 ? toLocale(myLast.보급) : "-"}</span>`;
    $("myPower").innerHTML  = `${my.송전소||0} <span class="mini">최근 참여: ${myLast.송전소 ? toLocale(myLast.송전소) : "-"}</span>`;
    $("myEscort").innerHTML = `${my.차량수호||0} <span class="mini">최근 참여: ${myLast.차량수호 ? toLocale(myLast.차량수호) : "-"}</span>`;
  }

  // ===== Admin: whitelist/user mgmt =====
  async function addWhitelistUser(){
    if(!isAdmin()) return;
    const name = prompt("추가할 닉네임(=아이디)");
    if(!name) return;
    const pw = prompt("비밀번호");
    if(!pw) return;

    await setDoc(doc(db,"users",name),{
      password: pw,
      isAdmin: false,
      isHidden: false,
      rank: "하사",
      department: deptList[0],
      isDeptLeader: false,
      lastNoticeRead: {}
    }, { merge:true });

    await loadUsers();
    await refreshAll();
  }
  window.addWhitelistUser = addWhitelistUser;

  async function deleteWhitelistUser(){
    if(!isAdmin()) return;
    const name = prompt("삭제할 닉네임(=아이디)");
    if(!name) return;
    const ok = confirm(`${name} 유저를 삭제하시겠습니까? (되돌릴 수 없습니다)`);
    if(!ok) return;

    await deleteDoc(doc(db,"users",name));
    await loadUsers();
    await refreshAll();
  }
  window.deleteWhitelistUser = deleteWhitelistUser;

  async function toggleAdminRole(name){
    if(!isAdmin()) return;
    const u = usersCache.get(name);
    await updateDoc(doc(db,"users",name),{ isAdmin: !u?.isAdmin });
    await loadUsers();
    await refreshAll();
  }
  window.toggleAdminRole = toggleAdminRole;

  async function toggleHiddenUser(name){
    if(!isAdmin()) return;
    const u = usersCache.get(name);
    await updateDoc(doc(db,"users",name),{ isHidden: !u?.isHidden });
    await loadUsers();
    await refreshAll();
  }
  window.toggleHiddenUser = toggleHiddenUser;

  // ===== Password (관리자 확인/변경) =====
  function openPasswordModal(name){
    if(!isAdmin()) return;
    const u = usersCache.get(name) || {};
    $("modalTitle").textContent = `비밀번호 관리 · ${name}`;
    $("modalBody").innerHTML = `
      <div class="warnbox mini">
        ※ 이 화면은 보안을 약화시킵니다(관리자가 비밀번호를 확인할 수 있음). 요청하셔서 넣었지만, 실제 운영에서는 '변경만 가능'으로 쓰는 걸 권장합니다.
      </div>
      <div class="sep"></div>
      <div class="row">
        <label class="mini">현재 비밀번호</label>
        <input id="pwCurrent" type="password" value="${escapeHtml(u.password||"")}" />
        <button onclick="togglePwVisible()">표시/숨김</button>
      </div>
      <div class="sep"></div>
      <div class="row">
        <label class="mini">새 비밀번호</label>
        <input id="pwNew" placeholder="새 비밀번호" />
        <button class="primary" onclick="applyPassword('${escapeHtml(name)}')">변경</button>
      </div>
      <div class="mini muted">※ 변경 시 즉시 적용됩니다.</div>
    `;
    openModal();
  }
  window.openPasswordModal = openPasswordModal;

  function togglePwVisible(){
    const el = $("pwCurrent");
    el.type = (el.type==="password") ? "text" : "password";
  }
  window.togglePwVisible = togglePwVisible;

  async function applyPassword(name){
    const newPw = ($("pwNew").value||"").trim();
    if(!newPw) return alert("새 비밀번호를 입력해 주세요.");
    await updateDoc(doc(db,"users",name),{ password: newPw });
    await loadUsers();
    closeModal();
    await refreshAll();
  }
  window.applyPassword = applyPassword;

  // ===== Admin Modal: Rank =====
  function openRankModal(name){
    if(!isAdmin()) return;
    const u = usersCache.get(name) || {};
    $("modalTitle").textContent = `계급 변경 · ${name}`;
    $("modalBody").innerHTML = `
      <div class="row">
        <select id="rankSel">
          ${rankOrder.map(r=>`<option value="${r}" ${r===(u.rank||"하사")?"selected":""}>${r}</option>`).join("")}
        </select>
        <button class="primary" onclick="applyRank('${escapeHtml(name)}')">적용</button>
      </div>
      <div class="muted">계급은 정렬에 사용됩니다. (대령이 최상위 계급입니다.)</div>
    `;
    openModal();
  }
  window.openRankModal = openRankModal;

  async function applyRank(name){
    const rank = $("rankSel").value;
    await updateDoc(doc(db,"users",name),{ rank });
    await loadUsers();
    closeModal();
    await refreshAll();
  }
  window.applyRank = applyRank;

  // ===== Admin Modal: Department + Leader =====
  function openDeptModal(name){
    if(!isAdmin()) return;
    const u = usersCache.get(name) || {};
    $("modalTitle").textContent = `부서/부서장 · ${name}`;
    $("modalBody").innerHTML = `
      <div class="two">
        <div>
          <div class="muted">부서 지정</div>
          <select id="deptSel">
            ${deptList.map(d=>`<option value="${d}" ${d===(u.department||deptList[0])?"selected":""}>${d}</option>`).join("")}
          </select>
          <div class="sep"></div>
          <div class="muted">부서장 권한</div>
          <label class="row" style="gap:8px">
            <input id="leaderChk" type="checkbox" ${u.isDeptLeader?"checked":""} />
            <span>부서장 지정</span>
          </label>
          <div class="row" style="margin-top:10px">
            <button class="primary" onclick="applyDept('${escapeHtml(name)}')">적용</button>
          </div>
        </div>
        <div>
          <div class="muted">설명</div>
          <div class="mini">
            부서장은 본인 부서 공지를 등록할 수 있습니다.<br/>
            관리자는 모든 부서 공지/채팅을 볼 수 있습니다.
          </div>
        </div>
      </div>
    `;
    openModal();
  }
  window.openDeptModal = openDeptModal;

  async function applyDept(name){
    const department = $("deptSel").value;
    const isDeptLeader = $("leaderChk").checked;
    await updateDoc(doc(db,"users",name),{ department, isDeptLeader });
    await loadUsers();
    closeModal();
    await refreshAll();
  }
  window.applyDept = applyDept;

  // ===== Content Summary (최근7일 요약) =====
  async function refreshContentSummary(){
    const seven = new Date();
    seven.setDate(seven.getDate()-7);

    const snap = await getDocs(query(
      colContent,
      where("time", ">=", seven),
      orderBy("time","desc"),
      limit(500)
    ));

    const byUser = new Map();
    const lastByUser = new Map();
    const lastByType = new Map();
    const counts = { 보급:0, 송전소:0, 차량수호:0 };
    const writerCounts = new Map();

    snap.forEach(d=>{
      const r = d.data();
      const t = r.time?.seconds || 0;
      let type = r.type;
      if(type==="차량 수호") type="차량수호";
      if(type in counts) counts[type]++;

      const w = r.writer;
      writerCounts.set(w, (writerCounts.get(w)||0)+1);

      const parts = Array.isArray(r.participants) ? r.participants : [];
      for(const p of parts){
        if(!byUser.has(p)) byUser.set(p, { 보급:0, 송전소:0, 차량수호:0 });
        if(type in byUser.get(p)) byUser.get(p)[type]++;

        lastByUser.set(p, Math.max(lastByUser.get(p)||0, t));

        if(!lastByType.has(p)) lastByType.set(p, { 보급:null, 송전소:null, 차량수호:null });
        const prev = lastByType.get(p)[type];
        lastByType.get(p)[type] = Math.max(prev||0, t);
      }
    });

    contentSummaryCache = { byUser, lastByUser, lastByType, counts, writerCounts };
    renderAverages();
  }

  // ===== Content Modal (체크박스+검색+OCR) =====
  function openContentModal(type){
    $("modalTitle").textContent = `${type} 보고 작성`;
    $("modalBody").innerHTML = `
      <div class="two">
        <div>
          <div class="row">
            <input id="memberSearch" placeholder="검색 (닉네임)" style="flex:1" oninput="renderMemberPickList()" />
            <button onclick="selectAllMembers()">전체</button>
            <button onclick="clearAllMembers()">비우기</button>
          </div>
          <div class="sep"></div>
          <div class="row">
            <input id="tabShot" type="file" accept="image/*" />
            <button onclick="scanTabScreenshot()">TAB 스샷 인식</button>
            <span class="mini muted">※ TAB 목록 스크린샷 → 등록 유저 닉네임 자동 추가</span>
          </div>
          <div id="ocrStatus" class="mini muted" style="margin-top:8px"></div>
          <div id="memberPickList" class="list" style="max-height:300px;overflow:auto;margin-top:10px"></div>
        </div>
        <div>
          <div class="muted">선택된 참여자</div>
          <div id="pickedChips" class="chips" style="margin-top:8px"></div>
          <div class="sep"></div>
          ${type==="송전소" ? `
            <div class="muted">송전소는 참여 인원만 기록됩니다.</div>
          ` : `
            <div class="muted">결과</div>
            <label class="row" style="gap:8px"><input type="radio" name="res" value="success" checked> 성공(O)</label>
            <label class="row" style="gap:8px"><input type="radio" name="res" value="fail"> 실패(X)</label>
          `}
          <div class="sep"></div>
          <div class="row">
            <button class="primary" onclick="submitContent('${type}')">저장</button>
            <button onclick="closeModal()">취소</button>
          </div>
          <div class="mini">작성자(<span class="kbd">${escapeHtml(currentUser)}</span>)는 자동 포함됩니다.</div>
        </div>
      </div>
    `;
    window.__picked = new Set([currentUser]);
    renderMemberPickList();
    renderPickedChips();
    openModal();
  }
  window.openContentModal = openContentModal;

  function renderMemberPickList(){
    const qtxt = ($("memberSearch")?.value||"").trim().toLowerCase();
    const arr = Array.from(usersCache.entries())
      .filter(([name,u])=> !!u)
      .filter(([name,u])=> isAdmin() ? true : !u.isHidden)
      .filter(([name,u])=> name.toLowerCase().includes(qtxt))
      .sort((a,b)=> a[0].localeCompare(b[0], "ko"));

    let html = "";
    for(const [name,u] of arr){
      const checked = window.__picked?.has(name);
      html += `<label class="item row" style="justify-content:space-between;gap:10px">
        <div>
          <div><b>${escapeHtml(name)}</b> <span class="mini">(${escapeHtml(u.rank||"-")} · ${escapeHtml(u.department||"-")})</span></div>
        </div>
        <input type="checkbox" ${checked?"checked":""} onchange="togglePicked('${escapeHtml(name)}', this.checked)" />
      </label>`;
    }
    $("memberPickList").innerHTML = html || `<div class="muted">검색 결과가 없습니다.</div>`;
  }
  window.renderMemberPickList = renderMemberPickList;

  function togglePicked(name, on){
    if(!window.__picked) window.__picked = new Set([currentUser]);
    if(on) window.__picked.add(name);
    else window.__picked.delete(name);
    window.__picked.add(currentUser);
    renderPickedChips();
  }
  window.togglePicked = togglePicked;

  function renderPickedChips(){
    const arr = Array.from(window.__picked||[]);
    $("pickedChips").innerHTML = arr.map(n=>`<span class="chip">${escapeHtml(n)}</span>`).join("") || `<span class="muted">없음</span>`;
  }

  function selectAllMembers(){
    window.__picked = new Set([currentUser]);
    for(const [name,u] of usersCache.entries()){
      if(!isAdmin() && u?.isHidden) continue;
      window.__picked.add(name);
    }
    renderMemberPickList();
    renderPickedChips();
  }
  window.selectAllMembers = selectAllMembers;

  function clearAllMembers(){
    window.__picked = new Set([currentUser]);
    renderMemberPickList();
    renderPickedChips();
  }
  window.clearAllMembers = clearAllMembers;

  async function scanTabScreenshot(){
    const f = $("tabShot")?.files?.[0];
    if(!f) return alert("TAB 스크린샷 이미지를 선택해 주세요.");
    if(!window.Tesseract) return alert("OCR 로딩 중입니다. 잠시 후 다시 시도해 주세요.");

    $("ocrStatus").textContent = "OCR 인식 중… (이미지 크기에 따라 5~20초)";
    try{
      const { data } = await window.Tesseract.recognize(f, "eng");
      const text = (data?.text||"").replace(/\s+/g," ");
      const names = Array.from(usersCache.keys());

      let found = [];
      for(const n of names){
        const re = new RegExp(`(^|[^A-Za-z0-9_])${n.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}([^A-Za-z0-9_]|$)`);
        if(re.test(text)) found.push(n);
      }

      if(!window.__picked) window.__picked = new Set([currentUser]);
      found.forEach(n=>{
        const u = usersCache.get(n);
        if(!isAdmin() && u?.isHidden) return;
        window.__picked.add(n);
      });
      window.__picked.add(currentUser);

      $("ocrStatus").textContent = found.length ? `인식 성공: ${found.join(", ")}` : "인식된 등록 유저가 없습니다.";
      renderMemberPickList();
      renderPickedChips();
    }catch(e){
      console.error(e);
      $("ocrStatus").textContent = "OCR 실패: 콘솔을 확인해 주세요.";
      alert("OCR 인식에 실패했습니다. 이미지 해상도를 높이거나 TAB 화면이 선명한 스샷으로 다시 시도해 주세요.");
    }
  }
  window.scanTabScreenshot = scanTabScreenshot;

  async function submitContent(type){
    const arr = Array.from(window.__picked||[]).filter(Boolean);
    if(arr.length===0) return alert("0명은 저장할 수 없습니다.");

    let storedType = type;
    if(storedType==="차량 수호") storedType="차량수호";

    let success = null;
    if(storedType!=="송전소"){
      const v = document.querySelector("input[name='res']:checked")?.value || "success";
      success = (v==="success");
    }

    await addDoc(colContent,{
      type: storedType,
      writer: currentUser,
      participants: arr,
      originalParticipants: [...arr],
      success,
      modified: false,
      lastModifiedBy: null,
      time: serverTimestamp()
    });

    closeModal();
    await refreshAll();
  }
  window.submitContent = submitContent;

  function setContentFilter(v){
    contentFilter = v;
    resetContentPagingAndLoad();
    if(isAdmin()) resetAdminContentPagingAndLoad();
  }
  window.loadStatsOnce = loadStatsOnce;
  window.loadOnlineOnce = loadOnlineOnce;
  window.refreshContentSummary = refreshContentSummary;
  window.resetContentPagingAndLoad = resetContentPagingAndLoad;
  window.setContentFilter = setContentFilter;

  // ===== Content paging (numbered) =====
  async function resetContentPagingAndLoad(){
    contentCursors = [null];
    contentPage = 0;
    contentHasMore = true;
    await loadContentPageNumbered(0, true);
  }
  window.resetContentPagingAndLoad = resetContentPagingAndLoad;

  async function loadContentPageNumbered(pageIndex, reset=false){
    const seven = new Date(); seven.setDate(seven.getDate()-7);

    const cursor = contentCursors[pageIndex] || null;

    let qBase = query(colContent, where("time", ">=", seven), orderBy("time","desc"), limit(CONTENT_PAGE));
    if(cursor){
      qBase = query(colContent, where("time", ">=", seven), orderBy("time","desc"), startAfter(cursor), limit(CONTENT_PAGE));
    }

    const snap = await getDocs(qBase);
    const docs = snap.docs;

    // set next cursor for pageIndex+1 if there are docs
    if(docs.length>0){
      contentCursors[pageIndex+1] = docs[docs.length-1];
    }
    contentHasMore = (docs.length === CONTENT_PAGE);

    const rows = [];
    for(const d of docs){
      const r = d.data();
      r.__id = d.id;
      let t = r.type;
      if(t==="차량 수호") t="차량수호";
      r.type = t;

      if(contentFilter!=="ALL" && r.type !== contentFilter) continue;
      if(!isAdmin()){
        const writerHidden = usersCache.get(r.writer)?.isHidden;
        if(writerHidden) continue;
      }
      rows.push(r);
    }

    renderContent(rows, true);
    contentPage = pageIndex;
    renderPager();
  }

  function renderPager(){
    const pager = $("contentPager");
    if(!pager) return;

    // ✅ 20개(페이지 사이즈) 이상일 때만 다음 페이지가 "존재 가능"합니다.
    const maxPageIndex = contentPage + (contentHasMore ? 1 : 0);
    const start = Math.max(0, contentPage - 3);
    const end = Math.min(maxPageIndex, contentPage + 3);

    let html = "";
    html += `<button class="pagebtn" onclick="goContentPage(${Math.max(0, contentPage-1)})" ${contentPage===0?"disabled":""}>이전</button>`;

    for(let i=start;i<=end;i++){
      html += `<button class="pagebtn ${i===contentPage?"active":""}" onclick="goContentPage(${i})">${i+1}</button>`;
    }

    html += `<button class="pagebtn" onclick="${contentHasMore ? `goContentPage(${contentPage+1})` : "void(0)"}" ${contentHasMore ? "" : "disabled"}>다음</button>`;
    pager.innerHTML = html;
  }

    if(contentHasMore){
      html += '<button class="pagebtn" onclick="goContentPage(' + (contentPage+1) + ')">다음</button>';
    }else{
      html += '<button class="pagebtn" disabled>다음</button>';
    }

    pager.innerHTML = html;
  }

  async function goContentPage(i){
    if(i<0) return;
    // if cursor not known yet but we canNext, try
    if(i >= contentCursors.length) return;
    await loadContentPageNumbered(i, true);
  }
  window.goContentPage = goContentPage;

  // Admin content paging
  async function resetAdminContentPagingAndLoad(){
    adminContentCursors = [null];
    adminContentPage = 0;
    adminContentHasMore = true;
    await loadAdminContentPageNumbered(0, true);
  }
  window.resetAdminContentPagingAndLoad = resetAdminContentPagingAndLoad;

  async function loadAdminContentPageNumbered(pageIndex, reset=false){
    if(!isAdmin()) return;
    const seven = new Date(); seven.setDate(seven.getDate()-7);
    const cursor = adminContentCursors[pageIndex] || null;

    let qBase = query(colContent, where("time", ">=", seven), orderBy("time","desc"), limit(CONTENT_PAGE));
    if(cursor){
      qBase = query(colContent, where("time", ">=", seven), orderBy("time","desc"), startAfter(cursor), limit(CONTENT_PAGE));
    }
    const snap = await getDocs(qBase);
    const docs = snap.docs;

    if(docs.length>0){
      adminContentCursors[pageIndex+1] = docs[docs.length-1];
    }
    adminContentHasMore = (docs.length === CONTENT_PAGE);

    const rows = [];
    for(const d of docs){
      const r = d.data();
      r.__id = d.id;
      let t = r.type;
      if(t==="차량 수호") t="차량수호";
      r.type = t;

      if(contentFilter!=="ALL" && r.type !== contentFilter) continue;
      rows.push(r);
    }

    renderAdminContent(rows, true);
    adminContentPage = pageIndex;
    renderAdminPager();
  }

  function renderAdminPager(){
    const pager = $("adminContentPager");
    if(!pager) return;

    const maxPageIndex = adminContentPage + (adminContentHasMore ? 1 : 0);
    const start = Math.max(0, adminContentPage - 3);
    const end = Math.min(maxPageIndex, adminContentPage + 3);

    let html = "";
    html += `<button class="pagebtn" onclick="goAdminContentPage(${Math.max(0, adminContentPage-1)})" ${adminContentPage===0?"disabled":""}>이전</button>`;

    for(let i=start;i<=end;i++){
      html += `<button class="pagebtn ${i===adminContentPage?"active":""}" onclick="goAdminContentPage(${i})">${i+1}</button>`;
    }

    html += `<button class="pagebtn" onclick="${adminContentHasMore ? `goAdminContentPage(${adminContentPage+1})` : "void(0)"}" ${adminContentHasMore ? "" : "disabled"}>다음</button>`;
    pager.innerHTML = html;
  }

    if(adminContentHasMore){
      html += '<button class="pagebtn" onclick="goAdminContentPage(' + (adminContentPage+1) + ')">다음</button>';
    }else{
      html += '<button class="pagebtn" disabled>다음</button>';
    }

    pager.innerHTML = html;
  }

  async function goAdminContentPage(i){
    if(!isAdmin()) return;
    if(i<0) return;
    if(i >= adminContentCursors.length) return;
    await loadAdminContentPageNumbered(i, true);
  }
  window.goAdminContentPage = goAdminContentPage;

  // ===== Content render/edit/delete =====
  function formatParticipantsForView(r){
    const o = r.originalParticipants || [];
    const c = r.participants || [];
    const parts = [];
    for(const n of c){
      if(!o.includes(n)) parts.push(`<u>${escapeHtml(n)}</u>`);
      else parts.push(escapeHtml(n));
    }
    for(const n of o){
      if(!c.includes(n)) parts.push(`<s>${escapeHtml(n)}</s>`);
    }
    return parts.join(", ");
  }

  function canEditContent(r){ return isAdmin() || r.writer === currentUser; }

  function modifiedLabel(r){
    if(!r.modified) return "";
    if(r.lastModifiedBy && r.lastModifiedBy !== r.writer){
      return ` <span class="mini">· 수정:${escapeHtml(r.lastModifiedBy)}</span>`;
    }
    return ` <span class="mini">(수정됨)</span>`;
  }

  function renderContent(rows, reset){
    let html = "";
    for(const r of rows){
      const t = r.time?.seconds ? new Date(r.time.seconds*1000).toLocaleString() : "-";
      const res = (r.success===null || r.success===undefined) ? "" : (r.success ? "성공(O)" : "실패(X)");
      const writer = `<b>${escapeHtml(r.writer)}</b>`;
      html += `
        <div class="item">
          <div class="row">
            <div><b>${escapeHtml(r.type)}</b> <span class="mini">${t}</span></div>
            <div class="right mini">${res}</div>
          </div>
          <div class="mini">작성자: ${writer}${modifiedLabel(r)}</div>
          <div class="mini">참여자: ${formatParticipantsForView(r) || "-"}</div>
          <div class="row" style="margin-top:8px">
            ${canEditContent(r) ? `<button onclick="openEditContent('${r.__id}')">수정</button>` : ""}
          </div>
        </div>
      `;
    }
    $("contentList").innerHTML = html || `<div class="muted">최근 7일 기록이 없습니다.</div>`;
  }

  function renderAdminContent(rows, reset){
    let html = "";
    for(const r of rows){
      const t = r.time?.seconds ? new Date(r.time.seconds*1000).toLocaleString() : "-";
      const res = (r.success===null || r.success===undefined) ? "" : (r.success ? "성공(O)" : "실패(X)");
      const writer = `<b>${escapeHtml(r.writer)}</b>`;
      html += `
        <div class="item">
          <div class="row">
            <div><b>${escapeHtml(r.type)}</b> <span class="mini">${t}</span></div>
            <div class="right mini">${res}</div>
          </div>
          <div class="mini">작성자: ${writer}${modifiedLabel(r)}</div>
          <div class="mini">참여자: ${formatParticipantsForView(r) || "-"}</div>
          <div class="row" style="margin-top:8px">
            ${canEditContent(r) ? `<button onclick="openEditContent('${r.__id}')">수정</button>` : ""}
            <button class="danger" onclick="deleteOneContent('${r.__id}')">삭제</button>
          </div>
        </div>
      `;
    }
    $("adminContentList").innerHTML = html || `<div class="muted">최근 7일 기록이 없습니다.</div>`;
  }

  async function openEditContent(id){
    const snap = await getDoc(doc(db,"contentRecords",id));
    if(!snap.exists()) return alert("기록을 찾을 수 없습니다.");
    const r = snap.data();
    if(r.type==="차량 수호") r.type="차량수호";
    if(!canEditContent(r)) return alert("수정 권한이 없습니다.");

    $("modalTitle").textContent = `기록 수정 · ${r.type}`;
    $("modalBody").innerHTML = `
      <div class="two">
        <div>
          <div class="muted">참여자 수정 (콤마 구분)</div>
          <textarea id="editParticipants">${(r.participants||[]).join(", ")}</textarea>
          <div class="mini">작성자(<span class="kbd">${escapeHtml(r.writer)}</span>)는 자동 포함됩니다.</div>
        </div>
        <div>
          ${r.type==="송전소" ? `
            <div class="muted">송전소는 결과가 없습니다.</div>
          ` : `
            <div class="muted">결과</div>
            <label class="row" style="gap:8px"><input type="radio" name="editRes" value="success" ${r.success!==false?"checked":""}> 성공(O)</label>
            <label class="row" style="gap:8px"><input type="radio" name="editRes" value="fail" ${r.success===false?"checked":""}> 실패(X)</label>
          `}
          <div class="sep"></div>
          <div class="row">
            <button class="primary" onclick="applyEditContent('${id}')">저장</button>
            <button onclick="closeModal()">취소</button>
          </div>
          <div class="mini">추가 인원은 <u>밑줄</u>, 삭제 인원은 <s>취소선</s>으로 표시됩니다.</div>
        </div>
      </div>
    `;
    openModal();
  }
  window.openEditContent = openEditContent;

  async function applyEditContent(id){
    const snap = await getDoc(doc(db,"contentRecords",id));
    if(!snap.exists()) return;
    const r = snap.data();
    if(r.type==="차량 수호") r.type="차량수호";
    if(!canEditContent(r)) return alert("수정 권한이 없습니다.");

    const raw = $("editParticipants").value || "";
    let arr = raw.split(",").map(s=>s.trim()).filter(Boolean);

    if(!arr.includes(r.writer)) arr.unshift(r.writer);
    if(arr.length===0) return alert("0명은 저장할 수 없습니다.");

    let success = r.success;
    if(r.type!=="송전소"){
      const v = document.querySelector("input[name='editRes']:checked")?.value || "success";
      success = (v==="success");
    }

    await updateDoc(doc(db,"contentRecords",id),{
      participants: arr,
      success,
      modified: true,
      lastModifiedBy: currentUser
    });

    closeModal();
    await refreshAll();
  }
  window.applyEditContent = applyEditContent;

  async function deleteOneContent(id){
    if(!isAdmin()) return;
    const ok = confirm("이 기록을 삭제하시겠습니까?");
    if(!ok) return;
    await deleteDoc(doc(db,"contentRecords",id));
    await refreshAll();
  }
  window.deleteOneContent = deleteOneContent;

  async function deleteAllContent(){
    if(!isAdmin()) return;
    const ok = confirm("전체 컨텐츠 기록을 삭제하시겠습니까? (되돌릴 수 없습니다)");
    if(!ok) return;
    const snap = await getDocs(colContent);
    for(const d of snap.docs){
      await deleteDoc(doc(db,"contentRecords",d.id));
    }
    await refreshAll();
  }
  window.deleteAllContent = deleteAllContent;

  // ===== Chat =====
  function renderDeptSelects(){
    const sel = $("adminChatDept");
    if(!sel) return;
    const depts = new Set();
    for(const [,u] of usersCache.entries()){
      if(u?.department) depts.add(u.department);
    }
    const list = Array.from(depts).filter(Boolean).sort((a,b)=>a.localeCompare(b,"ko"));
    sel.innerHTML = `<option value="">(부서 선택)</option>` + list.map(d=>`<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join("");
    if(!chatDept){
      chatDept = currentUserData?.department || "";
    }
    if(chatDept && list.includes(chatDept)){
      sel.value = chatDept;
    }
  }

  function renderAdminWorkUserSelect(){
    const sel = $("adminWorkUser");
    if(!sel) return;
    const names = Array.from(usersCache.keys()).sort((a,b)=>a.localeCompare(b,"ko"));
    sel.innerHTML = `<option value="">(유저 선택)</option>` + names.map(n=>`<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("");
  }


  function openChatSmart(){
    const dept = currentUserData?.department;
    if(!dept) return;
    openChat(dept);
  }

  function openChat(dept){
    if(!dept) return;
    chatDept = dept;
    $("chatTitle").textContent = `부서 채팅 · ${dept}`;

    if(chatUnsub){
      chatUnsub();
      chatUnsub = null;
    }

    const ref = collection(db, "departments", dept, "messages");
    const q = query(ref, orderBy("time","desc"), limit(50));

    chatUnsub = onSnapshot(q, (snap)=>{
      let html = "";
      snap.forEach(d=>{
        const r = d.data();
        const t = r.time?.seconds ? new Date(r.time.seconds*1000).toLocaleTimeString() : "";
        html += `<div class="mini"><b>${escapeHtml(r.writer||"-")}</b> <span class="muted">(${t})</span><div>${escapeHtml(r.text||"")}</div></div><div class="sep"></div>`;
      });
      $("chatBox").innerHTML = html || `<div class="muted">메시지가 없습니다.</div>`;
    });
  }
  window.openChat = openChat;

  async function sendChat(){
    const dept = chatDept || currentUserData?.department;
    if(!dept) return alert("부서가 없습니다.");
    const text = $("chatInput").value.trim();
    if(!text) return;

    await addDoc(collection(db,"departments",dept,"messages"),{
      writer: currentUser,
      text,
      time: serverTimestamp()
    });

    $("chatInput").value = "";
  }
  window.sendChat = sendChat;

  function adminOpenDeptChat(){
    if(!isAdmin()) return;
    const dept = $("adminChatDept").value;
    if(!dept) return alert("부서를 선택해 주세요.");
    openChat(dept);
  }
  window.adminOpenDeptChat = adminOpenDeptChat;

  // ===== Notice =====
  async function postNotice(){
    const dept = currentUserData?.department;
    if(!dept) return alert("부서가 없습니다.");
    if(!(isAdmin() || isDeptLeader())) return alert("공지 등록 권한이 없습니다.");

    const text = prompt("공지 내용을 입력해 주세요.");
    if(!text) return;

    const ref = doc(db,"announcements",dept);
    const snap = await getDoc(ref);

    if(snap.exists()){
      await updateDoc(ref,{ text, time: serverTimestamp(), by: currentUser });
    }else{
      await setDoc(ref,{ text, time: serverTimestamp(), by: currentUser });
    }

    setToast("공지 등록 완료");
  }
  window.postNotice = postNotice;

  async function checkNoticeOnLoginOnce(){
    const dept = currentUserData?.department;
    if(!dept) return;

    const ref = doc(db,"announcements",dept);
    const snap = await getDoc(ref);
    if(!snap.exists()) return;

    const notice = snap.data();
    const lastRead = currentUserData?.lastNoticeRead?.[dept] || null;

    const noticeSec = notice?.time?.seconds || 0;
    const readSec = lastRead?.seconds || 0;

    if(noticeSec > readSec){
      alert(`📢 ${dept} 공지\n\n${notice.text || ""}\n\n(작성: ${notice.by || "-"})`);
      await updateDoc(doc(db,"users",currentUser),{
        [`lastNoticeRead.${dept}`]: notice.time
      });
      currentUserData.lastNoticeRead = currentUserData.lastNoticeRead || {};
      currentUserData.lastNoticeRead[dept] = notice.time;
    }
  }

  // ===== Admin panel toggle =====
  function toggleAdminPanel(){ $("adminPanelBody").classList.toggle("hidden"); }
  window.toggleAdminPanel = toggleAdminPanel;

  // ===== Modal helpers =====
  function openModal(){ $("overlay").classList.remove("hidden"); }
  function closeModal(){ $("overlay").classList.add("hidden"); }
  window.closeModal = closeModal;

  // ===== Averages / Graphs =====
  function toggleGraph(){ $("graphWrap").classList.toggle("hidden"); }
  window.toggleGraph = toggleGraph;

  function formatMinToHHMM(min){
    if(!min && min!==0) return "-";
    const h = Math.floor(min/60);
    const m = Math.floor(min%60);
    return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
  }

  function renderAverages(){
    const workMap = window.__workMap;
    if(!workMap) return;

    // 근무 평균(최근7일): 사용자별 sec7 평균, sessions7 평균, 평균 출근/퇴근 시간(전체)
    let userCount = 0;
    let sumSec7 = 0;
    let sumSessions7 = 0;
    let sumIn = 0; let inC = 0;
    let sumOut = 0; let outC = 0;

    for(const [name,u] of usersCache.entries()){
      if(!isAdmin() && u.isHidden) continue;
      const s = workMap.get(name);
      if(!s) continue;
      userCount++;
      sumSec7 += (s.sec7||0);
      sumSessions7 += (s.sessions7||0);
      sumIn += (s.avgInMin||0); inC += (s.inCount||0);
      sumOut += (s.avgOutMin||0); outC += (s.outCount||0);
    }

    const avgH7 = userCount ? Math.floor((sumSec7/userCount)/3600) : 0;
    const avgSessions = userCount ? (sumSessions7/userCount).toFixed(1) : "0.0";
    const avgIn = inC ? Math.round(sumIn/inC) : null;
    const avgOut = outC ? Math.round(sumOut/outC) : null;

    $("avgWork7").textContent = `${avgH7}h`;
    $("avgSessions7").textContent = `${avgSessions}회`;
    $("avgInTime").textContent = formatMinToHHMM(avgIn);
    $("avgOutTime").textContent = formatMinToHHMM(avgOut);
  }

  function renderAdminGraph(workMap){
    // 관리자만
    if(!isAdmin()) return;
    const canvas = $("graphCanvas");
    if(!canvas) return;
    const ctx = canvas.getContext("2d");

    // 상위 12명: 최근7일 접속시간 기준
    const users = Array.from(usersCache.entries());
    users.sort((a,b)=> (rankOrder.indexOf(b[1].rank||"하사") - rankOrder.indexOf(a[1].rank||"하사")));
    const top = users.slice(0,12).map(([name,u])=>({
      name,
      v: Math.floor(((workMap.get(name)?.sec7)||0)/3600)
    }));

    const labels = top.map(x=>x.name);
    const vals = top.map(x=>x.v);
    const max = Math.max(1, ...vals);

    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "rgba(230,237,243,.9)";
    ctx.font = "12px Segoe UI";
    ctx.fillText("최근 7일 접속시간(시간) · 상위 12", 12, 18);

    const left = 12, topY = 30, w = canvas.width-24, h = canvas.height-42;
    const barW = Math.max(10, Math.floor(w / (vals.length*1.6)));
    const gap = Math.floor(barW*0.6);

    vals.forEach((v,i)=>{
      const bh = Math.floor((v/max)*h);
      const x = left + i*(barW+gap);
      const y = topY + (h-bh);
      ctx.fillStyle = "rgba(31,111,235,.85)";
      ctx.fillRect(x,y,barW,bh);
      ctx.fillStyle = "rgba(230,237,243,.85)";
      ctx.fillText(String(v), x, y-4);
      ctx.save();
      ctx.translate(x, topY+h+10);
      ctx.rotate(-0.7);
      ctx.fillText(labels[i], 0, 0);
      ctx.restore();
    });
  }

  // ===== Tabs =====
  function setTab(name){
    ["tabContentUser","tabContentAdmin"].forEach(id=>$(id).classList.remove("active"));
    ["panelContentUser","panelContentAdmin"].forEach(id=>$(id).classList.add("hidden"));

    if(name==="user"){
      $("tabContentUser").classList.add("active");
      $("panelContentUser").classList.remove("hidden");
    }else{
      $("tabContentAdmin").classList.add("active");
      $("panelContentAdmin").classList.remove("hidden");
    }
  }
  window.setTab = setTab;

  // ===== Boot globals =====


  // ✅ 버튼이 "안 먹는" 느낌일 때 원인 파악을 위해, 숨겨진 에러를 알림으로 표시합니다.
  window.addEventListener('unhandledrejection', (e)=>{
    try{
      const msg = e?.reason?.message || String(e.reason || e);
      console.error('UnhandledRejection:', e.reason);
      if(msg.includes('permission-denied')) alert('작업이 차단되었습니다: Firestore 권한(permission-denied)\nRules를 확인해 주세요.');
      else if(msg.includes('resource-exhausted')) alert('작업이 차단되었습니다: Firestore 할당량 초과(resource-exhausted)\n오늘 한도 초과일 수 있습니다.');
      else alert('오류가 발생했습니다. 콘솔(F12)을 확인해 주세요.\n' + msg);
    }catch(_){}
  });
  window.addEventListener('error', (e)=>{
    console.error('WindowError:', e?.error || e);
  });

  // ✅ 로그인 입력창에서 Enter를 누르면 로그인합니다.
  document.addEventListener("keydown",(e)=>{
    if(document.getElementById("loginBox") && !document.getElementById("loginBox").classList.contains("hidden")){
      if(e.key==="Enter"){
        const ae = document.activeElement;
        if(ae && (ae.id==="loginId" || ae.id==="loginPw")){
          e.preventDefault();
          window.login && window.login();
        }
      }
    }
  });

  window.loadStatsOnce = loadStatsOnce;
  window.setContentFilter = setContentFilter;
</script>
</head>

<body>
  <div id="loginBox" class="wrap">
    <div class="card" style="max-width:620px;margin:60px auto;">
      <h2>로그인</h2>
      <div class="row">
        <input id="loginId" placeholder="아이디(닉네임)" style="flex:1" />
      </div>
      <div class="row">
        <input id="loginPw" type="password" placeholder="비밀번호" style="flex:1" />
      </div>
      <div class="row">
        <button class="primary" onclick="login()">로그인</button>
        <span class="muted">화이트리스트(등록 유저)만 접속됩니다.</span>
      </div>
    </div>
  </div>

  <div id="appBox" class="hidden">
    <div class="topbar">
      <div class="brand">도스온라인 국방부 근퇴시스템</div>
      <div class="pill" id="me"></div>
    </div>

    <div class="wrap">
      <div class="grid">

        <!-- LEFT -->
        <div>
          <div class="card">
            <h2>근태 <span class="right mini">자동 갱신: 1분</span></h2>
            <div class="row">
              <button class="primary" onclick="checkIn()">출근</button>
              <button onclick="checkOut()">퇴근</button>
              <button class="ghost" onclick="refreshAll()">전체 새로고침</button>
              <span id="toast" class="toast"></span>
            </div>
          </div>

          <div class="card">
            <h2>접속 목록</h2>
            <div class="muted">출근 중인 유저가 표시됩니다. (숨김 유저는 일반 유저에게 표시되지 않습니다.)</div>
            <div class="sep"></div>
            <div id="onlineList">-</div>
          </div>

          <div class="card">
            <h2>내 정보</h2>
            <div class="row">
              <span class="tag"><span class="dot warn"></span>최근 7일 기준</span>
            </div>
            <div class="sep"></div>
            <div class="list">
              <div class="item"><b>최근 1주일 접속시간</b> · <span id="myWorkWeek">-</span></div>
              <div class="item"><b>보급 참여</b> · <span id="mySupply">-</span></div>
              <div class="item"><b>송전소 참여</b> · <span id="myPower">-</span></div>
              <div class="item"><b>차량 수호 참여</b> · <span id="myEscort">-</span></div>
            </div>
          </div>

          <div class="card">
            <h2>컨텐츠 기록</h2>
            <div class="row">
              <div class="tabs">
                <button id="tabContentUser" class="tab active" onclick="setTab('user')">일반</button>
                <button id="tabContentAdmin" class="tab" onclick="setTab('admin')">관리자</button>
              </div>
              <div class="right"></div>
              <select onchange="setContentFilter(this.value)">
                <option value="ALL">전체 보기</option>
                <option value="보급">보급만</option>
                <option value="송전소">송전소만</option>
                <option value="차량수호">차량수호만</option>
              </select>
            </div>

            <div id="panelContentUser">
              <div class="sep"></div>
              <div class="row">
                <button onclick="openContentModal('보급')">보급 작성</button>
                <button onclick="openContentModal('송전소')">송전소 작성</button>
                <button onclick="openContentModal('차량수호')">차량 수호 작성</button>
              </div>
              <div class="sep"></div>
              <div id="contentList" class="list"></div>
              <div class="row" style="margin-top:10px">
                <div id="contentPager" class="pager"></div>
                <button class="ghost" onclick="resetContentPagingAndLoad()">새로고침</button>
                <span class="mini muted">※ 최근 7일, 페이지당 20건</span>
              </div>
            </div>

            <div id="panelContentAdmin" class="hidden">
              <div class="sep"></div>
              <div class="muted">관리자 전용: 숨김 유저 포함 / 개별 삭제 / 전체 삭제</div>
              <div class="sep"></div>
              <div id="adminContentList" class="list"></div>
              <div class="row" style="margin-top:10px">
                <div id="adminContentPager" class="pager"></div>
                <button class="ghost" onclick="resetAdminContentPagingAndLoad()">새로고침</button>
                <button id="adminQuick" class="danger hidden" onclick="deleteAllContent()">전체 삭제</button>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div>
          <div class="card">
            <h2>유저 통계</h2>
            <div class="row">
              <span class="muted">정렬</span>
              <select id="sortSelect" onchange="loadStatsOnce()">
                <option value="rank_desc">계급 높은순</option>
                <option value="rank_asc">계급 낮은순</option>
                <option value="online">접속자 우선</option>
              </select>
              <button onclick="loadStatsOnce()">새로고침</button>
              <button class="ghost" onclick="toggleGraph()">그래프 펼치기</button>
            </div>
            <div id="graphWrap" class="hidden" style="margin-top:10px">
              <canvas id="graphCanvas" width="880" height="260"></canvas>
              <div class="sep"></div>
              <div class="row">
                <div class="item" style="flex:1"><b>평균 접속시간(7일)</b> · <span id="avgWork7">-</span></div>
                <div class="item" style="flex:1"><b>평균 근퇴 횟수(7일)</b> · <span id="avgSessions7">-</span></div>
                <div class="item" style="flex:1"><b>평균 출근시간</b> · <span id="avgInTime">-</span></div>
                <div class="item" style="flex:1"><b>평균 퇴근시간</b> · <span id="avgOutTime">-</span></div>
              </div>
              <div class="mini muted" style="margin-top:6px">※ 평균은 표시 대상 유저(숨김 제외)의 근태 기록을 기반으로 계산됩니다.</div>
            </div>
            <div class="sep"></div>
            <div id="statsList" class="list"></div>
          </div>

          <div class="card">
            <h2>유저 목록</h2>
            <div class="muted">온/오프라인 및 마지막 컨텐츠 시간입니다. (숨김 유저는 일반 유저에게 표시되지 않습니다.)</div>
            <div class="sep"></div>
            <div id="userDirList" class="list"></div>
          </div>

          <div id="adminBlock" class="card hidden">
            <h2>관리자(권한/부서/채팅/공지)</h2>
            <div class="row">
              <button onclick="toggleAdminPanel()">패널 열기/닫기</button>
              <button onclick="addWhitelistUser()">유저 추가</button>
              <button class="danger" onclick="deleteWhitelistUser()">유저 삭제</button>
            </div>
            <div id="adminPanelBody" class="hidden">
              <div class="sep"></div>
              <div class="muted">관리자는 숨김 유저를 포함해 모든 유저가 표시됩니다.</div>
              <div class="sep"></div>
              <div class="row">
                <select id="adminChatDept"></select>
                <button onclick="adminOpenDeptChat()">부서 채팅 보기</button>
                <button onclick="postNotice()">공지 등록</button>
              </div>
              <div class="mini muted">공지 권한: 관리자 또는 해당 부서장</div>
            </div>
          </div>

          <div id="adminWorkBlock" class="card hidden">
            <h2>근태 기록 관리(관리자)</h2>
            <div class="row">
              <select id="adminWorkUser"></select>
              <button onclick="adminLoadWorkRecords()">조회</button>
              <button class="danger" onclick="adminDeleteAllWorkOfUser()">유저 기록 전체 삭제</button>
            </div>
            <div class="mini muted">※ 최근 50건만 표시됩니다.</div>
            <div class="sep"></div>
            <div id="adminWorkList" class="list"></div>
          </div>

          <div id="adminPwdBlock" class="card hidden">
            <h2>비밀번호 관리(관리자)</h2>
            <div class="muted">유저 통계의 “비밀번호” 버튼에서 확인/변경합니다.</div>
          </div>

          <div class="card">
            <h2 id="chatTitle">부서 채팅</h2>
            <div id="chatBox" class="chat-box"></div>
            <div class="row" style="margin-top:10px">
              <input id="chatInput" placeholder="메시지 입력" style="flex:1" />
              <button class="primary" onclick="sendChat()">전송</button>
            </div>
            <div class="mini muted">※ 최근 50개 메시지만 표시됩니다.</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="overlay" class="overlay hidden" onclick="if(event.target.id==='overlay') closeModal()">
    <div class="modal">
      <div class="row" style="justify-content:space-between">
        <h3 id="modalTitle">모달</h3>
        <button onclick="closeModal()">닫기</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
  // non-module helpers: fill selects after login via module functions (called inside refreshAll/loadUsers)
  // These IDs exist; module will populate based on usersCache, but we need hooks to avoid "undefined"
</script>

</body>
</html>
